var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),s=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,ee=c.length,te;l<ee;l++)te=c[l],!a.call(e,te)&&te!==o&&t(e,te,{get:(e=>i[e]).bind(null,te),enumerable:!(s=n(i,te))||s.enumerable});return e},c=(n,r,a)=>(a=n==null?{}:e(i(n)),s(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));function l(e){return e==null||typeof e!=`object`&&typeof e!=`function`}function ee(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function te(e){if(l(e))return e;if(Array.isArray(e)||ee(e)||e instanceof ArrayBuffer||typeof SharedArrayBuffer<`u`&&e instanceof SharedArrayBuffer)return e.slice(0);let t=Object.getPrototypeOf(e),n=t.constructor;if(e instanceof Date||e instanceof Map||e instanceof Set)return new n(e);if(e instanceof RegExp){let t=new n(e);return t.lastIndex=e.lastIndex,t}if(e instanceof DataView)return new n(e.buffer.slice(0));if(e instanceof Error){let t=new n(e.message);return t.stack=e.stack,t.name=e.name,t.cause=e.cause,t}if(typeof File<`u`&&e instanceof File)return new n([e],e.name,{type:e.type,lastModified:e.lastModified});if(typeof e==`object`){let n=Object.create(t);return Object.assign(n,e)}return e}var ne=c(o((exports=>{Object.defineProperty(exports,`__esModule`,{value:!0}),exports.camelize=n;let t={plural:{men:RegExp(`^(m|wom)en$`,`gi`),people:RegExp(`(pe)ople$`,`gi`),children:RegExp(`(child)ren$`,`gi`),tia:RegExp(`([ti])a$`,`gi`),analyses:RegExp(`((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$`,`gi`),databases:RegExp(`(database)s$`,`gi`),drives:RegExp(`(drive)s$`,`gi`),hives:RegExp(`(hi|ti)ves$`,`gi`),curves:RegExp(`(curve)s$`,`gi`),lrves:RegExp(`([lr])ves$`,`gi`),aves:RegExp(`([a])ves$`,`gi`),foves:RegExp(`([^fo])ves$`,`gi`),movies:RegExp(`(m)ovies$`,`gi`),aeiouyies:RegExp(`([^aeiouy]|qu)ies$`,`gi`),series:RegExp(`(s)eries$`,`gi`),xes:RegExp(`(x|ch|ss|sh)es$`,`gi`),mice:RegExp(`([m|l])ice$`,`gi`),buses:RegExp(`(bus)es$`,`gi`),oes:RegExp(`(o)es$`,`gi`),shoes:RegExp(`(shoe)s$`,`gi`),crises:RegExp(`(cris|ax|test)es$`,`gi`),octopuses:RegExp(`(octop|vir)uses$`,`gi`),aliases:RegExp(`(alias|canvas|status|campus)es$`,`gi`),summonses:RegExp(`^(summons|bonus)es$`,`gi`),oxen:RegExp(`^(ox)en`,`gi`),matrices:RegExp(`(matr)ices$`,`gi`),vertices:RegExp(`(vert|ind)ices$`,`gi`),feet:RegExp(`^feet$`,`gi`),teeth:RegExp(`^teeth$`,`gi`),geese:RegExp(`^geese$`,`gi`),quizzes:RegExp(`(quiz)zes$`,`gi`),whereases:RegExp(`^(whereas)es$`,`gi`),criteria:RegExp(`^(criteri)a$`,`gi`),genera:RegExp(`^genera$`,`gi`),ss:RegExp(`ss$`,`gi`),s:RegExp(`s$`,`gi`)},singular:{man:RegExp(`^(m|wom)an$`,`gi`),person:RegExp(`(pe)rson$`,`gi`),child:RegExp(`(child)$`,`gi`),drive:RegExp(`(drive)$`,`gi`),ox:RegExp(`^(ox)$`,`gi`),axis:RegExp(`(ax|test)is$`,`gi`),octopus:RegExp(`(octop|vir)us$`,`gi`),alias:RegExp(`(alias|status|canvas|campus)$`,`gi`),summons:RegExp(`^(summons|bonus)$`,`gi`),bus:RegExp(`(bu)s$`,`gi`),buffalo:RegExp(`(buffal|tomat|potat)o$`,`gi`),tium:RegExp(`([ti])um$`,`gi`),sis:RegExp(`sis$`,`gi`),ffe:RegExp(`(?:([^f])fe|([lr])f)$`,`gi`),focus:RegExp(`^(focus)$`,`gi`),hive:RegExp(`(hi|ti)ve$`,`gi`),aeiouyy:RegExp(`([^aeiouy]|qu)y$`,`gi`),x:RegExp(`(x|ch|ss|sh)$`,`gi`),matrix:RegExp(`(matr)ix$`,`gi`),vertex:RegExp(`(vert|ind)ex$`,`gi`),mouse:RegExp(`([m|l])ouse$`,`gi`),foot:RegExp(`^foot$`,`gi`),tooth:RegExp(`^tooth$`,`gi`),goose:RegExp(`^goose$`,`gi`),quiz:RegExp(`(quiz)$`,`gi`),whereas:RegExp(`^(whereas)$`,`gi`),criterion:RegExp(`^(criteri)on$`,`gi`),genus:RegExp(`^genus$`,`gi`),s:RegExp(`s$`,`gi`),common:RegExp(`$`,`gi`)}};t.plural.men,t.plural.people,t.plural.children,t.plural.tia,t.plural.analyses,t.plural.databases,t.plural.drives,t.plural.hives,t.plural.curves,t.plural.lrves,t.plural.foves,t.plural.aeiouyies,t.plural.series,t.plural.movies,t.plural.xes,t.plural.mice,t.plural.buses,t.plural.oes,t.plural.shoes,t.plural.crises,t.plural.octopuses,t.plural.aliases,t.plural.summonses,t.plural.oxen,t.plural.matrices,t.plural.feet,t.plural.teeth,t.plural.geese,t.plural.quizzes,t.plural.whereases,t.plural.criteria,t.plural.genera,t.singular.man,t.singular.person,t.singular.child,t.singular.drive,t.singular.ox,t.singular.axis,t.singular.octopus,t.singular.alias,t.singular.summons,t.singular.bus,t.singular.buffalo,t.singular.tium,t.singular.sis,t.singular.ffe,t.singular.focus,t.singular.hive,t.singular.aeiouyy,t.singular.matrix,t.singular.vertex,t.singular.x,t.singular.mouse,t.singular.foot,t.singular.tooth,t.singular.goose,t.singular.quiz,t.singular.whereas,t.singular.criterion,t.singular.genus,t.singular.s,t.singular.common,t.singular.man,t.singular.person,t.singular.child,t.singular.drive,t.singular.ox,t.singular.axis,t.singular.octopus,t.singular.alias,t.singular.summons,t.singular.bus,t.singular.buffalo,t.singular.tium,t.singular.sis,t.singular.ffe,t.singular.focus,t.singular.hive,t.singular.aeiouyy,t.singular.x,t.singular.matrix,t.singular.mouse,t.singular.foot,t.singular.tooth,t.singular.goose,t.singular.quiz,t.singular.whereas,t.singular.criterion,t.singular.genus,t.plural.men,t.plural.people,t.plural.children,t.plural.databases,t.plural.drives,t.plural.genera,t.plural.criteria,t.plural.tia,t.plural.analyses,t.plural.hives,t.plural.curves,t.plural.lrves,t.plural.aves,t.plural.foves,t.plural.movies,t.plural.aeiouyies,t.plural.series,t.plural.xes,t.plural.mice,t.plural.buses,t.plural.oes,t.plural.shoes,t.plural.crises,t.plural.octopuses,t.plural.aliases,t.plural.summonses,t.plural.oxen,t.plural.matrices,t.plural.vertices,t.plural.feet,t.plural.teeth,t.plural.geese,t.plural.quizzes,t.plural.whereases,t.plural.ss,t.plural.s;function n(e,t){let n=e.split(`/`),r=n.length,i,a,o,s;for(let e=0;e<r;e++){for(i=n[e].split(`_`),a=0,o=i.length;a<o;a++)a!==0&&(i[a]=i[a].toLowerCase()),s=i[a].charAt(0),s=t&&e===0&&a===0?s.toLowerCase():s.toUpperCase(),i[a]=s+i[a].substring(1);n[e]=i.join(``)}return n.join(`::`)}}))(),1);function re(e){let t=e.match(/^[ \t]+/);return t?t[0]:``}function ie(e){let t=e.match(/(?<=(\r\n|\r|\n))[ \t]+$/);return t?t[0]:``}function ae(e,...t){let n=``,r=(typeof e==`string`?e.split(/(?=\r\n|\r|\n)/):e.map(e=>e)).map((e,r)=>(e.match(/\r\n|\r|\n/)&&(n=ie(e)||n),e+(t[r]||``).replace(/\r\n|\r|\n/g,`
`+n))).join(``).split(/\r\n|\r|\n/),i=Math.min(...r.filter(e=>!!e.match(/[^ \t]/)).map(e=>re(e).length));return r.map(e=>e.slice(i)).join(`
`).replace(/^\n|\n[ \t]*$/g,``)}function oe(e){return e.map(e=>typeof e==`string`?{value:e,description:``}:{...e,description:e.description??``})}var se=class{_output=null;constructor(e){this.fields=e}},ce=class e{_metadata;_defined=void 0;_output=void 0;get metadata(){return{...this._metadata}}constructor(e,t,n,r){this.fields=n,this._metadata={type:e,required:!0},t&&(t.optional===!0&&(this._metadata.required=!1,t.assertNonNull===!0&&(this._metadata.assertNonNull=!0)),t.array===!0&&(this._metadata.array=!0)),r&&(this._metadata.allowedValues=oe(r))}static create(t,n,r,i){return new e(t,n,r,i)}description(e){return this._metadata.description=e,this}};const u=ce.create;function le(e){return u(`uuid`,e)}function ue(e){return u(`string`,e)}function de(e){return u(`boolean`,e)}function fe(e){return u(`integer`,e)}function pe(e){return u(`float`,e)}function me(e){return u(`date`,e)}function he(e){return u(`datetime`,e)}function ge(e){return u(`time`,e)}function _e(...e){let t,n,r=e[e.length-1];return typeof r==`object`&&!(`value`in r)?(t=e.slice(0,-1),n=r):(t=e,n=void 0),u(`enum`,n,void 0,t)}function ve(e,t){return u(`nested`,t,e)}function ye(e){return new se(e)}const be={type:ye,uuid:le,string:ue,bool:de,int:fe,float:pe,date:me,datetime:he,time:ge,enum:_e,object:ve},xe=class e extends ce{_ref=void 0;get reference(){return te(this._ref)}get metadata(){return{...this._metadata}}get config(){return{...this._metadata,validate:this._metadata.validate?.map(e=>{let{fn:t,message:n}=typeof e==`function`?{fn:e,message:`failed by \`${e.toString().trim()}\``}:{fn:e[0],message:e[1]};return{script:{expr:`(${t.toString().trim()})({ value: _value, user })`},errorMessage:n}}),hooks:this._metadata.hooks?{create:this._metadata.hooks.create?{expr:`(${this._metadata.hooks.create.toString().trim()})({ value: _value, data: _data, user })`}:void 0,update:this._metadata.hooks.update?{expr:`(${this._metadata.hooks.update.toString().trim()})({ value: _value, data: _data, user })`}:void 0}:void 0,serial:this._metadata.serial?{start:this._metadata.serial.start,maxValue:this._metadata.serial.maxValue,format:`format`in this._metadata.serial?this._metadata.serial.format:void 0}:void 0}}constructor(e,t,n,r){super(e,t,n,r)}static create(t,n,r,i){return new e(t,n,r,i)}description(e){return super.description(e)}relation(e){let t=this,n=e?.toward?.type===`self`;if(t._metadata.index=!0,t._metadata.foreignKey=!0,t._metadata.unique=[`oneToOne`,`1-1`].includes(e.type),!n){let n=e.toward.type;t._metadata.foreignKeyType=n.name}if(e.type===`keyOnly`)return t;let r=e?.toward?.key??`id`,i=e?.backward??``;if(n){let n=e;return t._pendingSelfRelation={as:n.toward.as,key:r,backward:i,relationType:n.type},t._metadata.relation=!0,t}let a=e,o=a.toward.type,s=a.toward.as??ne.camelize(o.name,!0);return this._ref={type:o,nameMap:[s,i],key:r},t._metadata.relation=!0,t}index(){return this._metadata.index=!0,this}unique(){return this._metadata.unique=!0,this._metadata.index=!0,this}vector(){return this._metadata.vector=!0,this}hooks(e){return this._metadata.hooks=e,this}validate(...e){return this._metadata.validate=e,this}serial(e){return this._metadata.serial=e,this}}.create;function Se(e){return xe(`uuid`,e)}Se();var Ce=class{_output=null;_context=null;#steps;get steps(){return this.#steps}#options;get options(){return this.#options}#output=null;get output(){return this.#output}#outputMapper=null;get outputMapper(){return this.#outputMapper}constructor(e,t,n,r={defaults:{}}){this.queryType=e,this.name=t,this.input=n,this.#steps=[],this.#options=r}fnStep(e,t,n){return this.#steps.push([`fn`,e,t,n]),this}returns(e,t){return this.#outputMapper=e,this.#output=t,this}};function we(e,t,n){return t&&`_output`in t?new Ce(`query`,e,t,n):new Ce(`query`,e,void 0,t)}ae`
  import { SqlClient } from "@tailor-platform/tailor-sdk";
  import {
    ColumnType,
    DummyDriver,
    Kysely,
    PostgresAdapter,
    PostgresIntrospector,
    PostgresQueryCompiler,
    type CompiledQuery,
  } from "kysely";

  type ArrayType<T> = ArrayTypeImpl<T> extends (infer U)[]
    ? U[]
    : ArrayTypeImpl<T>;
  type ArrayTypeImpl<T> = T extends ColumnType<infer S, infer I, infer U>
    ? ColumnType<S[], I[], U[]>
    : T[];
  type Generated<T> = T extends ColumnType<infer S, infer I, infer U>
    ? ColumnType<S, I | undefined, U>
    : ColumnType<T, T | undefined, T>;
  type Json = JsonValue;
  type JsonArray = JsonValue[];
  type JsonObject = {
    [x: string]: JsonValue | undefined;
  };
  type JsonPrimitive = boolean | number | string | null;
  type JsonValue = JsonArray | JsonObject | JsonPrimitive;
  type Timestamp = ColumnType<Date, Date | string, Date | string>;
`,ae`
  const getDB = () => {
    return new Kysely<DB>({
      dialect: {
        createAdapter: () => new PostgresAdapter(),
        createDriver: () => new DummyDriver(),
        createIntrospector: (db: Kysely<unknown>) => new PostgresIntrospector(db),
        createQueryCompiler: () => new PostgresQueryCompiler(),
      },
    });
  };

  type QueryReturnType<T> = T extends CompiledQuery<infer U> ? U : never;

  export async function kyselyWrapper<const C extends { client: SqlClient }, R>(
    context: C,
    callback: (
      context: Omit<C, "client"> & {
        db: ReturnType<typeof getDB>;
        client: {
          exec: <Q extends CompiledQuery>(
            query: Q,
          ) => Promise<QueryReturnType<Q>[]>;
        };
      },
    ) => Promise<R>,
  ) {
    const db = getDB();
    const clientWrapper = {
      exec: async <Q extends CompiledQuery>(query: Q) => {
        return await context.client.exec<QueryReturnType<Q>[]>(query.sql, query.parameters);
      },
    };

    return await callback({ ...context, db, client: clientWrapper });
  }
`,ae`
  const $connect_tailordb = async (namespace) => {
    const baseClient = namespace ? new tailordb.Client({ namespace }) : { connect: () => {}, end: () => {} };
    await baseClient.connect();

    const client = {
      async exec(query, params) {
        const result = await baseClient.queryObject(query, params ?? []);
        return result.rows;
      },
      async execOne(query, params) {
        const result = await baseClient.queryObject(query, params ?? []);
        return result.rows[0];
      },
    };
    return {
      ...client,
      async transaction(callback) {
        try {
          await client.exec("BEGIN");
          const result = await callback(client);
          await client.exec("COMMIT");
          return result;
        } catch (e) {
          console.error("Transaction failed:", e);
          try {
            await client.exec("ROLLBACK");
          } catch (e) {
            console.error("Failed to rollback transaction:", e);
          }
        }
      },
      async end() {
        try {
          await baseClient.end();
        } catch (e) {
          console.error("Error ending connection:", e);
        }
      }
    };
  };

  const ${`$tailor_db_wrapper`} = async (namespace, fn) => {
    return async (args) => {
      const client = await $connect_tailordb(namespace);
      try {
        return await fn({ ...args, client });
      } finally {
        await client.end();
      }
    };
  };
`;const d={...be},Te=6048e5,Ee=3600*24;Ee*7,Ee*365.2425;const De=Symbol.for(`constructDateFrom`);function Oe(e,t){return typeof e==`function`?e(t):e&&typeof e==`object`&&De in e?e[De](t):e instanceof Date?new e.constructor(t):new Date(t)}function f(e,t){return Oe(t||e,e)}let ke={};function Ae(){return ke}function je(e,t){let n=Ae(),r=t?.weekStartsOn??t?.locale?.options?.weekStartsOn??n.weekStartsOn??n.locale?.options?.weekStartsOn??0,i=f(e,t?.in),a=i.getDay(),o=(a<r?7:0)+a-r;return i.setDate(i.getDate()-o),i.setHours(0,0,0,0),i}function Me(e,t){return je(e,{...t,weekStartsOn:1})}function Ne(e,t){let n=f(e,t?.in),r=n.getFullYear(),i=Oe(n,0);i.setFullYear(r+1,0,4),i.setHours(0,0,0,0);let a=Me(i),o=Oe(n,0);o.setFullYear(r,0,4),o.setHours(0,0,0,0);let s=Me(o);return n.getTime()>=a.getTime()?r+1:n.getTime()>=s.getTime()?r:r-1}function Pe(e){let t=f(e),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return n.setUTCFullYear(t.getFullYear()),e-+n}function Fe(e,...t){let n=Oe.bind(null,e||t.find(e=>typeof e==`object`));return t.map(n)}function Ie(e,t){let n=f(e,t?.in);return n.setHours(0,0,0,0),n}function Le(e,t,n){let[r,i]=Fe(n?.in,e,t),a=Ie(r),o=Ie(i),s=+a-Pe(a),c=+o-Pe(o);return Math.round((s-c)/864e5)}function Re(e,t){let n=Ne(e,t),r=Oe(t?.in||e,0);return r.setFullYear(n,0,4),r.setHours(0,0,0,0),Me(r)}function ze(e){return e instanceof Date||typeof e==`object`&&Object.prototype.toString.call(e)===`[object Date]`}function Be(e){return!(!ze(e)&&typeof e!=`number`||isNaN(+f(e)))}function Ve(e,t){let n=f(e,t?.in);return n.setFullYear(n.getFullYear(),0,1),n.setHours(0,0,0,0),n}const He={lessThanXSeconds:{one:`less than a second`,other:`less than {{count}} seconds`},xSeconds:{one:`1 second`,other:`{{count}} seconds`},halfAMinute:`half a minute`,lessThanXMinutes:{one:`less than a minute`,other:`less than {{count}} minutes`},xMinutes:{one:`1 minute`,other:`{{count}} minutes`},aboutXHours:{one:`about 1 hour`,other:`about {{count}} hours`},xHours:{one:`1 hour`,other:`{{count}} hours`},xDays:{one:`1 day`,other:`{{count}} days`},aboutXWeeks:{one:`about 1 week`,other:`about {{count}} weeks`},xWeeks:{one:`1 week`,other:`{{count}} weeks`},aboutXMonths:{one:`about 1 month`,other:`about {{count}} months`},xMonths:{one:`1 month`,other:`{{count}} months`},aboutXYears:{one:`about 1 year`,other:`about {{count}} years`},xYears:{one:`1 year`,other:`{{count}} years`},overXYears:{one:`over 1 year`,other:`over {{count}} years`},almostXYears:{one:`almost 1 year`,other:`almost {{count}} years`}},Ue=(e,t,n)=>{let r,i=He[e];return r=typeof i==`string`?i:t===1?i.one:i.other.replace(`{{count}}`,t.toString()),n?.addSuffix?n.comparison&&n.comparison>0?`in `+r:r+` ago`:r};function We(e){return(t={})=>{let n=t.width?String(t.width):e.defaultWidth;return e.formats[n]||e.formats[e.defaultWidth]}}const Ge={date:We({formats:{full:`EEEE, MMMM do, y`,long:`MMMM do, y`,medium:`MMM d, y`,short:`MM/dd/yyyy`},defaultWidth:`full`}),time:We({formats:{full:`h:mm:ss a zzzz`,long:`h:mm:ss a z`,medium:`h:mm:ss a`,short:`h:mm a`},defaultWidth:`full`}),dateTime:We({formats:{full:`{{date}} 'at' {{time}}`,long:`{{date}} 'at' {{time}}`,medium:`{{date}}, {{time}}`,short:`{{date}}, {{time}}`},defaultWidth:`full`})},Ke={lastWeek:`'last' eeee 'at' p`,yesterday:`'yesterday at' p`,today:`'today at' p`,tomorrow:`'tomorrow at' p`,nextWeek:`eeee 'at' p`,other:`P`},qe=(e,t,n,r)=>Ke[e];function Je(e){return(t,n)=>{let r=n?.context?String(n.context):`standalone`,i;if(r===`formatting`&&e.formattingValues){let t=e.defaultFormattingWidth||e.defaultWidth,r=n?.width?String(n.width):t;i=e.formattingValues[r]||e.formattingValues[t]}else{let t=e.defaultWidth,r=n?.width?String(n.width):e.defaultWidth;i=e.values[r]||e.values[t]}let a=e.argumentCallback?e.argumentCallback(t):t;return i[a]}}const Ye={ordinalNumber:(e,t)=>{let n=Number(e),r=n%100;if(r>20||r<10)switch(r%10){case 1:return n+`st`;case 2:return n+`nd`;case 3:return n+`rd`}return n+`th`},era:Je({values:{narrow:[`B`,`A`],abbreviated:[`BC`,`AD`],wide:[`Before Christ`,`Anno Domini`]},defaultWidth:`wide`}),quarter:Je({values:{narrow:[`1`,`2`,`3`,`4`],abbreviated:[`Q1`,`Q2`,`Q3`,`Q4`],wide:[`1st quarter`,`2nd quarter`,`3rd quarter`,`4th quarter`]},defaultWidth:`wide`,argumentCallback:e=>e-1}),month:Je({values:{narrow:[`J`,`F`,`M`,`A`,`M`,`J`,`J`,`A`,`S`,`O`,`N`,`D`],abbreviated:[`Jan`,`Feb`,`Mar`,`Apr`,`May`,`Jun`,`Jul`,`Aug`,`Sep`,`Oct`,`Nov`,`Dec`],wide:[`January`,`February`,`March`,`April`,`May`,`June`,`July`,`August`,`September`,`October`,`November`,`December`]},defaultWidth:`wide`}),day:Je({values:{narrow:[`S`,`M`,`T`,`W`,`T`,`F`,`S`],short:[`Su`,`Mo`,`Tu`,`We`,`Th`,`Fr`,`Sa`],abbreviated:[`Sun`,`Mon`,`Tue`,`Wed`,`Thu`,`Fri`,`Sat`],wide:[`Sunday`,`Monday`,`Tuesday`,`Wednesday`,`Thursday`,`Friday`,`Saturday`]},defaultWidth:`wide`}),dayPeriod:Je({values:{narrow:{am:`a`,pm:`p`,midnight:`mi`,noon:`n`,morning:`morning`,afternoon:`afternoon`,evening:`evening`,night:`night`},abbreviated:{am:`AM`,pm:`PM`,midnight:`midnight`,noon:`noon`,morning:`morning`,afternoon:`afternoon`,evening:`evening`,night:`night`},wide:{am:`a.m.`,pm:`p.m.`,midnight:`midnight`,noon:`noon`,morning:`morning`,afternoon:`afternoon`,evening:`evening`,night:`night`}},defaultWidth:`wide`,formattingValues:{narrow:{am:`a`,pm:`p`,midnight:`mi`,noon:`n`,morning:`in the morning`,afternoon:`in the afternoon`,evening:`in the evening`,night:`at night`},abbreviated:{am:`AM`,pm:`PM`,midnight:`midnight`,noon:`noon`,morning:`in the morning`,afternoon:`in the afternoon`,evening:`in the evening`,night:`at night`},wide:{am:`a.m.`,pm:`p.m.`,midnight:`midnight`,noon:`noon`,morning:`in the morning`,afternoon:`in the afternoon`,evening:`in the evening`,night:`at night`}},defaultFormattingWidth:`wide`})};function Xe(e){return(t,n={})=>{let r=n.width,i=r&&e.matchPatterns[r]||e.matchPatterns[e.defaultMatchWidth],a=t.match(i);if(!a)return null;let o=a[0],s=r&&e.parsePatterns[r]||e.parsePatterns[e.defaultParseWidth],c=Array.isArray(s)?Qe(s,e=>e.test(o)):Ze(s,e=>e.test(o)),l;l=e.valueCallback?e.valueCallback(c):c,l=n.valueCallback?n.valueCallback(l):l;let ee=t.slice(o.length);return{value:l,rest:ee}}}function Ze(e,t){for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&t(e[n]))return n}function Qe(e,t){for(let n=0;n<e.length;n++)if(t(e[n]))return n}function $e(e){return(t,n={})=>{let r=t.match(e.matchPattern);if(!r)return null;let i=r[0],a=t.match(e.parsePattern);if(!a)return null;let o=e.valueCallback?e.valueCallback(a[0]):a[0];o=n.valueCallback?n.valueCallback(o):o;let s=t.slice(i.length);return{value:o,rest:s}}}const et={ordinalNumber:$e({matchPattern:/^(\d+)(th|st|nd|rd)?/i,parsePattern:/\d+/i,valueCallback:e=>parseInt(e,10)}),era:Xe({matchPatterns:{narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},defaultMatchWidth:`wide`,parsePatterns:{any:[/^b/i,/^(a|c)/i]},defaultParseWidth:`any`}),quarter:Xe({matchPatterns:{narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},defaultMatchWidth:`wide`,parsePatterns:{any:[/1/i,/2/i,/3/i,/4/i]},defaultParseWidth:`any`,valueCallback:e=>e+1}),month:Xe({matchPatterns:{narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},defaultMatchWidth:`wide`,parsePatterns:{narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},defaultParseWidth:`any`}),day:Xe({matchPatterns:{narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},defaultMatchWidth:`wide`,parsePatterns:{narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},defaultParseWidth:`any`}),dayPeriod:Xe({matchPatterns:{narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},defaultMatchWidth:`any`,parsePatterns:{any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},defaultParseWidth:`any`})},tt={code:`en-US`,formatDistance:Ue,formatLong:Ge,formatRelative:qe,localize:Ye,match:et,options:{weekStartsOn:0,firstWeekContainsDate:1}};function nt(e,t){let n=f(e,t?.in);return Le(n,Ve(n))+1}function rt(e,t){let n=f(e,t?.in),r=Me(n)-+Re(n);return Math.round(r/Te)+1}function it(e,t){let n=f(e,t?.in),r=n.getFullYear(),i=Ae(),a=t?.firstWeekContainsDate??t?.locale?.options?.firstWeekContainsDate??i.firstWeekContainsDate??i.locale?.options?.firstWeekContainsDate??1,o=Oe(t?.in||e,0);o.setFullYear(r+1,0,a),o.setHours(0,0,0,0);let s=je(o,t),c=Oe(t?.in||e,0);c.setFullYear(r,0,a),c.setHours(0,0,0,0);let l=je(c,t);return+n>=+s?r+1:+n>=+l?r:r-1}function at(e,t){let n=Ae(),r=t?.firstWeekContainsDate??t?.locale?.options?.firstWeekContainsDate??n.firstWeekContainsDate??n.locale?.options?.firstWeekContainsDate??1,i=it(e,t),a=Oe(t?.in||e,0);return a.setFullYear(i,0,r),a.setHours(0,0,0,0),je(a,t)}function ot(e,t){let n=f(e,t?.in),r=je(n,t)-+at(n,t);return Math.round(r/Te)+1}function p(e,t){let n=e<0?`-`:``,r=Math.abs(e).toString().padStart(t,`0`);return n+r}const m={y(e,t){let n=e.getFullYear(),r=n>0?n:1-n;return p(t===`yy`?r%100:r,t.length)},M(e,t){let n=e.getMonth();return t===`M`?String(n+1):p(n+1,2)},d(e,t){return p(e.getDate(),t.length)},a(e,t){let n=e.getHours()/12>=1?`pm`:`am`;switch(t){case`a`:case`aa`:return n.toUpperCase();case`aaa`:return n;case`aaaaa`:return n[0];case`aaaa`:default:return n===`am`?`a.m.`:`p.m.`}},h(e,t){return p(e.getHours()%12||12,t.length)},H(e,t){return p(e.getHours(),t.length)},m(e,t){return p(e.getMinutes(),t.length)},s(e,t){return p(e.getSeconds(),t.length)},S(e,t){let n=t.length,r=e.getMilliseconds(),i=Math.trunc(r*10**(n-3));return p(i,t.length)}},st={am:`am`,pm:`pm`,midnight:`midnight`,noon:`noon`,morning:`morning`,afternoon:`afternoon`,evening:`evening`,night:`night`},ct={G:function(e,t,n){let r=e.getFullYear()>0?1:0;switch(t){case`G`:case`GG`:case`GGG`:return n.era(r,{width:`abbreviated`});case`GGGGG`:return n.era(r,{width:`narrow`});case`GGGG`:default:return n.era(r,{width:`wide`})}},y:function(e,t,n){if(t===`yo`){let t=e.getFullYear(),r=t>0?t:1-t;return n.ordinalNumber(r,{unit:`year`})}return m.y(e,t)},Y:function(e,t,n,r){let i=it(e,r),a=i>0?i:1-i;if(t===`YY`){let e=a%100;return p(e,2)}return t===`Yo`?n.ordinalNumber(a,{unit:`year`}):p(a,t.length)},R:function(e,t){let n=Ne(e);return p(n,t.length)},u:function(e,t){let n=e.getFullYear();return p(n,t.length)},Q:function(e,t,n){let r=Math.ceil((e.getMonth()+1)/3);switch(t){case`Q`:return String(r);case`QQ`:return p(r,2);case`Qo`:return n.ordinalNumber(r,{unit:`quarter`});case`QQQ`:return n.quarter(r,{width:`abbreviated`,context:`formatting`});case`QQQQQ`:return n.quarter(r,{width:`narrow`,context:`formatting`});case`QQQQ`:default:return n.quarter(r,{width:`wide`,context:`formatting`})}},q:function(e,t,n){let r=Math.ceil((e.getMonth()+1)/3);switch(t){case`q`:return String(r);case`qq`:return p(r,2);case`qo`:return n.ordinalNumber(r,{unit:`quarter`});case`qqq`:return n.quarter(r,{width:`abbreviated`,context:`standalone`});case`qqqqq`:return n.quarter(r,{width:`narrow`,context:`standalone`});case`qqqq`:default:return n.quarter(r,{width:`wide`,context:`standalone`})}},M:function(e,t,n){let r=e.getMonth();switch(t){case`M`:case`MM`:return m.M(e,t);case`Mo`:return n.ordinalNumber(r+1,{unit:`month`});case`MMM`:return n.month(r,{width:`abbreviated`,context:`formatting`});case`MMMMM`:return n.month(r,{width:`narrow`,context:`formatting`});case`MMMM`:default:return n.month(r,{width:`wide`,context:`formatting`})}},L:function(e,t,n){let r=e.getMonth();switch(t){case`L`:return String(r+1);case`LL`:return p(r+1,2);case`Lo`:return n.ordinalNumber(r+1,{unit:`month`});case`LLL`:return n.month(r,{width:`abbreviated`,context:`standalone`});case`LLLLL`:return n.month(r,{width:`narrow`,context:`standalone`});case`LLLL`:default:return n.month(r,{width:`wide`,context:`standalone`})}},w:function(e,t,n,r){let i=ot(e,r);return t===`wo`?n.ordinalNumber(i,{unit:`week`}):p(i,t.length)},I:function(e,t,n){let r=rt(e);return t===`Io`?n.ordinalNumber(r,{unit:`week`}):p(r,t.length)},d:function(e,t,n){return t===`do`?n.ordinalNumber(e.getDate(),{unit:`date`}):m.d(e,t)},D:function(e,t,n){let r=nt(e);return t===`Do`?n.ordinalNumber(r,{unit:`dayOfYear`}):p(r,t.length)},E:function(e,t,n){let r=e.getDay();switch(t){case`E`:case`EE`:case`EEE`:return n.day(r,{width:`abbreviated`,context:`formatting`});case`EEEEE`:return n.day(r,{width:`narrow`,context:`formatting`});case`EEEEEE`:return n.day(r,{width:`short`,context:`formatting`});case`EEEE`:default:return n.day(r,{width:`wide`,context:`formatting`})}},e:function(e,t,n,r){let i=e.getDay(),a=(i-r.weekStartsOn+8)%7||7;switch(t){case`e`:return String(a);case`ee`:return p(a,2);case`eo`:return n.ordinalNumber(a,{unit:`day`});case`eee`:return n.day(i,{width:`abbreviated`,context:`formatting`});case`eeeee`:return n.day(i,{width:`narrow`,context:`formatting`});case`eeeeee`:return n.day(i,{width:`short`,context:`formatting`});case`eeee`:default:return n.day(i,{width:`wide`,context:`formatting`})}},c:function(e,t,n,r){let i=e.getDay(),a=(i-r.weekStartsOn+8)%7||7;switch(t){case`c`:return String(a);case`cc`:return p(a,t.length);case`co`:return n.ordinalNumber(a,{unit:`day`});case`ccc`:return n.day(i,{width:`abbreviated`,context:`standalone`});case`ccccc`:return n.day(i,{width:`narrow`,context:`standalone`});case`cccccc`:return n.day(i,{width:`short`,context:`standalone`});case`cccc`:default:return n.day(i,{width:`wide`,context:`standalone`})}},i:function(e,t,n){let r=e.getDay(),i=r===0?7:r;switch(t){case`i`:return String(i);case`ii`:return p(i,t.length);case`io`:return n.ordinalNumber(i,{unit:`day`});case`iii`:return n.day(r,{width:`abbreviated`,context:`formatting`});case`iiiii`:return n.day(r,{width:`narrow`,context:`formatting`});case`iiiiii`:return n.day(r,{width:`short`,context:`formatting`});case`iiii`:default:return n.day(r,{width:`wide`,context:`formatting`})}},a:function(e,t,n){let r=e.getHours()/12>=1?`pm`:`am`;switch(t){case`a`:case`aa`:return n.dayPeriod(r,{width:`abbreviated`,context:`formatting`});case`aaa`:return n.dayPeriod(r,{width:`abbreviated`,context:`formatting`}).toLowerCase();case`aaaaa`:return n.dayPeriod(r,{width:`narrow`,context:`formatting`});case`aaaa`:default:return n.dayPeriod(r,{width:`wide`,context:`formatting`})}},b:function(e,t,n){let r=e.getHours(),i;switch(i=r===12?st.noon:r===0?st.midnight:r/12>=1?`pm`:`am`,t){case`b`:case`bb`:return n.dayPeriod(i,{width:`abbreviated`,context:`formatting`});case`bbb`:return n.dayPeriod(i,{width:`abbreviated`,context:`formatting`}).toLowerCase();case`bbbbb`:return n.dayPeriod(i,{width:`narrow`,context:`formatting`});case`bbbb`:default:return n.dayPeriod(i,{width:`wide`,context:`formatting`})}},B:function(e,t,n){let r=e.getHours(),i;switch(i=r>=17?st.evening:r>=12?st.afternoon:r>=4?st.morning:st.night,t){case`B`:case`BB`:case`BBB`:return n.dayPeriod(i,{width:`abbreviated`,context:`formatting`});case`BBBBB`:return n.dayPeriod(i,{width:`narrow`,context:`formatting`});case`BBBB`:default:return n.dayPeriod(i,{width:`wide`,context:`formatting`})}},h:function(e,t,n){if(t===`ho`){let t=e.getHours()%12;return t===0&&(t=12),n.ordinalNumber(t,{unit:`hour`})}return m.h(e,t)},H:function(e,t,n){return t===`Ho`?n.ordinalNumber(e.getHours(),{unit:`hour`}):m.H(e,t)},K:function(e,t,n){let r=e.getHours()%12;return t===`Ko`?n.ordinalNumber(r,{unit:`hour`}):p(r,t.length)},k:function(e,t,n){let r=e.getHours();return r===0&&(r=24),t===`ko`?n.ordinalNumber(r,{unit:`hour`}):p(r,t.length)},m:function(e,t,n){return t===`mo`?n.ordinalNumber(e.getMinutes(),{unit:`minute`}):m.m(e,t)},s:function(e,t,n){return t===`so`?n.ordinalNumber(e.getSeconds(),{unit:`second`}):m.s(e,t)},S:function(e,t){return m.S(e,t)},X:function(e,t,n){let r=e.getTimezoneOffset();if(r===0)return`Z`;switch(t){case`X`:return ut(r);case`XXXX`:case`XX`:return dt(r);case`XXXXX`:case`XXX`:default:return dt(r,`:`)}},x:function(e,t,n){let r=e.getTimezoneOffset();switch(t){case`x`:return ut(r);case`xxxx`:case`xx`:return dt(r);case`xxxxx`:case`xxx`:default:return dt(r,`:`)}},O:function(e,t,n){let r=e.getTimezoneOffset();switch(t){case`O`:case`OO`:case`OOO`:return`GMT`+lt(r,`:`);case`OOOO`:default:return`GMT`+dt(r,`:`)}},z:function(e,t,n){let r=e.getTimezoneOffset();switch(t){case`z`:case`zz`:case`zzz`:return`GMT`+lt(r,`:`);case`zzzz`:default:return`GMT`+dt(r,`:`)}},t:function(e,t,n){let r=Math.trunc(e/1e3);return p(r,t.length)},T:function(e,t,n){return p(+e,t.length)}};function lt(e,t=``){let n=e>0?`-`:`+`,r=Math.abs(e),i=Math.trunc(r/60),a=r%60;return a===0?n+String(i):n+String(i)+t+p(a,2)}function ut(e,t){return e%60==0?(e>0?`-`:`+`)+p(Math.abs(e)/60,2):dt(e,t)}function dt(e,t=``){let n=e>0?`-`:`+`,r=Math.abs(e),i=p(Math.trunc(r/60),2),a=p(r%60,2);return n+i+t+a}const ft=(e,t)=>{switch(e){case`P`:return t.date({width:`short`});case`PP`:return t.date({width:`medium`});case`PPP`:return t.date({width:`long`});case`PPPP`:default:return t.date({width:`full`})}},pt=(e,t)=>{switch(e){case`p`:return t.time({width:`short`});case`pp`:return t.time({width:`medium`});case`ppp`:return t.time({width:`long`});case`pppp`:default:return t.time({width:`full`})}},mt={p:pt,P:(e,t)=>{let n=e.match(/(P+)(p+)?/)||[],r=n[1],i=n[2];if(!i)return ft(e,t);let a;switch(r){case`P`:a=t.dateTime({width:`short`});break;case`PP`:a=t.dateTime({width:`medium`});break;case`PPP`:a=t.dateTime({width:`long`});break;case`PPPP`:default:a=t.dateTime({width:`full`});break}return a.replace(`{{date}}`,ft(r,t)).replace(`{{time}}`,pt(i,t))}},ht=/^D+$/,gt=/^Y+$/,_t=[`D`,`DD`,`YY`,`YYYY`];function vt(e){return ht.test(e)}function yt(e){return gt.test(e)}function bt(e,t,n){let r=xt(e,t,n);if(console.warn(r),_t.includes(e))throw RangeError(r)}function xt(e,t,n){let r=e[0]===`Y`?`years`:`days of the month`;return`Use \`${e.toLowerCase()}\` instead of \`${e}\` (in \`${t}\`) for formatting ${r} to the input \`${n}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const St=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Ct=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,wt=/^'([^]*?)'?$/,Tt=/''/g,Et=/[a-zA-Z]/;function Dt(e,t,n){let r=Ae(),i=n?.locale??r.locale??tt,a=n?.firstWeekContainsDate??n?.locale?.options?.firstWeekContainsDate??r.firstWeekContainsDate??r.locale?.options?.firstWeekContainsDate??1,o=n?.weekStartsOn??n?.locale?.options?.weekStartsOn??r.weekStartsOn??r.locale?.options?.weekStartsOn??0,s=f(e,n?.in);if(!Be(s))throw RangeError(`Invalid time value`);let c=t.match(Ct).map(e=>{let t=e[0];if(t===`p`||t===`P`){let n=mt[t];return n(e,i.formatLong)}return e}).join(``).match(St).map(e=>{if(e===`''`)return{isToken:!1,value:`'`};let t=e[0];if(t===`'`)return{isToken:!1,value:Ot(e)};if(ct[t])return{isToken:!0,value:e};if(t.match(Et))throw RangeError("Format string contains an unescaped latin alphabet character `"+t+"`");return{isToken:!1,value:e}});i.localize.preprocessor&&(c=i.localize.preprocessor(s,c));let l={firstWeekContainsDate:a,weekStartsOn:o,locale:i};return c.map(r=>{if(!r.isToken)return r.value;let a=r.value;(!n?.useAdditionalWeekYearTokens&&yt(a)||!n?.useAdditionalDayOfYearTokens&&vt(a))&&bt(a,t,String(e));let o=ct[a[0]];return o(s,a,i.localize,l)}).join(``)}function Ot(e){let t=e.match(wt);return t?t[1].replace(Tt,`'`):e}function h(e){return e===void 0||e===void 0}function g(e){return typeof e==`string`}function kt(e){return typeof e==`number`}function At(e){return typeof e==`boolean`}function jt(e){return e===null}function Mt(e){return e instanceof Date}function Nt(e){return typeof e==`bigint`}function _(e){return typeof e==`function`}function v(e){return typeof e==`object`&&!!e}function y(e){return Object.freeze(e)}function Pt(e){return b(e)?e:[e]}function b(e){return Array.isArray(e)}function Ft(e){return e}const x=y({is(e){return e.kind===`AlterTableNode`},create(e){return y({kind:`AlterTableNode`,table:e})},cloneWithTableProps(e,t){return y({...e,...t})},cloneWithColumnAlteration(e,t){return y({...e,columnAlterations:e.columnAlterations?[...e.columnAlterations,t]:[t]})}}),S=y({is(e){return e.kind===`IdentifierNode`},create(e){return y({kind:`IdentifierNode`,name:e})}}),C=y({is(e){return e.kind===`CreateIndexNode`},create(e){return y({kind:`CreateIndexNode`,name:S.create(e)})},cloneWith(e,t){return y({...e,...t})},cloneWithColumns(e,t){return y({...e,columns:[...e.columns||[],...t]})}}),It=y({is(e){return e.kind===`CreateSchemaNode`},create(e,t){return y({kind:`CreateSchemaNode`,schema:S.create(e),...t})},cloneWith(e,t){return y({...e,...t})}}),Lt=[`preserve rows`,`delete rows`,`drop`],w=y({is(e){return e.kind===`CreateTableNode`},create(e){return y({kind:`CreateTableNode`,table:e,columns:y([])})},cloneWithColumn(e,t){return y({...e,columns:y([...e.columns,t])})},cloneWithConstraint(e,t){return y({...e,constraints:e.constraints?y([...e.constraints,t]):y([t])})},cloneWithFrontModifier(e,t){return y({...e,frontModifiers:e.frontModifiers?y([...e.frontModifiers,t]):y([t])})},cloneWithEndModifier(e,t){return y({...e,endModifiers:e.endModifiers?y([...e.endModifiers,t]):y([t])})},cloneWith(e,t){return y({...e,...t})}}),Rt=y({is(e){return e.kind===`SchemableIdentifierNode`},create(e){return y({kind:`SchemableIdentifierNode`,identifier:S.create(e)})},createWithSchema(e,t){return y({kind:`SchemableIdentifierNode`,schema:S.create(e),identifier:S.create(t)})}}),zt=y({is(e){return e.kind===`DropIndexNode`},create(e,t){return y({kind:`DropIndexNode`,name:Rt.create(e),...t})},cloneWith(e,t){return y({...e,...t})}}),Bt=y({is(e){return e.kind===`DropSchemaNode`},create(e,t){return y({kind:`DropSchemaNode`,schema:S.create(e),...t})},cloneWith(e,t){return y({...e,...t})}}),Vt=y({is(e){return e.kind===`DropTableNode`},create(e,t){return y({kind:`DropTableNode`,table:e,...t})},cloneWith(e,t){return y({...e,...t})}}),Ht=y({is(e){return e.kind===`AliasNode`},create(e,t){return y({kind:`AliasNode`,node:e,alias:t})}}),T=y({is(e){return e.kind===`TableNode`},create(e){return y({kind:`TableNode`,table:Rt.create(e)})},createWithSchema(e,t){return y({kind:`TableNode`,table:Rt.createWithSchema(e,t)})}});function E(e){return v(e)&&_(e.toOperationNode)}function Ut(e){return v(e)&&`expressionType`in e&&E(e)}function Wt(e){return v(e)&&`expression`in e&&g(e.alias)&&E(e)}const D=y({is(e){return e.kind===`SelectModifierNode`},create(e,t){return y({kind:`SelectModifierNode`,modifier:e,of:t})},createWithExpression(e){return y({kind:`SelectModifierNode`,rawModifier:e})}}),Gt=y({is(e){return e.kind===`AndNode`},create(e,t){return y({kind:`AndNode`,left:e,right:t})}}),Kt=y({is(e){return e.kind===`OrNode`},create(e,t){return y({kind:`OrNode`,left:e,right:t})}}),qt=y({is(e){return e.kind===`OnNode`},create(e){return y({kind:`OnNode`,on:e})},cloneWithOperation(e,t,n){return y({...e,on:t===`And`?Gt.create(e.on,n):Kt.create(e.on,n)})}}),Jt=y({is(e){return e.kind===`JoinNode`},create(e,t){return y({kind:`JoinNode`,joinType:e,table:t,on:void 0})},createWithOn(e,t,n){return y({kind:`JoinNode`,joinType:e,table:t,on:qt.create(n)})},cloneWithOn(e,t){return y({...e,on:e.on?qt.cloneWithOperation(e.on,`And`,t):qt.create(t)})}}),Yt=y({is(e){return e.kind===`BinaryOperationNode`},create(e,t,n){return y({kind:`BinaryOperationNode`,leftOperand:e,operator:t,rightOperand:n})}}),Xt=`=.==.!=.<>.>.>=.<.<=.in.not in.is.is not.like.not like.match.ilike.not ilike.@>.<@.^@.&&.?.?&.?|.!<.!>.<=>.!~.~.~*.!~*.@@.@@@.!!.<->.regexp.is distinct from.is not distinct from`.split(`.`),Zt=[`+`,`-`,`*`,`/`,`%`,`^`,`&`,`|`,`#`,`<<`,`>>`],Qt=[`->`,`->>`],$t=[...Xt,...Zt,`&&`,`||`],en=[`not`,`-`,...[`exists`,`not exists`]],tn=[...$t,...Qt,...en,`between`,`between symmetric`],O=y({is(e){return e.kind===`OperatorNode`},create(e){return y({kind:`OperatorNode`,operator:e})}});function nn(e){return g(e)&&Qt.includes(e)}const k=y({is(e){return e.kind===`ColumnNode`},create(e){return y({kind:`ColumnNode`,column:S.create(e)})}}),rn=y({is(e){return e.kind===`SelectAllNode`},create(){return y({kind:`SelectAllNode`})}}),an=y({is(e){return e.kind===`ReferenceNode`},create(e,t){return y({kind:`ReferenceNode`,table:t,column:e})},createSelectAll(e){return y({kind:`ReferenceNode`,table:e,column:rn.create()})}});var on=class{#dynamicReference;get dynamicReference(){return this.#dynamicReference}get refType(){}constructor(e){this.#dynamicReference=e}toOperationNode(){return _n(this.#dynamicReference)}};function sn(e){return v(e)&&E(e)&&g(e.dynamicReference)}const cn=y({is(e){return e.kind===`OrderByItemNode`},create(e,t){return y({kind:`OrderByItemNode`,orderBy:e,direction:t})}}),A=y({is(e){return e.kind===`RawNode`},create(e,t){return y({kind:`RawNode`,sqlFragments:y(e),parameters:y(t)})},createWithSql(e){return A.create([e],[])},createWithChild(e){return A.create([``,``],[e])},createWithChildren(e){return A.create(Array(e.length+1).fill(``),e)}});function ln(e){return e===`asc`||e===`desc`}function un(e){if(e.length===2)return[dn(e[0],e[1])];if(e.length===1){let[t]=e;return Array.isArray(t)?t.map(e=>dn(e)):[dn(t)]}throw Error(`Invalid number of arguments at order by! expected 1-2, received ${e.length}`)}function dn(e,t){let n=fn(e);if(cn.is(n)){if(t)throw Error(`Cannot specify direction twice!`);return n}return cn.create(n,pn(t))}function fn(e){if(ea(e))return Qi(e);if(sn(e))return e.toOperationNode();let[t,n]=e.split(` `);if(n){if(!ln(n))throw Error(`Invalid order by direction: ${n}`);return cn.create(M(t),pn(n))}return M(e)}function pn(e){if(e)return e===`asc`||e===`desc`?A.createWithSql(e):e.toOperationNode()}const mn=y({is(e){return e.kind===`JSONReferenceNode`},create(e,t){return y({kind:`JSONReferenceNode`,reference:e,traversal:t})},cloneWithTraversal(e,t){return y({...e,traversal:t})}}),hn=y({is(e){return e.kind===`JSONOperatorChainNode`},create(e){return y({kind:`JSONOperatorChainNode`,operator:e,values:y([])})},cloneWithValue(e,t){return y({...e,values:y([...e.values,t])})}}),gn=y({is(e){return e.kind===`JSONPathNode`},create(e){return y({kind:`JSONPathNode`,inOperator:e,pathLegs:y([])})},cloneWithLeg(e,t){return y({...e,pathLegs:y([...e.pathLegs,t])})}});function _n(e){return g(e)?M(e):e.toOperationNode()}function vn(e){return b(e)?e.map(e=>j(e)):[j(e)]}function j(e){return ea(e)?Qi(e):_n(e)}function yn(e,t){let n=M(e);if(nn(t))return mn.create(n,hn.create(O.create(t)));let r=t.slice(0,-1);if(nn(r))return mn.create(n,gn.create(O.create(r)));throw Error(`Invalid JSON operator: ${t}`)}function M(e){if(!e.includes(`.`))return an.create(k.create(e));let t=e.split(`.`).map(Tn);if(t.length===3)return Cn(t);if(t.length===2)return wn(t);throw Error(`invalid column reference ${e}`)}function bn(e){let t=` as `;if(e.includes(t)){let[n,r]=e.split(t).map(Tn);return Ht.create(M(n),S.create(r))}else return M(e)}function xn(e){return k.create(e)}function Sn(e){if(e.includes(` `)){let[t,n]=e.split(` `).map(Tn);if(!ln(n))throw Error(`invalid order direction "${n}" next to "${t}"`);return un([t,n])[0]}else return xn(e)}function Cn(e){let[t,n,r]=e;return an.create(k.create(r),T.createWithSchema(t,n))}function wn(e){let[t,n]=e;return an.create(k.create(n),T.create(t))}function Tn(e){return e.trim()}const En=y({is(e){return e.kind===`PrimitiveValueListNode`},create(e){return y({kind:`PrimitiveValueListNode`,values:y([...e])})}}),Dn=y({is(e){return e.kind===`ValueListNode`},create(e){return y({kind:`ValueListNode`,values:y(e)})}}),N=y({is(e){return e.kind===`ValueNode`},create(e){return y({kind:`ValueNode`,value:e})},createImmediate(e){return y({kind:`ValueNode`,value:e,immediate:!0})}});function On(e){return b(e)?jn(e):P(e)}function P(e){return ea(e)?Qi(e):N.create(e)}function kn(e){return kt(e)||At(e)||jt(e)}function An(e){if(!kn(e))throw Error(`unsafe immediate value ${JSON.stringify(e)}`);return N.createImmediate(e)}function jn(e){return e.some(ea)?Dn.create(e.map(e=>P(e))):En.create(e)}const Mn=y({is(e){return e.kind===`ParensNode`},create(e){return y({kind:`ParensNode`,node:e})}});function F(e){if(e.length===3)return Nn(e[0],e[1],e[2]);if(e.length===1)return P(e[0]);throw Error(`invalid arguments: ${JSON.stringify(e)}`)}function Nn(e,t,n){return In(t)&&Ln(n)?Yt.create(j(e),Rn(t),N.createImmediate(n)):Yt.create(j(e),Rn(t),On(n))}function I(e,t,n){return Yt.create(j(e),Rn(t),j(n))}function Pn(e,t){return Fn(Object.entries(e).filter(([,e])=>!h(e)).map(([e,t])=>Nn(e,Ln(t)?`is`:`=`,t)),t)}function Fn(e,t,n=!0){let r=t===`and`?Gt.create:Kt.create;if(e.length===0)return Yt.create(N.createImmediate(1),O.create(`=`),N.createImmediate(t===`and`?1:0));let i=zn(e[0]);for(let t=1;t<e.length;++t)i=r(i,zn(e[t]));return e.length>1&&n?Mn.create(i):i}function In(e){return e===`is`||e===`is not`}function Ln(e){return jt(e)||At(e)}function Rn(e){if(g(e)&&tn.includes(e))return O.create(e);if(E(e))return e.toOperationNode();throw Error(`invalid operator ${JSON.stringify(e)}`)}function zn(e){return E(e)?e.toOperationNode():e}const Bn=y({is(e){return e.kind===`OrderByNode`},create(e){return y({kind:`OrderByNode`,items:y([...e])})},cloneWithItems(e,t){return y({...e,items:y([...e.items,...t])})}}),Vn=y({is(e){return e.kind===`PartitionByNode`},create(e){return y({kind:`PartitionByNode`,items:y(e)})},cloneWithItems(e,t){return y({...e,items:y([...e.items,...t])})}}),Hn=y({is(e){return e.kind===`OverNode`},create(){return y({kind:`OverNode`})},cloneWithOrderByItems(e,t){return y({...e,orderBy:e.orderBy?Bn.cloneWithItems(e.orderBy,t):Bn.create(t)})},cloneWithPartitionByItems(e,t){return y({...e,partitionBy:e.partitionBy?Vn.cloneWithItems(e.partitionBy,t):Vn.create(t)})}}),Un=y({is(e){return e.kind===`FromNode`},create(e){return y({kind:`FromNode`,froms:y(e)})},cloneWithFroms(e,t){return y({...e,froms:y([...e.froms,...t])})}}),Wn=y({is(e){return e.kind===`GroupByNode`},create(e){return y({kind:`GroupByNode`,items:y(e)})},cloneWithItems(e,t){return y({...e,items:y([...e.items,...t])})}}),Gn=y({is(e){return e.kind===`HavingNode`},create(e){return y({kind:`HavingNode`,having:e})},cloneWithOperation(e,t,n){return y({...e,having:t===`And`?Gt.create(e.having,n):Kt.create(e.having,n)})}}),L=y({is(e){return e.kind===`SelectQueryNode`},create(e){return y({kind:`SelectQueryNode`,...e&&{with:e}})},createFrom(e,t){return y({kind:`SelectQueryNode`,from:Un.create(e),...t&&{with:t}})},cloneWithSelections(e,t){return y({...e,selections:e.selections?y([...e.selections,...t]):y(t)})},cloneWithDistinctOn(e,t){return y({...e,distinctOn:e.distinctOn?y([...e.distinctOn,...t]):y(t)})},cloneWithFrontModifier(e,t){return y({...e,frontModifiers:e.frontModifiers?y([...e.frontModifiers,t]):y([t])})},cloneWithOrderByItems(e,t){return y({...e,orderBy:e.orderBy?Bn.cloneWithItems(e.orderBy,t):Bn.create(t)})},cloneWithGroupByItems(e,t){return y({...e,groupBy:e.groupBy?Wn.cloneWithItems(e.groupBy,t):Wn.create(t)})},cloneWithLimit(e,t){return y({...e,limit:t})},cloneWithOffset(e,t){return y({...e,offset:t})},cloneWithFetch(e,t){return y({...e,fetch:t})},cloneWithHaving(e,t){return y({...e,having:e.having?Gn.cloneWithOperation(e.having,`And`,t):Gn.create(t)})},cloneWithSetOperations(e,t){return y({...e,setOperations:e.setOperations?y([...e.setOperations,...t]):y([...t])})},cloneWithoutSelections(e){return y({...e,selections:[]})},cloneWithoutLimit(e){return y({...e,limit:void 0})},cloneWithoutOffset(e){return y({...e,offset:void 0})},cloneWithoutOrderBy(e){return y({...e,orderBy:void 0})},cloneWithoutGroupBy(e){return y({...e,groupBy:void 0})}});function R(e,t){Object.defineProperties(e.prototype,{then:{enumerable:!1,value:()=>{throw Error(t)}}})}var Kn=class e{#props;constructor(e){this.#props=y(e)}on(...t){return new e({...this.#props,joinNode:Jt.cloneWithOn(this.#props.joinNode,F(t))})}onRef(t,n,r){return new e({...this.#props,joinNode:Jt.cloneWithOn(this.#props.joinNode,I(t,n,r))})}onTrue(){return new e({...this.#props,joinNode:Jt.cloneWithOn(this.#props.joinNode,A.createWithSql(`true`))})}$call(e){return e(this)}toOperationNode(){return this.#props.joinNode}};R(Kn,`don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.`);const qn=y({is(e){return e.kind===`PartitionByItemNode`},create(e){return y({kind:`PartitionByItemNode`,partitionBy:e})}});function Jn(e){return vn(e).map(qn.create)}var Yn=class e{#props;constructor(e){this.#props=y(e)}orderBy(t,n){return new e({overNode:Hn.cloneWithOrderByItems(this.#props.overNode,un([t,n]))})}partitionBy(t){return new e({overNode:Hn.cloneWithPartitionByItems(this.#props.overNode,Jn(t))})}$call(e){return e(this)}toOperationNode(){return this.#props.overNode}};R(Yn,`don't await OverBuilder instances. They are never executed directly and are always just a part of a query.`);const Xn=y({is(e){return e.kind===`SelectionNode`},create(e){return y({kind:`SelectionNode`,selection:e})},createSelectAll(){return y({kind:`SelectionNode`,selection:rn.create()})},createSelectAllFromTable(e){return y({kind:`SelectionNode`,selection:an.createSelectAll(e)})}});function z(e){return _(e)?z(e(Zi())):b(e)?e.map(e=>Zn(e)):[Zn(e)]}function Zn(e){return g(e)?Xn.create(bn(e)):sn(e)?Xn.create(e.toOperationNode()):Xn.create($i(e))}function B(e){return e?Array.isArray(e)?e.map(Qn):[Qn(e)]:[Xn.createSelectAll()]}function Qn(e){if(g(e))return Xn.createSelectAllFromTable(Z(e));throw Error(`invalid value selectAll expression: ${JSON.stringify(e)}`)}const $n=y({is(e){return e.kind===`ValuesNode`},create(e){return y({kind:`ValuesNode`,values:y(e)})}}),er=y({is(e){return e.kind===`DefaultInsertValueNode`},create(){return y({kind:`DefaultInsertValueNode`})}});function tr(e){let t=_(e)?e(Zi()):e,n=b(t)?t:y([t]);return nr(n)}function nr(e){let t=rr(e);return[y([...t.keys()].map(k.create)),$n.create(e.map(e=>ir(e,t)))]}function rr(e){let t=new Map;for(let n of e){let e=Object.keys(n);for(let r of e)!t.has(r)&&n[r]!==void 0&&t.set(r,t.size)}return t}function ir(e,t){let n=Object.keys(e),r=Array.from({length:t.size}),i=!1,a=n.length;for(let o of n){let n=t.get(o);if(h(n)){a--;continue}let s=e[o];(h(s)||ea(s))&&(i=!0),r[n]=s}if(a<t.size||i){let e=er.create();return Dn.create(r.map(t=>h(t)?e:P(t)))}return En.create(r)}const V=y({is(e){return e.kind===`InsertQueryNode`},create(e,t,n){return y({kind:`InsertQueryNode`,into:e,...t&&{with:t},replace:n})},createWithoutInto(){return y({kind:`InsertQueryNode`})},cloneWith(e,t){return y({...e,...t})}}),ar=y({is(e){return e.kind===`UpdateQueryNode`},create(e,t){return y({kind:`UpdateQueryNode`,table:e,...t&&{with:t}})},createWithoutTable(){return y({kind:`UpdateQueryNode`})},cloneWithFromItems(e,t){return y({...e,from:e.from?Un.cloneWithFroms(e.from,t):Un.create(t)})},cloneWithUpdates(e,t){return y({...e,updates:e.updates?y([...e.updates,...t]):t})},cloneWithLimit(e,t){return y({...e,limit:t})}}),or=y({is(e){return e.kind===`UsingNode`},create(e){return y({kind:`UsingNode`,tables:y(e)})},cloneWithTables(e,t){return y({...e,tables:y([...e.tables,...t])})}}),sr=y({is(e){return e.kind===`DeleteQueryNode`},create(e,t){return y({kind:`DeleteQueryNode`,from:Un.create(e),...t&&{with:t}})},cloneWithOrderByItems(e,t){return y({...e,orderBy:e.orderBy?Bn.cloneWithItems(e.orderBy,t):Bn.create(t)})},cloneWithoutOrderBy(e){return y({...e,orderBy:void 0})},cloneWithLimit(e,t){return y({...e,limit:t})},cloneWithoutLimit(e){return y({...e,limit:void 0})},cloneWithUsing(e,t){return y({...e,using:e.using===void 0?or.create(t):or.cloneWithTables(e.using,t)})}}),H=y({is(e){return e.kind===`WhereNode`},create(e){return y({kind:`WhereNode`,where:e})},cloneWithOperation(e,t,n){return y({...e,where:t===`And`?Gt.create(e.where,n):Kt.create(e.where,n)})}}),cr=y({is(e){return e.kind===`ReturningNode`},create(e){return y({kind:`ReturningNode`,selections:y(e)})},cloneWithSelections(e,t){return y({...e,selections:e.selections?y([...e.selections,...t]):y(t)})}}),lr=y({is(e){return e.kind===`ExplainNode`},create(e,t){return y({kind:`ExplainNode`,format:e,options:t})}}),ur=y({is(e){return e.kind===`WhenNode`},create(e){return y({kind:`WhenNode`,condition:e})},cloneWithResult(e,t){return y({...e,result:t})}}),U=y({is(e){return e.kind===`MergeQueryNode`},create(e,t){return y({kind:`MergeQueryNode`,into:e,...t&&{with:t}})},cloneWithUsing(e,t){return y({...e,using:t})},cloneWithWhen(e,t){return y({...e,whens:e.whens?y([...e.whens,t]):y([t])})},cloneWithThen(e,t){return y({...e,whens:e.whens?y([...e.whens.slice(0,-1),ur.cloneWithResult(e.whens[e.whens.length-1],t)]):void 0})}}),dr=y({is(e){return e.kind===`OutputNode`},create(e){return y({kind:`OutputNode`,selections:y(e)})},cloneWithSelections(e,t){return y({...e,selections:e.selections?y([...e.selections,...t]):y(t)})}}),W=y({is(e){return L.is(e)||V.is(e)||ar.is(e)||sr.is(e)||U.is(e)},cloneWithEndModifier(e,t){return y({...e,endModifiers:e.endModifiers?y([...e.endModifiers,t]):y([t])})},cloneWithWhere(e,t){return y({...e,where:e.where?H.cloneWithOperation(e.where,`And`,t):H.create(t)})},cloneWithJoin(e,t){return y({...e,joins:e.joins?y([...e.joins,t]):y([t])})},cloneWithReturning(e,t){return y({...e,returning:e.returning?cr.cloneWithSelections(e.returning,t):cr.create(t)})},cloneWithoutReturning(e){return y({...e,returning:void 0})},cloneWithoutWhere(e){return y({...e,where:void 0})},cloneWithExplain(e,t,n){return y({...e,explain:lr.create(t,n?.toOperationNode())})},cloneWithTop(e,t){return y({...e,top:t})},cloneWithOutput(e,t){return y({...e,output:e.output?dr.cloneWithSelections(e.output,t):dr.create(t)})}}),fr=y({is(e){return e.kind===`ColumnUpdateNode`},create(e,t){return y({kind:`ColumnUpdateNode`,column:e,value:t})}});function pr(...e){return e.length===2?[fr.create(j(e[0]),P(e[1]))]:mr(e[0])}function mr(e){let t=_(e)?e(Zi()):e;return Object.entries(t).filter(([e,t])=>t!==void 0).map(([e,t])=>fr.create(k.create(e),P(t)))}const hr=y({is(e){return e.kind===`OnDuplicateKeyNode`},create(e){return y({kind:`OnDuplicateKeyNode`,updates:e})}});var gr=class{insertId;numInsertedOrUpdatedRows;constructor(e,t){this.insertId=e,this.numInsertedOrUpdatedRows=t}},_r=class extends Error{node;constructor(e){super(`no result`),this.node=e}};function vr(e){return Object.prototype.hasOwnProperty.call(e,`prototype`)}const G=y({is(e){return e.kind===`OnConflictNode`},create(){return y({kind:`OnConflictNode`})},cloneWith(e,t){return y({...e,...t})},cloneWithIndexWhere(e,t){return y({...e,indexWhere:e.indexWhere?H.cloneWithOperation(e.indexWhere,`And`,t):H.create(t)})},cloneWithIndexOrWhere(e,t){return y({...e,indexWhere:e.indexWhere?H.cloneWithOperation(e.indexWhere,`Or`,t):H.create(t)})},cloneWithUpdateWhere(e,t){return y({...e,updateWhere:e.updateWhere?H.cloneWithOperation(e.updateWhere,`And`,t):H.create(t)})},cloneWithUpdateOrWhere(e,t){return y({...e,updateWhere:e.updateWhere?H.cloneWithOperation(e.updateWhere,`Or`,t):H.create(t)})},cloneWithoutIndexWhere(e){return y({...e,indexWhere:void 0})},cloneWithoutUpdateWhere(e){return y({...e,updateWhere:void 0})}});var yr=class e{#props;constructor(e){this.#props=y(e)}column(t){let n=k.create(t);return new e({...this.#props,onConflictNode:G.cloneWith(this.#props.onConflictNode,{columns:this.#props.onConflictNode.columns?y([...this.#props.onConflictNode.columns,n]):y([n])})})}columns(t){let n=t.map(k.create);return new e({...this.#props,onConflictNode:G.cloneWith(this.#props.onConflictNode,{columns:this.#props.onConflictNode.columns?y([...this.#props.onConflictNode.columns,...n]):y(n)})})}constraint(t){return new e({...this.#props,onConflictNode:G.cloneWith(this.#props.onConflictNode,{constraint:S.create(t)})})}expression(t){return new e({...this.#props,onConflictNode:G.cloneWith(this.#props.onConflictNode,{indexExpression:t.toOperationNode()})})}where(...t){return new e({...this.#props,onConflictNode:G.cloneWithIndexWhere(this.#props.onConflictNode,F(t))})}whereRef(t,n,r){return new e({...this.#props,onConflictNode:G.cloneWithIndexWhere(this.#props.onConflictNode,I(t,n,r))})}clearWhere(){return new e({...this.#props,onConflictNode:G.cloneWithoutIndexWhere(this.#props.onConflictNode)})}doNothing(){return new br({...this.#props,onConflictNode:G.cloneWith(this.#props.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new xr({...this.#props,onConflictNode:G.cloneWith(this.#props.onConflictNode,{updates:mr(e)})})}$call(e){return e(this)}};R(yr,`don't await OnConflictBuilder instances.`);var br=class{#props;constructor(e){this.#props=y(e)}toOperationNode(){return this.#props.onConflictNode}};R(br,`don't await OnConflictDoNothingBuilder instances.`);var xr=class e{#props;constructor(e){this.#props=y(e)}where(...t){return new e({...this.#props,onConflictNode:G.cloneWithUpdateWhere(this.#props.onConflictNode,F(t))})}whereRef(t,n,r){return new e({...this.#props,onConflictNode:G.cloneWithUpdateWhere(this.#props.onConflictNode,I(t,n,r))})}clearWhere(){return new e({...this.#props,onConflictNode:G.cloneWithoutUpdateWhere(this.#props.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#props.onConflictNode}};R(xr,`don't await OnConflictUpdateBuilder instances.`);const Sr=y({is(e){return e.kind===`TopNode`},create(e,t){return y({kind:`TopNode`,expression:e,modifiers:t})}});function Cr(e,t){if(!kt(e)&&!Nt(e))throw Error(`Invalid top expression: ${e}`);if(!h(t)&&!wr(t))throw Error(`Invalid top modifiers: ${t}`);return Sr.create(e,t)}function wr(e){return e===`percent`||e===`with ties`||e===`percent with ties`}var Tr=class e{#props;constructor(e){this.#props=y(e)}values(t){let[n,r]=tr(t);return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{columns:n,values:r})})}columns(t){return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{columns:y(t.map(k.create))})})}expression(t){return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{values:Qi(t)})})}defaultValues(){return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{defaultValues:!0})})}modifyEnd(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}ignore(){return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{ignore:!0})})}top(t,n){return new e({...this.#props,queryNode:W.cloneWithTop(this.#props.queryNode,Cr(t,n))})}onConflict(t){return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{onConflict:t(new yr({onConflictNode:G.create()})).toOperationNode()})})}onDuplicateKeyUpdate(t){return new e({...this.#props,queryNode:V.cloneWith(this.#props.queryNode,{onDuplicateKey:hr.create(mr(t))})})}returning(t){return new e({...this.#props,queryNode:W.cloneWithReturning(this.#props.queryNode,z(t))})}returningAll(){return new e({...this.#props,queryNode:W.cloneWithReturning(this.#props.queryNode,B())})}output(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,z(t))})}outputAll(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,B(t))})}clearReturning(){return new e({...this.#props,queryNode:W.cloneWithoutReturning(this.#props.queryNode)})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId),{adapter:n}=this.#props.executor,r=e.query;return r.returning&&n.supportsReturning||r.output&&n.supportsOutput?t.rows:[new gr(t.insertId,t.numAffectedRows??t.numUpdatedOrDeletedRows)]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=_r){let t=await this.executeTakeFirst();if(t===void 0)throw vr(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:W.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};R(Tr,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var Er=class{numDeletedRows;constructor(e){this.numDeletedRows=e}};const Dr=y({is(e){return e.kind===`LimitNode`},create(e){return y({kind:`LimitNode`,limit:e})}});var Or=class e{#props;constructor(e){this.#props=y(e)}where(...t){return new e({...this.#props,queryNode:W.cloneWithWhere(this.#props.queryNode,F(t))})}whereRef(t,n,r){return new e({...this.#props,queryNode:W.cloneWithWhere(this.#props.queryNode,I(t,n,r))})}clearWhere(){return new e({...this.#props,queryNode:W.cloneWithoutWhere(this.#props.queryNode)})}top(t,n){return new e({...this.#props,queryNode:W.cloneWithTop(this.#props.queryNode,Cr(t,n))})}using(t){return new e({...this.#props,queryNode:sr.cloneWithUsing(this.#props.queryNode,ta(t))})}innerJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`InnerJoin`,t))})}leftJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`LeftJoin`,t))})}rightJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`RightJoin`,t))})}fullJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`FullJoin`,t))})}returning(t){return new e({...this.#props,queryNode:W.cloneWithReturning(this.#props.queryNode,z(t))})}returningAll(t){return new e({...this.#props,queryNode:W.cloneWithReturning(this.#props.queryNode,B(t))})}output(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,z(t))})}outputAll(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,B(t))})}clearReturning(){return new e({...this.#props,queryNode:W.cloneWithoutReturning(this.#props.queryNode)})}clearLimit(){return new e({...this.#props,queryNode:sr.cloneWithoutLimit(this.#props.queryNode)})}clearOrderBy(){return new e({...this.#props,queryNode:sr.cloneWithoutOrderBy(this.#props.queryNode)})}orderBy(t,n){return new e({...this.#props,queryNode:sr.cloneWithOrderByItems(this.#props.queryNode,un([t,n]))})}limit(t){return new e({...this.#props,queryNode:sr.cloneWithLimit(this.#props.queryNode,Dr.create(P(t)))})}modifyEnd(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId),{adapter:n}=this.#props.executor,r=e.query;return r.returning&&n.supportsReturning||r.output&&n.supportsOutput?t.rows:[new Er(t.numAffectedRows??t.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=_r){let t=await this.executeTakeFirst();if(t===void 0)throw vr(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:W.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};R(Or,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var kr=class{numUpdatedRows;numChangedRows;constructor(e,t){this.numUpdatedRows=e,this.numChangedRows=t}},Ar=class e{#props;constructor(e){this.#props=y(e)}where(...t){return new e({...this.#props,queryNode:W.cloneWithWhere(this.#props.queryNode,F(t))})}whereRef(t,n,r){return new e({...this.#props,queryNode:W.cloneWithWhere(this.#props.queryNode,I(t,n,r))})}clearWhere(){return new e({...this.#props,queryNode:W.cloneWithoutWhere(this.#props.queryNode)})}top(t,n){return new e({...this.#props,queryNode:W.cloneWithTop(this.#props.queryNode,Cr(t,n))})}from(t){return new e({...this.#props,queryNode:ar.cloneWithFromItems(this.#props.queryNode,ta(t))})}innerJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`InnerJoin`,t))})}leftJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`LeftJoin`,t))})}rightJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`RightJoin`,t))})}fullJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`FullJoin`,t))})}limit(t){return new e({...this.#props,queryNode:ar.cloneWithLimit(this.#props.queryNode,Dr.create(P(t)))})}set(...t){return new e({...this.#props,queryNode:ar.cloneWithUpdates(this.#props.queryNode,pr(...t))})}returning(t){return new e({...this.#props,queryNode:W.cloneWithReturning(this.#props.queryNode,z(t))})}returningAll(t){return new e({...this.#props,queryNode:W.cloneWithReturning(this.#props.queryNode,B(t))})}output(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,z(t))})}outputAll(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,B(t))})}modifyEnd(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}clearReturning(){return new e({...this.#props,queryNode:W.cloneWithoutReturning(this.#props.queryNode)})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId),{adapter:n}=this.#props.executor,r=e.query;return r.returning&&n.supportsReturning||r.output&&n.supportsOutput?t.rows:[new kr(t.numAffectedRows??t.numUpdatedOrDeletedRows??BigInt(0),t.numChangedRows)]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=_r){let t=await this.executeTakeFirst();if(t===void 0)throw vr(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:W.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};R(Ar,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const jr=y({is(e){return e.kind===`CommonTableExpressionNameNode`},create(e,t){return y({kind:`CommonTableExpressionNameNode`,table:T.create(e),columns:t?y(t.map(k.create)):void 0})}}),Mr=y({is(e){return e.kind===`CommonTableExpressionNode`},create(e,t){return y({kind:`CommonTableExpressionNode`,name:e,expression:t})},cloneWith(e,t){return y({...e,...t})}});var Nr=class e{#props;constructor(e){this.#props=y(e)}materialized(){return new e({...this.#props,node:Mr.cloneWith(this.#props.node,{materialized:!0})})}notMaterialized(){return new e({...this.#props,node:Mr.cloneWith(this.#props.node,{materialized:!1})})}toOperationNode(){return this.#props.node}};R(Nr,`don't await CTEBuilder instances. They are never executed directly and are always just a part of a query.`);function Pr(e,t){let n=t(li()).toOperationNode();return _(e)?e(Fr(n)).toOperationNode():Mr.create(Ir(e),n)}function Fr(e){return t=>new Nr({node:Mr.create(Ir(t),e)})}function Ir(e){if(e.includes(`(`)){let t=e.split(/[\(\)]/),n=t[0],r=t[1].split(`,`).map(e=>e.trim());return jr.create(n,r)}else return jr.create(e)}const Lr=y({is(e){return e.kind===`WithNode`},create(e,t){return y({kind:`WithNode`,expressions:y([e]),...t})},cloneWithExpression(e,t){return y({...e,expressions:y([...e.expressions,t])})}}),Rr=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`.split(``);function zr(e){let t=``;for(let n=0;n<e;++n)t+=Br();return t}function Br(){return Rr[~~(Math.random()*Rr.length)]}function K(){return new Vr}var Vr=class{#queryId;get queryId(){return this.#queryId===void 0&&(this.#queryId=zr(8)),this.#queryId}};function q(e){return e}var Hr=class{nodeStack=[];#transformers=y({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this),OutputNode:this.transformOutput.bind(this)});transformNode(e){if(!e)return e;this.nodeStack.push(e);let t=this.transformNodeImpl(e);return this.nodeStack.pop(),y(t)}transformNodeImpl(e){return this.#transformers[e.kind](e)}transformNodeList(e){return e&&y(e.map(e=>this.transformNode(e)))}transformSelectQuery(e){return q({kind:`SelectQueryNode`,from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations),fetch:this.transformNode(e.fetch),top:this.transformNode(e.top)})}transformSelection(e){return q({kind:`SelectionNode`,selection:this.transformNode(e.selection)})}transformColumn(e){return q({kind:`ColumnNode`,column:this.transformNode(e.column)})}transformAlias(e){return q({kind:`AliasNode`,node:this.transformNode(e.node),alias:this.transformNode(e.alias)})}transformTable(e){return q({kind:`TableNode`,table:this.transformNode(e.table)})}transformFrom(e){return q({kind:`FromNode`,froms:this.transformNodeList(e.froms)})}transformReference(e){return q({kind:`ReferenceNode`,column:this.transformNode(e.column),table:this.transformNode(e.table)})}transformAnd(e){return q({kind:`AndNode`,left:this.transformNode(e.left),right:this.transformNode(e.right)})}transformOr(e){return q({kind:`OrNode`,left:this.transformNode(e.left),right:this.transformNode(e.right)})}transformValueList(e){return q({kind:`ValueListNode`,values:this.transformNodeList(e.values)})}transformParens(e){return q({kind:`ParensNode`,node:this.transformNode(e.node)})}transformJoin(e){return q({kind:`JoinNode`,joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)})}transformRaw(e){return q({kind:`RawNode`,sqlFragments:y([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)})}transformWhere(e){return q({kind:`WhereNode`,where:this.transformNode(e.where)})}transformInsertQuery(e){return q({kind:`InsertQueryNode`,into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain),defaultValues:e.defaultValues,top:this.transformNode(e.top),output:this.transformNode(e.output)})}transformValues(e){return q({kind:`ValuesNode`,values:this.transformNodeList(e.values)})}transformDeleteQuery(e){return q({kind:`DeleteQueryNode`,from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain),top:this.transformNode(e.top),output:this.transformNode(e.output)})}transformReturning(e){return q({kind:`ReturningNode`,selections:this.transformNodeList(e.selections)})}transformCreateTable(e){return q({kind:`CreateTableNode`,table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),selectQuery:this.transformNode(e.selectQuery)})}transformColumnDefinition(e){return q({kind:`ColumnDefinitionNode`,column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),nullsNotDistinct:e.nullsNotDistinct,identity:e.identity,ifNotExists:e.ifNotExists})}transformAddColumn(e){return q({kind:`AddColumnNode`,column:this.transformNode(e.column)})}transformDropTable(e){return q({kind:`DropTableNode`,table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade})}transformOrderBy(e){return q({kind:`OrderByNode`,items:this.transformNodeList(e.items)})}transformOrderByItem(e){return q({kind:`OrderByItemNode`,orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)})}transformGroupBy(e){return q({kind:`GroupByNode`,items:this.transformNodeList(e.items)})}transformGroupByItem(e){return q({kind:`GroupByItemNode`,groupBy:this.transformNode(e.groupBy)})}transformUpdateQuery(e){return q({kind:`UpdateQueryNode`,table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),explain:this.transformNode(e.explain),limit:this.transformNode(e.limit),top:this.transformNode(e.top),output:this.transformNode(e.output)})}transformColumnUpdate(e){return q({kind:`ColumnUpdateNode`,column:this.transformNode(e.column),value:this.transformNode(e.value)})}transformLimit(e){return q({kind:`LimitNode`,limit:this.transformNode(e.limit)})}transformOffset(e){return q({kind:`OffsetNode`,offset:this.transformNode(e.offset)})}transformOnConflict(e){return q({kind:`OnConflictNode`,columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing})}transformOnDuplicateKey(e){return q({kind:`OnDuplicateKeyNode`,updates:this.transformNodeList(e.updates)})}transformCreateIndex(e){return q({kind:`CreateIndexNode`,name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where),nullsNotDistinct:e.nullsNotDistinct})}transformList(e){return q({kind:`ListNode`,items:this.transformNodeList(e.items)})}transformDropIndex(e){return q({kind:`DropIndexNode`,name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade})}transformPrimaryKeyConstraint(e){return q({kind:`PrimaryKeyConstraintNode`,columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)})}transformUniqueConstraint(e){return q({kind:`UniqueConstraintNode`,columns:this.transformNodeList(e.columns),name:this.transformNode(e.name),nullsNotDistinct:e.nullsNotDistinct})}transformForeignKeyConstraint(e){return q({kind:`ForeignKeyConstraintNode`,columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate})}transformSetOperation(e){return q({kind:`SetOperationNode`,operator:e.operator,expression:this.transformNode(e.expression),all:e.all})}transformReferences(e){return q({kind:`ReferencesNode`,table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate})}transformCheckConstraint(e){return q({kind:`CheckConstraintNode`,expression:this.transformNode(e.expression),name:this.transformNode(e.name)})}transformWith(e){return q({kind:`WithNode`,expressions:this.transformNodeList(e.expressions),recursive:e.recursive})}transformCommonTableExpression(e){return q({kind:`CommonTableExpressionNode`,name:this.transformNode(e.name),materialized:e.materialized,expression:this.transformNode(e.expression)})}transformCommonTableExpressionName(e){return q({kind:`CommonTableExpressionNameNode`,table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)})}transformHaving(e){return q({kind:`HavingNode`,having:this.transformNode(e.having)})}transformCreateSchema(e){return q({kind:`CreateSchemaNode`,schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists})}transformDropSchema(e){return q({kind:`DropSchemaNode`,schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade})}transformAlterTable(e){return q({kind:`AlterTableNode`,table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint),addIndex:this.transformNode(e.addIndex),dropIndex:this.transformNode(e.dropIndex)})}transformDropColumn(e){return q({kind:`DropColumnNode`,column:this.transformNode(e.column)})}transformRenameColumn(e){return q({kind:`RenameColumnNode`,column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)})}transformAlterColumn(e){return q({kind:`AlterColumnNode`,column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull})}transformModifyColumn(e){return q({kind:`ModifyColumnNode`,column:this.transformNode(e.column)})}transformAddConstraint(e){return q({kind:`AddConstraintNode`,constraint:this.transformNode(e.constraint)})}transformDropConstraint(e){return q({kind:`DropConstraintNode`,constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier})}transformCreateView(e){return q({kind:`CreateViewNode`,name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)})}transformDropView(e){return q({kind:`DropViewNode`,name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade})}transformGenerated(e){return q({kind:`GeneratedNode`,byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)})}transformDefaultValue(e){return q({kind:`DefaultValueNode`,defaultValue:this.transformNode(e.defaultValue)})}transformOn(e){return q({kind:`OnNode`,on:this.transformNode(e.on)})}transformSelectModifier(e){return q({kind:`SelectModifierNode`,modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier),of:this.transformNodeList(e.of)})}transformCreateType(e){return q({kind:`CreateTypeNode`,name:this.transformNode(e.name),enum:this.transformNode(e.enum)})}transformDropType(e){return q({kind:`DropTypeNode`,name:this.transformNode(e.name),ifExists:e.ifExists})}transformExplain(e){return q({kind:`ExplainNode`,format:e.format,options:this.transformNode(e.options)})}transformSchemableIdentifier(e){return q({kind:`SchemableIdentifierNode`,schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)})}transformAggregateFunction(e){return q({kind:`AggregateFunctionNode`,aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,orderBy:this.transformNode(e.orderBy),filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)})}transformOver(e){return q({kind:`OverNode`,orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)})}transformPartitionBy(e){return q({kind:`PartitionByNode`,items:this.transformNodeList(e.items)})}transformPartitionByItem(e){return q({kind:`PartitionByItemNode`,partitionBy:this.transformNode(e.partitionBy)})}transformBinaryOperation(e){return q({kind:`BinaryOperationNode`,leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)})}transformUnaryOperation(e){return q({kind:`UnaryOperationNode`,operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)})}transformUsing(e){return q({kind:`UsingNode`,tables:this.transformNodeList(e.tables)})}transformFunction(e){return q({kind:`FunctionNode`,func:e.func,arguments:this.transformNodeList(e.arguments)})}transformCase(e){return q({kind:`CaseNode`,value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement})}transformWhen(e){return q({kind:`WhenNode`,condition:this.transformNode(e.condition),result:this.transformNode(e.result)})}transformJSONReference(e){return q({kind:`JSONReferenceNode`,reference:this.transformNode(e.reference),traversal:this.transformNode(e.traversal)})}transformJSONPath(e){return q({kind:`JSONPathNode`,inOperator:this.transformNode(e.inOperator),pathLegs:this.transformNodeList(e.pathLegs)})}transformJSONPathLeg(e){return q({kind:`JSONPathLegNode`,type:e.type,value:e.value})}transformJSONOperatorChain(e){return q({kind:`JSONOperatorChainNode`,operator:this.transformNode(e.operator),values:this.transformNodeList(e.values)})}transformTuple(e){return q({kind:`TupleNode`,values:this.transformNodeList(e.values)})}transformMergeQuery(e){return q({kind:`MergeQueryNode`,into:this.transformNode(e.into),using:this.transformNode(e.using),whens:this.transformNodeList(e.whens),with:this.transformNode(e.with),top:this.transformNode(e.top),endModifiers:this.transformNodeList(e.endModifiers),output:this.transformNode(e.output)})}transformMatched(e){return q({kind:`MatchedNode`,not:e.not,bySource:e.bySource})}transformAddIndex(e){return q({kind:`AddIndexNode`,name:this.transformNode(e.name),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists})}transformCast(e){return q({kind:`CastNode`,expression:this.transformNode(e.expression),dataType:this.transformNode(e.dataType)})}transformFetch(e){return q({kind:`FetchNode`,rowCount:this.transformNode(e.rowCount),modifier:e.modifier})}transformTop(e){return q({kind:`TopNode`,expression:e.expression,modifiers:e.modifiers})}transformOutput(e){return q({kind:`OutputNode`,selections:this.transformNodeList(e.selections)})}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}};const Ur=y({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0}),Wr={json_agg:!0,to_json:!0};var Gr=class extends Hr{#schema;#schemableIds=new Set;#ctes=new Set;constructor(e){super(),this.#schema=e}transformNodeImpl(e){if(!this.#isRootOperationNode(e))return super.transformNodeImpl(e);let t=this.#collectCTEs(e);for(let e of t)this.#ctes.add(e);let n=this.#collectSchemableIds(e);for(let e of n)this.#schemableIds.add(e);let r=super.transformNodeImpl(e);for(let e of n)this.#schemableIds.delete(e);for(let e of t)this.#ctes.delete(e);return r}transformSchemableIdentifier(e){let t=super.transformSchemableIdentifier(e);return t.schema||!this.#schemableIds.has(e.identifier.name)?t:{...t,schema:S.create(this.#schema)}}transformReferences(e){let t=super.transformReferences(e);return t.table.table.schema?t:{...t,table:T.createWithSchema(this.#schema,t.table.table.identifier.name)}}transformAggregateFunction(e){return{...super.transformAggregateFunction({...e,aggregated:[]}),aggregated:this.#transformTableArgsWithoutSchemas(e,`aggregated`)}}transformFunction(e){return{...super.transformFunction({...e,arguments:[]}),arguments:this.#transformTableArgsWithoutSchemas(e,`arguments`)}}#transformTableArgsWithoutSchemas(e,t){return Wr[e.func]?e[t].map(e=>!T.is(e)||e.table.schema?this.transformNode(e):{...e,table:this.transformIdentifier(e.table.identifier)}):this.transformNodeList(e[t])}#isRootOperationNode(e){return e.kind in Ur}#collectSchemableIds(e){let t=new Set;if(`name`in e&&e.name&&Rt.is(e.name)&&this.#collectSchemableId(e.name,t),`from`in e&&e.from)for(let n of e.from.froms)this.#collectSchemableIdsFromTableExpr(n,t);if(`into`in e&&e.into&&this.#collectSchemableIdsFromTableExpr(e.into,t),`table`in e&&e.table&&this.#collectSchemableIdsFromTableExpr(e.table,t),`joins`in e&&e.joins)for(let n of e.joins)this.#collectSchemableIdsFromTableExpr(n.table,t);return`using`in e&&e.using&&this.#collectSchemableIdsFromTableExpr(e.using,t),t}#collectCTEs(e){let t=new Set;return`with`in e&&e.with&&this.#collectCTEIds(e.with,t),t}#collectSchemableIdsFromTableExpr(e,t){let n=T.is(e)?e:Ht.is(e)&&T.is(e.node)?e.node:null;n&&this.#collectSchemableId(n.table,t)}#collectSchemableId(e,t){let n=e.identifier.name;!this.#schemableIds.has(n)&&!this.#ctes.has(n)&&t.add(n)}#collectCTEIds(e,t){for(let n of e.expressions){let e=n.name.table.table.identifier.name;this.#ctes.has(e)||t.add(e)}}},Kr=class{#transformer;constructor(e){this.#transformer=new Gr(e)}transformQuery(e){return this.#transformer.transformNode(e.node)}async transformResult(e){return e.result}};const qr=y({is(e){return e.kind===`MatchedNode`},create(e,t=!1){return y({kind:`MatchedNode`,not:e,bySource:t})}});function Jr(e,t,n){return ur.create(Fn([qr.create(!e.isMatched,e.bySource),...t&&t.length>0?[t.length===3&&n?I(t[0],t[1],t[2]):F(t)]:[]],`and`,!1))}function Yr(e){return g(e)?A.create([e],[]):E(e)?e.toOperationNode():e}var Xr=class{#promise;#resolve;#reject;constructor(){this.#promise=new Promise((e,t)=>{this.#reject=t,this.#resolve=e})}get promise(){return this.#promise}resolve=e=>{this.#resolve&&this.#resolve(e)};reject=e=>{this.#reject&&this.#reject(e)}};const Zr=new Set;function Qr(e){Zr.has(e)||(Zr.add(e),console.log(e))}const $r=y([]);var ei=class{#plugins;constructor(e=$r){this.#plugins=e}get plugins(){return this.#plugins}transformQuery(e,t){for(let n of this.#plugins){let r=n.transformQuery({node:e,queryId:t});if(r.kind===e.kind)e=r;else throw Error([`KyselyPlugin.transformQuery must return a node`,`of the same kind that was given to it.`,`The plugin was given a ${e.kind}`,`but it returned a ${r.kind}`].join(` `))}return e}async executeQuery(e,t){return await this.provideConnection(async n=>{let r=await n.executeQuery(e),i=await this.#transformResult(r,t);return ti(r,i),i})}async*stream(e,t,n){let r=new Xr,i=new Xr;this.provideConnection(async e=>(r.resolve(e),await i.promise)).catch(e=>r.reject(e));let a=await r.promise;try{for await(let r of a.streamQuery(e,t))yield await this.#transformResult(r,n)}finally{i.resolve()}}async#transformResult(e,t){for(let n of this.#plugins)e=await n.transformResult({result:e,queryId:t});return e}};function ti(e,t){let{numAffectedRows:n}=e;n===void 0&&e.numUpdatedOrDeletedRows===void 0||n!==void 0&&t.numAffectedRows!==void 0||Qr(`kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.`)}const ni=new class e extends ei{get adapter(){throw Error(`this query cannot be compiled to SQL`)}compileQuery(){throw Error(`this query cannot be compiled to SQL`)}provideConnection(){throw Error(`this query cannot be executed`)}withConnectionProvider(){throw Error(`this query cannot have a connection provider`)}withPlugin(t){return new e([...this.plugins,t])}withPlugins(t){return new e([...this.plugins,...t])}withPluginAtFront(t){return new e([t,...this.plugins])}withoutPlugins(){return new e([])}};var ri=class{numChangedRows;constructor(e){this.numChangedRows=e}},ii=class e{#props;constructor(e){this.#props=y(e)}modifyEnd(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}top(t,n){return new e({...this.#props,queryNode:W.cloneWithTop(this.#props.queryNode,Cr(t,n))})}using(...e){return new ai({...this.#props,queryNode:U.cloneWithUsing(this.#props.queryNode,J(`Using`,e))})}output(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,z(t))})}outputAll(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,B(t))})}};R(ii,"don't await MergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var ai=class e{#props;constructor(e){this.#props=y(e)}modifyEnd(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}top(t,n){return new e({...this.#props,queryNode:W.cloneWithTop(this.#props.queryNode,Cr(t,n))})}whenMatched(){return this.#whenMatched([])}whenMatchedAnd(...e){return this.#whenMatched(e)}whenMatchedAndRef(e,t,n){return this.#whenMatched([e,t,n],!0)}#whenMatched(e,t){return new oi({...this.#props,queryNode:U.cloneWithWhen(this.#props.queryNode,Jr({isMatched:!0},e,t))})}whenNotMatched(){return this.#whenNotMatched([])}whenNotMatchedAnd(...e){return this.#whenNotMatched(e)}whenNotMatchedAndRef(e,t,n){return this.#whenNotMatched([e,t,n],!0)}whenNotMatchedBySource(){return this.#whenNotMatched([],!1,!0)}whenNotMatchedBySourceAnd(...e){return this.#whenNotMatched(e,!1,!0)}whenNotMatchedBySourceAndRef(e,t,n){return this.#whenNotMatched([e,t,n],!0,!0)}output(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,z(t))})}outputAll(t){return new e({...this.#props,queryNode:W.cloneWithOutput(this.#props.queryNode,B(t))})}#whenNotMatched(e,t=!1,n=!1){let r={...this.#props,queryNode:U.cloneWithWhen(this.#props.queryNode,Jr({isMatched:!1,bySource:n},e,t))};return new(n?oi:si)(r)}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId);return e.query.output&&this.#props.executor.adapter.supportsOutput?t.rows:[new ri(t.numAffectedRows)]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=_r){let t=await this.executeTakeFirst();if(t===void 0)throw vr(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}};R(ai,"don't await WheneableMergeQueryBuilder instances directly. To execute the query you need to call `execute`.");var oi=class{#props;constructor(e){this.#props=y(e)}thenDelete(){return new ai({...this.#props,queryNode:U.cloneWithThen(this.#props.queryNode,Yr(`delete`))})}thenDoNothing(){return new ai({...this.#props,queryNode:U.cloneWithThen(this.#props.queryNode,Yr(`do nothing`))})}thenUpdate(e){return new ai({...this.#props,queryNode:U.cloneWithThen(this.#props.queryNode,Yr(e(new Ar({queryId:this.#props.queryId,executor:ni,queryNode:ar.createWithoutTable()}))))})}thenUpdateSet(...e){return this.thenUpdate(t=>t.set(...e))}};R(oi,"don't await MatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var si=class{#props;constructor(e){this.#props=y(e)}thenDoNothing(){return new ai({...this.#props,queryNode:U.cloneWithThen(this.#props.queryNode,Yr(`do nothing`))})}thenInsertValues(e){let[t,n]=tr(e);return new ai({...this.#props,queryNode:U.cloneWithThen(this.#props.queryNode,Yr(V.cloneWith(V.createWithoutInto(),{columns:t,values:n})))})}};R(si,"don't await NotMatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var ci=class e{#props;constructor(e){this.#props=y(e)}selectFrom(e){return Ei({queryId:K(),executor:this.#props.executor,queryNode:L.createFrom(ta(e),this.#props.withNode)})}selectNoFrom(e){return Ei({queryId:K(),executor:this.#props.executor,queryNode:L.cloneWithSelections(L.create(this.#props.withNode),z(e))})}insertInto(e){return new Tr({queryId:K(),executor:this.#props.executor,queryNode:V.create(Z(e),this.#props.withNode)})}replaceInto(e){return new Tr({queryId:K(),executor:this.#props.executor,queryNode:V.create(Z(e),this.#props.withNode,!0)})}deleteFrom(e){return new Or({queryId:K(),executor:this.#props.executor,queryNode:sr.create(ta(e),this.#props.withNode)})}updateTable(e){return new Ar({queryId:K(),executor:this.#props.executor,queryNode:ar.create(na(e),this.#props.withNode)})}mergeInto(e){return new ii({queryId:K(),executor:this.#props.executor,queryNode:U.create(ra(e),this.#props.withNode)})}with(t,n){let r=Pr(t,n);return new e({...this.#props,withNode:this.#props.withNode?Lr.cloneWithExpression(this.#props.withNode,r):Lr.create(r)})}withRecursive(t,n){let r=Pr(t,n);return new e({...this.#props,withNode:this.#props.withNode?Lr.cloneWithExpression(this.#props.withNode,r):Lr.create(r,{recursive:!0})})}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}withoutPlugins(){return new e({...this.#props,executor:this.#props.executor.withoutPlugins()})}withSchema(t){return new e({...this.#props,executor:this.#props.executor.withPluginAtFront(new Kr(t))})}};function li(){return new ci({executor:ni})}function ui(e,t){return new Kn({joinNode:Jt.create(e,na(t))})}function di(){return new Yn({overNode:Hn.create()})}function J(e,t){if(t.length===3)return pi(e,t[0],t[1],t[2]);if(t.length===2)return fi(e,t[0],t[1]);throw Error(`not implemented`)}function fi(e,t,n){return n(ui(e,t)).toOperationNode()}function pi(e,t,n,r){return Jt.createWithOn(e,na(t),I(n,`=`,r))}const mi=y({is(e){return e.kind===`OffsetNode`},create(e){return y({kind:`OffsetNode`,offset:e})}}),hi=y({is(e){return e.kind===`GroupByItemNode`},create(e){return y({kind:`GroupByItemNode`,groupBy:e})}});function gi(e){return e=_(e)?e(Zi()):e,vn(e).map(hi.create)}const _i=y({is(e){return e.kind===`SetOperationNode`},create(e,t,n){return y({kind:`SetOperationNode`,operator:e,expression:t,all:n})}});function vi(e,t,n){return _(t)&&(t=t(Xi())),b(t)||(t=[t]),t.map(t=>_i.create(e,Qi(t),n))}var Y=class e{#node;constructor(e){this.#node=e}get expressionType(){}as(e){return new yi(this,e)}or(...e){return new bi(Kt.create(this.#node,F(e)))}and(...e){return new xi(Gt.create(this.#node,F(e)))}$castTo(){return new e(this.#node)}$notNull(){return new e(this.#node)}toOperationNode(){return this.#node}},yi=class{#expr;#alias;constructor(e,t){this.#expr=e,this.#alias=t}get expression(){return this.#expr}get alias(){return this.#alias}toOperationNode(){return Ht.create(this.#expr.toOperationNode(),E(this.#alias)?this.#alias.toOperationNode():S.create(this.#alias))}},bi=class e{#node;constructor(e){this.#node=e}get expressionType(){}as(e){return new yi(this,e)}or(...t){return new e(Kt.create(this.#node,F(t)))}$castTo(){return new e(this.#node)}toOperationNode(){return Mn.create(this.#node)}},xi=class e{#node;constructor(e){this.#node=e}get expressionType(){}as(e){return new yi(this,e)}and(...t){return new e(Gt.create(this.#node,F(t)))}$castTo(){return new e(this.#node)}toOperationNode(){return Mn.create(this.#node)}};const Si={is(e){return e.kind===`FetchNode`},create(e,t){return{kind:`FetchNode`,rowCount:N.create(e),modifier:t}}};function Ci(e,t){if(!kt(e)&&!Nt(e))throw Error(`Invalid fetch row count: ${e}`);if(!wi(t))throw Error(`Invalid fetch modifier: ${t}`);return Si.create(e,t)}function wi(e){return e===`only`||e===`with ties`}var Ti=class e{#props;constructor(e){this.#props=y(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...t){return new e({...this.#props,queryNode:W.cloneWithWhere(this.#props.queryNode,F(t))})}whereRef(t,n,r){return new e({...this.#props,queryNode:W.cloneWithWhere(this.#props.queryNode,I(t,n,r))})}having(...t){return new e({...this.#props,queryNode:L.cloneWithHaving(this.#props.queryNode,F(t))})}havingRef(t,n,r){return new e({...this.#props,queryNode:L.cloneWithHaving(this.#props.queryNode,I(t,n,r))})}select(t){return new e({...this.#props,queryNode:L.cloneWithSelections(this.#props.queryNode,z(t))})}distinctOn(t){return new e({...this.#props,queryNode:L.cloneWithDistinctOn(this.#props.queryNode,vn(t))})}modifyFront(t){return new e({...this.#props,queryNode:L.cloneWithFrontModifier(this.#props.queryNode,D.createWithExpression(t.toOperationNode()))})}modifyEnd(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.createWithExpression(t.toOperationNode()))})}distinct(){return new e({...this.#props,queryNode:L.cloneWithFrontModifier(this.#props.queryNode,D.create(`Distinct`))})}forUpdate(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.create(`ForUpdate`,t?Pt(t).map(Z):void 0))})}forShare(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.create(`ForShare`,t?Pt(t).map(Z):void 0))})}forKeyShare(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.create(`ForKeyShare`,t?Pt(t).map(Z):void 0))})}forNoKeyUpdate(t){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.create(`ForNoKeyUpdate`,t?Pt(t).map(Z):void 0))})}skipLocked(){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.create(`SkipLocked`))})}noWait(){return new e({...this.#props,queryNode:W.cloneWithEndModifier(this.#props.queryNode,D.create(`NoWait`))})}selectAll(t){return new e({...this.#props,queryNode:L.cloneWithSelections(this.#props.queryNode,B(t))})}innerJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`InnerJoin`,t))})}leftJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`LeftJoin`,t))})}rightJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`RightJoin`,t))})}fullJoin(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`FullJoin`,t))})}innerJoinLateral(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`LateralInnerJoin`,t))})}leftJoinLateral(...t){return new e({...this.#props,queryNode:W.cloneWithJoin(this.#props.queryNode,J(`LateralLeftJoin`,t))})}orderBy(...t){return new e({...this.#props,queryNode:L.cloneWithOrderByItems(this.#props.queryNode,un(t))})}groupBy(t){return new e({...this.#props,queryNode:L.cloneWithGroupByItems(this.#props.queryNode,gi(t))})}limit(t){return new e({...this.#props,queryNode:L.cloneWithLimit(this.#props.queryNode,Dr.create(P(t)))})}offset(t){return new e({...this.#props,queryNode:L.cloneWithOffset(this.#props.queryNode,mi.create(P(t)))})}fetch(t,n=`only`){return new e({...this.#props,queryNode:L.cloneWithFetch(this.#props.queryNode,Ci(t,n))})}top(t,n){return new e({...this.#props,queryNode:W.cloneWithTop(this.#props.queryNode,Cr(t,n))})}union(t){return new e({...this.#props,queryNode:L.cloneWithSetOperations(this.#props.queryNode,vi(`union`,t,!1))})}unionAll(t){return new e({...this.#props,queryNode:L.cloneWithSetOperations(this.#props.queryNode,vi(`union`,t,!0))})}intersect(t){return new e({...this.#props,queryNode:L.cloneWithSetOperations(this.#props.queryNode,vi(`intersect`,t,!1))})}intersectAll(t){return new e({...this.#props,queryNode:L.cloneWithSetOperations(this.#props.queryNode,vi(`intersect`,t,!0))})}except(t){return new e({...this.#props,queryNode:L.cloneWithSetOperations(this.#props.queryNode,vi(`except`,t,!1))})}exceptAll(t){return new e({...this.#props,queryNode:L.cloneWithSetOperations(this.#props.queryNode,vi(`except`,t,!0))})}as(e){return new Di(this,e)}clearSelect(){return new e({...this.#props,queryNode:L.cloneWithoutSelections(this.#props.queryNode)})}clearWhere(){return new e({...this.#props,queryNode:W.cloneWithoutWhere(this.#props.queryNode)})}clearLimit(){return new e({...this.#props,queryNode:L.cloneWithoutLimit(this.#props.queryNode)})}clearOffset(){return new e({...this.#props,queryNode:L.cloneWithoutOffset(this.#props.queryNode)})}clearOrderBy(){return new e({...this.#props,queryNode:L.cloneWithoutOrderBy(this.#props.queryNode)})}clearGroupBy(){return new e({...this.#props,queryNode:L.cloneWithoutGroupBy(this.#props.queryNode)})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}$asTuple(){return new Y(this.toOperationNode())}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile();return(await this.#props.executor.executeQuery(e,this.#props.queryId)).rows}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=_r){let t=await this.executeTakeFirst();if(t===void 0)throw vr(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:W.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};R(Ti,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");function Ei(e){return new Ti(e)}var Di=class{#queryBuilder;#alias;constructor(e,t){this.#queryBuilder=e,this.#alias=t}get expression(){return this.#queryBuilder}get alias(){return this.#alias}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return Ht.create(this.#queryBuilder.toOperationNode(),S.create(this.#alias))}};R(Di,`don't await AliasedSelectQueryBuilder instances directly. AliasedSelectQueryBuilder should never be executed directly since it's always a part of another query.`);const Oi=y({is(e){return e.kind===`AggregateFunctionNode`},create(e,t=[]){return y({kind:`AggregateFunctionNode`,func:e,aggregated:t})},cloneWithDistinct(e){return y({...e,distinct:!0})},cloneWithOrderBy(e,t){return y({...e,orderBy:e.orderBy?Bn.cloneWithItems(e.orderBy,t):Bn.create(t)})},cloneWithFilter(e,t){return y({...e,filter:e.filter?H.cloneWithOperation(e.filter,`And`,t):H.create(t)})},cloneWithOrFilter(e,t){return y({...e,filter:e.filter?H.cloneWithOperation(e.filter,`Or`,t):H.create(t)})},cloneWithOver(e,t){return y({...e,over:t})}}),ki=y({is(e){return e.kind===`FunctionNode`},create(e,t){return y({kind:`FunctionNode`,func:e,arguments:t})}});var Ai=class e{#props;constructor(e){this.#props=y(e)}get expressionType(){}as(e){return new ji(this,e)}distinct(){return new e({...this.#props,aggregateFunctionNode:Oi.cloneWithDistinct(this.#props.aggregateFunctionNode)})}orderBy(t,n){return new e({...this.#props,aggregateFunctionNode:Oi.cloneWithOrderBy(this.#props.aggregateFunctionNode,un([t,n]))})}filterWhere(...t){return new e({...this.#props,aggregateFunctionNode:Oi.cloneWithFilter(this.#props.aggregateFunctionNode,F(t))})}filterWhereRef(t,n,r){return new e({...this.#props,aggregateFunctionNode:Oi.cloneWithFilter(this.#props.aggregateFunctionNode,I(t,n,r))})}over(t){let n=di();return new e({...this.#props,aggregateFunctionNode:Oi.cloneWithOver(this.#props.aggregateFunctionNode,(t?t(n):n).toOperationNode())})}$call(e){return e(this)}$castTo(){return new e(this.#props)}$notNull(){return new e(this.#props)}toOperationNode(){return this.#props.aggregateFunctionNode}};R(Ai,`don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.`);var ji=class{#aggregateFunctionBuilder;#alias;constructor(e,t){this.#aggregateFunctionBuilder=e,this.#alias=t}get expression(){return this.#aggregateFunctionBuilder}get alias(){return this.#alias}toOperationNode(){return Ht.create(this.#aggregateFunctionBuilder.toOperationNode(),S.create(this.#alias))}};function Mi(){let e=(e,t)=>new Y(ki.create(e,vn(t??[]))),t=(e,t)=>new Ai({aggregateFunctionNode:Oi.create(e,t?vn(t):void 0)});return Object.assign(e,{agg:t,avg(e){return t(`avg`,[e])},coalesce(...t){return e(`coalesce`,t)},count(e){return t(`count`,[e])},countAll(e){return new Ai({aggregateFunctionNode:Oi.create(`count`,B(e))})},max(e){return t(`max`,[e])},min(e){return t(`min`,[e])},sum(e){return t(`sum`,[e])},any(t){return e(`any`,[t])},jsonAgg(e){return new Ai({aggregateFunctionNode:Oi.create(`json_agg`,[g(e)?Z(e):e.toOperationNode()])})},toJson(e){return new Y(ki.create(`to_json`,[g(e)?Z(e):e.toOperationNode()]))}})}const Ni=y({is(e){return e.kind===`UnaryOperationNode`},create(e,t){return y({kind:`UnaryOperationNode`,operator:e,operand:t})}});function Pi(e,t){return Ni.create(O.create(e),j(t))}const X=y({is(e){return e.kind===`CaseNode`},create(e){return y({kind:`CaseNode`,value:e})},cloneWithWhen(e,t){return y({...e,when:y(e.when?[...e.when,t]:[t])})},cloneWithThen(e,t){return y({...e,when:e.when?y([...e.when.slice(0,-1),ur.cloneWithResult(e.when[e.when.length-1],t)]):void 0})},cloneWith(e,t){return y({...e,...t})}});var Fi=class{#props;constructor(e){this.#props=y(e)}when(...e){return new Ii({...this.#props,node:X.cloneWithWhen(this.#props.node,ur.create(F(e)))})}},Ii=class{#props;constructor(e){this.#props=y(e)}then(e){return new Li({...this.#props,node:X.cloneWithThen(this.#props.node,kn(e)?An(e):P(e))})}},Li=class{#props;constructor(e){this.#props=y(e)}when(...e){return new Ii({...this.#props,node:X.cloneWithWhen(this.#props.node,ur.create(F(e)))})}else(e){return new Ri({...this.#props,node:X.cloneWith(this.#props.node,{else:kn(e)?An(e):P(e)})})}end(){return new Y(X.cloneWith(this.#props.node,{isStatement:!1}))}endCase(){return new Y(X.cloneWith(this.#props.node,{isStatement:!0}))}},Ri=class{#props;constructor(e){this.#props=y(e)}end(){return new Y(X.cloneWith(this.#props.node,{isStatement:!1}))}endCase(){return new Y(X.cloneWith(this.#props.node,{isStatement:!0}))}};const zi=y({is(e){return e.kind===`JSONPathLegNode`},create(e,t){return y({kind:`JSONPathLegNode`,type:e,value:t})}});var Bi=class{#node;constructor(e){this.#node=e}at(e){return this.#createBuilderWithPathLeg(`ArrayLocation`,e)}key(e){return this.#createBuilderWithPathLeg(`Member`,e)}#createBuilderWithPathLeg(e,t){return mn.is(this.#node)?new Vi(mn.cloneWithTraversal(this.#node,gn.is(this.#node.traversal)?gn.cloneWithLeg(this.#node.traversal,zi.create(e,t)):hn.cloneWithValue(this.#node.traversal,N.createImmediate(t)))):new Vi(gn.cloneWithLeg(this.#node,zi.create(e,t)))}},Vi=class e extends Bi{#node;constructor(e){super(e),this.#node=e}get expressionType(){}as(e){return new Hi(this,e)}$castTo(){return new e(this.#node)}$notNull(){return new e(this.#node)}toOperationNode(){return this.#node}},Hi=class{#jsonPath;#alias;constructor(e,t){this.#jsonPath=e,this.#alias=t}get expression(){return this.#jsonPath}get alias(){return this.#alias}toOperationNode(){return Ht.create(this.#jsonPath.toOperationNode(),E(this.#alias)?this.#alias.toOperationNode():S.create(this.#alias))}};const Ui=y({is(e){return e.kind===`TupleNode`},create(e){return y({kind:`TupleNode`,values:y(e)})}}),Wi=`varchar.char.text.integer.int2.int4.int8.smallint.bigint.boolean.real.double precision.float4.float8.decimal.numeric.binary.bytea.date.datetime.time.timetz.timestamp.timestamptz.serial.bigserial.uuid.json.jsonb.blob.varbinary.int4range.int4multirange.int8range.int8multirange.numrange.nummultirange.tsrange.tsmultirange.tstzrange.tstzmultirange.daterange.datemultirange`.split(`.`),Gi=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timetz\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/,/^varbinary\(\d+\)$/],Ki=y({is(e){return e.kind===`DataTypeNode`},create(e){return y({kind:`DataTypeNode`,dataType:e})}});function qi(e){return!!(Wi.includes(e)||Gi.some(t=>t.test(e)))}function Ji(e){if(E(e))return e.toOperationNode();if(qi(e))return Ki.create(e);throw Error(`invalid column data type ${JSON.stringify(e)}`)}const Yi=y({is(e){return e.kind===`CastNode`},create(e,t){return y({kind:`CastNode`,expression:e,dataType:t})}});function Xi(e=ni){function t(e,t,n){return new Y(Nn(e,t,n))}function n(e,t){return new Y(Pi(e,t))}let r=Object.assign(t,{fn:void 0,eb:void 0,selectFrom(t){return Ei({queryId:K(),executor:e,queryNode:L.createFrom(ta(t))})},case(e){return new Fi({node:X.create(h(e)?void 0:j(e))})},ref(e,t){return h(t)?new Y(M(e)):new Bi(yn(e,t))},jsonPath(){return new Bi(gn.create())},table(e){return new Y(Z(e))},val(e){return new Y(P(e))},refTuple(...e){return new Y(Ui.create(e.map(j)))},tuple(...e){return new Y(Ui.create(e.map(P)))},lit(e){return new Y(An(e))},unary:n,not(e){return n(`not`,e)},exists(e){return n(`exists`,e)},neg(e){return n(`-`,e)},between(e,t,n){return new Y(Yt.create(j(e),O.create(`between`),Gt.create(P(t),P(n))))},betweenSymmetric(e,t,n){return new Y(Yt.create(j(e),O.create(`between symmetric`),Gt.create(P(t),P(n))))},and(e){return b(e)?new Y(Fn(e,`and`)):new Y(Pn(e,`and`))},or(e){return b(e)?new Y(Fn(e,`or`)):new Y(Pn(e,`or`))},parens(...e){let t=F(e);return Mn.is(t)?new Y(t):new Y(Mn.create(t))},cast(e,t){return new Y(Yi.create(j(e),Ji(t)))},withSchema(t){return Xi(e.withPluginAtFront(new Kr(t)))}});return r.fn=Mi(),r.eb=r,r}function Zi(e){return Xi()}function Qi(e){if(E(e))return e.toOperationNode();if(_(e))return e(Zi()).toOperationNode();throw Error(`invalid expression: ${JSON.stringify(e)}`)}function $i(e){if(E(e))return e.toOperationNode();if(_(e))return e(Zi()).toOperationNode();throw Error(`invalid aliased expression: ${JSON.stringify(e)}`)}function ea(e){return Ut(e)||Wt(e)||_(e)}function ta(e){return b(e)?e.map(e=>na(e)):[na(e)]}function na(e){return g(e)?ra(e):$i(e)}function ra(e){let t=` as `;if(e.includes(t)){let[n,r]=e.split(t).map(ia);return Ht.create(Z(n),S.create(r))}else return Z(e)}function Z(e){if(e.includes(`.`)){let[t,n]=e.split(`.`).map(ia);return T.createWithSchema(t,n)}else return T.create(e)}function ia(e){return e.trim()}const aa=y({is(e){return e.kind===`AddColumnNode`},create(e){return y({kind:`AddColumnNode`,column:e})}}),Q=y({is(e){return e.kind===`ColumnDefinitionNode`},create(e,t){return y({kind:`ColumnDefinitionNode`,column:k.create(e),dataType:t})},cloneWithFrontModifier(e,t){return y({...e,frontModifiers:e.frontModifiers?y([...e.frontModifiers,t]):[t]})},cloneWithEndModifier(e,t){return y({...e,endModifiers:e.endModifiers?y([...e.endModifiers,t]):[t]})},cloneWith(e,t){return y({...e,...t})}}),oa=y({is(e){return e.kind===`DropColumnNode`},create(e){return y({kind:`DropColumnNode`,column:k.create(e)})}}),sa=y({is(e){return e.kind===`RenameColumnNode`},create(e,t){return y({kind:`RenameColumnNode`,column:k.create(e),renameTo:k.create(t)})}}),ca=y({is(e){return e.kind===`CheckConstraintNode`},create(e,t){return y({kind:`CheckConstraintNode`,expression:e,name:t?S.create(t):void 0})}}),la=[`no action`,`restrict`,`cascade`,`set null`,`set default`],ua=y({is(e){return e.kind===`ReferencesNode`},create(e,t){return y({kind:`ReferencesNode`,table:e,columns:y([...t])})},cloneWithOnDelete(e,t){return y({...e,onDelete:t})},cloneWithOnUpdate(e,t){return y({...e,onUpdate:t})}});function da(e){return E(e)?e.toOperationNode():N.createImmediate(e)}const fa=y({is(e){return e.kind===`GeneratedNode`},create(e){return y({kind:`GeneratedNode`,...e})},createWithExpression(e){return y({kind:`GeneratedNode`,always:!0,expression:e})},cloneWith(e,t){return y({...e,...t})}}),pa=y({is(e){return e.kind===`DefaultValueNode`},create(e){return y({kind:`DefaultValueNode`,defaultValue:e})}});function ma(e){if(la.includes(e))return e;throw Error(`invalid OnModifyForeignAction ${e}`)}var ha=class e{#node;constructor(e){this.#node=e}autoIncrement(){return new e(Q.cloneWith(this.#node,{autoIncrement:!0}))}identity(){return new e(Q.cloneWith(this.#node,{identity:!0}))}primaryKey(){return new e(Q.cloneWith(this.#node,{primaryKey:!0}))}references(t){let n=M(t);if(!n.table||rn.is(n.column))throw Error(`invalid call references('${t}'). The reference must have format table.column or schema.table.column`);return new e(Q.cloneWith(this.#node,{references:ua.create(n.table,[n.column])}))}onDelete(t){if(!this.#node.references)throw Error(`on delete constraint can only be added for foreign keys`);return new e(Q.cloneWith(this.#node,{references:ua.cloneWithOnDelete(this.#node.references,ma(t))}))}onUpdate(t){if(!this.#node.references)throw Error(`on update constraint can only be added for foreign keys`);return new e(Q.cloneWith(this.#node,{references:ua.cloneWithOnUpdate(this.#node.references,ma(t))}))}unique(){return new e(Q.cloneWith(this.#node,{unique:!0}))}notNull(){return new e(Q.cloneWith(this.#node,{notNull:!0}))}unsigned(){return new e(Q.cloneWith(this.#node,{unsigned:!0}))}defaultTo(t){return new e(Q.cloneWith(this.#node,{defaultTo:pa.create(da(t))}))}check(t){return new e(Q.cloneWith(this.#node,{check:ca.create(t.toOperationNode())}))}generatedAlwaysAs(t){return new e(Q.cloneWith(this.#node,{generated:fa.createWithExpression(t.toOperationNode())}))}generatedAlwaysAsIdentity(){return new e(Q.cloneWith(this.#node,{generated:fa.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new e(Q.cloneWith(this.#node,{generated:fa.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#node.generated)throw Error(`stored() can only be called after generatedAlwaysAs`);return new e(Q.cloneWith(this.#node,{generated:fa.cloneWith(this.#node.generated,{stored:!0})}))}modifyFront(t){return new e(Q.cloneWithFrontModifier(this.#node,t.toOperationNode()))}nullsNotDistinct(){return new e(Q.cloneWith(this.#node,{nullsNotDistinct:!0}))}ifNotExists(){return new e(Q.cloneWith(this.#node,{ifNotExists:!0}))}modifyEnd(t){return new e(Q.cloneWithEndModifier(this.#node,t.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#node}};R(ha,`don't await ColumnDefinitionBuilder instances directly.`);const ga=y({is(e){return e.kind===`ModifyColumnNode`},create(e){return y({kind:`ModifyColumnNode`,column:e})}}),_a=y({is(e){return e.kind===`ForeignKeyConstraintNode`},create(e,t,n,r){return y({kind:`ForeignKeyConstraintNode`,columns:e,references:ua.create(t,n),name:r?S.create(r):void 0})},cloneWith(e,t){return y({...e,...t})}});var va=class e{#node;constructor(e){this.#node=e}onDelete(t){return new e(_a.cloneWith(this.#node,{onDelete:ma(t)}))}onUpdate(t){return new e(_a.cloneWith(this.#node,{onUpdate:ma(t)}))}$call(e){return e(this)}toOperationNode(){return this.#node}};R(va,`don't await ForeignKeyConstraintBuilder instances directly.`);const ya=y({is(e){return e.kind===`AddConstraintNode`},create(e){return y({kind:`AddConstraintNode`,constraint:e})}}),ba=y({is(e){return e.kind===`UniqueConstraintNode`},create(e,t,n){return y({kind:`UniqueConstraintNode`,columns:y(e.map(k.create)),name:t?S.create(t):void 0,nullsNotDistinct:n})},cloneWith(e,t){return y({...e,...t})}}),xa=y({is(e){return e.kind===`DropConstraintNode`},create(e){return y({kind:`DropConstraintNode`,constraintName:S.create(e)})},cloneWith(e,t){return y({...e,...t})}}),Sa=y({is(e){return e.kind===`AlterColumnNode`},create(e,t,n){return y({kind:`AlterColumnNode`,column:k.create(e),[t]:n})}});var Ca=class{#column;constructor(e){this.#column=e}setDataType(e){return new wa(Sa.create(this.#column,`dataType`,Ji(e)))}setDefault(e){return new wa(Sa.create(this.#column,`setDefault`,da(e)))}dropDefault(){return new wa(Sa.create(this.#column,`dropDefault`,!0))}setNotNull(){return new wa(Sa.create(this.#column,`setNotNull`,!0))}dropNotNull(){return new wa(Sa.create(this.#column,`dropNotNull`,!0))}$call(e){return e(this)}};R(Ca,`don't await AlterColumnBuilder instances`);var wa=class{#alterColumnNode;constructor(e){this.#alterColumnNode=e}toOperationNode(){return this.#alterColumnNode}};R(wa,`don't await AlteredColumnBuilder instances`);var Ta=class{#props;constructor(e){this.#props=y(e)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ta,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");var Ea=class e{#props;constructor(e){this.#props=y(e)}onDelete(t){return new e({...this.#props,constraintBuilder:this.#props.constraintBuilder.onDelete(t)})}onUpdate(t){return new e({...this.#props,constraintBuilder:this.#props.constraintBuilder.onUpdate(t)})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(x.cloneWithTableProps(this.#props.node,{addConstraint:ya.create(this.#props.constraintBuilder.toOperationNode())}),this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ea,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");var Da=class e{#props;constructor(e){this.#props=y(e)}ifExists(){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{dropConstraint:xa.cloneWith(this.#props.node.dropConstraint,{ifExists:!0})})})}cascade(){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{dropConstraint:xa.cloneWith(this.#props.node.dropConstraint,{modifier:`cascade`})})})}restrict(){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{dropConstraint:xa.cloneWith(this.#props.node.dropConstraint,{modifier:`restrict`})})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Da,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");const Oa=y({is(e){return e.kind===`PrimaryKeyConstraintNode`},create(e,t){return y({kind:`PrimaryKeyConstraintNode`,columns:y(e.map(k.create)),name:t?S.create(t):void 0})}}),ka=y({is(e){return e.kind===`AddIndexNode`},create(e){return y({kind:`AddIndexNode`,name:S.create(e)})},cloneWith(e,t){return y({...e,...t})},cloneWithColumns(e,t){return y({...e,columns:[...e.columns||[],...t]})}});var Aa=class e{#props;constructor(e){this.#props=y(e)}unique(){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addIndex:ka.cloneWith(this.#props.node.addIndex,{unique:!0})})})}column(t){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addIndex:ka.cloneWithColumns(this.#props.node.addIndex,[Sn(t)])})})}columns(t){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addIndex:ka.cloneWithColumns(this.#props.node.addIndex,t.map(Sn))})})}expression(t){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addIndex:ka.cloneWithColumns(this.#props.node.addIndex,[t.toOperationNode()])})})}using(t){return new e({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addIndex:ka.cloneWith(this.#props.node.addIndex,{using:A.createWithSql(t)})})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Aa,"don't await AlterTableAddIndexBuilder instances directly. To execute the query you need to call `execute`");var ja=class e{#node;constructor(e){this.#node=e}toOperationNode(){return this.#node}nullsNotDistinct(){return new e(ba.cloneWith(this.#node,{nullsNotDistinct:!0}))}};R(ja,`don't await UniqueConstraintNodeBuilder instances directly.`);var Ma=class{#props;constructor(e){this.#props=y(e)}renameTo(e){return new Ta({...this.#props,node:x.cloneWithTableProps(this.#props.node,{renameTo:Z(e)})})}setSchema(e){return new Ta({...this.#props,node:x.cloneWithTableProps(this.#props.node,{setSchema:S.create(e)})})}alterColumn(e,t){let n=t(new Ca(e));return new Na({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,n.toOperationNode())})}dropColumn(e){return new Na({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,oa.create(e))})}renameColumn(e,t){return new Na({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,sa.create(e,t))})}addColumn(e,t,n=Ft){let r=n(new ha(Q.create(e,Ji(t))));return new Na({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,aa.create(r.toOperationNode()))})}modifyColumn(e,t,n=Ft){let r=n(new ha(Q.create(e,Ji(t))));return new Na({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,ga.create(r.toOperationNode()))})}addUniqueConstraint(e,t,n=Ft){let r=n(new ja(ba.create(t,e)));return new Ta({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addConstraint:ya.create(r.toOperationNode())})})}addCheckConstraint(e,t){return new Ta({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addConstraint:ya.create(ca.create(t.toOperationNode(),e))})})}addForeignKeyConstraint(e,t,n,r){return new Ea({...this.#props,constraintBuilder:new va(_a.create(t.map(k.create),Z(n),r.map(k.create),e))})}addPrimaryKeyConstraint(e,t){return new Ta({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addConstraint:ya.create(Oa.create(t,e))})})}dropConstraint(e){return new Da({...this.#props,node:x.cloneWithTableProps(this.#props.node,{dropConstraint:xa.create(e)})})}addIndex(e){return new Aa({...this.#props,node:x.cloneWithTableProps(this.#props.node,{addIndex:ka.create(e)})})}dropIndex(e){return new Ta({...this.#props,node:x.cloneWithTableProps(this.#props.node,{dropIndex:zt.create(e)})})}$call(e){return e(this)}};R(Ma,`don't await AlterTableBuilder instances`);var Na=class e{#props;constructor(e){this.#props=y(e)}alterColumn(t,n){let r=n(new Ca(t));return new e({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,r.toOperationNode())})}dropColumn(t){return new e({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,oa.create(t))})}renameColumn(t,n){return new e({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,sa.create(t,n))})}addColumn(t,n,r=Ft){let i=r(new ha(Q.create(t,Ji(n))));return new e({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,aa.create(i.toOperationNode()))})}modifyColumn(t,n,r=Ft){let i=r(new ha(Q.create(t,Ji(n))));return new e({...this.#props,node:x.cloneWithColumnAlteration(this.#props.node,ga.create(i.toOperationNode()))})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Na,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");var Pa=class extends Hr{transformValue(e){return{...super.transformValue(e),immediate:!0}}},Fa=class e{#props;constructor(e){this.#props=y(e)}ifNotExists(){return new e({...this.#props,node:C.cloneWith(this.#props.node,{ifNotExists:!0})})}unique(){return new e({...this.#props,node:C.cloneWith(this.#props.node,{unique:!0})})}nullsNotDistinct(){return new e({...this.#props,node:C.cloneWith(this.#props.node,{nullsNotDistinct:!0})})}on(t){return new e({...this.#props,node:C.cloneWith(this.#props.node,{table:Z(t)})})}column(t){return new e({...this.#props,node:C.cloneWithColumns(this.#props.node,[Sn(t)])})}columns(t){return new e({...this.#props,node:C.cloneWithColumns(this.#props.node,t.map(Sn))})}expression(t){return new e({...this.#props,node:C.cloneWithColumns(this.#props.node,[t.toOperationNode()])})}using(t){return new e({...this.#props,node:C.cloneWith(this.#props.node,{using:A.createWithSql(t)})})}where(...t){let n=new Pa;return new e({...this.#props,node:W.cloneWithWhere(this.#props.node,n.transformNode(F(t)))})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Fa,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");var Ia=class e{#props;constructor(e){this.#props=y(e)}ifNotExists(){return new e({...this.#props,node:It.cloneWith(this.#props.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ia,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");function La(e){if(Lt.includes(e))return e;throw Error(`invalid OnCommitAction ${e}`)}var Ra=class e{#props;constructor(e){this.#props=y(e)}temporary(){return new e({...this.#props,node:w.cloneWith(this.#props.node,{temporary:!0})})}onCommit(t){return new e({...this.#props,node:w.cloneWith(this.#props.node,{onCommit:La(t)})})}ifNotExists(){return new e({...this.#props,node:w.cloneWith(this.#props.node,{ifNotExists:!0})})}addColumn(t,n,r=Ft){let i=r(new ha(Q.create(t,Ji(n))));return new e({...this.#props,node:w.cloneWithColumn(this.#props.node,i.toOperationNode())})}addPrimaryKeyConstraint(t,n){return new e({...this.#props,node:w.cloneWithConstraint(this.#props.node,Oa.create(n,t))})}addUniqueConstraint(t,n,r=Ft){let i=r(new ja(ba.create(n,t)));return new e({...this.#props,node:w.cloneWithConstraint(this.#props.node,i.toOperationNode())})}addCheckConstraint(t,n){return new e({...this.#props,node:w.cloneWithConstraint(this.#props.node,ca.create(n.toOperationNode(),t))})}addForeignKeyConstraint(t,n,r,i,a=Ft){let o=a(new va(_a.create(n.map(k.create),Z(r),i.map(k.create),t)));return new e({...this.#props,node:w.cloneWithConstraint(this.#props.node,o.toOperationNode())})}modifyFront(t){return new e({...this.#props,node:w.cloneWithFrontModifier(this.#props.node,t.toOperationNode())})}modifyEnd(t){return new e({...this.#props,node:w.cloneWithEndModifier(this.#props.node,t.toOperationNode())})}as(t){return new e({...this.#props,node:w.cloneWith(this.#props.node,{selectQuery:Qi(t)})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ra,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");var za=class e{#props;constructor(e){this.#props=y(e)}on(t){return new e({...this.#props,node:zt.cloneWith(this.#props.node,{table:Z(t)})})}ifExists(){return new e({...this.#props,node:zt.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:zt.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(za,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");var Ba=class e{#props;constructor(e){this.#props=y(e)}ifExists(){return new e({...this.#props,node:Bt.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:Bt.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ba,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");var Va=class e{#props;constructor(e){this.#props=y(e)}ifExists(){return new e({...this.#props,node:Vt.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:Vt.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Va,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const Ha=y({is(e){return e.kind===`CreateViewNode`},create(e){return y({kind:`CreateViewNode`,name:Rt.create(e)})},cloneWith(e,t){return y({...e,...t})}});var Ua=class{#transformer=new Pa;transformQuery(e){return this.#transformer.transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}},Wa=class e{#props;constructor(e){this.#props=y(e)}temporary(){return new e({...this.#props,node:Ha.cloneWith(this.#props.node,{temporary:!0})})}materialized(){return new e({...this.#props,node:Ha.cloneWith(this.#props.node,{materialized:!0})})}ifNotExists(){return new e({...this.#props,node:Ha.cloneWith(this.#props.node,{ifNotExists:!0})})}orReplace(){return new e({...this.#props,node:Ha.cloneWith(this.#props.node,{orReplace:!0})})}columns(t){return new e({...this.#props,node:Ha.cloneWith(this.#props.node,{columns:t.map(xn)})})}as(t){let n=t.withPlugin(new Ua).toOperationNode();return new e({...this.#props,node:Ha.cloneWith(this.#props.node,{as:n})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Wa,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const Ga=y({is(e){return e.kind===`DropViewNode`},create(e){return y({kind:`DropViewNode`,name:Rt.create(e)})},cloneWith(e,t){return y({...e,...t})}});var Ka=class e{#props;constructor(e){this.#props=y(e)}materialized(){return new e({...this.#props,node:Ga.cloneWith(this.#props.node,{materialized:!0})})}ifExists(){return new e({...this.#props,node:Ga.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:Ga.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ka,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const qa=y({is(e){return e.kind===`CreateTypeNode`},create(e){return y({kind:`CreateTypeNode`,name:e})},cloneWithEnum(e,t){return y({...e,enum:Dn.create(t.map(e=>N.createImmediate(e)))})}});var Ja=class e{#props;constructor(e){this.#props=y(e)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}asEnum(t){return new e({...this.#props,node:qa.cloneWithEnum(this.#props.node,t)})}$call(e){return e(this)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Ja,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const Ya=y({is(e){return e.kind===`DropTypeNode`},create(e){return y({kind:`DropTypeNode`,name:e})},cloneWith(e,t){return y({...e,...t})}});var Xa=class e{#props;constructor(e){this.#props=y(e)}ifExists(){return new e({...this.#props,node:Ya.cloneWith(this.#props.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};R(Xa,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function Za(e){if(e.includes(`.`)){let t=e.split(`.`).map(Qa);if(t.length===2)return Rt.createWithSchema(t[0],t[1]);throw Error(`invalid schemable identifier ${e}`)}else return Rt.create(e)}function Qa(e){return e.trim()}var $a=class e{#executor;constructor(e){this.#executor=e}createTable(e){return new Ra({queryId:K(),executor:this.#executor,node:w.create(Z(e))})}dropTable(e){return new Va({queryId:K(),executor:this.#executor,node:Vt.create(Z(e))})}createIndex(e){return new Fa({queryId:K(),executor:this.#executor,node:C.create(e)})}dropIndex(e){return new za({queryId:K(),executor:this.#executor,node:zt.create(e)})}createSchema(e){return new Ia({queryId:K(),executor:this.#executor,node:It.create(e)})}dropSchema(e){return new Ba({queryId:K(),executor:this.#executor,node:Bt.create(e)})}alterTable(e){return new Ma({queryId:K(),executor:this.#executor,node:x.create(Z(e))})}createView(e){return new Wa({queryId:K(),executor:this.#executor,node:Ha.create(e)})}dropView(e){return new Ka({queryId:K(),executor:this.#executor,node:Ga.create(e)})}createType(e){return new Ja({queryId:K(),executor:this.#executor,node:qa.create(Za(e))})}dropType(e){return new Xa({queryId:K(),executor:this.#executor,node:Ya.create(Za(e))})}withPlugin(t){return new e(this.#executor.withPlugin(t))}withoutPlugins(){return new e(this.#executor.withoutPlugins())}withSchema(t){return new e(this.#executor.withPluginAtFront(new Kr(t)))}},eo=class{ref(e){return new on(e)}},to=class{#driver;constructor(e){this.#driver=e}async provideConnection(e){let t=await this.#driver.acquireConnection();try{return await e(t)}finally{await this.#driver.releaseConnection(t)}}},no=class e extends ei{#compiler;#adapter;#connectionProvider;constructor(e,t,n,r=[]){super(r),this.#compiler=e,this.#adapter=t,this.#connectionProvider=n}get adapter(){return this.#adapter}compileQuery(e){return this.#compiler.compileQuery(e)}provideConnection(e){return this.#connectionProvider.provideConnection(e)}withPlugins(t){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[...this.plugins,...t])}withPlugin(t){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[...this.plugins,t])}withPluginAtFront(t){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[t,...this.plugins])}withConnectionProvider(t){return new e(this.#compiler,this.#adapter,t,[...this.plugins])}withoutPlugins(){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[])}};function ro(){return typeof performance<`u`&&_(performance.now)?performance.now():Date.now()}var io=class{#driver;#log;#initPromise;#initDone;#destroyPromise;#connections=new WeakSet;constructor(e,t){this.#initDone=!1,this.#driver=e,this.#log=t}async init(){if(this.#destroyPromise)throw Error(`driver has already been destroyed`);this.#initPromise||=this.#driver.init().then(()=>{this.#initDone=!0}).catch(e=>(this.#initPromise=void 0,Promise.reject(e))),await this.#initPromise}async acquireConnection(){if(this.#destroyPromise)throw Error(`driver has already been destroyed`);this.#initDone||await this.init();let e=await this.#driver.acquireConnection();return this.#connections.has(e)||(this.#needsLogging()&&this.#addLogging(e),this.#connections.add(e)),e}async releaseConnection(e){await this.#driver.releaseConnection(e)}beginTransaction(e,t){return this.#driver.beginTransaction(e,t)}commitTransaction(e){return this.#driver.commitTransaction(e)}rollbackTransaction(e){return this.#driver.rollbackTransaction(e)}async destroy(){this.#initPromise&&(await this.#initPromise,this.#destroyPromise||=this.#driver.destroy().catch(e=>(this.#destroyPromise=void 0,Promise.reject(e))),await this.#destroyPromise)}#needsLogging(){return this.#log.isLevelEnabled(`query`)||this.#log.isLevelEnabled(`error`)}#addLogging(e){let t=e.executeQuery;e.executeQuery=async n=>{let r,i=ro();try{return await t.call(e,n)}catch(e){throw r=e,await this.#logError(e,n,i),e}finally{r||await this.#logQuery(n,i)}}}async#logError(e,t,n){await this.#log.error(()=>({level:`error`,error:e,query:t,queryDurationMillis:this.#calculateDurationMillis(n)}))}async#logQuery(e,t){await this.#log.query(()=>({level:`query`,query:e,queryDurationMillis:this.#calculateDurationMillis(t)}))}#calculateDurationMillis(e){return ro()-e}};const ao=()=>{};var oo=class{#connection;#runningPromise;constructor(e){this.#connection=e}async provideConnection(e){for(;this.#runningPromise;)await this.#runningPromise.catch(ao);return this.#runningPromise=this.#run(e).finally(()=>{this.#runningPromise=void 0}),this.#runningPromise}async#run(e){return await e(this.#connection)}};const so=[`read uncommitted`,`read committed`,`repeatable read`,`serializable`,`snapshot`];y([`query`,`error`]);var co=class{#levels;#logger;constructor(e){_(e)?(this.#logger=e,this.#levels=y({query:!0,error:!0})):(this.#logger=lo,this.#levels=y({query:e.includes(`query`),error:e.includes(`error`)}))}isLevelEnabled(e){return this.#levels[e]}async query(e){this.#levels.query&&await this.#logger(e())}async error(e){this.#levels.error&&await this.#logger(e())}};function lo(e){e.level===`query`?(console.log(`kysely:query: ${e.query.sql}`),console.log(`kysely:query: duration: ${e.queryDurationMillis.toFixed(1)}ms`)):e.level===`error`&&(e.error instanceof Error?console.error(`kysely:error: ${e.error.stack??e.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:e.error,query:e.query.sql,queryDurationMillis:e.queryDurationMillis})}`))}function uo(e){return v(e)&&_(e.compile)}var fo=class e extends ci{#props;constructor(e){let t,n;if(mo(e))t={executor:e.executor},n={...e};else{let r=e.dialect,i=r.createDriver(),a=r.createQueryCompiler(),o=r.createAdapter(),s=new co(e.log??[]),c=new io(i,s),l=new to(c),ee=new no(a,o,l,e.plugins??[]);t={executor:ee},n={config:e,executor:ee,dialect:r,driver:c}}super(t),this.#props=y(n)}get schema(){return new $a(this.#props.executor)}get dynamic(){return new eo}get introspection(){return this.#props.dialect.createIntrospector(this.withoutPlugins())}case(e){return new Fi({node:X.create(h(e)?void 0:Qi(e))})}get fn(){return Mi()}transaction(){return new go({...this.#props})}connection(){return new ho({...this.#props})}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}withoutPlugins(){return new e({...this.#props,executor:this.#props.executor.withoutPlugins()})}withSchema(t){return new e({...this.#props,executor:this.#props.executor.withPluginAtFront(new Kr(t))})}withTables(){return new e({...this.#props})}async destroy(){await this.#props.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#props.executor}executeQuery(e,t=K()){let n=uo(e)?e.compile():e;return this.getExecutor().executeQuery(n,t)}},po=class e extends fo{#props;constructor(e){super(e),this.#props=e}get isTransaction(){return!0}transaction(){throw Error(`calling the transaction method for a Transaction is not supported`)}connection(){throw Error(`calling the connection method for a Transaction is not supported`)}async destroy(){throw Error(`calling the destroy method for a Transaction is not supported`)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}withoutPlugins(){return new e({...this.#props,executor:this.#props.executor.withoutPlugins()})}withSchema(t){return new e({...this.#props,executor:this.#props.executor.withPluginAtFront(new Kr(t))})}withTables(){return new e({...this.#props})}};function mo(e){return v(e)&&v(e.config)&&v(e.driver)&&v(e.executor)&&v(e.dialect)}var ho=class{#props;constructor(e){this.#props=y(e)}async execute(e){return this.#props.executor.provideConnection(async t=>{let n=this.#props.executor.withConnectionProvider(new oo(t)),r=new fo({...this.#props,executor:n});return await e(r)})}};R(ho,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");var go=class e{#props;constructor(e){this.#props=y(e)}setIsolationLevel(t){return new e({...this.#props,isolationLevel:t})}async execute(e){let{isolationLevel:t,...n}=this.#props,r={isolationLevel:t};return _o(r),this.#props.executor.provideConnection(async t=>{let i=this.#props.executor.withConnectionProvider(new oo(t)),a=new po({...n,executor:i});try{await this.#props.driver.beginTransaction(t,r);let n=await e(a);return await this.#props.driver.commitTransaction(t),n}catch(e){throw await this.#props.driver.rollbackTransaction(t),e}})}};R(go,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function _o(e){if(e.isolationLevel&&!so.includes(e.isolationLevel))throw Error(`invalid transaction isolation level ${e.isolationLevel}`)}var vo=class e{#props;constructor(e){this.#props=y(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new yo(this,e)}$castTo(){return new e({...this.#props})}$notNull(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,plugins:this.#props.plugins===void 0?y([t]):y([...this.#props.plugins,t])})}toOperationNode(){return this.#toOperationNode(this.#getExecutor())}compile(e){return this.#compile(this.#getExecutor(e))}async execute(e){let t=this.#getExecutor(e);return t.executeQuery(this.#compile(t),this.#props.queryId)}#getExecutor(e){let t=e===void 0?ni:e.getExecutor();return this.#props.plugins===void 0?t:t.withPlugins(this.#props.plugins)}#toOperationNode(e){return e.transformQuery(this.#props.rawNode,this.#props.queryId)}#compile(e){return e.compileQuery(this.#toOperationNode(e),this.#props.queryId)}};function $(e){return new vo(e)}R(vo,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");var yo=class{#rawBuilder;#alias;constructor(e,t){this.#rawBuilder=e,this.#alias=t}get expression(){return this.#rawBuilder}get alias(){return this.#alias}get rawBuilder(){return this.#rawBuilder}toOperationNode(){return Ht.create(this.#rawBuilder.toOperationNode(),E(this.#alias)?this.#alias.toOperationNode():S.create(this.#alias))}};R(yo,`don't await AliasedRawBuilder instances directly. AliasedRawBuilder should never be executed directly since it's always a part of another query.`);const bo=Object.assign((e,...t)=>$({queryId:K(),rawNode:A.create(e,t?.map(xo)??[])}),{ref(e){return $({queryId:K(),rawNode:A.createWithChild(M(e))})},val(e){return $({queryId:K(),rawNode:A.createWithChild(P(e))})},value(e){return this.val(e)},table(e){return $({queryId:K(),rawNode:A.createWithChild(Z(e))})},id(...e){let t=Array(e.length+1).fill(`.`);return t[0]=``,t[t.length-1]=``,$({queryId:K(),rawNode:A.create(t,e.map(S.create))})},lit(e){return $({queryId:K(),rawNode:A.createWithChild(N.createImmediate(e))})},literal(e){return this.lit(e)},raw(e){return $({queryId:K(),rawNode:A.createWithSql(e)})},join(e,t=bo`, `){let n=Array(2*e.length-1),r=t.toOperationNode();for(let t=0;t<e.length;++t)n[2*t]=xo(e[t]),t!==e.length-1&&(n[2*t+1]=r);return $({queryId:K(),rawNode:A.createWithChildren(n)})}});function xo(e){return E(e)?e.toOperationNode():P(e)}var So=class{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#visitors=y({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#visitors[e.kind](e),this.nodeStack.pop()}},Co=class extends So{#sql=``;#parameters=[];get numParameters(){return this.#parameters.length}compileQuery(e){return this.#sql=``,this.#parameters=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(e),y({query:e,sql:this.getSql(),parameters:[...this.#parameters]})}getSql(){return this.#sql}visitSelectQuery(e){let t=this.parentNode!==void 0&&!Mn.is(this.parentNode)&&!V.is(this.parentNode)&&!w.is(this.parentNode)&&!Ha.is(this.parentNode)&&!_i.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(` `)),t&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`select`),e.distinctOn&&(this.append(` `),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(` `),this.compileList(e.frontModifiers,` `)),e.top&&(this.append(` `),this.visitNode(e.top)),e.selections&&(this.append(` `),this.compileList(e.selections)),e.from&&(this.append(` `),this.visitNode(e.from)),e.joins&&(this.append(` `),this.compileList(e.joins,` `)),e.where&&(this.append(` `),this.visitNode(e.where)),e.groupBy&&(this.append(` `),this.visitNode(e.groupBy)),e.having&&(this.append(` `),this.visitNode(e.having)),e.setOperations&&(this.append(` `),this.compileList(e.setOperations,` `)),e.orderBy&&(this.append(` `),this.visitNode(e.orderBy)),e.limit&&(this.append(` `),this.visitNode(e.limit)),e.offset&&(this.append(` `),this.visitNode(e.offset)),e.fetch&&(this.append(` `),this.visitNode(e.fetch)),e.endModifiers?.length&&(this.append(` `),this.compileList(this.sortSelectModifiers([...e.endModifiers]),` `)),t&&this.append(`)`)}visitFrom(e){this.append(`from `),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append(`distinct on (`),this.compileList(e),this.append(`)`)}compileList(e,t=`, `){let n=e.length-1;for(let r=0;r<=n;r++)this.visitNode(e[r]),r<n&&this.append(t)}visitWhere(e){this.append(`where `),this.visitNode(e.where)}visitHaving(e){this.append(`having `),this.visitNode(e.having)}visitInsertQuery(e){let t=this.nodeStack.find(W.is),n=t!==e;!n&&e.explain&&(this.visitNode(e.explain),this.append(` `)),n&&!U.is(t)&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(e.replace?`replace`:`insert`),e.ignore&&this.append(` ignore`),e.top&&(this.append(` `),this.visitNode(e.top)),e.into&&(this.append(` into `),this.visitNode(e.into)),e.columns&&(this.append(` (`),this.compileList(e.columns),this.append(`)`)),e.output&&(this.append(` `),this.visitNode(e.output)),e.values&&(this.append(` `),this.visitNode(e.values)),e.defaultValues&&(this.append(` `),this.append(`default values`)),e.onConflict&&(this.append(` `),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(` `),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(` `),this.visitNode(e.returning)),n&&!U.is(t)&&this.append(`)`),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitValues(e){this.append(`values `),this.compileList(e.values)}visitDeleteQuery(e){let t=this.nodeStack.find(W.is)!==e;!t&&e.explain&&(this.visitNode(e.explain),this.append(` `)),t&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`delete `),e.top&&(this.visitNode(e.top),this.append(` `)),this.visitNode(e.from),e.output&&(this.append(` `),this.visitNode(e.output)),e.using&&(this.append(` `),this.visitNode(e.using)),e.joins&&(this.append(` `),this.compileList(e.joins,` `)),e.where&&(this.append(` `),this.visitNode(e.where)),e.orderBy&&(this.append(` `),this.visitNode(e.orderBy)),e.limit&&(this.append(` `),this.visitNode(e.limit)),e.returning&&(this.append(` `),this.visitNode(e.returning)),t&&this.append(`)`),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitReturning(e){this.append(`returning `),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(` as `),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(`.`)),this.visitNode(e.column)}visitSelectAll(e){this.append(`*`)}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!g(e.name))throw Error(`a non-string identifier was passed to compileUnwrappedIdentifier.`);this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(` and `),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(` or `),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append(`(`),this.compileList(e.values),this.append(`)`)}visitTuple(e){this.append(`(`),this.compileList(e.values),this.append(`)`)}visitPrimitiveValueList(e){this.append(`(`);let{values:t}=e;for(let e=0;e<t.length;++e)this.appendValue(t[e]),e!==t.length-1&&this.append(`, `);this.append(`)`)}visitParens(e){this.append(`(`),this.visitNode(e.node),this.append(`)`)}visitJoin(e){this.append(Eo[e.joinType]),this.append(` `),this.visitNode(e.table),e.on&&(this.append(` `),this.visitNode(e.on))}visitOn(e){this.append(`on `),this.visitNode(e.on)}visitRaw(e){let{sqlFragments:t,parameters:n}=e;for(let e=0;e<t.length;++e)this.append(t[e]),n.length>e&&this.visitNode(n[e])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(`.`)),this.visitNode(e.identifier)}visitCreateTable(e){this.append(`create `),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers,` `),this.append(` `)),e.temporary&&this.append(`temporary `),this.append(`table `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.table),e.selectQuery?(this.append(` as `),this.visitNode(e.selectQuery)):(this.append(` (`),this.compileList([...e.columns,...e.constraints??[]]),this.append(`)`),e.onCommit&&(this.append(` on commit `),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(` `),this.compileList(e.endModifiers,` `)))}visitColumnDefinition(e){e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.column),this.append(` `),this.visitNode(e.dataType),e.unsigned&&this.append(` unsigned`),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(` `),this.compileList(e.frontModifiers,` `)),e.generated&&(this.append(` `),this.visitNode(e.generated)),e.identity&&this.append(` identity`),e.defaultTo&&(this.append(` `),this.visitNode(e.defaultTo)),e.notNull&&this.append(` not null`),e.unique&&this.append(` unique`),e.nullsNotDistinct&&this.append(` nulls not distinct`),e.primaryKey&&this.append(` primary key`),e.autoIncrement&&(this.append(` `),this.append(this.getAutoIncrement())),e.references&&(this.append(` `),this.visitNode(e.references)),e.check&&(this.append(` `),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(` `),this.compileList(e.endModifiers,` `))}getAutoIncrement(){return`auto_increment`}visitReferences(e){this.append(`references `),this.visitNode(e.table),this.append(` (`),this.compileList(e.columns),this.append(`)`),e.onDelete&&(this.append(` on delete `),this.append(e.onDelete)),e.onUpdate&&(this.append(` on update `),this.append(e.onUpdate))}visitDropTable(e){this.append(`drop table `),e.ifExists&&this.append(`if exists `),this.visitNode(e.table),e.cascade&&this.append(` cascade`)}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append(`order by `),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.direction&&(this.append(` `),this.visitNode(e.direction))}visitGroupBy(e){this.append(`group by `),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){let t=this.nodeStack.find(W.is),n=t!==e;!n&&e.explain&&(this.visitNode(e.explain),this.append(` `)),n&&!U.is(t)&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`update `),e.top&&(this.visitNode(e.top),this.append(` `)),e.table&&(this.visitNode(e.table),this.append(` `)),this.append(`set `),e.updates&&this.compileList(e.updates),e.output&&(this.append(` `),this.visitNode(e.output)),e.from&&(this.append(` `),this.visitNode(e.from)),e.joins&&(this.append(` `),this.compileList(e.joins,` `)),e.where&&(this.append(` `),this.visitNode(e.where)),e.limit&&(this.append(` `),this.visitNode(e.limit)),e.returning&&(this.append(` `),this.visitNode(e.returning)),n&&!U.is(t)&&this.append(`)`),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitColumnUpdate(e){this.visitNode(e.column),this.append(` = `),this.visitNode(e.value)}visitLimit(e){this.append(`limit `),this.visitNode(e.limit)}visitOffset(e){this.append(`offset `),this.visitNode(e.offset)}visitOnConflict(e){this.append(`on conflict`),e.columns?(this.append(` (`),this.compileList(e.columns),this.append(`)`)):e.constraint?(this.append(` on constraint `),this.visitNode(e.constraint)):e.indexExpression&&(this.append(` (`),this.visitNode(e.indexExpression),this.append(`)`)),e.indexWhere&&(this.append(` `),this.visitNode(e.indexWhere)),e.doNothing===!0?this.append(` do nothing`):e.updates&&(this.append(` do update set `),this.compileList(e.updates),e.updateWhere&&(this.append(` `),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append(`on duplicate key update `),this.compileList(e.updates)}visitCreateIndex(e){this.append(`create `),e.unique&&this.append(`unique `),this.append(`index `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.name),e.table&&(this.append(` on `),this.visitNode(e.table)),e.using&&(this.append(` using `),this.visitNode(e.using)),e.columns&&(this.append(` (`),this.compileList(e.columns),this.append(`)`)),e.nullsNotDistinct&&this.append(` nulls not distinct`),e.where&&(this.append(` `),this.visitNode(e.where))}visitDropIndex(e){this.append(`drop index `),e.ifExists&&this.append(`if exists `),this.visitNode(e.name),e.table&&(this.append(` on `),this.visitNode(e.table)),e.cascade&&this.append(` cascade`)}visitCreateSchema(e){this.append(`create schema `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.schema)}visitDropSchema(e){this.append(`drop schema `),e.ifExists&&this.append(`if exists `),this.visitNode(e.schema),e.cascade&&this.append(` cascade`)}visitPrimaryKeyConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`primary key (`),this.compileList(e.columns),this.append(`)`)}visitUniqueConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`unique`),e.nullsNotDistinct&&this.append(` nulls not distinct`),this.append(` (`),this.compileList(e.columns),this.append(`)`)}visitCheckConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`check (`),this.visitNode(e.expression),this.append(`)`)}visitForeignKeyConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`foreign key (`),this.compileList(e.columns),this.append(`) `),this.visitNode(e.references),e.onDelete&&(this.append(` on delete `),this.append(e.onDelete)),e.onUpdate&&(this.append(` on update `),this.append(e.onUpdate))}visitList(e){this.compileList(e.items)}visitWith(e){this.append(`with `),e.recursive&&this.append(`recursive `),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(` as `),At(e.materialized)&&(e.materialized||this.append(`not `),this.append(`materialized `)),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append(`(`),this.compileList(e.columns),this.append(`)`))}visitAlterTable(e){this.append(`alter table `),this.visitNode(e.table),this.append(` `),e.renameTo&&(this.append(`rename to `),this.visitNode(e.renameTo)),e.setSchema&&(this.append(`set schema `),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append(`add column `),this.visitNode(e.column)}visitRenameColumn(e){this.append(`rename column `),this.visitNode(e.column),this.append(` to `),this.visitNode(e.renameTo)}visitDropColumn(e){this.append(`drop column `),this.visitNode(e.column)}visitAlterColumn(e){this.append(`alter column `),this.visitNode(e.column),this.append(` `),e.dataType&&(this.announcesNewColumnDataType()&&this.append(`type `),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append(`using `),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append(`set default `),this.visitNode(e.setDefault)),e.dropDefault&&this.append(`drop default`),e.setNotNull&&this.append(`set not null`),e.dropNotNull&&this.append(`drop not null`)}visitModifyColumn(e){this.append(`modify column `),this.visitNode(e.column)}visitAddConstraint(e){this.append(`add `),this.visitNode(e.constraint)}visitDropConstraint(e){this.append(`drop constraint `),e.ifExists&&this.append(`if exists `),this.visitNode(e.constraintName),e.modifier===`cascade`?this.append(` cascade`):e.modifier===`restrict`&&this.append(` restrict`)}visitSetOperation(e){this.append(e.operator),this.append(` `),e.all&&this.append(`all `),this.visitNode(e.expression)}visitCreateView(e){this.append(`create `),e.orReplace&&this.append(`or replace `),e.materialized&&this.append(`materialized `),e.temporary&&this.append(`temporary `),this.append(`view `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.name),this.append(` `),e.columns&&(this.append(`(`),this.compileList(e.columns),this.append(`) `)),e.as&&(this.append(`as `),this.visitNode(e.as))}visitDropView(e){this.append(`drop `),e.materialized&&this.append(`materialized `),this.append(`view `),e.ifExists&&this.append(`if exists `),this.visitNode(e.name),e.cascade&&this.append(` cascade`)}visitGenerated(e){this.append(`generated `),e.always&&this.append(`always `),e.byDefault&&this.append(`by default `),this.append(`as `),e.identity&&this.append(`identity`),e.expression&&(this.append(`(`),this.visitNode(e.expression),this.append(`)`)),e.stored&&this.append(` stored`)}visitDefaultValue(e){this.append(`default `),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(wo[e.modifier]),e.of&&(this.append(` of `),this.compileList(e.of,`, `))}visitCreateType(e){this.append(`create type `),this.visitNode(e.name),e.enum&&(this.append(` as enum `),this.visitNode(e.enum))}visitDropType(e){this.append(`drop type `),e.ifExists&&this.append(`if exists `),this.visitNode(e.name)}visitExplain(e){this.append(`explain`),(e.options||e.format)&&(this.append(` `),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append(`format`),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append(`default`)}visitAggregateFunction(e){this.append(e.func),this.append(`(`),e.distinct&&this.append(`distinct `),this.compileList(e.aggregated),e.orderBy&&(this.append(` `),this.visitNode(e.orderBy)),this.append(`)`),e.filter&&(this.append(` filter(`),this.visitNode(e.filter),this.append(`)`)),e.over&&(this.append(` `),this.visitNode(e.over))}visitOver(e){this.append(`over(`),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(` `)),e.orderBy&&this.visitNode(e.orderBy),this.append(`)`)}visitPartitionBy(e){this.append(`partition by `),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(` `),this.visitNode(e.operator),this.append(` `),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(` `),this.visitNode(e.operand)}isMinusOperator(e){return O.is(e)&&e.operator===`-`}visitUsing(e){this.append(`using `),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append(`(`),this.compileList(e.arguments),this.append(`)`)}visitCase(e){this.append(`case`),e.value&&(this.append(` `),this.visitNode(e.value)),e.when&&(this.append(` `),this.compileList(e.when,` `)),e.else&&(this.append(` else `),this.visitNode(e.else)),this.append(` end`),e.isStatement&&this.append(` case`)}visitWhen(e){this.append(`when `),this.visitNode(e.condition),e.result&&(this.append(` then `),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append(`'$`);for(let t of e.pathLegs)this.visitNode(t);this.append(`'`)}visitJSONPathLeg(e){let t=e.type===`ArrayLocation`;this.append(t?`[`:`.`),this.append(String(e.value)),t&&this.append(`]`)}visitJSONOperatorChain(e){for(let t=0,n=e.values.length;t<n;t++)t===n-1?this.visitNode(e.operator):this.append(`->`),this.visitNode(e.values[t])}visitMergeQuery(e){e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`merge `),e.top&&(this.visitNode(e.top),this.append(` `)),this.append(`into `),this.visitNode(e.into),e.using&&(this.append(` `),this.visitNode(e.using)),e.whens&&(this.append(` `),this.compileList(e.whens,` `)),e.output&&(this.append(` `),this.visitNode(e.output)),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitMatched(e){e.not&&this.append(`not `),this.append(`matched`),e.bySource&&this.append(` by source`)}visitAddIndex(e){this.append(`add `),e.unique&&this.append(`unique `),this.append(`index `),this.visitNode(e.name),e.columns&&(this.append(` (`),this.compileList(e.columns),this.append(`)`)),e.using&&(this.append(` using `),this.visitNode(e.using))}visitCast(e){this.append(`cast(`),this.visitNode(e.expression),this.append(` as `),this.visitNode(e.dataType),this.append(`)`)}visitFetch(e){this.append(`fetch next `),this.visitNode(e.rowCount),this.append(` rows ${e.modifier}`)}visitOutput(e){this.append(`output `),this.compileList(e.selections)}visitTop(e){this.append(`top(${e.expression})`),e.modifiers&&this.append(` ${e.modifiers}`)}append(e){this.#sql+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return`"`}getRightIdentifierWrapper(){return`"`}getCurrentParameterPlaceholder(){return`$`+this.numParameters}getLeftExplainOptionsWrapper(){return`(`}getExplainOptionAssignment(){return` `}getExplainOptionsDelimiter(){return`, `}getRightExplainOptionsWrapper(){return`)`}sanitizeIdentifier(e){let t=this.getLeftIdentifierWrapper(),n=this.getRightIdentifierWrapper(),r=``;for(let i of e)r+=i,i===t?r+=t:i===n&&(r+=n);return r}addParameter(e){this.#parameters.push(e)}appendImmediateValue(e){if(g(e))this.append(`'${e}'`);else if(kt(e)||At(e))this.append(e.toString());else if(jt(e))this.append(`null`);else if(Mt(e))this.appendImmediateValue(e.toISOString());else if(Nt(e))this.appendImmediateValue(e.toString());else throw Error(`invalid immediate value ${e}`)}sortSelectModifiers(e){return e.sort((e,t)=>e.modifier&&t.modifier?To[e.modifier]-To[t.modifier]:1),y(e)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}};const wo=y({ForKeyShare:`for key share`,ForNoKeyUpdate:`for no key update`,ForUpdate:`for update`,ForShare:`for share`,NoWait:`nowait`,SkipLocked:`skip locked`,Distinct:`distinct`}),To=y({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),Eo=y({InnerJoin:`inner join`,LeftJoin:`left join`,RightJoin:`right join`,FullJoin:`full join`,LateralInnerJoin:`inner join lateral`,LateralLeftJoin:`left join lateral`,Using:`using`});var Do=class{async init(){}async acquireConnection(){return new Oo}async beginTransaction(){}async commitTransaction(){}async rollbackTransaction(){}async releaseConnection(){}async destroy(){}},Oo=class{async executeQuery(){return{rows:[]}}async*streamQuery(){}},ko=class{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}};y({__noMigrations__:!0});const Ao=/"/g;var jo=class extends Co{sanitizeIdentifier(e){return e.replace(Ao,`""`)}},Mo=class{#db;constructor(e){this.#db=e}async getSchemas(){return(await this.#db.selectFrom(`pg_catalog.pg_namespace`).select(`nspname`).$castTo().execute()).map(e=>({name:e.nspname}))}async getTables(e={withInternalKyselyTables:!1}){let t=this.#db.selectFrom(`pg_catalog.pg_attribute as a`).innerJoin(`pg_catalog.pg_class as c`,`a.attrelid`,`c.oid`).innerJoin(`pg_catalog.pg_namespace as ns`,`c.relnamespace`,`ns.oid`).innerJoin(`pg_catalog.pg_type as typ`,`a.atttypid`,`typ.oid`).innerJoin(`pg_catalog.pg_namespace as dtns`,`typ.typnamespace`,`dtns.oid`).select([`a.attname as column`,`a.attnotnull as not_null`,`a.atthasdef as has_default`,`c.relname as table`,`c.relkind as table_type`,`ns.nspname as schema`,`typ.typname as type`,`dtns.nspname as type_schema`,bo`col_description(a.attrelid, a.attnum)`.as(`column_description`),this.#db.selectFrom(`pg_class`).select(bo`true`.as(`auto_incrementing`)).whereRef(`relnamespace`,`=`,`c.relnamespace`).where(`relkind`,`=`,`S`).where(`relname`,`=`,bo`c.relname || '_' || a.attname || '_seq'`).as(`auto_incrementing`)]).where(e=>e.or([e(`c.relkind`,`=`,`r`),e(`c.relkind`,`=`,`v`),e(`c.relkind`,`=`,`p`)])).where(`ns.nspname`,`!~`,`^pg_`).where(`ns.nspname`,`!=`,`information_schema`).where(`a.attnum`,`>=`,0).where(`a.attisdropped`,`!=`,!0).orderBy(`ns.nspname`).orderBy(`c.relname`).orderBy(`a.attnum`).$castTo();e.withInternalKyselyTables||(t=t.where(`c.relname`,`!=`,`kysely_migration`).where(`c.relname`,`!=`,`kysely_migration_lock`));let n=await t.execute();return this.#parseTableMetadata(n)}async getMetadata(e){return{tables:await this.getTables(e)}}#parseTableMetadata(e){return e.reduce((e,t)=>{let n=e.find(e=>e.name===t.table&&e.schema===t.schema);return n||(n=y({name:t.table,isView:t.table_type===`v`,schema:t.schema,columns:[]}),e.push(n)),n.columns.push(y({name:t.column,dataType:t.type,dataTypeSchema:t.type_schema,isNullable:!t.not_null,isAutoIncrementing:!!t.auto_incrementing,hasDefaultValue:t.has_default,comment:t.column_description??void 0})),e},[])}};const No=BigInt(`3853314791062309107`);var Po=class extends ko{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(e,t){await bo`select pg_advisory_xact_lock(${bo.lit(No)})`.execute(e)}async releaseMigrationLock(e,t){}};const Fo=()=>new fo({dialect:{createAdapter:()=>new Po,createDriver:()=>new Do,createIntrospector:e=>new Mo(e),createQueryCompiler:()=>new jo}});async function Io(e,t){let n=Fo(),r={exec:async t=>await e.client.exec(t.sql,t.parameters)};return await t({...e,db:n,client:r})}we(`stepChain`,d.type({user:d.object({name:d.object({first:d.string(),last:d.string()}),activatedAt:d.datetime({optional:!0})})}),{defaults:{dbNamespace:`tailordb`}}).fnStep(`step1`,e=>`step1: Hello ${e.input.user.name.first} ${e.input.user.name.last} on step1!`).fnStep(`step2`,async()=>`step2: recorded ${Dt(new Date,`yyyy-MM-dd HH:mm:ss`)} on step2!`).fnStep(`sqlStep`,async e=>{let t=await e.client.execOne(`SELECT name FROM User ORDER BY createdAt DESC`);return t?t.name:`no user found`}).fnStep(`kyselyStep`,e=>Io(e,async e=>{let t=e.db.selectFrom(`Supplier`).select([`state`]).compile();return(await e.client.exec(t)).map(e=>e.state).join(`, `)})).returns(e=>({result:{summary:[e.step1,e.step2,e.sqlStep,e.kyselyStep]}}),d.type({result:d.object({summary:d.string({array:!0})})}));const Lo=async e=>{let t=await e.client.execOne(`SELECT name FROM User ORDER BY createdAt DESC`);return t?t.name:`no user found`},Ro=async e=>{let t=e?new tailordb.Client({namespace:e}):{connect:()=>{},end:()=>{}};await t.connect();let n={async exec(e,n){return(await t.queryObject(e,n??[])).rows},async execOne(e,n){return(await t.queryObject(e,n??[])).rows[0]}};return{...n,async transaction(e){try{await n.exec(`BEGIN`);let t=await e(n);return await n.exec(`COMMIT`),t}catch(e){console.error(`Transaction failed:`,e);try{await n.exec(`ROLLBACK`)}catch(e){console.error(`Failed to rollback transaction:`,e)}}},async end(){try{await t.end()}catch(e){console.error(`Error ending connection:`,e)}}}};globalThis.main=await(async(e,t)=>async n=>{let r=await Ro(e);try{return await t({...n,client:r})}finally{await r.end()}})(`tailordb`,Lo);
//# sourceMappingURL=stepChain__sqlStep.js.map