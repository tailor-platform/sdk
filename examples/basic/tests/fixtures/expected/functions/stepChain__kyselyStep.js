function e(e){return e===void 0||e===void 0}function t(e){return typeof e==`string`}function n(e){return typeof e==`number`}function r(e){return typeof e==`boolean`}function i(e){return e===null}function a(e){return e instanceof Date}function o(e){return typeof e==`bigint`}function s(e){return typeof e==`function`}function c(e){return typeof e==`object`&&!!e}function l(e){return Object.freeze(e)}function ee(e){return u(e)?e:[e]}function u(e){return Array.isArray(e)}function d(e){return e}const f=l({is(e){return e.kind===`AlterTableNode`},create(e){return l({kind:`AlterTableNode`,table:e})},cloneWithTableProps(e,t){return l({...e,...t})},cloneWithColumnAlteration(e,t){return l({...e,columnAlterations:e.columnAlterations?[...e.columnAlterations,t]:[t]})}}),p=l({is(e){return e.kind===`IdentifierNode`},create(e){return l({kind:`IdentifierNode`,name:e})}}),m=l({is(e){return e.kind===`CreateIndexNode`},create(e){return l({kind:`CreateIndexNode`,name:p.create(e)})},cloneWith(e,t){return l({...e,...t})},cloneWithColumns(e,t){return l({...e,columns:[...e.columns||[],...t]})}}),te=l({is(e){return e.kind===`CreateSchemaNode`},create(e,t){return l({kind:`CreateSchemaNode`,schema:p.create(e),...t})},cloneWith(e,t){return l({...e,...t})}}),ne=[`preserve rows`,`delete rows`,`drop`],h=l({is(e){return e.kind===`CreateTableNode`},create(e){return l({kind:`CreateTableNode`,table:e,columns:l([])})},cloneWithColumn(e,t){return l({...e,columns:l([...e.columns,t])})},cloneWithConstraint(e,t){return l({...e,constraints:e.constraints?l([...e.constraints,t]):l([t])})},cloneWithFrontModifier(e,t){return l({...e,frontModifiers:e.frontModifiers?l([...e.frontModifiers,t]):l([t])})},cloneWithEndModifier(e,t){return l({...e,endModifiers:e.endModifiers?l([...e.endModifiers,t]):l([t])})},cloneWith(e,t){return l({...e,...t})}}),g=l({is(e){return e.kind===`SchemableIdentifierNode`},create(e){return l({kind:`SchemableIdentifierNode`,identifier:p.create(e)})},createWithSchema(e,t){return l({kind:`SchemableIdentifierNode`,schema:p.create(e),identifier:p.create(t)})}}),re=l({is(e){return e.kind===`DropIndexNode`},create(e,t){return l({kind:`DropIndexNode`,name:g.create(e),...t})},cloneWith(e,t){return l({...e,...t})}}),ie=l({is(e){return e.kind===`DropSchemaNode`},create(e,t){return l({kind:`DropSchemaNode`,schema:p.create(e),...t})},cloneWith(e,t){return l({...e,...t})}}),ae=l({is(e){return e.kind===`DropTableNode`},create(e,t){return l({kind:`DropTableNode`,table:e,...t})},cloneWith(e,t){return l({...e,...t})}}),_=l({is(e){return e.kind===`AliasNode`},create(e,t){return l({kind:`AliasNode`,node:e,alias:t})}}),v=l({is(e){return e.kind===`TableNode`},create(e){return l({kind:`TableNode`,table:g.create(e)})},createWithSchema(e,t){return l({kind:`TableNode`,table:g.createWithSchema(e,t)})}});function y(e){return c(e)&&s(e.toOperationNode)}function oe(e){return c(e)&&`expressionType`in e&&y(e)}function se(e){return c(e)&&`expression`in e&&t(e.alias)&&y(e)}const b=l({is(e){return e.kind===`SelectModifierNode`},create(e,t){return l({kind:`SelectModifierNode`,modifier:e,of:t})},createWithExpression(e){return l({kind:`SelectModifierNode`,rawModifier:e})}}),x=l({is(e){return e.kind===`AndNode`},create(e,t){return l({kind:`AndNode`,left:e,right:t})}}),ce=l({is(e){return e.kind===`OrNode`},create(e,t){return l({kind:`OrNode`,left:e,right:t})}}),le=l({is(e){return e.kind===`OnNode`},create(e){return l({kind:`OnNode`,on:e})},cloneWithOperation(e,t,n){return l({...e,on:t===`And`?x.create(e.on,n):ce.create(e.on,n)})}}),ue=l({is(e){return e.kind===`JoinNode`},create(e,t){return l({kind:`JoinNode`,joinType:e,table:t,on:void 0})},createWithOn(e,t,n){return l({kind:`JoinNode`,joinType:e,table:t,on:le.create(n)})},cloneWithOn(e,t){return l({...e,on:e.on?le.cloneWithOperation(e.on,`And`,t):le.create(t)})}}),de=l({is(e){return e.kind===`BinaryOperationNode`},create(e,t,n){return l({kind:`BinaryOperationNode`,leftOperand:e,operator:t,rightOperand:n})}}),fe=`=.==.!=.<>.>.>=.<.<=.in.not in.is.is not.like.not like.match.ilike.not ilike.@>.<@.^@.&&.?.?&.?|.!<.!>.<=>.!~.~.~*.!~*.@@.@@@.!!.<->.regexp.is distinct from.is not distinct from`.split(`.`),pe=[`+`,`-`,`*`,`/`,`%`,`^`,`&`,`|`,`#`,`<<`,`>>`],me=[`->`,`->>`],he=[...fe,...pe,`&&`,`||`],ge=[`not`,`-`,...[`exists`,`not exists`]],_e=[...he,...me,...ge,`between`,`between symmetric`],S=l({is(e){return e.kind===`OperatorNode`},create(e){return l({kind:`OperatorNode`,operator:e})}});function ve(e){return t(e)&&me.includes(e)}const C=l({is(e){return e.kind===`ColumnNode`},create(e){return l({kind:`ColumnNode`,column:p.create(e)})}}),ye=l({is(e){return e.kind===`SelectAllNode`},create(){return l({kind:`SelectAllNode`})}}),be=l({is(e){return e.kind===`ReferenceNode`},create(e,t){return l({kind:`ReferenceNode`,table:t,column:e})},createSelectAll(e){return l({kind:`ReferenceNode`,table:e,column:ye.create()})}});var xe=class{#dynamicReference;get dynamicReference(){return this.#dynamicReference}get refType(){}constructor(e){this.#dynamicReference=e}toOperationNode(){return Me(this.#dynamicReference)}};function Se(e){return c(e)&&y(e)&&t(e.dynamicReference)}const Ce=l({is(e){return e.kind===`OrderByItemNode`},create(e,t){return l({kind:`OrderByItemNode`,orderBy:e,direction:t})}}),w=l({is(e){return e.kind===`RawNode`},create(e,t){return l({kind:`RawNode`,sqlFragments:l(e),parameters:l(t)})},createWithSql(e){return w.create([e],[])},createWithChild(e){return w.create([``,``],[e])},createWithChildren(e){return w.create(Array(e.length+1).fill(``),e)}});function we(e){return e===`asc`||e===`desc`}function Te(e){if(e.length===2)return[Ee(e[0],e[1])];if(e.length===1){let[t]=e;return Array.isArray(t)?t.map(e=>Ee(e)):[Ee(t)]}throw Error(`Invalid number of arguments at order by! expected 1-2, received ${e.length}`)}function Ee(e,t){let n=De(e);if(Ce.is(n)){if(t)throw Error(`Cannot specify direction twice!`);return n}return Ce.create(n,Oe(t))}function De(e){if(dr(e))return Y(e);if(Se(e))return e.toOperationNode();let[t,n]=e.split(` `);if(n){if(!we(n))throw Error(`Invalid order by direction: ${n}`);return Ce.create(E(t),Oe(n))}return E(e)}function Oe(e){if(e)return e===`asc`||e===`desc`?w.createWithSql(e):e.toOperationNode()}const ke=l({is(e){return e.kind===`JSONReferenceNode`},create(e,t){return l({kind:`JSONReferenceNode`,reference:e,traversal:t})},cloneWithTraversal(e,t){return l({...e,traversal:t})}}),Ae=l({is(e){return e.kind===`JSONOperatorChainNode`},create(e){return l({kind:`JSONOperatorChainNode`,operator:e,values:l([])})},cloneWithValue(e,t){return l({...e,values:l([...e.values,t])})}}),je=l({is(e){return e.kind===`JSONPathNode`},create(e){return l({kind:`JSONPathNode`,inOperator:e,pathLegs:l([])})},cloneWithLeg(e,t){return l({...e,pathLegs:l([...e.pathLegs,t])})}});function Me(e){return t(e)?E(e):e.toOperationNode()}function Ne(e){return u(e)?e.map(e=>T(e)):[T(e)]}function T(e){return dr(e)?Y(e):Me(e)}function Pe(e,t){let n=E(e);if(ve(t))return ke.create(n,Ae.create(S.create(t)));let r=t.slice(0,-1);if(ve(r))return ke.create(n,je.create(S.create(r)));throw Error(`Invalid JSON operator: ${t}`)}function E(e){if(!e.includes(`.`))return be.create(C.create(e));let t=e.split(`.`).map(Be);if(t.length===3)return Re(t);if(t.length===2)return ze(t);throw Error(`invalid column reference ${e}`)}function Fe(e){let t=` as `;if(e.includes(t)){let[n,r]=e.split(t).map(Be);return _.create(E(n),p.create(r))}else return E(e)}function Ie(e){return C.create(e)}function Le(e){if(e.includes(` `)){let[t,n]=e.split(` `).map(Be);if(!we(n))throw Error(`invalid order direction "${n}" next to "${t}"`);return Te([t,n])[0]}else return Ie(e)}function Re(e){let[t,n,r]=e;return be.create(C.create(r),v.createWithSchema(t,n))}function ze(e){let[t,n]=e;return be.create(C.create(n),v.create(t))}function Be(e){return e.trim()}const Ve=l({is(e){return e.kind===`PrimitiveValueListNode`},create(e){return l({kind:`PrimitiveValueListNode`,values:l([...e])})}}),He=l({is(e){return e.kind===`ValueListNode`},create(e){return l({kind:`ValueListNode`,values:l(e)})}}),D=l({is(e){return e.kind===`ValueNode`},create(e){return l({kind:`ValueNode`,value:e})},createImmediate(e){return l({kind:`ValueNode`,value:e,immediate:!0})}});function Ue(e){return u(e)?Ke(e):O(e)}function O(e){return dr(e)?Y(e):D.create(e)}function We(e){return n(e)||r(e)||i(e)}function Ge(e){if(!We(e))throw Error(`unsafe immediate value ${JSON.stringify(e)}`);return D.createImmediate(e)}function Ke(e){return e.some(dr)?He.create(e.map(e=>O(e))):Ve.create(e)}const qe=l({is(e){return e.kind===`ParensNode`},create(e){return l({kind:`ParensNode`,node:e})}});function k(e){if(e.length===3)return Je(e[0],e[1],e[2]);if(e.length===1)return O(e[0]);throw Error(`invalid arguments: ${JSON.stringify(e)}`)}function Je(e,t,n){return Ze(t)&&Qe(n)?de.create(T(e),$e(t),D.createImmediate(n)):de.create(T(e),$e(t),Ue(n))}function A(e,t,n){return de.create(T(e),$e(t),T(n))}function Ye(t,n){return Xe(Object.entries(t).filter(([,t])=>!e(t)).map(([e,t])=>Je(e,Qe(t)?`is`:`=`,t)),n)}function Xe(e,t,n=!0){let r=t===`and`?x.create:ce.create;if(e.length===0)return de.create(D.createImmediate(1),S.create(`=`),D.createImmediate(t===`and`?1:0));let i=et(e[0]);for(let t=1;t<e.length;++t)i=r(i,et(e[t]));return e.length>1&&n?qe.create(i):i}function Ze(e){return e===`is`||e===`is not`}function Qe(e){return i(e)||r(e)}function $e(e){if(t(e)&&_e.includes(e))return S.create(e);if(y(e))return e.toOperationNode();throw Error(`invalid operator ${JSON.stringify(e)}`)}function et(e){return y(e)?e.toOperationNode():e}const j=l({is(e){return e.kind===`OrderByNode`},create(e){return l({kind:`OrderByNode`,items:l([...e])})},cloneWithItems(e,t){return l({...e,items:l([...e.items,...t])})}}),tt=l({is(e){return e.kind===`PartitionByNode`},create(e){return l({kind:`PartitionByNode`,items:l(e)})},cloneWithItems(e,t){return l({...e,items:l([...e.items,...t])})}}),nt=l({is(e){return e.kind===`OverNode`},create(){return l({kind:`OverNode`})},cloneWithOrderByItems(e,t){return l({...e,orderBy:e.orderBy?j.cloneWithItems(e.orderBy,t):j.create(t)})},cloneWithPartitionByItems(e,t){return l({...e,partitionBy:e.partitionBy?tt.cloneWithItems(e.partitionBy,t):tt.create(t)})}}),rt=l({is(e){return e.kind===`FromNode`},create(e){return l({kind:`FromNode`,froms:l(e)})},cloneWithFroms(e,t){return l({...e,froms:l([...e.froms,...t])})}}),it=l({is(e){return e.kind===`GroupByNode`},create(e){return l({kind:`GroupByNode`,items:l(e)})},cloneWithItems(e,t){return l({...e,items:l([...e.items,...t])})}}),at=l({is(e){return e.kind===`HavingNode`},create(e){return l({kind:`HavingNode`,having:e})},cloneWithOperation(e,t,n){return l({...e,having:t===`And`?x.create(e.having,n):ce.create(e.having,n)})}}),M=l({is(e){return e.kind===`SelectQueryNode`},create(e){return l({kind:`SelectQueryNode`,...e&&{with:e}})},createFrom(e,t){return l({kind:`SelectQueryNode`,from:rt.create(e),...t&&{with:t}})},cloneWithSelections(e,t){return l({...e,selections:e.selections?l([...e.selections,...t]):l(t)})},cloneWithDistinctOn(e,t){return l({...e,distinctOn:e.distinctOn?l([...e.distinctOn,...t]):l(t)})},cloneWithFrontModifier(e,t){return l({...e,frontModifiers:e.frontModifiers?l([...e.frontModifiers,t]):l([t])})},cloneWithOrderByItems(e,t){return l({...e,orderBy:e.orderBy?j.cloneWithItems(e.orderBy,t):j.create(t)})},cloneWithGroupByItems(e,t){return l({...e,groupBy:e.groupBy?it.cloneWithItems(e.groupBy,t):it.create(t)})},cloneWithLimit(e,t){return l({...e,limit:t})},cloneWithOffset(e,t){return l({...e,offset:t})},cloneWithFetch(e,t){return l({...e,fetch:t})},cloneWithHaving(e,t){return l({...e,having:e.having?at.cloneWithOperation(e.having,`And`,t):at.create(t)})},cloneWithSetOperations(e,t){return l({...e,setOperations:e.setOperations?l([...e.setOperations,...t]):l([...t])})},cloneWithoutSelections(e){return l({...e,selections:[]})},cloneWithoutLimit(e){return l({...e,limit:void 0})},cloneWithoutOffset(e){return l({...e,offset:void 0})},cloneWithoutOrderBy(e){return l({...e,orderBy:void 0})},cloneWithoutGroupBy(e){return l({...e,groupBy:void 0})}});function N(e,t){Object.defineProperties(e.prototype,{then:{enumerable:!1,value:()=>{throw Error(t)}}})}var ot=class e{#props;constructor(e){this.#props=l(e)}on(...t){return new e({...this.#props,joinNode:ue.cloneWithOn(this.#props.joinNode,k(t))})}onRef(t,n,r){return new e({...this.#props,joinNode:ue.cloneWithOn(this.#props.joinNode,A(t,n,r))})}onTrue(){return new e({...this.#props,joinNode:ue.cloneWithOn(this.#props.joinNode,w.createWithSql(`true`))})}$call(e){return e(this)}toOperationNode(){return this.#props.joinNode}};N(ot,`don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.`);const st=l({is(e){return e.kind===`PartitionByItemNode`},create(e){return l({kind:`PartitionByItemNode`,partitionBy:e})}});function ct(e){return Ne(e).map(st.create)}var lt=class e{#props;constructor(e){this.#props=l(e)}orderBy(t,n){return new e({overNode:nt.cloneWithOrderByItems(this.#props.overNode,Te([t,n]))})}partitionBy(t){return new e({overNode:nt.cloneWithPartitionByItems(this.#props.overNode,ct(t))})}$call(e){return e(this)}toOperationNode(){return this.#props.overNode}};N(lt,`don't await OverBuilder instances. They are never executed directly and are always just a part of a query.`);const ut=l({is(e){return e.kind===`SelectionNode`},create(e){return l({kind:`SelectionNode`,selection:e})},createSelectAll(){return l({kind:`SelectionNode`,selection:ye.create()})},createSelectAllFromTable(e){return l({kind:`SelectionNode`,selection:be.createSelectAll(e)})}});function P(e){return s(e)?P(e(lr())):u(e)?e.map(e=>dt(e)):[dt(e)]}function dt(e){return t(e)?ut.create(Fe(e)):Se(e)?ut.create(e.toOperationNode()):ut.create(ur(e))}function F(e){return e?Array.isArray(e)?e.map(ft):[ft(e)]:[ut.createSelectAll()]}function ft(e){if(t(e))return ut.createSelectAllFromTable(X(e));throw Error(`invalid value selectAll expression: ${JSON.stringify(e)}`)}const pt=l({is(e){return e.kind===`ValuesNode`},create(e){return l({kind:`ValuesNode`,values:l(e)})}}),mt=l({is(e){return e.kind===`DefaultInsertValueNode`},create(){return l({kind:`DefaultInsertValueNode`})}});function ht(e){let t=s(e)?e(lr()):e,n=u(t)?t:l([t]);return gt(n)}function gt(e){let t=_t(e);return[l([...t.keys()].map(C.create)),pt.create(e.map(e=>vt(e,t)))]}function _t(e){let t=new Map;for(let n of e){let e=Object.keys(n);for(let r of e)!t.has(r)&&n[r]!==void 0&&t.set(r,t.size)}return t}function vt(t,n){let r=Object.keys(t),i=Array.from({length:n.size}),a=!1,o=r.length;for(let s of r){let r=n.get(s);if(e(r)){o--;continue}let c=t[s];(e(c)||dr(c))&&(a=!0),i[r]=c}if(o<n.size||a){let t=mt.create();return He.create(i.map(n=>e(n)?t:O(n)))}return Ve.create(i)}const I=l({is(e){return e.kind===`InsertQueryNode`},create(e,t,n){return l({kind:`InsertQueryNode`,into:e,...t&&{with:t},replace:n})},createWithoutInto(){return l({kind:`InsertQueryNode`})},cloneWith(e,t){return l({...e,...t})}}),yt=l({is(e){return e.kind===`UpdateQueryNode`},create(e,t){return l({kind:`UpdateQueryNode`,table:e,...t&&{with:t}})},createWithoutTable(){return l({kind:`UpdateQueryNode`})},cloneWithFromItems(e,t){return l({...e,from:e.from?rt.cloneWithFroms(e.from,t):rt.create(t)})},cloneWithUpdates(e,t){return l({...e,updates:e.updates?l([...e.updates,...t]):t})},cloneWithLimit(e,t){return l({...e,limit:t})}}),bt=l({is(e){return e.kind===`UsingNode`},create(e){return l({kind:`UsingNode`,tables:l(e)})},cloneWithTables(e,t){return l({...e,tables:l([...e.tables,...t])})}}),L=l({is(e){return e.kind===`DeleteQueryNode`},create(e,t){return l({kind:`DeleteQueryNode`,from:rt.create(e),...t&&{with:t}})},cloneWithOrderByItems(e,t){return l({...e,orderBy:e.orderBy?j.cloneWithItems(e.orderBy,t):j.create(t)})},cloneWithoutOrderBy(e){return l({...e,orderBy:void 0})},cloneWithLimit(e,t){return l({...e,limit:t})},cloneWithoutLimit(e){return l({...e,limit:void 0})},cloneWithUsing(e,t){return l({...e,using:e.using===void 0?bt.create(t):bt.cloneWithTables(e.using,t)})}}),R=l({is(e){return e.kind===`WhereNode`},create(e){return l({kind:`WhereNode`,where:e})},cloneWithOperation(e,t,n){return l({...e,where:t===`And`?x.create(e.where,n):ce.create(e.where,n)})}}),xt=l({is(e){return e.kind===`ReturningNode`},create(e){return l({kind:`ReturningNode`,selections:l(e)})},cloneWithSelections(e,t){return l({...e,selections:e.selections?l([...e.selections,...t]):l(t)})}}),St=l({is(e){return e.kind===`ExplainNode`},create(e,t){return l({kind:`ExplainNode`,format:e,options:t})}}),Ct=l({is(e){return e.kind===`WhenNode`},create(e){return l({kind:`WhenNode`,condition:e})},cloneWithResult(e,t){return l({...e,result:t})}}),z=l({is(e){return e.kind===`MergeQueryNode`},create(e,t){return l({kind:`MergeQueryNode`,into:e,...t&&{with:t}})},cloneWithUsing(e,t){return l({...e,using:t})},cloneWithWhen(e,t){return l({...e,whens:e.whens?l([...e.whens,t]):l([t])})},cloneWithThen(e,t){return l({...e,whens:e.whens?l([...e.whens.slice(0,-1),Ct.cloneWithResult(e.whens[e.whens.length-1],t)]):void 0})}}),wt=l({is(e){return e.kind===`OutputNode`},create(e){return l({kind:`OutputNode`,selections:l(e)})},cloneWithSelections(e,t){return l({...e,selections:e.selections?l([...e.selections,...t]):l(t)})}}),B=l({is(e){return M.is(e)||I.is(e)||yt.is(e)||L.is(e)||z.is(e)},cloneWithEndModifier(e,t){return l({...e,endModifiers:e.endModifiers?l([...e.endModifiers,t]):l([t])})},cloneWithWhere(e,t){return l({...e,where:e.where?R.cloneWithOperation(e.where,`And`,t):R.create(t)})},cloneWithJoin(e,t){return l({...e,joins:e.joins?l([...e.joins,t]):l([t])})},cloneWithReturning(e,t){return l({...e,returning:e.returning?xt.cloneWithSelections(e.returning,t):xt.create(t)})},cloneWithoutReturning(e){return l({...e,returning:void 0})},cloneWithoutWhere(e){return l({...e,where:void 0})},cloneWithExplain(e,t,n){return l({...e,explain:St.create(t,n?.toOperationNode())})},cloneWithTop(e,t){return l({...e,top:t})},cloneWithOutput(e,t){return l({...e,output:e.output?wt.cloneWithSelections(e.output,t):wt.create(t)})}}),Tt=l({is(e){return e.kind===`ColumnUpdateNode`},create(e,t){return l({kind:`ColumnUpdateNode`,column:e,value:t})}});function Et(...e){return e.length===2?[Tt.create(T(e[0]),O(e[1]))]:Dt(e[0])}function Dt(e){let t=s(e)?e(lr()):e;return Object.entries(t).filter(([e,t])=>t!==void 0).map(([e,t])=>Tt.create(C.create(e),O(t)))}const Ot=l({is(e){return e.kind===`OnDuplicateKeyNode`},create(e){return l({kind:`OnDuplicateKeyNode`,updates:e})}});var kt=class{insertId;numInsertedOrUpdatedRows;constructor(e,t){this.insertId=e,this.numInsertedOrUpdatedRows=t}},At=class extends Error{node;constructor(e){super(`no result`),this.node=e}};function jt(e){return Object.prototype.hasOwnProperty.call(e,`prototype`)}const V=l({is(e){return e.kind===`OnConflictNode`},create(){return l({kind:`OnConflictNode`})},cloneWith(e,t){return l({...e,...t})},cloneWithIndexWhere(e,t){return l({...e,indexWhere:e.indexWhere?R.cloneWithOperation(e.indexWhere,`And`,t):R.create(t)})},cloneWithIndexOrWhere(e,t){return l({...e,indexWhere:e.indexWhere?R.cloneWithOperation(e.indexWhere,`Or`,t):R.create(t)})},cloneWithUpdateWhere(e,t){return l({...e,updateWhere:e.updateWhere?R.cloneWithOperation(e.updateWhere,`And`,t):R.create(t)})},cloneWithUpdateOrWhere(e,t){return l({...e,updateWhere:e.updateWhere?R.cloneWithOperation(e.updateWhere,`Or`,t):R.create(t)})},cloneWithoutIndexWhere(e){return l({...e,indexWhere:void 0})},cloneWithoutUpdateWhere(e){return l({...e,updateWhere:void 0})}});var Mt=class e{#props;constructor(e){this.#props=l(e)}column(t){let n=C.create(t);return new e({...this.#props,onConflictNode:V.cloneWith(this.#props.onConflictNode,{columns:this.#props.onConflictNode.columns?l([...this.#props.onConflictNode.columns,n]):l([n])})})}columns(t){let n=t.map(C.create);return new e({...this.#props,onConflictNode:V.cloneWith(this.#props.onConflictNode,{columns:this.#props.onConflictNode.columns?l([...this.#props.onConflictNode.columns,...n]):l(n)})})}constraint(t){return new e({...this.#props,onConflictNode:V.cloneWith(this.#props.onConflictNode,{constraint:p.create(t)})})}expression(t){return new e({...this.#props,onConflictNode:V.cloneWith(this.#props.onConflictNode,{indexExpression:t.toOperationNode()})})}where(...t){return new e({...this.#props,onConflictNode:V.cloneWithIndexWhere(this.#props.onConflictNode,k(t))})}whereRef(t,n,r){return new e({...this.#props,onConflictNode:V.cloneWithIndexWhere(this.#props.onConflictNode,A(t,n,r))})}clearWhere(){return new e({...this.#props,onConflictNode:V.cloneWithoutIndexWhere(this.#props.onConflictNode)})}doNothing(){return new Nt({...this.#props,onConflictNode:V.cloneWith(this.#props.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new Pt({...this.#props,onConflictNode:V.cloneWith(this.#props.onConflictNode,{updates:Dt(e)})})}$call(e){return e(this)}};N(Mt,`don't await OnConflictBuilder instances.`);var Nt=class{#props;constructor(e){this.#props=l(e)}toOperationNode(){return this.#props.onConflictNode}};N(Nt,`don't await OnConflictDoNothingBuilder instances.`);var Pt=class e{#props;constructor(e){this.#props=l(e)}where(...t){return new e({...this.#props,onConflictNode:V.cloneWithUpdateWhere(this.#props.onConflictNode,k(t))})}whereRef(t,n,r){return new e({...this.#props,onConflictNode:V.cloneWithUpdateWhere(this.#props.onConflictNode,A(t,n,r))})}clearWhere(){return new e({...this.#props,onConflictNode:V.cloneWithoutUpdateWhere(this.#props.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#props.onConflictNode}};N(Pt,`don't await OnConflictUpdateBuilder instances.`);const Ft=l({is(e){return e.kind===`TopNode`},create(e,t){return l({kind:`TopNode`,expression:e,modifiers:t})}});function It(t,r){if(!n(t)&&!o(t))throw Error(`Invalid top expression: ${t}`);if(!e(r)&&!Lt(r))throw Error(`Invalid top modifiers: ${r}`);return Ft.create(t,r)}function Lt(e){return e===`percent`||e===`with ties`||e===`percent with ties`}var Rt=class e{#props;constructor(e){this.#props=l(e)}values(t){let[n,r]=ht(t);return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{columns:n,values:r})})}columns(t){return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{columns:l(t.map(C.create))})})}expression(t){return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{values:Y(t)})})}defaultValues(){return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{defaultValues:!0})})}modifyEnd(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}ignore(){return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{ignore:!0})})}top(t,n){return new e({...this.#props,queryNode:B.cloneWithTop(this.#props.queryNode,It(t,n))})}onConflict(t){return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{onConflict:t(new Mt({onConflictNode:V.create()})).toOperationNode()})})}onDuplicateKeyUpdate(t){return new e({...this.#props,queryNode:I.cloneWith(this.#props.queryNode,{onDuplicateKey:Ot.create(Dt(t))})})}returning(t){return new e({...this.#props,queryNode:B.cloneWithReturning(this.#props.queryNode,P(t))})}returningAll(){return new e({...this.#props,queryNode:B.cloneWithReturning(this.#props.queryNode,F())})}output(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,P(t))})}outputAll(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,F(t))})}clearReturning(){return new e({...this.#props,queryNode:B.cloneWithoutReturning(this.#props.queryNode)})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId),{adapter:n}=this.#props.executor,r=e.query;return r.returning&&n.supportsReturning||r.output&&n.supportsOutput?t.rows:[new kt(t.insertId,t.numAffectedRows??t.numUpdatedOrDeletedRows)]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=At){let t=await this.executeTakeFirst();if(t===void 0)throw jt(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:B.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};N(Rt,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var zt=class{numDeletedRows;constructor(e){this.numDeletedRows=e}};const Bt=l({is(e){return e.kind===`LimitNode`},create(e){return l({kind:`LimitNode`,limit:e})}});var Vt=class e{#props;constructor(e){this.#props=l(e)}where(...t){return new e({...this.#props,queryNode:B.cloneWithWhere(this.#props.queryNode,k(t))})}whereRef(t,n,r){return new e({...this.#props,queryNode:B.cloneWithWhere(this.#props.queryNode,A(t,n,r))})}clearWhere(){return new e({...this.#props,queryNode:B.cloneWithoutWhere(this.#props.queryNode)})}top(t,n){return new e({...this.#props,queryNode:B.cloneWithTop(this.#props.queryNode,It(t,n))})}using(t){return new e({...this.#props,queryNode:L.cloneWithUsing(this.#props.queryNode,fr(t))})}innerJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`InnerJoin`,t))})}leftJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`LeftJoin`,t))})}rightJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`RightJoin`,t))})}fullJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`FullJoin`,t))})}returning(t){return new e({...this.#props,queryNode:B.cloneWithReturning(this.#props.queryNode,P(t))})}returningAll(t){return new e({...this.#props,queryNode:B.cloneWithReturning(this.#props.queryNode,F(t))})}output(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,P(t))})}outputAll(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,F(t))})}clearReturning(){return new e({...this.#props,queryNode:B.cloneWithoutReturning(this.#props.queryNode)})}clearLimit(){return new e({...this.#props,queryNode:L.cloneWithoutLimit(this.#props.queryNode)})}clearOrderBy(){return new e({...this.#props,queryNode:L.cloneWithoutOrderBy(this.#props.queryNode)})}orderBy(t,n){return new e({...this.#props,queryNode:L.cloneWithOrderByItems(this.#props.queryNode,Te([t,n]))})}limit(t){return new e({...this.#props,queryNode:L.cloneWithLimit(this.#props.queryNode,Bt.create(O(t)))})}modifyEnd(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId),{adapter:n}=this.#props.executor,r=e.query;return r.returning&&n.supportsReturning||r.output&&n.supportsOutput?t.rows:[new zt(t.numAffectedRows??t.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=At){let t=await this.executeTakeFirst();if(t===void 0)throw jt(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:B.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};N(Vt,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var Ht=class{numUpdatedRows;numChangedRows;constructor(e,t){this.numUpdatedRows=e,this.numChangedRows=t}},Ut=class e{#props;constructor(e){this.#props=l(e)}where(...t){return new e({...this.#props,queryNode:B.cloneWithWhere(this.#props.queryNode,k(t))})}whereRef(t,n,r){return new e({...this.#props,queryNode:B.cloneWithWhere(this.#props.queryNode,A(t,n,r))})}clearWhere(){return new e({...this.#props,queryNode:B.cloneWithoutWhere(this.#props.queryNode)})}top(t,n){return new e({...this.#props,queryNode:B.cloneWithTop(this.#props.queryNode,It(t,n))})}from(t){return new e({...this.#props,queryNode:yt.cloneWithFromItems(this.#props.queryNode,fr(t))})}innerJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`InnerJoin`,t))})}leftJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`LeftJoin`,t))})}rightJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`RightJoin`,t))})}fullJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`FullJoin`,t))})}limit(t){return new e({...this.#props,queryNode:yt.cloneWithLimit(this.#props.queryNode,Bt.create(O(t)))})}set(...t){return new e({...this.#props,queryNode:yt.cloneWithUpdates(this.#props.queryNode,Et(...t))})}returning(t){return new e({...this.#props,queryNode:B.cloneWithReturning(this.#props.queryNode,P(t))})}returningAll(t){return new e({...this.#props,queryNode:B.cloneWithReturning(this.#props.queryNode,F(t))})}output(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,P(t))})}outputAll(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,F(t))})}modifyEnd(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}clearReturning(){return new e({...this.#props,queryNode:B.cloneWithoutReturning(this.#props.queryNode)})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId),{adapter:n}=this.#props.executor,r=e.query;return r.returning&&n.supportsReturning||r.output&&n.supportsOutput?t.rows:[new Ht(t.numAffectedRows??t.numUpdatedOrDeletedRows??BigInt(0),t.numChangedRows)]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=At){let t=await this.executeTakeFirst();if(t===void 0)throw jt(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:B.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};N(Ut,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const Wt=l({is(e){return e.kind===`CommonTableExpressionNameNode`},create(e,t){return l({kind:`CommonTableExpressionNameNode`,table:v.create(e),columns:t?l(t.map(C.create)):void 0})}}),Gt=l({is(e){return e.kind===`CommonTableExpressionNode`},create(e,t){return l({kind:`CommonTableExpressionNode`,name:e,expression:t})},cloneWith(e,t){return l({...e,...t})}});var Kt=class e{#props;constructor(e){this.#props=l(e)}materialized(){return new e({...this.#props,node:Gt.cloneWith(this.#props.node,{materialized:!0})})}notMaterialized(){return new e({...this.#props,node:Gt.cloneWith(this.#props.node,{materialized:!1})})}toOperationNode(){return this.#props.node}};N(Kt,`don't await CTEBuilder instances. They are never executed directly and are always just a part of a query.`);function qt(e,t){let n=t(Cn()).toOperationNode();return s(e)?e(Jt(n)).toOperationNode():Gt.create(Yt(e),n)}function Jt(e){return t=>new Kt({node:Gt.create(Yt(t),e)})}function Yt(e){if(e.includes(`(`)){let t=e.split(/[\(\)]/),n=t[0],r=t[1].split(`,`).map(e=>e.trim());return Wt.create(n,r)}else return Wt.create(e)}const Xt=l({is(e){return e.kind===`WithNode`},create(e,t){return l({kind:`WithNode`,expressions:l([e]),...t})},cloneWithExpression(e,t){return l({...e,expressions:l([...e.expressions,t])})}}),Zt=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`.split(``);function Qt(e){let t=``;for(let n=0;n<e;++n)t+=$t();return t}function $t(){return Zt[~~(Math.random()*Zt.length)]}function H(){return new en}var en=class{#queryId;get queryId(){return this.#queryId===void 0&&(this.#queryId=Qt(8)),this.#queryId}};function U(e){return e}var tn=class{nodeStack=[];#transformers=l({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this),OutputNode:this.transformOutput.bind(this)});transformNode(e){if(!e)return e;this.nodeStack.push(e);let t=this.transformNodeImpl(e);return this.nodeStack.pop(),l(t)}transformNodeImpl(e){return this.#transformers[e.kind](e)}transformNodeList(e){return e&&l(e.map(e=>this.transformNode(e)))}transformSelectQuery(e){return U({kind:`SelectQueryNode`,from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations),fetch:this.transformNode(e.fetch),top:this.transformNode(e.top)})}transformSelection(e){return U({kind:`SelectionNode`,selection:this.transformNode(e.selection)})}transformColumn(e){return U({kind:`ColumnNode`,column:this.transformNode(e.column)})}transformAlias(e){return U({kind:`AliasNode`,node:this.transformNode(e.node),alias:this.transformNode(e.alias)})}transformTable(e){return U({kind:`TableNode`,table:this.transformNode(e.table)})}transformFrom(e){return U({kind:`FromNode`,froms:this.transformNodeList(e.froms)})}transformReference(e){return U({kind:`ReferenceNode`,column:this.transformNode(e.column),table:this.transformNode(e.table)})}transformAnd(e){return U({kind:`AndNode`,left:this.transformNode(e.left),right:this.transformNode(e.right)})}transformOr(e){return U({kind:`OrNode`,left:this.transformNode(e.left),right:this.transformNode(e.right)})}transformValueList(e){return U({kind:`ValueListNode`,values:this.transformNodeList(e.values)})}transformParens(e){return U({kind:`ParensNode`,node:this.transformNode(e.node)})}transformJoin(e){return U({kind:`JoinNode`,joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)})}transformRaw(e){return U({kind:`RawNode`,sqlFragments:l([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)})}transformWhere(e){return U({kind:`WhereNode`,where:this.transformNode(e.where)})}transformInsertQuery(e){return U({kind:`InsertQueryNode`,into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain),defaultValues:e.defaultValues,top:this.transformNode(e.top),output:this.transformNode(e.output)})}transformValues(e){return U({kind:`ValuesNode`,values:this.transformNodeList(e.values)})}transformDeleteQuery(e){return U({kind:`DeleteQueryNode`,from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain),top:this.transformNode(e.top),output:this.transformNode(e.output)})}transformReturning(e){return U({kind:`ReturningNode`,selections:this.transformNodeList(e.selections)})}transformCreateTable(e){return U({kind:`CreateTableNode`,table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),selectQuery:this.transformNode(e.selectQuery)})}transformColumnDefinition(e){return U({kind:`ColumnDefinitionNode`,column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),nullsNotDistinct:e.nullsNotDistinct,identity:e.identity,ifNotExists:e.ifNotExists})}transformAddColumn(e){return U({kind:`AddColumnNode`,column:this.transformNode(e.column)})}transformDropTable(e){return U({kind:`DropTableNode`,table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade})}transformOrderBy(e){return U({kind:`OrderByNode`,items:this.transformNodeList(e.items)})}transformOrderByItem(e){return U({kind:`OrderByItemNode`,orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)})}transformGroupBy(e){return U({kind:`GroupByNode`,items:this.transformNodeList(e.items)})}transformGroupByItem(e){return U({kind:`GroupByItemNode`,groupBy:this.transformNode(e.groupBy)})}transformUpdateQuery(e){return U({kind:`UpdateQueryNode`,table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),explain:this.transformNode(e.explain),limit:this.transformNode(e.limit),top:this.transformNode(e.top),output:this.transformNode(e.output)})}transformColumnUpdate(e){return U({kind:`ColumnUpdateNode`,column:this.transformNode(e.column),value:this.transformNode(e.value)})}transformLimit(e){return U({kind:`LimitNode`,limit:this.transformNode(e.limit)})}transformOffset(e){return U({kind:`OffsetNode`,offset:this.transformNode(e.offset)})}transformOnConflict(e){return U({kind:`OnConflictNode`,columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing})}transformOnDuplicateKey(e){return U({kind:`OnDuplicateKeyNode`,updates:this.transformNodeList(e.updates)})}transformCreateIndex(e){return U({kind:`CreateIndexNode`,name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where),nullsNotDistinct:e.nullsNotDistinct})}transformList(e){return U({kind:`ListNode`,items:this.transformNodeList(e.items)})}transformDropIndex(e){return U({kind:`DropIndexNode`,name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade})}transformPrimaryKeyConstraint(e){return U({kind:`PrimaryKeyConstraintNode`,columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)})}transformUniqueConstraint(e){return U({kind:`UniqueConstraintNode`,columns:this.transformNodeList(e.columns),name:this.transformNode(e.name),nullsNotDistinct:e.nullsNotDistinct})}transformForeignKeyConstraint(e){return U({kind:`ForeignKeyConstraintNode`,columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate})}transformSetOperation(e){return U({kind:`SetOperationNode`,operator:e.operator,expression:this.transformNode(e.expression),all:e.all})}transformReferences(e){return U({kind:`ReferencesNode`,table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate})}transformCheckConstraint(e){return U({kind:`CheckConstraintNode`,expression:this.transformNode(e.expression),name:this.transformNode(e.name)})}transformWith(e){return U({kind:`WithNode`,expressions:this.transformNodeList(e.expressions),recursive:e.recursive})}transformCommonTableExpression(e){return U({kind:`CommonTableExpressionNode`,name:this.transformNode(e.name),materialized:e.materialized,expression:this.transformNode(e.expression)})}transformCommonTableExpressionName(e){return U({kind:`CommonTableExpressionNameNode`,table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)})}transformHaving(e){return U({kind:`HavingNode`,having:this.transformNode(e.having)})}transformCreateSchema(e){return U({kind:`CreateSchemaNode`,schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists})}transformDropSchema(e){return U({kind:`DropSchemaNode`,schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade})}transformAlterTable(e){return U({kind:`AlterTableNode`,table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint),addIndex:this.transformNode(e.addIndex),dropIndex:this.transformNode(e.dropIndex)})}transformDropColumn(e){return U({kind:`DropColumnNode`,column:this.transformNode(e.column)})}transformRenameColumn(e){return U({kind:`RenameColumnNode`,column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)})}transformAlterColumn(e){return U({kind:`AlterColumnNode`,column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull})}transformModifyColumn(e){return U({kind:`ModifyColumnNode`,column:this.transformNode(e.column)})}transformAddConstraint(e){return U({kind:`AddConstraintNode`,constraint:this.transformNode(e.constraint)})}transformDropConstraint(e){return U({kind:`DropConstraintNode`,constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier})}transformCreateView(e){return U({kind:`CreateViewNode`,name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)})}transformDropView(e){return U({kind:`DropViewNode`,name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade})}transformGenerated(e){return U({kind:`GeneratedNode`,byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)})}transformDefaultValue(e){return U({kind:`DefaultValueNode`,defaultValue:this.transformNode(e.defaultValue)})}transformOn(e){return U({kind:`OnNode`,on:this.transformNode(e.on)})}transformSelectModifier(e){return U({kind:`SelectModifierNode`,modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier),of:this.transformNodeList(e.of)})}transformCreateType(e){return U({kind:`CreateTypeNode`,name:this.transformNode(e.name),enum:this.transformNode(e.enum)})}transformDropType(e){return U({kind:`DropTypeNode`,name:this.transformNode(e.name),ifExists:e.ifExists})}transformExplain(e){return U({kind:`ExplainNode`,format:e.format,options:this.transformNode(e.options)})}transformSchemableIdentifier(e){return U({kind:`SchemableIdentifierNode`,schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)})}transformAggregateFunction(e){return U({kind:`AggregateFunctionNode`,aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,orderBy:this.transformNode(e.orderBy),filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)})}transformOver(e){return U({kind:`OverNode`,orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)})}transformPartitionBy(e){return U({kind:`PartitionByNode`,items:this.transformNodeList(e.items)})}transformPartitionByItem(e){return U({kind:`PartitionByItemNode`,partitionBy:this.transformNode(e.partitionBy)})}transformBinaryOperation(e){return U({kind:`BinaryOperationNode`,leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)})}transformUnaryOperation(e){return U({kind:`UnaryOperationNode`,operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)})}transformUsing(e){return U({kind:`UsingNode`,tables:this.transformNodeList(e.tables)})}transformFunction(e){return U({kind:`FunctionNode`,func:e.func,arguments:this.transformNodeList(e.arguments)})}transformCase(e){return U({kind:`CaseNode`,value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement})}transformWhen(e){return U({kind:`WhenNode`,condition:this.transformNode(e.condition),result:this.transformNode(e.result)})}transformJSONReference(e){return U({kind:`JSONReferenceNode`,reference:this.transformNode(e.reference),traversal:this.transformNode(e.traversal)})}transformJSONPath(e){return U({kind:`JSONPathNode`,inOperator:this.transformNode(e.inOperator),pathLegs:this.transformNodeList(e.pathLegs)})}transformJSONPathLeg(e){return U({kind:`JSONPathLegNode`,type:e.type,value:e.value})}transformJSONOperatorChain(e){return U({kind:`JSONOperatorChainNode`,operator:this.transformNode(e.operator),values:this.transformNodeList(e.values)})}transformTuple(e){return U({kind:`TupleNode`,values:this.transformNodeList(e.values)})}transformMergeQuery(e){return U({kind:`MergeQueryNode`,into:this.transformNode(e.into),using:this.transformNode(e.using),whens:this.transformNodeList(e.whens),with:this.transformNode(e.with),top:this.transformNode(e.top),endModifiers:this.transformNodeList(e.endModifiers),output:this.transformNode(e.output)})}transformMatched(e){return U({kind:`MatchedNode`,not:e.not,bySource:e.bySource})}transformAddIndex(e){return U({kind:`AddIndexNode`,name:this.transformNode(e.name),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists})}transformCast(e){return U({kind:`CastNode`,expression:this.transformNode(e.expression),dataType:this.transformNode(e.dataType)})}transformFetch(e){return U({kind:`FetchNode`,rowCount:this.transformNode(e.rowCount),modifier:e.modifier})}transformTop(e){return U({kind:`TopNode`,expression:e.expression,modifiers:e.modifiers})}transformOutput(e){return U({kind:`OutputNode`,selections:this.transformNodeList(e.selections)})}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}};const nn=l({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0}),rn={json_agg:!0,to_json:!0};var an=class extends tn{#schema;#schemableIds=new Set;#ctes=new Set;constructor(e){super(),this.#schema=e}transformNodeImpl(e){if(!this.#isRootOperationNode(e))return super.transformNodeImpl(e);let t=this.#collectCTEs(e);for(let e of t)this.#ctes.add(e);let n=this.#collectSchemableIds(e);for(let e of n)this.#schemableIds.add(e);let r=super.transformNodeImpl(e);for(let e of n)this.#schemableIds.delete(e);for(let e of t)this.#ctes.delete(e);return r}transformSchemableIdentifier(e){let t=super.transformSchemableIdentifier(e);return t.schema||!this.#schemableIds.has(e.identifier.name)?t:{...t,schema:p.create(this.#schema)}}transformReferences(e){let t=super.transformReferences(e);return t.table.table.schema?t:{...t,table:v.createWithSchema(this.#schema,t.table.table.identifier.name)}}transformAggregateFunction(e){return{...super.transformAggregateFunction({...e,aggregated:[]}),aggregated:this.#transformTableArgsWithoutSchemas(e,`aggregated`)}}transformFunction(e){return{...super.transformFunction({...e,arguments:[]}),arguments:this.#transformTableArgsWithoutSchemas(e,`arguments`)}}#transformTableArgsWithoutSchemas(e,t){return rn[e.func]?e[t].map(e=>!v.is(e)||e.table.schema?this.transformNode(e):{...e,table:this.transformIdentifier(e.table.identifier)}):this.transformNodeList(e[t])}#isRootOperationNode(e){return e.kind in nn}#collectSchemableIds(e){let t=new Set;if(`name`in e&&e.name&&g.is(e.name)&&this.#collectSchemableId(e.name,t),`from`in e&&e.from)for(let n of e.from.froms)this.#collectSchemableIdsFromTableExpr(n,t);if(`into`in e&&e.into&&this.#collectSchemableIdsFromTableExpr(e.into,t),`table`in e&&e.table&&this.#collectSchemableIdsFromTableExpr(e.table,t),`joins`in e&&e.joins)for(let n of e.joins)this.#collectSchemableIdsFromTableExpr(n.table,t);return`using`in e&&e.using&&this.#collectSchemableIdsFromTableExpr(e.using,t),t}#collectCTEs(e){let t=new Set;return`with`in e&&e.with&&this.#collectCTEIds(e.with,t),t}#collectSchemableIdsFromTableExpr(e,t){let n=v.is(e)?e:_.is(e)&&v.is(e.node)?e.node:null;n&&this.#collectSchemableId(n.table,t)}#collectSchemableId(e,t){let n=e.identifier.name;!this.#schemableIds.has(n)&&!this.#ctes.has(n)&&t.add(n)}#collectCTEIds(e,t){for(let n of e.expressions){let e=n.name.table.table.identifier.name;this.#ctes.has(e)||t.add(e)}}},on=class{#transformer;constructor(e){this.#transformer=new an(e)}transformQuery(e){return this.#transformer.transformNode(e.node)}async transformResult(e){return e.result}};const sn=l({is(e){return e.kind===`MatchedNode`},create(e,t=!1){return l({kind:`MatchedNode`,not:e,bySource:t})}});function cn(e,t,n){return Ct.create(Xe([sn.create(!e.isMatched,e.bySource),...t&&t.length>0?[t.length===3&&n?A(t[0],t[1],t[2]):k(t)]:[]],`and`,!1))}function ln(e){return t(e)?w.create([e],[]):y(e)?e.toOperationNode():e}var un=class{#promise;#resolve;#reject;constructor(){this.#promise=new Promise((e,t)=>{this.#reject=t,this.#resolve=e})}get promise(){return this.#promise}resolve=e=>{this.#resolve&&this.#resolve(e)};reject=e=>{this.#reject&&this.#reject(e)}};const dn=new Set;function fn(e){dn.has(e)||(dn.add(e),console.log(e))}const pn=l([]);var mn=class{#plugins;constructor(e=pn){this.#plugins=e}get plugins(){return this.#plugins}transformQuery(e,t){for(let n of this.#plugins){let r=n.transformQuery({node:e,queryId:t});if(r.kind===e.kind)e=r;else throw Error([`KyselyPlugin.transformQuery must return a node`,`of the same kind that was given to it.`,`The plugin was given a ${e.kind}`,`but it returned a ${r.kind}`].join(` `))}return e}async executeQuery(e,t){return await this.provideConnection(async n=>{let r=await n.executeQuery(e),i=await this.#transformResult(r,t);return hn(r,i),i})}async*stream(e,t,n){let r=new un,i=new un;this.provideConnection(async e=>(r.resolve(e),await i.promise)).catch(e=>r.reject(e));let a=await r.promise;try{for await(let r of a.streamQuery(e,t))yield await this.#transformResult(r,n)}finally{i.resolve()}}async#transformResult(e,t){for(let n of this.#plugins)e=await n.transformResult({result:e,queryId:t});return e}};function hn(e,t){let{numAffectedRows:n}=e;n===void 0&&e.numUpdatedOrDeletedRows===void 0||n!==void 0&&t.numAffectedRows!==void 0||fn(`kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.`)}const gn=new class e extends mn{get adapter(){throw Error(`this query cannot be compiled to SQL`)}compileQuery(){throw Error(`this query cannot be compiled to SQL`)}provideConnection(){throw Error(`this query cannot be executed`)}withConnectionProvider(){throw Error(`this query cannot have a connection provider`)}withPlugin(t){return new e([...this.plugins,t])}withPlugins(t){return new e([...this.plugins,...t])}withPluginAtFront(t){return new e([t,...this.plugins])}withoutPlugins(){return new e([])}};var _n=class{numChangedRows;constructor(e){this.numChangedRows=e}},vn=class e{#props;constructor(e){this.#props=l(e)}modifyEnd(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}top(t,n){return new e({...this.#props,queryNode:B.cloneWithTop(this.#props.queryNode,It(t,n))})}using(...e){return new yn({...this.#props,queryNode:z.cloneWithUsing(this.#props.queryNode,W(`Using`,e))})}output(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,P(t))})}outputAll(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,F(t))})}};N(vn,"don't await MergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var yn=class e{#props;constructor(e){this.#props=l(e)}modifyEnd(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,t.toOperationNode())})}top(t,n){return new e({...this.#props,queryNode:B.cloneWithTop(this.#props.queryNode,It(t,n))})}whenMatched(){return this.#whenMatched([])}whenMatchedAnd(...e){return this.#whenMatched(e)}whenMatchedAndRef(e,t,n){return this.#whenMatched([e,t,n],!0)}#whenMatched(e,t){return new bn({...this.#props,queryNode:z.cloneWithWhen(this.#props.queryNode,cn({isMatched:!0},e,t))})}whenNotMatched(){return this.#whenNotMatched([])}whenNotMatchedAnd(...e){return this.#whenNotMatched(e)}whenNotMatchedAndRef(e,t,n){return this.#whenNotMatched([e,t,n],!0)}whenNotMatchedBySource(){return this.#whenNotMatched([],!1,!0)}whenNotMatchedBySourceAnd(...e){return this.#whenNotMatched(e,!1,!0)}whenNotMatchedBySourceAndRef(e,t,n){return this.#whenNotMatched([e,t,n],!0,!0)}output(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,P(t))})}outputAll(t){return new e({...this.#props,queryNode:B.cloneWithOutput(this.#props.queryNode,F(t))})}#whenNotMatched(e,t=!1,n=!1){let r={...this.#props,queryNode:z.cloneWithWhen(this.#props.queryNode,cn({isMatched:!1,bySource:n},e,t))};return new(n?bn:xn)(r)}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile(),t=await this.#props.executor.executeQuery(e,this.#props.queryId);return e.query.output&&this.#props.executor.adapter.supportsOutput?t.rows:[new _n(t.numAffectedRows)]}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=At){let t=await this.executeTakeFirst();if(t===void 0)throw jt(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}};N(yn,"don't await WheneableMergeQueryBuilder instances directly. To execute the query you need to call `execute`.");var bn=class{#props;constructor(e){this.#props=l(e)}thenDelete(){return new yn({...this.#props,queryNode:z.cloneWithThen(this.#props.queryNode,ln(`delete`))})}thenDoNothing(){return new yn({...this.#props,queryNode:z.cloneWithThen(this.#props.queryNode,ln(`do nothing`))})}thenUpdate(e){return new yn({...this.#props,queryNode:z.cloneWithThen(this.#props.queryNode,ln(e(new Ut({queryId:this.#props.queryId,executor:gn,queryNode:yt.createWithoutTable()}))))})}thenUpdateSet(...e){return this.thenUpdate(t=>t.set(...e))}};N(bn,"don't await MatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var xn=class{#props;constructor(e){this.#props=l(e)}thenDoNothing(){return new yn({...this.#props,queryNode:z.cloneWithThen(this.#props.queryNode,ln(`do nothing`))})}thenInsertValues(e){let[t,n]=ht(e);return new yn({...this.#props,queryNode:z.cloneWithThen(this.#props.queryNode,ln(I.cloneWith(I.createWithoutInto(),{columns:t,values:n})))})}};N(xn,"don't await NotMatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var Sn=class e{#props;constructor(e){this.#props=l(e)}selectFrom(e){return Bn({queryId:H(),executor:this.#props.executor,queryNode:M.createFrom(fr(e),this.#props.withNode)})}selectNoFrom(e){return Bn({queryId:H(),executor:this.#props.executor,queryNode:M.cloneWithSelections(M.create(this.#props.withNode),P(e))})}insertInto(e){return new Rt({queryId:H(),executor:this.#props.executor,queryNode:I.create(X(e),this.#props.withNode)})}replaceInto(e){return new Rt({queryId:H(),executor:this.#props.executor,queryNode:I.create(X(e),this.#props.withNode,!0)})}deleteFrom(e){return new Vt({queryId:H(),executor:this.#props.executor,queryNode:L.create(fr(e),this.#props.withNode)})}updateTable(e){return new Ut({queryId:H(),executor:this.#props.executor,queryNode:yt.create(pr(e),this.#props.withNode)})}mergeInto(e){return new vn({queryId:H(),executor:this.#props.executor,queryNode:z.create(mr(e),this.#props.withNode)})}with(t,n){let r=qt(t,n);return new e({...this.#props,withNode:this.#props.withNode?Xt.cloneWithExpression(this.#props.withNode,r):Xt.create(r)})}withRecursive(t,n){let r=qt(t,n);return new e({...this.#props,withNode:this.#props.withNode?Xt.cloneWithExpression(this.#props.withNode,r):Xt.create(r,{recursive:!0})})}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}withoutPlugins(){return new e({...this.#props,executor:this.#props.executor.withoutPlugins()})}withSchema(t){return new e({...this.#props,executor:this.#props.executor.withPluginAtFront(new on(t))})}};function Cn(){return new Sn({executor:gn})}function wn(e,t){return new ot({joinNode:ue.create(e,pr(t))})}function Tn(){return new lt({overNode:nt.create()})}function W(e,t){if(t.length===3)return Dn(e,t[0],t[1],t[2]);if(t.length===2)return En(e,t[0],t[1]);throw Error(`not implemented`)}function En(e,t,n){return n(wn(e,t)).toOperationNode()}function Dn(e,t,n,r){return ue.createWithOn(e,pr(t),A(n,`=`,r))}const On=l({is(e){return e.kind===`OffsetNode`},create(e){return l({kind:`OffsetNode`,offset:e})}}),kn=l({is(e){return e.kind===`GroupByItemNode`},create(e){return l({kind:`GroupByItemNode`,groupBy:e})}});function An(e){return e=s(e)?e(lr()):e,Ne(e).map(kn.create)}const jn=l({is(e){return e.kind===`SetOperationNode`},create(e,t,n){return l({kind:`SetOperationNode`,operator:e,expression:t,all:n})}});function Mn(e,t,n){return s(t)&&(t=t(cr())),u(t)||(t=[t]),t.map(t=>jn.create(e,Y(t),n))}var G=class e{#node;constructor(e){this.#node=e}get expressionType(){}as(e){return new Nn(this,e)}or(...e){return new Pn(ce.create(this.#node,k(e)))}and(...e){return new Fn(x.create(this.#node,k(e)))}$castTo(){return new e(this.#node)}$notNull(){return new e(this.#node)}toOperationNode(){return this.#node}},Nn=class{#expr;#alias;constructor(e,t){this.#expr=e,this.#alias=t}get expression(){return this.#expr}get alias(){return this.#alias}toOperationNode(){return _.create(this.#expr.toOperationNode(),y(this.#alias)?this.#alias.toOperationNode():p.create(this.#alias))}},Pn=class e{#node;constructor(e){this.#node=e}get expressionType(){}as(e){return new Nn(this,e)}or(...t){return new e(ce.create(this.#node,k(t)))}$castTo(){return new e(this.#node)}toOperationNode(){return qe.create(this.#node)}},Fn=class e{#node;constructor(e){this.#node=e}get expressionType(){}as(e){return new Nn(this,e)}and(...t){return new e(x.create(this.#node,k(t)))}$castTo(){return new e(this.#node)}toOperationNode(){return qe.create(this.#node)}};const In={is(e){return e.kind===`FetchNode`},create(e,t){return{kind:`FetchNode`,rowCount:D.create(e),modifier:t}}};function Ln(e,t){if(!n(e)&&!o(e))throw Error(`Invalid fetch row count: ${e}`);if(!Rn(t))throw Error(`Invalid fetch modifier: ${t}`);return In.create(e,t)}function Rn(e){return e===`only`||e===`with ties`}var zn=class e{#props;constructor(e){this.#props=l(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...t){return new e({...this.#props,queryNode:B.cloneWithWhere(this.#props.queryNode,k(t))})}whereRef(t,n,r){return new e({...this.#props,queryNode:B.cloneWithWhere(this.#props.queryNode,A(t,n,r))})}having(...t){return new e({...this.#props,queryNode:M.cloneWithHaving(this.#props.queryNode,k(t))})}havingRef(t,n,r){return new e({...this.#props,queryNode:M.cloneWithHaving(this.#props.queryNode,A(t,n,r))})}select(t){return new e({...this.#props,queryNode:M.cloneWithSelections(this.#props.queryNode,P(t))})}distinctOn(t){return new e({...this.#props,queryNode:M.cloneWithDistinctOn(this.#props.queryNode,Ne(t))})}modifyFront(t){return new e({...this.#props,queryNode:M.cloneWithFrontModifier(this.#props.queryNode,b.createWithExpression(t.toOperationNode()))})}modifyEnd(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.createWithExpression(t.toOperationNode()))})}distinct(){return new e({...this.#props,queryNode:M.cloneWithFrontModifier(this.#props.queryNode,b.create(`Distinct`))})}forUpdate(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.create(`ForUpdate`,t?ee(t).map(X):void 0))})}forShare(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.create(`ForShare`,t?ee(t).map(X):void 0))})}forKeyShare(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.create(`ForKeyShare`,t?ee(t).map(X):void 0))})}forNoKeyUpdate(t){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.create(`ForNoKeyUpdate`,t?ee(t).map(X):void 0))})}skipLocked(){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.create(`SkipLocked`))})}noWait(){return new e({...this.#props,queryNode:B.cloneWithEndModifier(this.#props.queryNode,b.create(`NoWait`))})}selectAll(t){return new e({...this.#props,queryNode:M.cloneWithSelections(this.#props.queryNode,F(t))})}innerJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`InnerJoin`,t))})}leftJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`LeftJoin`,t))})}rightJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`RightJoin`,t))})}fullJoin(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`FullJoin`,t))})}innerJoinLateral(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`LateralInnerJoin`,t))})}leftJoinLateral(...t){return new e({...this.#props,queryNode:B.cloneWithJoin(this.#props.queryNode,W(`LateralLeftJoin`,t))})}orderBy(...t){return new e({...this.#props,queryNode:M.cloneWithOrderByItems(this.#props.queryNode,Te(t))})}groupBy(t){return new e({...this.#props,queryNode:M.cloneWithGroupByItems(this.#props.queryNode,An(t))})}limit(t){return new e({...this.#props,queryNode:M.cloneWithLimit(this.#props.queryNode,Bt.create(O(t)))})}offset(t){return new e({...this.#props,queryNode:M.cloneWithOffset(this.#props.queryNode,On.create(O(t)))})}fetch(t,n=`only`){return new e({...this.#props,queryNode:M.cloneWithFetch(this.#props.queryNode,Ln(t,n))})}top(t,n){return new e({...this.#props,queryNode:B.cloneWithTop(this.#props.queryNode,It(t,n))})}union(t){return new e({...this.#props,queryNode:M.cloneWithSetOperations(this.#props.queryNode,Mn(`union`,t,!1))})}unionAll(t){return new e({...this.#props,queryNode:M.cloneWithSetOperations(this.#props.queryNode,Mn(`union`,t,!0))})}intersect(t){return new e({...this.#props,queryNode:M.cloneWithSetOperations(this.#props.queryNode,Mn(`intersect`,t,!1))})}intersectAll(t){return new e({...this.#props,queryNode:M.cloneWithSetOperations(this.#props.queryNode,Mn(`intersect`,t,!0))})}except(t){return new e({...this.#props,queryNode:M.cloneWithSetOperations(this.#props.queryNode,Mn(`except`,t,!1))})}exceptAll(t){return new e({...this.#props,queryNode:M.cloneWithSetOperations(this.#props.queryNode,Mn(`except`,t,!0))})}as(e){return new Vn(this,e)}clearSelect(){return new e({...this.#props,queryNode:M.cloneWithoutSelections(this.#props.queryNode)})}clearWhere(){return new e({...this.#props,queryNode:B.cloneWithoutWhere(this.#props.queryNode)})}clearLimit(){return new e({...this.#props,queryNode:M.cloneWithoutLimit(this.#props.queryNode)})}clearOffset(){return new e({...this.#props,queryNode:M.cloneWithoutOffset(this.#props.queryNode)})}clearOrderBy(){return new e({...this.#props,queryNode:M.cloneWithoutOrderBy(this.#props.queryNode)})}clearGroupBy(){return new e({...this.#props,queryNode:M.cloneWithoutGroupBy(this.#props.queryNode)})}$call(e){return e(this)}$if(t,n){return t?n(this):new e({...this.#props})}$castTo(){return new e(this.#props)}$narrowType(){return new e(this.#props)}$assertType(){return new e(this.#props)}$asTuple(){return new G(this.toOperationNode())}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.queryNode,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){let e=this.compile();return(await this.#props.executor.executeQuery(e,this.#props.queryId)).rows}async executeTakeFirst(){let[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=At){let t=await this.executeTakeFirst();if(t===void 0)throw jt(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){let t=this.compile(),n=this.#props.executor.stream(t,e,this.#props.queryId);for await(let e of n)yield*e.rows}async explain(t,n){return await new e({...this.#props,queryNode:B.cloneWithExplain(this.#props.queryNode,t,n)}).execute()}};N(zn,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");function Bn(e){return new zn(e)}var Vn=class{#queryBuilder;#alias;constructor(e,t){this.#queryBuilder=e,this.#alias=t}get expression(){return this.#queryBuilder}get alias(){return this.#alias}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return _.create(this.#queryBuilder.toOperationNode(),p.create(this.#alias))}};N(Vn,`don't await AliasedSelectQueryBuilder instances directly. AliasedSelectQueryBuilder should never be executed directly since it's always a part of another query.`);const K=l({is(e){return e.kind===`AggregateFunctionNode`},create(e,t=[]){return l({kind:`AggregateFunctionNode`,func:e,aggregated:t})},cloneWithDistinct(e){return l({...e,distinct:!0})},cloneWithOrderBy(e,t){return l({...e,orderBy:e.orderBy?j.cloneWithItems(e.orderBy,t):j.create(t)})},cloneWithFilter(e,t){return l({...e,filter:e.filter?R.cloneWithOperation(e.filter,`And`,t):R.create(t)})},cloneWithOrFilter(e,t){return l({...e,filter:e.filter?R.cloneWithOperation(e.filter,`Or`,t):R.create(t)})},cloneWithOver(e,t){return l({...e,over:t})}}),Hn=l({is(e){return e.kind===`FunctionNode`},create(e,t){return l({kind:`FunctionNode`,func:e,arguments:t})}});var Un=class e{#props;constructor(e){this.#props=l(e)}get expressionType(){}as(e){return new Wn(this,e)}distinct(){return new e({...this.#props,aggregateFunctionNode:K.cloneWithDistinct(this.#props.aggregateFunctionNode)})}orderBy(t,n){return new e({...this.#props,aggregateFunctionNode:K.cloneWithOrderBy(this.#props.aggregateFunctionNode,Te([t,n]))})}filterWhere(...t){return new e({...this.#props,aggregateFunctionNode:K.cloneWithFilter(this.#props.aggregateFunctionNode,k(t))})}filterWhereRef(t,n,r){return new e({...this.#props,aggregateFunctionNode:K.cloneWithFilter(this.#props.aggregateFunctionNode,A(t,n,r))})}over(t){let n=Tn();return new e({...this.#props,aggregateFunctionNode:K.cloneWithOver(this.#props.aggregateFunctionNode,(t?t(n):n).toOperationNode())})}$call(e){return e(this)}$castTo(){return new e(this.#props)}$notNull(){return new e(this.#props)}toOperationNode(){return this.#props.aggregateFunctionNode}};N(Un,`don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.`);var Wn=class{#aggregateFunctionBuilder;#alias;constructor(e,t){this.#aggregateFunctionBuilder=e,this.#alias=t}get expression(){return this.#aggregateFunctionBuilder}get alias(){return this.#alias}toOperationNode(){return _.create(this.#aggregateFunctionBuilder.toOperationNode(),p.create(this.#alias))}};function Gn(){let e=(e,t)=>new G(Hn.create(e,Ne(t??[]))),n=(e,t)=>new Un({aggregateFunctionNode:K.create(e,t?Ne(t):void 0)});return Object.assign(e,{agg:n,avg(e){return n(`avg`,[e])},coalesce(...t){return e(`coalesce`,t)},count(e){return n(`count`,[e])},countAll(e){return new Un({aggregateFunctionNode:K.create(`count`,F(e))})},max(e){return n(`max`,[e])},min(e){return n(`min`,[e])},sum(e){return n(`sum`,[e])},any(t){return e(`any`,[t])},jsonAgg(e){return new Un({aggregateFunctionNode:K.create(`json_agg`,[t(e)?X(e):e.toOperationNode()])})},toJson(e){return new G(Hn.create(`to_json`,[t(e)?X(e):e.toOperationNode()]))}})}const Kn=l({is(e){return e.kind===`UnaryOperationNode`},create(e,t){return l({kind:`UnaryOperationNode`,operator:e,operand:t})}});function qn(e,t){return Kn.create(S.create(e),T(t))}const q=l({is(e){return e.kind===`CaseNode`},create(e){return l({kind:`CaseNode`,value:e})},cloneWithWhen(e,t){return l({...e,when:l(e.when?[...e.when,t]:[t])})},cloneWithThen(e,t){return l({...e,when:e.when?l([...e.when.slice(0,-1),Ct.cloneWithResult(e.when[e.when.length-1],t)]):void 0})},cloneWith(e,t){return l({...e,...t})}});var Jn=class{#props;constructor(e){this.#props=l(e)}when(...e){return new Yn({...this.#props,node:q.cloneWithWhen(this.#props.node,Ct.create(k(e)))})}},Yn=class{#props;constructor(e){this.#props=l(e)}then(e){return new Xn({...this.#props,node:q.cloneWithThen(this.#props.node,We(e)?Ge(e):O(e))})}},Xn=class{#props;constructor(e){this.#props=l(e)}when(...e){return new Yn({...this.#props,node:q.cloneWithWhen(this.#props.node,Ct.create(k(e)))})}else(e){return new Zn({...this.#props,node:q.cloneWith(this.#props.node,{else:We(e)?Ge(e):O(e)})})}end(){return new G(q.cloneWith(this.#props.node,{isStatement:!1}))}endCase(){return new G(q.cloneWith(this.#props.node,{isStatement:!0}))}},Zn=class{#props;constructor(e){this.#props=l(e)}end(){return new G(q.cloneWith(this.#props.node,{isStatement:!1}))}endCase(){return new G(q.cloneWith(this.#props.node,{isStatement:!0}))}};const Qn=l({is(e){return e.kind===`JSONPathLegNode`},create(e,t){return l({kind:`JSONPathLegNode`,type:e,value:t})}});var $n=class{#node;constructor(e){this.#node=e}at(e){return this.#createBuilderWithPathLeg(`ArrayLocation`,e)}key(e){return this.#createBuilderWithPathLeg(`Member`,e)}#createBuilderWithPathLeg(e,t){return ke.is(this.#node)?new er(ke.cloneWithTraversal(this.#node,je.is(this.#node.traversal)?je.cloneWithLeg(this.#node.traversal,Qn.create(e,t)):Ae.cloneWithValue(this.#node.traversal,D.createImmediate(t)))):new er(je.cloneWithLeg(this.#node,Qn.create(e,t)))}},er=class e extends $n{#node;constructor(e){super(e),this.#node=e}get expressionType(){}as(e){return new tr(this,e)}$castTo(){return new e(this.#node)}$notNull(){return new e(this.#node)}toOperationNode(){return this.#node}},tr=class{#jsonPath;#alias;constructor(e,t){this.#jsonPath=e,this.#alias=t}get expression(){return this.#jsonPath}get alias(){return this.#alias}toOperationNode(){return _.create(this.#jsonPath.toOperationNode(),y(this.#alias)?this.#alias.toOperationNode():p.create(this.#alias))}};const nr=l({is(e){return e.kind===`TupleNode`},create(e){return l({kind:`TupleNode`,values:l(e)})}}),rr=`varchar.char.text.integer.int2.int4.int8.smallint.bigint.boolean.real.double precision.float4.float8.decimal.numeric.binary.bytea.date.datetime.time.timetz.timestamp.timestamptz.serial.bigserial.uuid.json.jsonb.blob.varbinary.int4range.int4multirange.int8range.int8multirange.numrange.nummultirange.tsrange.tsmultirange.tstzrange.tstzmultirange.daterange.datemultirange`.split(`.`),ir=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timetz\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/,/^varbinary\(\d+\)$/],ar=l({is(e){return e.kind===`DataTypeNode`},create(e){return l({kind:`DataTypeNode`,dataType:e})}});function or(e){return!!(rr.includes(e)||ir.some(t=>t.test(e)))}function J(e){if(y(e))return e.toOperationNode();if(or(e))return ar.create(e);throw Error(`invalid column data type ${JSON.stringify(e)}`)}const sr=l({is(e){return e.kind===`CastNode`},create(e,t){return l({kind:`CastNode`,expression:e,dataType:t})}});function cr(t=gn){function n(e,t,n){return new G(Je(e,t,n))}function r(e,t){return new G(qn(e,t))}let i=Object.assign(n,{fn:void 0,eb:void 0,selectFrom(e){return Bn({queryId:H(),executor:t,queryNode:M.createFrom(fr(e))})},case(t){return new Jn({node:q.create(e(t)?void 0:T(t))})},ref(t,n){return e(n)?new G(E(t)):new $n(Pe(t,n))},jsonPath(){return new $n(je.create())},table(e){return new G(X(e))},val(e){return new G(O(e))},refTuple(...e){return new G(nr.create(e.map(T)))},tuple(...e){return new G(nr.create(e.map(O)))},lit(e){return new G(Ge(e))},unary:r,not(e){return r(`not`,e)},exists(e){return r(`exists`,e)},neg(e){return r(`-`,e)},between(e,t,n){return new G(de.create(T(e),S.create(`between`),x.create(O(t),O(n))))},betweenSymmetric(e,t,n){return new G(de.create(T(e),S.create(`between symmetric`),x.create(O(t),O(n))))},and(e){return u(e)?new G(Xe(e,`and`)):new G(Ye(e,`and`))},or(e){return u(e)?new G(Xe(e,`or`)):new G(Ye(e,`or`))},parens(...e){let t=k(e);return qe.is(t)?new G(t):new G(qe.create(t))},cast(e,t){return new G(sr.create(T(e),J(t)))},withSchema(e){return cr(t.withPluginAtFront(new on(e)))}});return i.fn=Gn(),i.eb=i,i}function lr(e){return cr()}function Y(e){if(y(e))return e.toOperationNode();if(s(e))return e(lr()).toOperationNode();throw Error(`invalid expression: ${JSON.stringify(e)}`)}function ur(e){if(y(e))return e.toOperationNode();if(s(e))return e(lr()).toOperationNode();throw Error(`invalid aliased expression: ${JSON.stringify(e)}`)}function dr(e){return oe(e)||se(e)||s(e)}function fr(e){return u(e)?e.map(e=>pr(e)):[pr(e)]}function pr(e){return t(e)?mr(e):ur(e)}function mr(e){let t=` as `;if(e.includes(t)){let[n,r]=e.split(t).map(hr);return _.create(X(n),p.create(r))}else return X(e)}function X(e){if(e.includes(`.`)){let[t,n]=e.split(`.`).map(hr);return v.createWithSchema(t,n)}else return v.create(e)}function hr(e){return e.trim()}const gr=l({is(e){return e.kind===`AddColumnNode`},create(e){return l({kind:`AddColumnNode`,column:e})}}),Z=l({is(e){return e.kind===`ColumnDefinitionNode`},create(e,t){return l({kind:`ColumnDefinitionNode`,column:C.create(e),dataType:t})},cloneWithFrontModifier(e,t){return l({...e,frontModifiers:e.frontModifiers?l([...e.frontModifiers,t]):[t]})},cloneWithEndModifier(e,t){return l({...e,endModifiers:e.endModifiers?l([...e.endModifiers,t]):[t]})},cloneWith(e,t){return l({...e,...t})}}),_r=l({is(e){return e.kind===`DropColumnNode`},create(e){return l({kind:`DropColumnNode`,column:C.create(e)})}}),vr=l({is(e){return e.kind===`RenameColumnNode`},create(e,t){return l({kind:`RenameColumnNode`,column:C.create(e),renameTo:C.create(t)})}}),yr=l({is(e){return e.kind===`CheckConstraintNode`},create(e,t){return l({kind:`CheckConstraintNode`,expression:e,name:t?p.create(t):void 0})}}),br=[`no action`,`restrict`,`cascade`,`set null`,`set default`],xr=l({is(e){return e.kind===`ReferencesNode`},create(e,t){return l({kind:`ReferencesNode`,table:e,columns:l([...t])})},cloneWithOnDelete(e,t){return l({...e,onDelete:t})},cloneWithOnUpdate(e,t){return l({...e,onUpdate:t})}});function Sr(e){return y(e)?e.toOperationNode():D.createImmediate(e)}const Cr=l({is(e){return e.kind===`GeneratedNode`},create(e){return l({kind:`GeneratedNode`,...e})},createWithExpression(e){return l({kind:`GeneratedNode`,always:!0,expression:e})},cloneWith(e,t){return l({...e,...t})}}),wr=l({is(e){return e.kind===`DefaultValueNode`},create(e){return l({kind:`DefaultValueNode`,defaultValue:e})}});function Tr(e){if(br.includes(e))return e;throw Error(`invalid OnModifyForeignAction ${e}`)}var Er=class e{#node;constructor(e){this.#node=e}autoIncrement(){return new e(Z.cloneWith(this.#node,{autoIncrement:!0}))}identity(){return new e(Z.cloneWith(this.#node,{identity:!0}))}primaryKey(){return new e(Z.cloneWith(this.#node,{primaryKey:!0}))}references(t){let n=E(t);if(!n.table||ye.is(n.column))throw Error(`invalid call references('${t}'). The reference must have format table.column or schema.table.column`);return new e(Z.cloneWith(this.#node,{references:xr.create(n.table,[n.column])}))}onDelete(t){if(!this.#node.references)throw Error(`on delete constraint can only be added for foreign keys`);return new e(Z.cloneWith(this.#node,{references:xr.cloneWithOnDelete(this.#node.references,Tr(t))}))}onUpdate(t){if(!this.#node.references)throw Error(`on update constraint can only be added for foreign keys`);return new e(Z.cloneWith(this.#node,{references:xr.cloneWithOnUpdate(this.#node.references,Tr(t))}))}unique(){return new e(Z.cloneWith(this.#node,{unique:!0}))}notNull(){return new e(Z.cloneWith(this.#node,{notNull:!0}))}unsigned(){return new e(Z.cloneWith(this.#node,{unsigned:!0}))}defaultTo(t){return new e(Z.cloneWith(this.#node,{defaultTo:wr.create(Sr(t))}))}check(t){return new e(Z.cloneWith(this.#node,{check:yr.create(t.toOperationNode())}))}generatedAlwaysAs(t){return new e(Z.cloneWith(this.#node,{generated:Cr.createWithExpression(t.toOperationNode())}))}generatedAlwaysAsIdentity(){return new e(Z.cloneWith(this.#node,{generated:Cr.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new e(Z.cloneWith(this.#node,{generated:Cr.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#node.generated)throw Error(`stored() can only be called after generatedAlwaysAs`);return new e(Z.cloneWith(this.#node,{generated:Cr.cloneWith(this.#node.generated,{stored:!0})}))}modifyFront(t){return new e(Z.cloneWithFrontModifier(this.#node,t.toOperationNode()))}nullsNotDistinct(){return new e(Z.cloneWith(this.#node,{nullsNotDistinct:!0}))}ifNotExists(){return new e(Z.cloneWith(this.#node,{ifNotExists:!0}))}modifyEnd(t){return new e(Z.cloneWithEndModifier(this.#node,t.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#node}};N(Er,`don't await ColumnDefinitionBuilder instances directly.`);const Dr=l({is(e){return e.kind===`ModifyColumnNode`},create(e){return l({kind:`ModifyColumnNode`,column:e})}}),Or=l({is(e){return e.kind===`ForeignKeyConstraintNode`},create(e,t,n,r){return l({kind:`ForeignKeyConstraintNode`,columns:e,references:xr.create(t,n),name:r?p.create(r):void 0})},cloneWith(e,t){return l({...e,...t})}});var kr=class e{#node;constructor(e){this.#node=e}onDelete(t){return new e(Or.cloneWith(this.#node,{onDelete:Tr(t)}))}onUpdate(t){return new e(Or.cloneWith(this.#node,{onUpdate:Tr(t)}))}$call(e){return e(this)}toOperationNode(){return this.#node}};N(kr,`don't await ForeignKeyConstraintBuilder instances directly.`);const Ar=l({is(e){return e.kind===`AddConstraintNode`},create(e){return l({kind:`AddConstraintNode`,constraint:e})}}),jr=l({is(e){return e.kind===`UniqueConstraintNode`},create(e,t,n){return l({kind:`UniqueConstraintNode`,columns:l(e.map(C.create)),name:t?p.create(t):void 0,nullsNotDistinct:n})},cloneWith(e,t){return l({...e,...t})}}),Mr=l({is(e){return e.kind===`DropConstraintNode`},create(e){return l({kind:`DropConstraintNode`,constraintName:p.create(e)})},cloneWith(e,t){return l({...e,...t})}}),Nr=l({is(e){return e.kind===`AlterColumnNode`},create(e,t,n){return l({kind:`AlterColumnNode`,column:C.create(e),[t]:n})}});var Pr=class{#column;constructor(e){this.#column=e}setDataType(e){return new Fr(Nr.create(this.#column,`dataType`,J(e)))}setDefault(e){return new Fr(Nr.create(this.#column,`setDefault`,Sr(e)))}dropDefault(){return new Fr(Nr.create(this.#column,`dropDefault`,!0))}setNotNull(){return new Fr(Nr.create(this.#column,`setNotNull`,!0))}dropNotNull(){return new Fr(Nr.create(this.#column,`dropNotNull`,!0))}$call(e){return e(this)}};N(Pr,`don't await AlterColumnBuilder instances`);var Fr=class{#alterColumnNode;constructor(e){this.#alterColumnNode=e}toOperationNode(){return this.#alterColumnNode}};N(Fr,`don't await AlteredColumnBuilder instances`);var Ir=class{#props;constructor(e){this.#props=l(e)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Ir,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");var Lr=class e{#props;constructor(e){this.#props=l(e)}onDelete(t){return new e({...this.#props,constraintBuilder:this.#props.constraintBuilder.onDelete(t)})}onUpdate(t){return new e({...this.#props,constraintBuilder:this.#props.constraintBuilder.onUpdate(t)})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(f.cloneWithTableProps(this.#props.node,{addConstraint:Ar.create(this.#props.constraintBuilder.toOperationNode())}),this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Lr,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");var Rr=class e{#props;constructor(e){this.#props=l(e)}ifExists(){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{dropConstraint:Mr.cloneWith(this.#props.node.dropConstraint,{ifExists:!0})})})}cascade(){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{dropConstraint:Mr.cloneWith(this.#props.node.dropConstraint,{modifier:`cascade`})})})}restrict(){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{dropConstraint:Mr.cloneWith(this.#props.node.dropConstraint,{modifier:`restrict`})})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Rr,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");const zr=l({is(e){return e.kind===`PrimaryKeyConstraintNode`},create(e,t){return l({kind:`PrimaryKeyConstraintNode`,columns:l(e.map(C.create)),name:t?p.create(t):void 0})}}),Br=l({is(e){return e.kind===`AddIndexNode`},create(e){return l({kind:`AddIndexNode`,name:p.create(e)})},cloneWith(e,t){return l({...e,...t})},cloneWithColumns(e,t){return l({...e,columns:[...e.columns||[],...t]})}});var Vr=class e{#props;constructor(e){this.#props=l(e)}unique(){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addIndex:Br.cloneWith(this.#props.node.addIndex,{unique:!0})})})}column(t){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addIndex:Br.cloneWithColumns(this.#props.node.addIndex,[Le(t)])})})}columns(t){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addIndex:Br.cloneWithColumns(this.#props.node.addIndex,t.map(Le))})})}expression(t){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addIndex:Br.cloneWithColumns(this.#props.node.addIndex,[t.toOperationNode()])})})}using(t){return new e({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addIndex:Br.cloneWith(this.#props.node.addIndex,{using:w.createWithSql(t)})})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Vr,"don't await AlterTableAddIndexBuilder instances directly. To execute the query you need to call `execute`");var Hr=class e{#node;constructor(e){this.#node=e}toOperationNode(){return this.#node}nullsNotDistinct(){return new e(jr.cloneWith(this.#node,{nullsNotDistinct:!0}))}};N(Hr,`don't await UniqueConstraintNodeBuilder instances directly.`);var Ur=class{#props;constructor(e){this.#props=l(e)}renameTo(e){return new Ir({...this.#props,node:f.cloneWithTableProps(this.#props.node,{renameTo:X(e)})})}setSchema(e){return new Ir({...this.#props,node:f.cloneWithTableProps(this.#props.node,{setSchema:p.create(e)})})}alterColumn(e,t){let n=t(new Pr(e));return new Wr({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,n.toOperationNode())})}dropColumn(e){return new Wr({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,_r.create(e))})}renameColumn(e,t){return new Wr({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,vr.create(e,t))})}addColumn(e,t,n=d){let r=n(new Er(Z.create(e,J(t))));return new Wr({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,gr.create(r.toOperationNode()))})}modifyColumn(e,t,n=d){let r=n(new Er(Z.create(e,J(t))));return new Wr({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,Dr.create(r.toOperationNode()))})}addUniqueConstraint(e,t,n=d){let r=n(new Hr(jr.create(t,e)));return new Ir({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addConstraint:Ar.create(r.toOperationNode())})})}addCheckConstraint(e,t){return new Ir({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addConstraint:Ar.create(yr.create(t.toOperationNode(),e))})})}addForeignKeyConstraint(e,t,n,r){return new Lr({...this.#props,constraintBuilder:new kr(Or.create(t.map(C.create),X(n),r.map(C.create),e))})}addPrimaryKeyConstraint(e,t){return new Ir({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addConstraint:Ar.create(zr.create(t,e))})})}dropConstraint(e){return new Rr({...this.#props,node:f.cloneWithTableProps(this.#props.node,{dropConstraint:Mr.create(e)})})}addIndex(e){return new Vr({...this.#props,node:f.cloneWithTableProps(this.#props.node,{addIndex:Br.create(e)})})}dropIndex(e){return new Ir({...this.#props,node:f.cloneWithTableProps(this.#props.node,{dropIndex:re.create(e)})})}$call(e){return e(this)}};N(Ur,`don't await AlterTableBuilder instances`);var Wr=class e{#props;constructor(e){this.#props=l(e)}alterColumn(t,n){let r=n(new Pr(t));return new e({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,r.toOperationNode())})}dropColumn(t){return new e({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,_r.create(t))})}renameColumn(t,n){return new e({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,vr.create(t,n))})}addColumn(t,n,r=d){let i=r(new Er(Z.create(t,J(n))));return new e({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,gr.create(i.toOperationNode()))})}modifyColumn(t,n,r=d){let i=r(new Er(Z.create(t,J(n))));return new e({...this.#props,node:f.cloneWithColumnAlteration(this.#props.node,Dr.create(i.toOperationNode()))})}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Wr,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");var Gr=class extends tn{transformValue(e){return{...super.transformValue(e),immediate:!0}}},Kr=class e{#props;constructor(e){this.#props=l(e)}ifNotExists(){return new e({...this.#props,node:m.cloneWith(this.#props.node,{ifNotExists:!0})})}unique(){return new e({...this.#props,node:m.cloneWith(this.#props.node,{unique:!0})})}nullsNotDistinct(){return new e({...this.#props,node:m.cloneWith(this.#props.node,{nullsNotDistinct:!0})})}on(t){return new e({...this.#props,node:m.cloneWith(this.#props.node,{table:X(t)})})}column(t){return new e({...this.#props,node:m.cloneWithColumns(this.#props.node,[Le(t)])})}columns(t){return new e({...this.#props,node:m.cloneWithColumns(this.#props.node,t.map(Le))})}expression(t){return new e({...this.#props,node:m.cloneWithColumns(this.#props.node,[t.toOperationNode()])})}using(t){return new e({...this.#props,node:m.cloneWith(this.#props.node,{using:w.createWithSql(t)})})}where(...t){let n=new Gr;return new e({...this.#props,node:B.cloneWithWhere(this.#props.node,n.transformNode(k(t)))})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Kr,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");var qr=class e{#props;constructor(e){this.#props=l(e)}ifNotExists(){return new e({...this.#props,node:te.cloneWith(this.#props.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(qr,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");function Jr(e){if(ne.includes(e))return e;throw Error(`invalid OnCommitAction ${e}`)}var Yr=class e{#props;constructor(e){this.#props=l(e)}temporary(){return new e({...this.#props,node:h.cloneWith(this.#props.node,{temporary:!0})})}onCommit(t){return new e({...this.#props,node:h.cloneWith(this.#props.node,{onCommit:Jr(t)})})}ifNotExists(){return new e({...this.#props,node:h.cloneWith(this.#props.node,{ifNotExists:!0})})}addColumn(t,n,r=d){let i=r(new Er(Z.create(t,J(n))));return new e({...this.#props,node:h.cloneWithColumn(this.#props.node,i.toOperationNode())})}addPrimaryKeyConstraint(t,n){return new e({...this.#props,node:h.cloneWithConstraint(this.#props.node,zr.create(n,t))})}addUniqueConstraint(t,n,r=d){let i=r(new Hr(jr.create(n,t)));return new e({...this.#props,node:h.cloneWithConstraint(this.#props.node,i.toOperationNode())})}addCheckConstraint(t,n){return new e({...this.#props,node:h.cloneWithConstraint(this.#props.node,yr.create(n.toOperationNode(),t))})}addForeignKeyConstraint(t,n,r,i,a=d){let o=a(new kr(Or.create(n.map(C.create),X(r),i.map(C.create),t)));return new e({...this.#props,node:h.cloneWithConstraint(this.#props.node,o.toOperationNode())})}modifyFront(t){return new e({...this.#props,node:h.cloneWithFrontModifier(this.#props.node,t.toOperationNode())})}modifyEnd(t){return new e({...this.#props,node:h.cloneWithEndModifier(this.#props.node,t.toOperationNode())})}as(t){return new e({...this.#props,node:h.cloneWith(this.#props.node,{selectQuery:Y(t)})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Yr,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");var Xr=class e{#props;constructor(e){this.#props=l(e)}on(t){return new e({...this.#props,node:re.cloneWith(this.#props.node,{table:X(t)})})}ifExists(){return new e({...this.#props,node:re.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:re.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Xr,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");var Zr=class e{#props;constructor(e){this.#props=l(e)}ifExists(){return new e({...this.#props,node:ie.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:ie.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Zr,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");var Qr=class e{#props;constructor(e){this.#props=l(e)}ifExists(){return new e({...this.#props,node:ae.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:ae.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(Qr,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const Q=l({is(e){return e.kind===`CreateViewNode`},create(e){return l({kind:`CreateViewNode`,name:g.create(e)})},cloneWith(e,t){return l({...e,...t})}});var $r=class{#transformer=new Gr;transformQuery(e){return this.#transformer.transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}},ei=class e{#props;constructor(e){this.#props=l(e)}temporary(){return new e({...this.#props,node:Q.cloneWith(this.#props.node,{temporary:!0})})}materialized(){return new e({...this.#props,node:Q.cloneWith(this.#props.node,{materialized:!0})})}ifNotExists(){return new e({...this.#props,node:Q.cloneWith(this.#props.node,{ifNotExists:!0})})}orReplace(){return new e({...this.#props,node:Q.cloneWith(this.#props.node,{orReplace:!0})})}columns(t){return new e({...this.#props,node:Q.cloneWith(this.#props.node,{columns:t.map(Ie)})})}as(t){let n=t.withPlugin(new $r).toOperationNode();return new e({...this.#props,node:Q.cloneWith(this.#props.node,{as:n})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(ei,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const ti=l({is(e){return e.kind===`DropViewNode`},create(e){return l({kind:`DropViewNode`,name:g.create(e)})},cloneWith(e,t){return l({...e,...t})}});var ni=class e{#props;constructor(e){this.#props=l(e)}materialized(){return new e({...this.#props,node:ti.cloneWith(this.#props.node,{materialized:!0})})}ifExists(){return new e({...this.#props,node:ti.cloneWith(this.#props.node,{ifExists:!0})})}cascade(){return new e({...this.#props,node:ti.cloneWith(this.#props.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(ni,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const ri=l({is(e){return e.kind===`CreateTypeNode`},create(e){return l({kind:`CreateTypeNode`,name:e})},cloneWithEnum(e,t){return l({...e,enum:He.create(t.map(e=>D.createImmediate(e)))})}});var ii=class e{#props;constructor(e){this.#props=l(e)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}asEnum(t){return new e({...this.#props,node:ri.cloneWithEnum(this.#props.node,t)})}$call(e){return e(this)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(ii,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const ai=l({is(e){return e.kind===`DropTypeNode`},create(e){return l({kind:`DropTypeNode`,name:e})},cloneWith(e,t){return l({...e,...t})}});var oi=class e{#props;constructor(e){this.#props=l(e)}ifExists(){return new e({...this.#props,node:ai.cloneWith(this.#props.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#props.executor.transformQuery(this.#props.node,this.#props.queryId)}compile(){return this.#props.executor.compileQuery(this.toOperationNode(),this.#props.queryId)}async execute(){await this.#props.executor.executeQuery(this.compile(),this.#props.queryId)}};N(oi,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function si(e){if(e.includes(`.`)){let t=e.split(`.`).map(ci);if(t.length===2)return g.createWithSchema(t[0],t[1]);throw Error(`invalid schemable identifier ${e}`)}else return g.create(e)}function ci(e){return e.trim()}var li=class e{#executor;constructor(e){this.#executor=e}createTable(e){return new Yr({queryId:H(),executor:this.#executor,node:h.create(X(e))})}dropTable(e){return new Qr({queryId:H(),executor:this.#executor,node:ae.create(X(e))})}createIndex(e){return new Kr({queryId:H(),executor:this.#executor,node:m.create(e)})}dropIndex(e){return new Xr({queryId:H(),executor:this.#executor,node:re.create(e)})}createSchema(e){return new qr({queryId:H(),executor:this.#executor,node:te.create(e)})}dropSchema(e){return new Zr({queryId:H(),executor:this.#executor,node:ie.create(e)})}alterTable(e){return new Ur({queryId:H(),executor:this.#executor,node:f.create(X(e))})}createView(e){return new ei({queryId:H(),executor:this.#executor,node:Q.create(e)})}dropView(e){return new ni({queryId:H(),executor:this.#executor,node:ti.create(e)})}createType(e){return new ii({queryId:H(),executor:this.#executor,node:ri.create(si(e))})}dropType(e){return new oi({queryId:H(),executor:this.#executor,node:ai.create(si(e))})}withPlugin(t){return new e(this.#executor.withPlugin(t))}withoutPlugins(){return new e(this.#executor.withoutPlugins())}withSchema(t){return new e(this.#executor.withPluginAtFront(new on(t)))}},ui=class{ref(e){return new xe(e)}},di=class{#driver;constructor(e){this.#driver=e}async provideConnection(e){let t=await this.#driver.acquireConnection();try{return await e(t)}finally{await this.#driver.releaseConnection(t)}}},fi=class e extends mn{#compiler;#adapter;#connectionProvider;constructor(e,t,n,r=[]){super(r),this.#compiler=e,this.#adapter=t,this.#connectionProvider=n}get adapter(){return this.#adapter}compileQuery(e){return this.#compiler.compileQuery(e)}provideConnection(e){return this.#connectionProvider.provideConnection(e)}withPlugins(t){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[...this.plugins,...t])}withPlugin(t){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[...this.plugins,t])}withPluginAtFront(t){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[t,...this.plugins])}withConnectionProvider(t){return new e(this.#compiler,this.#adapter,t,[...this.plugins])}withoutPlugins(){return new e(this.#compiler,this.#adapter,this.#connectionProvider,[])}};function pi(){return typeof performance<`u`&&s(performance.now)?performance.now():Date.now()}var mi=class{#driver;#log;#initPromise;#initDone;#destroyPromise;#connections=new WeakSet;constructor(e,t){this.#initDone=!1,this.#driver=e,this.#log=t}async init(){if(this.#destroyPromise)throw Error(`driver has already been destroyed`);this.#initPromise||=this.#driver.init().then(()=>{this.#initDone=!0}).catch(e=>(this.#initPromise=void 0,Promise.reject(e))),await this.#initPromise}async acquireConnection(){if(this.#destroyPromise)throw Error(`driver has already been destroyed`);this.#initDone||await this.init();let e=await this.#driver.acquireConnection();return this.#connections.has(e)||(this.#needsLogging()&&this.#addLogging(e),this.#connections.add(e)),e}async releaseConnection(e){await this.#driver.releaseConnection(e)}beginTransaction(e,t){return this.#driver.beginTransaction(e,t)}commitTransaction(e){return this.#driver.commitTransaction(e)}rollbackTransaction(e){return this.#driver.rollbackTransaction(e)}async destroy(){this.#initPromise&&(await this.#initPromise,this.#destroyPromise||=this.#driver.destroy().catch(e=>(this.#destroyPromise=void 0,Promise.reject(e))),await this.#destroyPromise)}#needsLogging(){return this.#log.isLevelEnabled(`query`)||this.#log.isLevelEnabled(`error`)}#addLogging(e){let t=e.executeQuery;e.executeQuery=async n=>{let r,i=pi();try{return await t.call(e,n)}catch(e){throw r=e,await this.#logError(e,n,i),e}finally{r||await this.#logQuery(n,i)}}}async#logError(e,t,n){await this.#log.error(()=>({level:`error`,error:e,query:t,queryDurationMillis:this.#calculateDurationMillis(n)}))}async#logQuery(e,t){await this.#log.query(()=>({level:`query`,query:e,queryDurationMillis:this.#calculateDurationMillis(t)}))}#calculateDurationMillis(e){return pi()-e}};const hi=()=>{};var gi=class{#connection;#runningPromise;constructor(e){this.#connection=e}async provideConnection(e){for(;this.#runningPromise;)await this.#runningPromise.catch(hi);return this.#runningPromise=this.#run(e).finally(()=>{this.#runningPromise=void 0}),this.#runningPromise}async#run(e){return await e(this.#connection)}};const _i=[`read uncommitted`,`read committed`,`repeatable read`,`serializable`,`snapshot`];l([`query`,`error`]);var vi=class{#levels;#logger;constructor(e){s(e)?(this.#logger=e,this.#levels=l({query:!0,error:!0})):(this.#logger=yi,this.#levels=l({query:e.includes(`query`),error:e.includes(`error`)}))}isLevelEnabled(e){return this.#levels[e]}async query(e){this.#levels.query&&await this.#logger(e())}async error(e){this.#levels.error&&await this.#logger(e())}};function yi(e){e.level===`query`?(console.log(`kysely:query: ${e.query.sql}`),console.log(`kysely:query: duration: ${e.queryDurationMillis.toFixed(1)}ms`)):e.level===`error`&&(e.error instanceof Error?console.error(`kysely:error: ${e.error.stack??e.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:e.error,query:e.query.sql,queryDurationMillis:e.queryDurationMillis})}`))}function bi(e){return c(e)&&s(e.compile)}var xi=class t extends Sn{#props;constructor(e){let t,n;if(Ci(e))t={executor:e.executor},n={...e};else{let r=e.dialect,i=r.createDriver(),a=r.createQueryCompiler(),o=r.createAdapter(),s=new vi(e.log??[]),c=new mi(i,s),l=new di(c),ee=new fi(a,o,l,e.plugins??[]);t={executor:ee},n={config:e,executor:ee,dialect:r,driver:c}}super(t),this.#props=l(n)}get schema(){return new li(this.#props.executor)}get dynamic(){return new ui}get introspection(){return this.#props.dialect.createIntrospector(this.withoutPlugins())}case(t){return new Jn({node:q.create(e(t)?void 0:Y(t))})}get fn(){return Gn()}transaction(){return new Ti({...this.#props})}connection(){return new wi({...this.#props})}withPlugin(e){return new t({...this.#props,executor:this.#props.executor.withPlugin(e)})}withoutPlugins(){return new t({...this.#props,executor:this.#props.executor.withoutPlugins()})}withSchema(e){return new t({...this.#props,executor:this.#props.executor.withPluginAtFront(new on(e))})}withTables(){return new t({...this.#props})}async destroy(){await this.#props.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#props.executor}executeQuery(e,t=H()){let n=bi(e)?e.compile():e;return this.getExecutor().executeQuery(n,t)}},Si=class e extends xi{#props;constructor(e){super(e),this.#props=e}get isTransaction(){return!0}transaction(){throw Error(`calling the transaction method for a Transaction is not supported`)}connection(){throw Error(`calling the connection method for a Transaction is not supported`)}async destroy(){throw Error(`calling the destroy method for a Transaction is not supported`)}withPlugin(t){return new e({...this.#props,executor:this.#props.executor.withPlugin(t)})}withoutPlugins(){return new e({...this.#props,executor:this.#props.executor.withoutPlugins()})}withSchema(t){return new e({...this.#props,executor:this.#props.executor.withPluginAtFront(new on(t))})}withTables(){return new e({...this.#props})}};function Ci(e){return c(e)&&c(e.config)&&c(e.driver)&&c(e.executor)&&c(e.dialect)}var wi=class{#props;constructor(e){this.#props=l(e)}async execute(e){return this.#props.executor.provideConnection(async t=>{let n=this.#props.executor.withConnectionProvider(new gi(t)),r=new xi({...this.#props,executor:n});return await e(r)})}};N(wi,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");var Ti=class e{#props;constructor(e){this.#props=l(e)}setIsolationLevel(t){return new e({...this.#props,isolationLevel:t})}async execute(e){let{isolationLevel:t,...n}=this.#props,r={isolationLevel:t};return Ei(r),this.#props.executor.provideConnection(async t=>{let i=this.#props.executor.withConnectionProvider(new gi(t)),a=new Si({...n,executor:i});try{await this.#props.driver.beginTransaction(t,r);let n=await e(a);return await this.#props.driver.commitTransaction(t),n}catch(e){throw await this.#props.driver.rollbackTransaction(t),e}})}};N(Ti,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function Ei(e){if(e.isolationLevel&&!_i.includes(e.isolationLevel))throw Error(`invalid transaction isolation level ${e.isolationLevel}`)}var Di=class e{#props;constructor(e){this.#props=l(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new Oi(this,e)}$castTo(){return new e({...this.#props})}$notNull(){return new e(this.#props)}withPlugin(t){return new e({...this.#props,plugins:this.#props.plugins===void 0?l([t]):l([...this.#props.plugins,t])})}toOperationNode(){return this.#toOperationNode(this.#getExecutor())}compile(e){return this.#compile(this.#getExecutor(e))}async execute(e){let t=this.#getExecutor(e);return t.executeQuery(this.#compile(t),this.#props.queryId)}#getExecutor(e){let t=e===void 0?gn:e.getExecutor();return this.#props.plugins===void 0?t:t.withPlugins(this.#props.plugins)}#toOperationNode(e){return e.transformQuery(this.#props.rawNode,this.#props.queryId)}#compile(e){return e.compileQuery(this.#toOperationNode(e),this.#props.queryId)}};function $(e){return new Di(e)}N(Di,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");var Oi=class{#rawBuilder;#alias;constructor(e,t){this.#rawBuilder=e,this.#alias=t}get expression(){return this.#rawBuilder}get alias(){return this.#alias}get rawBuilder(){return this.#rawBuilder}toOperationNode(){return _.create(this.#rawBuilder.toOperationNode(),y(this.#alias)?this.#alias.toOperationNode():p.create(this.#alias))}};N(Oi,`don't await AliasedRawBuilder instances directly. AliasedRawBuilder should never be executed directly since it's always a part of another query.`);const ki=Object.assign((e,...t)=>$({queryId:H(),rawNode:w.create(e,t?.map(Ai)??[])}),{ref(e){return $({queryId:H(),rawNode:w.createWithChild(E(e))})},val(e){return $({queryId:H(),rawNode:w.createWithChild(O(e))})},value(e){return this.val(e)},table(e){return $({queryId:H(),rawNode:w.createWithChild(X(e))})},id(...e){let t=Array(e.length+1).fill(`.`);return t[0]=``,t[t.length-1]=``,$({queryId:H(),rawNode:w.create(t,e.map(p.create))})},lit(e){return $({queryId:H(),rawNode:w.createWithChild(D.createImmediate(e))})},literal(e){return this.lit(e)},raw(e){return $({queryId:H(),rawNode:w.createWithSql(e)})},join(e,t=ki`, `){let n=Array(2*e.length-1),r=t.toOperationNode();for(let t=0;t<e.length;++t)n[2*t]=Ai(e[t]),t!==e.length-1&&(n[2*t+1]=r);return $({queryId:H(),rawNode:w.createWithChildren(n)})}});function Ai(e){return y(e)?e.toOperationNode():O(e)}var ji=class{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#visitors=l({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#visitors[e.kind](e),this.nodeStack.pop()}},Mi=class extends ji{#sql=``;#parameters=[];get numParameters(){return this.#parameters.length}compileQuery(e){return this.#sql=``,this.#parameters=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(e),l({query:e,sql:this.getSql(),parameters:[...this.#parameters]})}getSql(){return this.#sql}visitSelectQuery(e){let t=this.parentNode!==void 0&&!qe.is(this.parentNode)&&!I.is(this.parentNode)&&!h.is(this.parentNode)&&!Q.is(this.parentNode)&&!jn.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(` `)),t&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`select`),e.distinctOn&&(this.append(` `),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(` `),this.compileList(e.frontModifiers,` `)),e.top&&(this.append(` `),this.visitNode(e.top)),e.selections&&(this.append(` `),this.compileList(e.selections)),e.from&&(this.append(` `),this.visitNode(e.from)),e.joins&&(this.append(` `),this.compileList(e.joins,` `)),e.where&&(this.append(` `),this.visitNode(e.where)),e.groupBy&&(this.append(` `),this.visitNode(e.groupBy)),e.having&&(this.append(` `),this.visitNode(e.having)),e.setOperations&&(this.append(` `),this.compileList(e.setOperations,` `)),e.orderBy&&(this.append(` `),this.visitNode(e.orderBy)),e.limit&&(this.append(` `),this.visitNode(e.limit)),e.offset&&(this.append(` `),this.visitNode(e.offset)),e.fetch&&(this.append(` `),this.visitNode(e.fetch)),e.endModifiers?.length&&(this.append(` `),this.compileList(this.sortSelectModifiers([...e.endModifiers]),` `)),t&&this.append(`)`)}visitFrom(e){this.append(`from `),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append(`distinct on (`),this.compileList(e),this.append(`)`)}compileList(e,t=`, `){let n=e.length-1;for(let r=0;r<=n;r++)this.visitNode(e[r]),r<n&&this.append(t)}visitWhere(e){this.append(`where `),this.visitNode(e.where)}visitHaving(e){this.append(`having `),this.visitNode(e.having)}visitInsertQuery(e){let t=this.nodeStack.find(B.is),n=t!==e;!n&&e.explain&&(this.visitNode(e.explain),this.append(` `)),n&&!z.is(t)&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(e.replace?`replace`:`insert`),e.ignore&&this.append(` ignore`),e.top&&(this.append(` `),this.visitNode(e.top)),e.into&&(this.append(` into `),this.visitNode(e.into)),e.columns&&(this.append(` (`),this.compileList(e.columns),this.append(`)`)),e.output&&(this.append(` `),this.visitNode(e.output)),e.values&&(this.append(` `),this.visitNode(e.values)),e.defaultValues&&(this.append(` `),this.append(`default values`)),e.onConflict&&(this.append(` `),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(` `),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(` `),this.visitNode(e.returning)),n&&!z.is(t)&&this.append(`)`),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitValues(e){this.append(`values `),this.compileList(e.values)}visitDeleteQuery(e){let t=this.nodeStack.find(B.is)!==e;!t&&e.explain&&(this.visitNode(e.explain),this.append(` `)),t&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`delete `),e.top&&(this.visitNode(e.top),this.append(` `)),this.visitNode(e.from),e.output&&(this.append(` `),this.visitNode(e.output)),e.using&&(this.append(` `),this.visitNode(e.using)),e.joins&&(this.append(` `),this.compileList(e.joins,` `)),e.where&&(this.append(` `),this.visitNode(e.where)),e.orderBy&&(this.append(` `),this.visitNode(e.orderBy)),e.limit&&(this.append(` `),this.visitNode(e.limit)),e.returning&&(this.append(` `),this.visitNode(e.returning)),t&&this.append(`)`),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitReturning(e){this.append(`returning `),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(` as `),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(`.`)),this.visitNode(e.column)}visitSelectAll(e){this.append(`*`)}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!t(e.name))throw Error(`a non-string identifier was passed to compileUnwrappedIdentifier.`);this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(` and `),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(` or `),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append(`(`),this.compileList(e.values),this.append(`)`)}visitTuple(e){this.append(`(`),this.compileList(e.values),this.append(`)`)}visitPrimitiveValueList(e){this.append(`(`);let{values:t}=e;for(let e=0;e<t.length;++e)this.appendValue(t[e]),e!==t.length-1&&this.append(`, `);this.append(`)`)}visitParens(e){this.append(`(`),this.visitNode(e.node),this.append(`)`)}visitJoin(e){this.append(Fi[e.joinType]),this.append(` `),this.visitNode(e.table),e.on&&(this.append(` `),this.visitNode(e.on))}visitOn(e){this.append(`on `),this.visitNode(e.on)}visitRaw(e){let{sqlFragments:t,parameters:n}=e;for(let e=0;e<t.length;++e)this.append(t[e]),n.length>e&&this.visitNode(n[e])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(`.`)),this.visitNode(e.identifier)}visitCreateTable(e){this.append(`create `),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers,` `),this.append(` `)),e.temporary&&this.append(`temporary `),this.append(`table `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.table),e.selectQuery?(this.append(` as `),this.visitNode(e.selectQuery)):(this.append(` (`),this.compileList([...e.columns,...e.constraints??[]]),this.append(`)`),e.onCommit&&(this.append(` on commit `),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(` `),this.compileList(e.endModifiers,` `)))}visitColumnDefinition(e){e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.column),this.append(` `),this.visitNode(e.dataType),e.unsigned&&this.append(` unsigned`),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(` `),this.compileList(e.frontModifiers,` `)),e.generated&&(this.append(` `),this.visitNode(e.generated)),e.identity&&this.append(` identity`),e.defaultTo&&(this.append(` `),this.visitNode(e.defaultTo)),e.notNull&&this.append(` not null`),e.unique&&this.append(` unique`),e.nullsNotDistinct&&this.append(` nulls not distinct`),e.primaryKey&&this.append(` primary key`),e.autoIncrement&&(this.append(` `),this.append(this.getAutoIncrement())),e.references&&(this.append(` `),this.visitNode(e.references)),e.check&&(this.append(` `),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(` `),this.compileList(e.endModifiers,` `))}getAutoIncrement(){return`auto_increment`}visitReferences(e){this.append(`references `),this.visitNode(e.table),this.append(` (`),this.compileList(e.columns),this.append(`)`),e.onDelete&&(this.append(` on delete `),this.append(e.onDelete)),e.onUpdate&&(this.append(` on update `),this.append(e.onUpdate))}visitDropTable(e){this.append(`drop table `),e.ifExists&&this.append(`if exists `),this.visitNode(e.table),e.cascade&&this.append(` cascade`)}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append(`order by `),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.direction&&(this.append(` `),this.visitNode(e.direction))}visitGroupBy(e){this.append(`group by `),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){let t=this.nodeStack.find(B.is),n=t!==e;!n&&e.explain&&(this.visitNode(e.explain),this.append(` `)),n&&!z.is(t)&&this.append(`(`),e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`update `),e.top&&(this.visitNode(e.top),this.append(` `)),e.table&&(this.visitNode(e.table),this.append(` `)),this.append(`set `),e.updates&&this.compileList(e.updates),e.output&&(this.append(` `),this.visitNode(e.output)),e.from&&(this.append(` `),this.visitNode(e.from)),e.joins&&(this.append(` `),this.compileList(e.joins,` `)),e.where&&(this.append(` `),this.visitNode(e.where)),e.limit&&(this.append(` `),this.visitNode(e.limit)),e.returning&&(this.append(` `),this.visitNode(e.returning)),n&&!z.is(t)&&this.append(`)`),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitColumnUpdate(e){this.visitNode(e.column),this.append(` = `),this.visitNode(e.value)}visitLimit(e){this.append(`limit `),this.visitNode(e.limit)}visitOffset(e){this.append(`offset `),this.visitNode(e.offset)}visitOnConflict(e){this.append(`on conflict`),e.columns?(this.append(` (`),this.compileList(e.columns),this.append(`)`)):e.constraint?(this.append(` on constraint `),this.visitNode(e.constraint)):e.indexExpression&&(this.append(` (`),this.visitNode(e.indexExpression),this.append(`)`)),e.indexWhere&&(this.append(` `),this.visitNode(e.indexWhere)),e.doNothing===!0?this.append(` do nothing`):e.updates&&(this.append(` do update set `),this.compileList(e.updates),e.updateWhere&&(this.append(` `),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append(`on duplicate key update `),this.compileList(e.updates)}visitCreateIndex(e){this.append(`create `),e.unique&&this.append(`unique `),this.append(`index `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.name),e.table&&(this.append(` on `),this.visitNode(e.table)),e.using&&(this.append(` using `),this.visitNode(e.using)),e.columns&&(this.append(` (`),this.compileList(e.columns),this.append(`)`)),e.nullsNotDistinct&&this.append(` nulls not distinct`),e.where&&(this.append(` `),this.visitNode(e.where))}visitDropIndex(e){this.append(`drop index `),e.ifExists&&this.append(`if exists `),this.visitNode(e.name),e.table&&(this.append(` on `),this.visitNode(e.table)),e.cascade&&this.append(` cascade`)}visitCreateSchema(e){this.append(`create schema `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.schema)}visitDropSchema(e){this.append(`drop schema `),e.ifExists&&this.append(`if exists `),this.visitNode(e.schema),e.cascade&&this.append(` cascade`)}visitPrimaryKeyConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`primary key (`),this.compileList(e.columns),this.append(`)`)}visitUniqueConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`unique`),e.nullsNotDistinct&&this.append(` nulls not distinct`),this.append(` (`),this.compileList(e.columns),this.append(`)`)}visitCheckConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`check (`),this.visitNode(e.expression),this.append(`)`)}visitForeignKeyConstraint(e){e.name&&(this.append(`constraint `),this.visitNode(e.name),this.append(` `)),this.append(`foreign key (`),this.compileList(e.columns),this.append(`) `),this.visitNode(e.references),e.onDelete&&(this.append(` on delete `),this.append(e.onDelete)),e.onUpdate&&(this.append(` on update `),this.append(e.onUpdate))}visitList(e){this.compileList(e.items)}visitWith(e){this.append(`with `),e.recursive&&this.append(`recursive `),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(` as `),r(e.materialized)&&(e.materialized||this.append(`not `),this.append(`materialized `)),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append(`(`),this.compileList(e.columns),this.append(`)`))}visitAlterTable(e){this.append(`alter table `),this.visitNode(e.table),this.append(` `),e.renameTo&&(this.append(`rename to `),this.visitNode(e.renameTo)),e.setSchema&&(this.append(`set schema `),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append(`add column `),this.visitNode(e.column)}visitRenameColumn(e){this.append(`rename column `),this.visitNode(e.column),this.append(` to `),this.visitNode(e.renameTo)}visitDropColumn(e){this.append(`drop column `),this.visitNode(e.column)}visitAlterColumn(e){this.append(`alter column `),this.visitNode(e.column),this.append(` `),e.dataType&&(this.announcesNewColumnDataType()&&this.append(`type `),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append(`using `),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append(`set default `),this.visitNode(e.setDefault)),e.dropDefault&&this.append(`drop default`),e.setNotNull&&this.append(`set not null`),e.dropNotNull&&this.append(`drop not null`)}visitModifyColumn(e){this.append(`modify column `),this.visitNode(e.column)}visitAddConstraint(e){this.append(`add `),this.visitNode(e.constraint)}visitDropConstraint(e){this.append(`drop constraint `),e.ifExists&&this.append(`if exists `),this.visitNode(e.constraintName),e.modifier===`cascade`?this.append(` cascade`):e.modifier===`restrict`&&this.append(` restrict`)}visitSetOperation(e){this.append(e.operator),this.append(` `),e.all&&this.append(`all `),this.visitNode(e.expression)}visitCreateView(e){this.append(`create `),e.orReplace&&this.append(`or replace `),e.materialized&&this.append(`materialized `),e.temporary&&this.append(`temporary `),this.append(`view `),e.ifNotExists&&this.append(`if not exists `),this.visitNode(e.name),this.append(` `),e.columns&&(this.append(`(`),this.compileList(e.columns),this.append(`) `)),e.as&&(this.append(`as `),this.visitNode(e.as))}visitDropView(e){this.append(`drop `),e.materialized&&this.append(`materialized `),this.append(`view `),e.ifExists&&this.append(`if exists `),this.visitNode(e.name),e.cascade&&this.append(` cascade`)}visitGenerated(e){this.append(`generated `),e.always&&this.append(`always `),e.byDefault&&this.append(`by default `),this.append(`as `),e.identity&&this.append(`identity`),e.expression&&(this.append(`(`),this.visitNode(e.expression),this.append(`)`)),e.stored&&this.append(` stored`)}visitDefaultValue(e){this.append(`default `),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(Ni[e.modifier]),e.of&&(this.append(` of `),this.compileList(e.of,`, `))}visitCreateType(e){this.append(`create type `),this.visitNode(e.name),e.enum&&(this.append(` as enum `),this.visitNode(e.enum))}visitDropType(e){this.append(`drop type `),e.ifExists&&this.append(`if exists `),this.visitNode(e.name)}visitExplain(e){this.append(`explain`),(e.options||e.format)&&(this.append(` `),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append(`format`),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append(`default`)}visitAggregateFunction(e){this.append(e.func),this.append(`(`),e.distinct&&this.append(`distinct `),this.compileList(e.aggregated),e.orderBy&&(this.append(` `),this.visitNode(e.orderBy)),this.append(`)`),e.filter&&(this.append(` filter(`),this.visitNode(e.filter),this.append(`)`)),e.over&&(this.append(` `),this.visitNode(e.over))}visitOver(e){this.append(`over(`),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(` `)),e.orderBy&&this.visitNode(e.orderBy),this.append(`)`)}visitPartitionBy(e){this.append(`partition by `),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(` `),this.visitNode(e.operator),this.append(` `),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(` `),this.visitNode(e.operand)}isMinusOperator(e){return S.is(e)&&e.operator===`-`}visitUsing(e){this.append(`using `),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append(`(`),this.compileList(e.arguments),this.append(`)`)}visitCase(e){this.append(`case`),e.value&&(this.append(` `),this.visitNode(e.value)),e.when&&(this.append(` `),this.compileList(e.when,` `)),e.else&&(this.append(` else `),this.visitNode(e.else)),this.append(` end`),e.isStatement&&this.append(` case`)}visitWhen(e){this.append(`when `),this.visitNode(e.condition),e.result&&(this.append(` then `),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append(`'$`);for(let t of e.pathLegs)this.visitNode(t);this.append(`'`)}visitJSONPathLeg(e){let t=e.type===`ArrayLocation`;this.append(t?`[`:`.`),this.append(String(e.value)),t&&this.append(`]`)}visitJSONOperatorChain(e){for(let t=0,n=e.values.length;t<n;t++)t===n-1?this.visitNode(e.operator):this.append(`->`),this.visitNode(e.values[t])}visitMergeQuery(e){e.with&&(this.visitNode(e.with),this.append(` `)),this.append(`merge `),e.top&&(this.visitNode(e.top),this.append(` `)),this.append(`into `),this.visitNode(e.into),e.using&&(this.append(` `),this.visitNode(e.using)),e.whens&&(this.append(` `),this.compileList(e.whens,` `)),e.output&&(this.append(` `),this.visitNode(e.output)),e.endModifiers?.length&&(this.append(` `),this.compileList(e.endModifiers,` `))}visitMatched(e){e.not&&this.append(`not `),this.append(`matched`),e.bySource&&this.append(` by source`)}visitAddIndex(e){this.append(`add `),e.unique&&this.append(`unique `),this.append(`index `),this.visitNode(e.name),e.columns&&(this.append(` (`),this.compileList(e.columns),this.append(`)`)),e.using&&(this.append(` using `),this.visitNode(e.using))}visitCast(e){this.append(`cast(`),this.visitNode(e.expression),this.append(` as `),this.visitNode(e.dataType),this.append(`)`)}visitFetch(e){this.append(`fetch next `),this.visitNode(e.rowCount),this.append(` rows ${e.modifier}`)}visitOutput(e){this.append(`output `),this.compileList(e.selections)}visitTop(e){this.append(`top(${e.expression})`),e.modifiers&&this.append(` ${e.modifiers}`)}append(e){this.#sql+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return`"`}getRightIdentifierWrapper(){return`"`}getCurrentParameterPlaceholder(){return`$`+this.numParameters}getLeftExplainOptionsWrapper(){return`(`}getExplainOptionAssignment(){return` `}getExplainOptionsDelimiter(){return`, `}getRightExplainOptionsWrapper(){return`)`}sanitizeIdentifier(e){let t=this.getLeftIdentifierWrapper(),n=this.getRightIdentifierWrapper(),r=``;for(let i of e)r+=i,i===t?r+=t:i===n&&(r+=n);return r}addParameter(e){this.#parameters.push(e)}appendImmediateValue(e){if(t(e))this.append(`'${e}'`);else if(n(e)||r(e))this.append(e.toString());else if(i(e))this.append(`null`);else if(a(e))this.appendImmediateValue(e.toISOString());else if(o(e))this.appendImmediateValue(e.toString());else throw Error(`invalid immediate value ${e}`)}sortSelectModifiers(e){return e.sort((e,t)=>e.modifier&&t.modifier?Pi[e.modifier]-Pi[t.modifier]:1),l(e)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}};const Ni=l({ForKeyShare:`for key share`,ForNoKeyUpdate:`for no key update`,ForUpdate:`for update`,ForShare:`for share`,NoWait:`nowait`,SkipLocked:`skip locked`,Distinct:`distinct`}),Pi=l({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),Fi=l({InnerJoin:`inner join`,LeftJoin:`left join`,RightJoin:`right join`,FullJoin:`full join`,LateralInnerJoin:`inner join lateral`,LateralLeftJoin:`left join lateral`,Using:`using`});var Ii=class{async init(){}async acquireConnection(){return new Li}async beginTransaction(){}async commitTransaction(){}async rollbackTransaction(){}async releaseConnection(){}async destroy(){}},Li=class{async executeQuery(){return{rows:[]}}async*streamQuery(){}},Ri=class{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}};l({__noMigrations__:!0});const zi=/"/g;var Bi=class extends Mi{sanitizeIdentifier(e){return e.replace(zi,`""`)}},Vi=class{#db;constructor(e){this.#db=e}async getSchemas(){return(await this.#db.selectFrom(`pg_catalog.pg_namespace`).select(`nspname`).$castTo().execute()).map(e=>({name:e.nspname}))}async getTables(e={withInternalKyselyTables:!1}){let t=this.#db.selectFrom(`pg_catalog.pg_attribute as a`).innerJoin(`pg_catalog.pg_class as c`,`a.attrelid`,`c.oid`).innerJoin(`pg_catalog.pg_namespace as ns`,`c.relnamespace`,`ns.oid`).innerJoin(`pg_catalog.pg_type as typ`,`a.atttypid`,`typ.oid`).innerJoin(`pg_catalog.pg_namespace as dtns`,`typ.typnamespace`,`dtns.oid`).select([`a.attname as column`,`a.attnotnull as not_null`,`a.atthasdef as has_default`,`c.relname as table`,`c.relkind as table_type`,`ns.nspname as schema`,`typ.typname as type`,`dtns.nspname as type_schema`,ki`col_description(a.attrelid, a.attnum)`.as(`column_description`),this.#db.selectFrom(`pg_class`).select(ki`true`.as(`auto_incrementing`)).whereRef(`relnamespace`,`=`,`c.relnamespace`).where(`relkind`,`=`,`S`).where(`relname`,`=`,ki`c.relname || '_' || a.attname || '_seq'`).as(`auto_incrementing`)]).where(e=>e.or([e(`c.relkind`,`=`,`r`),e(`c.relkind`,`=`,`v`),e(`c.relkind`,`=`,`p`)])).where(`ns.nspname`,`!~`,`^pg_`).where(`ns.nspname`,`!=`,`information_schema`).where(`a.attnum`,`>=`,0).where(`a.attisdropped`,`!=`,!0).orderBy(`ns.nspname`).orderBy(`c.relname`).orderBy(`a.attnum`).$castTo();e.withInternalKyselyTables||(t=t.where(`c.relname`,`!=`,`kysely_migration`).where(`c.relname`,`!=`,`kysely_migration_lock`));let n=await t.execute();return this.#parseTableMetadata(n)}async getMetadata(e){return{tables:await this.getTables(e)}}#parseTableMetadata(e){return e.reduce((e,t)=>{let n=e.find(e=>e.name===t.table&&e.schema===t.schema);return n||(n=l({name:t.table,isView:t.table_type===`v`,schema:t.schema,columns:[]}),e.push(n)),n.columns.push(l({name:t.column,dataType:t.type,dataTypeSchema:t.type_schema,isNullable:!t.not_null,isAutoIncrementing:!!t.auto_incrementing,hasDefaultValue:t.has_default,comment:t.column_description??void 0})),e},[])}};const Hi=BigInt(`3853314791062309107`);var Ui=class extends Ri{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(e,t){await ki`select pg_advisory_xact_lock(${ki.lit(Hi)})`.execute(e)}async releaseMigrationLock(e,t){}};const Wi=()=>new xi({dialect:{createAdapter:()=>new Ui,createDriver:()=>new Ii,createIntrospector:e=>new Vi(e),createQueryCompiler:()=>new Bi}});async function Gi(e,t){let n=Wi(),r={exec:async t=>await e.client.exec(t.sql)};return await t({...e,db:n,client:r})}const Ki=e=>Gi(e,async e=>{let t=e.db.selectFrom(`Supplier`).select([`state`]).compile();return(await e.client.exec(t)).map(e=>e.state).join(`, `)}),qi=async e=>{let t=e?new tailordb.Client({namespace:e}):{connect:()=>{},end:()=>{}};await t.connect();let n={async exec(e,n){return(await t.queryObject(e,n??[])).rows},async execOne(e,n){return(await t.queryObject(e,n??[])).rows[0]}};return{...n,async transaction(e){try{await n.exec(`BEGIN`);let t=await e(n);return await n.exec(`COMMIT`),t}catch(e){console.error(`Transaction failed:`,e);try{await n.exec(`ROLLBACK`)}catch(e){console.error(`Failed to rollback transaction:`,e)}}},async end(){try{await t.end()}catch(e){console.error(`Error ending connection:`,e)}}}};globalThis.main=await(async(e,t)=>async n=>{let r=await qi(e);try{return await t({...n,client:r})}finally{await r.end()}})(`tailordb`,Ki);
//# sourceMappingURL=stepChain__kyselyStep.js.map