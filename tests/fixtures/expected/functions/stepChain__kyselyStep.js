function isUndefined(t){return typeof t>"u"||t===void 0}function isString(t){return typeof t=="string"}function isNumber(t){return typeof t=="number"}function isBoolean(t){return typeof t=="boolean"}function isNull(t){return t===null}function isDate(t){return t instanceof Date}function isBigInt(t){return typeof t=="bigint"}function isFunction(t){return typeof t=="function"}function isObject(t){return typeof t=="object"&&t!==null}function freeze(t){return Object.freeze(t)}function asArray(t){return isReadonlyArray(t)?t:[t]}function isReadonlyArray(t){return Array.isArray(t)}function noop(t){return t}const AlterTableNode=freeze({is(t){return t.kind==="AlterTableNode"},create(t){return freeze({kind:"AlterTableNode",table:t})},cloneWithTableProps(t,e){return freeze({...t,...e})},cloneWithColumnAlteration(t,e){return freeze({...t,columnAlterations:t.columnAlterations?[...t.columnAlterations,e]:[e]})}}),IdentifierNode=freeze({is(t){return t.kind==="IdentifierNode"},create(t){return freeze({kind:"IdentifierNode",name:t})}}),CreateIndexNode=freeze({is(t){return t.kind==="CreateIndexNode"},create(t){return freeze({kind:"CreateIndexNode",name:IdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})},cloneWithColumns(t,e){return freeze({...t,columns:[...t.columns||[],...e]})}}),CreateSchemaNode=freeze({is(t){return t.kind==="CreateSchemaNode"},create(t,e){return freeze({kind:"CreateSchemaNode",schema:IdentifierNode.create(t),...e})},cloneWith(t,e){return freeze({...t,...e})}}),ON_COMMIT_ACTIONS=["preserve rows","delete rows","drop"],CreateTableNode=freeze({is(t){return t.kind==="CreateTableNode"},create(t){return freeze({kind:"CreateTableNode",table:t,columns:freeze([])})},cloneWithColumn(t,e){return freeze({...t,columns:freeze([...t.columns,e])})},cloneWithConstraint(t,e){return freeze({...t,constraints:t.constraints?freeze([...t.constraints,e]):freeze([e])})},cloneWithFrontModifier(t,e){return freeze({...t,frontModifiers:t.frontModifiers?freeze([...t.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(t,e){return freeze({...t,endModifiers:t.endModifiers?freeze([...t.endModifiers,e]):freeze([e])})},cloneWith(t,e){return freeze({...t,...e})}}),SchemableIdentifierNode=freeze({is(t){return t.kind==="SchemableIdentifierNode"},create(t){return freeze({kind:"SchemableIdentifierNode",identifier:IdentifierNode.create(t)})},createWithSchema(t,e){return freeze({kind:"SchemableIdentifierNode",schema:IdentifierNode.create(t),identifier:IdentifierNode.create(e)})}}),DropIndexNode=freeze({is(t){return t.kind==="DropIndexNode"},create(t,e){return freeze({kind:"DropIndexNode",name:SchemableIdentifierNode.create(t),...e})},cloneWith(t,e){return freeze({...t,...e})}}),DropSchemaNode=freeze({is(t){return t.kind==="DropSchemaNode"},create(t,e){return freeze({kind:"DropSchemaNode",schema:IdentifierNode.create(t),...e})},cloneWith(t,e){return freeze({...t,...e})}}),DropTableNode=freeze({is(t){return t.kind==="DropTableNode"},create(t,e){return freeze({kind:"DropTableNode",table:t,...e})},cloneWith(t,e){return freeze({...t,...e})}}),AliasNode=freeze({is(t){return t.kind==="AliasNode"},create(t,e){return freeze({kind:"AliasNode",node:t,alias:e})}}),TableNode=freeze({is(t){return t.kind==="TableNode"},create(t){return freeze({kind:"TableNode",table:SchemableIdentifierNode.create(t)})},createWithSchema(t,e){return freeze({kind:"TableNode",table:SchemableIdentifierNode.createWithSchema(t,e)})}});function isOperationNodeSource(t){return isObject(t)&&isFunction(t.toOperationNode)}function isExpression(t){return isObject(t)&&"expressionType"in t&&isOperationNodeSource(t)}function isAliasedExpression(t){return isObject(t)&&"expression"in t&&isString(t.alias)&&isOperationNodeSource(t)}const SelectModifierNode=freeze({is(t){return t.kind==="SelectModifierNode"},create(t,e){return freeze({kind:"SelectModifierNode",modifier:t,of:e})},createWithExpression(t){return freeze({kind:"SelectModifierNode",rawModifier:t})}}),AndNode=freeze({is(t){return t.kind==="AndNode"},create(t,e){return freeze({kind:"AndNode",left:t,right:e})}}),OrNode=freeze({is(t){return t.kind==="OrNode"},create(t,e){return freeze({kind:"OrNode",left:t,right:e})}}),OnNode=freeze({is(t){return t.kind==="OnNode"},create(t){return freeze({kind:"OnNode",on:t})},cloneWithOperation(t,e,i){return freeze({...t,on:e==="And"?AndNode.create(t.on,i):OrNode.create(t.on,i)})}}),JoinNode=freeze({is(t){return t.kind==="JoinNode"},create(t,e){return freeze({kind:"JoinNode",joinType:t,table:e,on:void 0})},createWithOn(t,e,i){return freeze({kind:"JoinNode",joinType:t,table:e,on:OnNode.create(i)})},cloneWithOn(t,e){return freeze({...t,on:t.on?OnNode.cloneWithOperation(t.on,"And",e):OnNode.create(e)})}}),BinaryOperationNode=freeze({is(t){return t.kind==="BinaryOperationNode"},create(t,e,i){return freeze({kind:"BinaryOperationNode",leftOperand:t,operator:e,rightOperand:i})}}),COMPARISON_OPERATORS=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","^@","&&","?","?&","?|","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp","is distinct from","is not distinct from"],ARITHMETIC_OPERATORS=["+","-","*","/","%","^","&","|","#","<<",">>"],JSON_OPERATORS=["->","->>"],BINARY_OPERATORS=[...COMPARISON_OPERATORS,...ARITHMETIC_OPERATORS,"&&","||"],UNARY_FILTER_OPERATORS=["exists","not exists"],UNARY_OPERATORS=["not","-",...UNARY_FILTER_OPERATORS],OPERATORS=[...BINARY_OPERATORS,...JSON_OPERATORS,...UNARY_OPERATORS,"between","between symmetric"],OperatorNode=freeze({is(t){return t.kind==="OperatorNode"},create(t){return freeze({kind:"OperatorNode",operator:t})}});function isJSONOperator(t){return isString(t)&&JSON_OPERATORS.includes(t)}const ColumnNode=freeze({is(t){return t.kind==="ColumnNode"},create(t){return freeze({kind:"ColumnNode",column:IdentifierNode.create(t)})}}),SelectAllNode=freeze({is(t){return t.kind==="SelectAllNode"},create(){return freeze({kind:"SelectAllNode"})}}),ReferenceNode=freeze({is(t){return t.kind==="ReferenceNode"},create(t,e){return freeze({kind:"ReferenceNode",table:e,column:t})},createSelectAll(t){return freeze({kind:"ReferenceNode",table:t,column:SelectAllNode.create()})}});class DynamicReferenceBuilder{#e;get dynamicReference(){return this.#e}get refType(){}constructor(e){this.#e=e}toOperationNode(){return parseSimpleReferenceExpression(this.#e)}}function isDynamicReferenceBuilder(t){return isObject(t)&&isOperationNodeSource(t)&&isString(t.dynamicReference)}const OrderByItemNode=freeze({is(t){return t.kind==="OrderByItemNode"},create(t,e){return freeze({kind:"OrderByItemNode",orderBy:t,direction:e})}}),RawNode=freeze({is(t){return t.kind==="RawNode"},create(t,e){return freeze({kind:"RawNode",sqlFragments:freeze(t),parameters:freeze(e)})},createWithSql(t){return RawNode.create([t],[])},createWithChild(t){return RawNode.create(["",""],[t])},createWithChildren(t){return RawNode.create(new Array(t.length+1).fill(""),t)}});function isOrderByDirection(t){return t==="asc"||t==="desc"}function parseOrderBy(t){if(t.length===2)return[parseOrderByItem(t[0],t[1])];if(t.length===1){const[e]=t;return Array.isArray(e)?e.map(i=>parseOrderByItem(i)):[parseOrderByItem(e)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${t.length}`)}function parseOrderByItem(t,e){const i=parseOrderByExpression(t);if(OrderByItemNode.is(i)){if(e)throw new Error("Cannot specify direction twice!");return i}return OrderByItemNode.create(i,parseOrderByDirectionExpression(e))}function parseOrderByExpression(t){if(isExpressionOrFactory(t))return parseExpression(t);if(isDynamicReferenceBuilder(t))return t.toOperationNode();const[e,i]=t.split(" ");if(i){if(!isOrderByDirection(i))throw new Error(`Invalid order by direction: ${i}`);return OrderByItemNode.create(parseStringReference(e),parseOrderByDirectionExpression(i))}return parseStringReference(t)}function parseOrderByDirectionExpression(t){if(t)return t==="asc"||t==="desc"?RawNode.createWithSql(t):t.toOperationNode()}const JSONReferenceNode=freeze({is(t){return t.kind==="JSONReferenceNode"},create(t,e){return freeze({kind:"JSONReferenceNode",reference:t,traversal:e})},cloneWithTraversal(t,e){return freeze({...t,traversal:e})}}),JSONOperatorChainNode=freeze({is(t){return t.kind==="JSONOperatorChainNode"},create(t){return freeze({kind:"JSONOperatorChainNode",operator:t,values:freeze([])})},cloneWithValue(t,e){return freeze({...t,values:freeze([...t.values,e])})}}),JSONPathNode=freeze({is(t){return t.kind==="JSONPathNode"},create(t){return freeze({kind:"JSONPathNode",inOperator:t,pathLegs:freeze([])})},cloneWithLeg(t,e){return freeze({...t,pathLegs:freeze([...t.pathLegs,e])})}});function parseSimpleReferenceExpression(t){return isString(t)?parseStringReference(t):t.toOperationNode()}function parseReferenceExpressionOrList(t){return isReadonlyArray(t)?t.map(e=>parseReferenceExpression(e)):[parseReferenceExpression(t)]}function parseReferenceExpression(t){return isExpressionOrFactory(t)?parseExpression(t):parseSimpleReferenceExpression(t)}function parseJSONReference(t,e){const i=parseStringReference(t);if(isJSONOperator(e))return JSONReferenceNode.create(i,JSONOperatorChainNode.create(OperatorNode.create(e)));const r=e.slice(0,-1);if(isJSONOperator(r))return JSONReferenceNode.create(i,JSONPathNode.create(OperatorNode.create(r)));throw new Error(`Invalid JSON operator: ${e}`)}function parseStringReference(t){const e=".";if(!t.includes(e))return ReferenceNode.create(ColumnNode.create(t));const i=t.split(e).map(trim$2);if(i.length===3)return parseStringReferenceWithTableAndSchema(i);if(i.length===2)return parseStringReferenceWithTable(i);throw new Error(`invalid column reference ${t}`)}function parseAliasedStringReference(t){const e=" as ";if(t.includes(e)){const[i,r]=t.split(e).map(trim$2);return AliasNode.create(parseStringReference(i),IdentifierNode.create(r))}else return parseStringReference(t)}function parseColumnName(t){return ColumnNode.create(t)}function parseOrderedColumnName(t){const e=" ";if(t.includes(e)){const[i,r]=t.split(e).map(trim$2);if(!isOrderByDirection(r))throw new Error(`invalid order direction "${r}" next to "${i}"`);return parseOrderBy([i,r])[0]}else return parseColumnName(t)}function parseStringReferenceWithTableAndSchema(t){const[e,i,r]=t;return ReferenceNode.create(ColumnNode.create(r),TableNode.createWithSchema(e,i))}function parseStringReferenceWithTable(t){const[e,i]=t;return ReferenceNode.create(ColumnNode.create(i),TableNode.create(e))}function trim$2(t){return t.trim()}const PrimitiveValueListNode=freeze({is(t){return t.kind==="PrimitiveValueListNode"},create(t){return freeze({kind:"PrimitiveValueListNode",values:freeze([...t])})}}),ValueListNode=freeze({is(t){return t.kind==="ValueListNode"},create(t){return freeze({kind:"ValueListNode",values:freeze(t)})}}),ValueNode=freeze({is(t){return t.kind==="ValueNode"},create(t){return freeze({kind:"ValueNode",value:t})},createImmediate(t){return freeze({kind:"ValueNode",value:t,immediate:!0})}});function parseValueExpressionOrList(t){return isReadonlyArray(t)?parseValueExpressionList(t):parseValueExpression(t)}function parseValueExpression(t){return isExpressionOrFactory(t)?parseExpression(t):ValueNode.create(t)}function isSafeImmediateValue(t){return isNumber(t)||isBoolean(t)||isNull(t)}function parseSafeImmediateValue(t){if(!isSafeImmediateValue(t))throw new Error(`unsafe immediate value ${JSON.stringify(t)}`);return ValueNode.createImmediate(t)}function parseValueExpressionList(t){return t.some(isExpressionOrFactory)?ValueListNode.create(t.map(e=>parseValueExpression(e))):PrimitiveValueListNode.create(t)}const ParensNode=freeze({is(t){return t.kind==="ParensNode"},create(t){return freeze({kind:"ParensNode",node:t})}});function parseValueBinaryOperationOrExpression(t){if(t.length===3)return parseValueBinaryOperation(t[0],t[1],t[2]);if(t.length===1)return parseValueExpression(t[0]);throw new Error(`invalid arguments: ${JSON.stringify(t)}`)}function parseValueBinaryOperation(t,e,i){return isIsOperator(e)&&needsIsOperator(i)?BinaryOperationNode.create(parseReferenceExpression(t),parseOperator(e),ValueNode.createImmediate(i)):BinaryOperationNode.create(parseReferenceExpression(t),parseOperator(e),parseValueExpressionOrList(i))}function parseReferentialBinaryOperation(t,e,i){return BinaryOperationNode.create(parseReferenceExpression(t),parseOperator(e),parseReferenceExpression(i))}function parseFilterObject(t,e){return parseFilterList(Object.entries(t).filter(([,i])=>!isUndefined(i)).map(([i,r])=>parseValueBinaryOperation(i,needsIsOperator(r)?"is":"=",r)),e)}function parseFilterList(t,e,i=!0){const r=e==="and"?AndNode.create:OrNode.create;if(t.length===0)return BinaryOperationNode.create(ValueNode.createImmediate(1),OperatorNode.create("="),ValueNode.createImmediate(e==="and"?1:0));let n=toOperationNode(t[0]);for(let s=1;s<t.length;++s)n=r(n,toOperationNode(t[s]));return t.length>1&&i?ParensNode.create(n):n}function isIsOperator(t){return t==="is"||t==="is not"}function needsIsOperator(t){return isNull(t)||isBoolean(t)}function parseOperator(t){if(isString(t)&&OPERATORS.includes(t))return OperatorNode.create(t);if(isOperationNodeSource(t))return t.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(t)}`)}function toOperationNode(t){return isOperationNodeSource(t)?t.toOperationNode():t}const OrderByNode=freeze({is(t){return t.kind==="OrderByNode"},create(t){return freeze({kind:"OrderByNode",items:freeze([...t])})},cloneWithItems(t,e){return freeze({...t,items:freeze([...t.items,...e])})}}),PartitionByNode=freeze({is(t){return t.kind==="PartitionByNode"},create(t){return freeze({kind:"PartitionByNode",items:freeze(t)})},cloneWithItems(t,e){return freeze({...t,items:freeze([...t.items,...e])})}}),OverNode=freeze({is(t){return t.kind==="OverNode"},create(){return freeze({kind:"OverNode"})},cloneWithOrderByItems(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithPartitionByItems(t,e){return freeze({...t,partitionBy:t.partitionBy?PartitionByNode.cloneWithItems(t.partitionBy,e):PartitionByNode.create(e)})}}),FromNode=freeze({is(t){return t.kind==="FromNode"},create(t){return freeze({kind:"FromNode",froms:freeze(t)})},cloneWithFroms(t,e){return freeze({...t,froms:freeze([...t.froms,...e])})}}),GroupByNode=freeze({is(t){return t.kind==="GroupByNode"},create(t){return freeze({kind:"GroupByNode",items:freeze(t)})},cloneWithItems(t,e){return freeze({...t,items:freeze([...t.items,...e])})}}),HavingNode=freeze({is(t){return t.kind==="HavingNode"},create(t){return freeze({kind:"HavingNode",having:t})},cloneWithOperation(t,e,i){return freeze({...t,having:e==="And"?AndNode.create(t.having,i):OrNode.create(t.having,i)})}}),SelectQueryNode=freeze({is(t){return t.kind==="SelectQueryNode"},create(t){return freeze({kind:"SelectQueryNode",...t&&{with:t}})},createFrom(t,e){return freeze({kind:"SelectQueryNode",from:FromNode.create(t),...e&&{with:e}})},cloneWithSelections(t,e){return freeze({...t,selections:t.selections?freeze([...t.selections,...e]):freeze(e)})},cloneWithDistinctOn(t,e){return freeze({...t,distinctOn:t.distinctOn?freeze([...t.distinctOn,...e]):freeze(e)})},cloneWithFrontModifier(t,e){return freeze({...t,frontModifiers:t.frontModifiers?freeze([...t.frontModifiers,e]):freeze([e])})},cloneWithOrderByItems(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithGroupByItems(t,e){return freeze({...t,groupBy:t.groupBy?GroupByNode.cloneWithItems(t.groupBy,e):GroupByNode.create(e)})},cloneWithLimit(t,e){return freeze({...t,limit:e})},cloneWithOffset(t,e){return freeze({...t,offset:e})},cloneWithFetch(t,e){return freeze({...t,fetch:e})},cloneWithHaving(t,e){return freeze({...t,having:t.having?HavingNode.cloneWithOperation(t.having,"And",e):HavingNode.create(e)})},cloneWithSetOperations(t,e){return freeze({...t,setOperations:t.setOperations?freeze([...t.setOperations,...e]):freeze([...e])})},cloneWithoutSelections(t){return freeze({...t,selections:[]})},cloneWithoutLimit(t){return freeze({...t,limit:void 0})},cloneWithoutOffset(t){return freeze({...t,offset:void 0})},cloneWithoutOrderBy(t){return freeze({...t,orderBy:void 0})},cloneWithoutGroupBy(t){return freeze({...t,groupBy:void 0})}});function preventAwait(t,e){Object.defineProperties(t.prototype,{then:{enumerable:!1,value:()=>{throw new Error(e)}}})}class JoinBuilder{#e;constructor(e){this.#e=freeze(e)}on(...e){return new JoinBuilder({...this.#e,joinNode:JoinNode.cloneWithOn(this.#e.joinNode,parseValueBinaryOperationOrExpression(e))})}onRef(e,i,r){return new JoinBuilder({...this.#e,joinNode:JoinNode.cloneWithOn(this.#e.joinNode,parseReferentialBinaryOperation(e,i,r))})}onTrue(){return new JoinBuilder({...this.#e,joinNode:JoinNode.cloneWithOn(this.#e.joinNode,RawNode.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return this.#e.joinNode}}preventAwait(JoinBuilder,"don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.");const PartitionByItemNode=freeze({is(t){return t.kind==="PartitionByItemNode"},create(t){return freeze({kind:"PartitionByItemNode",partitionBy:t})}});function parsePartitionBy(t){return parseReferenceExpressionOrList(t).map(PartitionByItemNode.create)}class OverBuilder{#e;constructor(e){this.#e=freeze(e)}orderBy(e,i){return new OverBuilder({overNode:OverNode.cloneWithOrderByItems(this.#e.overNode,parseOrderBy([e,i]))})}partitionBy(e){return new OverBuilder({overNode:OverNode.cloneWithPartitionByItems(this.#e.overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return this.#e.overNode}}preventAwait(OverBuilder,"don't await OverBuilder instances. They are never executed directly and are always just a part of a query.");const SelectionNode=freeze({is(t){return t.kind==="SelectionNode"},create(t){return freeze({kind:"SelectionNode",selection:t})},createSelectAll(){return freeze({kind:"SelectionNode",selection:SelectAllNode.create()})},createSelectAllFromTable(t){return freeze({kind:"SelectionNode",selection:ReferenceNode.createSelectAll(t)})}});function parseSelectArg(t){return isFunction(t)?parseSelectArg(t(expressionBuilder())):isReadonlyArray(t)?t.map(e=>parseSelectExpression(e)):[parseSelectExpression(t)]}function parseSelectExpression(t){return isString(t)?SelectionNode.create(parseAliasedStringReference(t)):isDynamicReferenceBuilder(t)?SelectionNode.create(t.toOperationNode()):SelectionNode.create(parseAliasedExpression(t))}function parseSelectAll(t){return t?Array.isArray(t)?t.map(parseSelectAllArg):[parseSelectAllArg(t)]:[SelectionNode.createSelectAll()]}function parseSelectAllArg(t){if(isString(t))return SelectionNode.createSelectAllFromTable(parseTable(t));throw new Error(`invalid value selectAll expression: ${JSON.stringify(t)}`)}const ValuesNode=freeze({is(t){return t.kind==="ValuesNode"},create(t){return freeze({kind:"ValuesNode",values:freeze(t)})}}),DefaultInsertValueNode=freeze({is(t){return t.kind==="DefaultInsertValueNode"},create(){return freeze({kind:"DefaultInsertValueNode"})}});function parseInsertExpression(t){const e=isFunction(t)?t(expressionBuilder()):t,i=isReadonlyArray(e)?e:freeze([e]);return parseInsertColumnsAndValues(i)}function parseInsertColumnsAndValues(t){const e=parseColumnNamesAndIndexes(t);return[freeze([...e.keys()].map(ColumnNode.create)),ValuesNode.create(t.map(i=>parseRowValues(i,e)))]}function parseColumnNamesAndIndexes(t){const e=new Map;for(const i of t){const r=Object.keys(i);for(const n of r)!e.has(n)&&i[n]!==void 0&&e.set(n,e.size)}return e}function parseRowValues(t,e){const i=Object.keys(t),r=Array.from({length:e.size});let n=!1,s=i.length;for(const a of i){const h=e.get(a);if(isUndefined(h)){s--;continue}const u=t[a];(isUndefined(u)||isExpressionOrFactory(u))&&(n=!0),r[h]=u}if(s<e.size||n){const a=DefaultInsertValueNode.create();return ValueListNode.create(r.map(h=>isUndefined(h)?a:parseValueExpression(h)))}return PrimitiveValueListNode.create(r)}const InsertQueryNode=freeze({is(t){return t.kind==="InsertQueryNode"},create(t,e,i){return freeze({kind:"InsertQueryNode",into:t,...e&&{with:e},replace:i})},createWithoutInto(){return freeze({kind:"InsertQueryNode"})},cloneWith(t,e){return freeze({...t,...e})}}),UpdateQueryNode=freeze({is(t){return t.kind==="UpdateQueryNode"},create(t,e){return freeze({kind:"UpdateQueryNode",table:t,...e&&{with:e}})},createWithoutTable(){return freeze({kind:"UpdateQueryNode"})},cloneWithFromItems(t,e){return freeze({...t,from:t.from?FromNode.cloneWithFroms(t.from,e):FromNode.create(e)})},cloneWithUpdates(t,e){return freeze({...t,updates:t.updates?freeze([...t.updates,...e]):e})},cloneWithLimit(t,e){return freeze({...t,limit:e})}}),UsingNode=freeze({is(t){return t.kind==="UsingNode"},create(t){return freeze({kind:"UsingNode",tables:freeze(t)})},cloneWithTables(t,e){return freeze({...t,tables:freeze([...t.tables,...e])})}}),DeleteQueryNode=freeze({is(t){return t.kind==="DeleteQueryNode"},create(t,e){return freeze({kind:"DeleteQueryNode",from:FromNode.create(t),...e&&{with:e}})},cloneWithOrderByItems(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithoutOrderBy(t){return freeze({...t,orderBy:void 0})},cloneWithLimit(t,e){return freeze({...t,limit:e})},cloneWithoutLimit(t){return freeze({...t,limit:void 0})},cloneWithUsing(t,e){return freeze({...t,using:t.using!==void 0?UsingNode.cloneWithTables(t.using,e):UsingNode.create(e)})}}),WhereNode=freeze({is(t){return t.kind==="WhereNode"},create(t){return freeze({kind:"WhereNode",where:t})},cloneWithOperation(t,e,i){return freeze({...t,where:e==="And"?AndNode.create(t.where,i):OrNode.create(t.where,i)})}}),ReturningNode=freeze({is(t){return t.kind==="ReturningNode"},create(t){return freeze({kind:"ReturningNode",selections:freeze(t)})},cloneWithSelections(t,e){return freeze({...t,selections:t.selections?freeze([...t.selections,...e]):freeze(e)})}}),ExplainNode=freeze({is(t){return t.kind==="ExplainNode"},create(t,e){return freeze({kind:"ExplainNode",format:t,options:e})}}),WhenNode=freeze({is(t){return t.kind==="WhenNode"},create(t){return freeze({kind:"WhenNode",condition:t})},cloneWithResult(t,e){return freeze({...t,result:e})}}),MergeQueryNode=freeze({is(t){return t.kind==="MergeQueryNode"},create(t,e){return freeze({kind:"MergeQueryNode",into:t,...e&&{with:e}})},cloneWithUsing(t,e){return freeze({...t,using:e})},cloneWithWhen(t,e){return freeze({...t,whens:t.whens?freeze([...t.whens,e]):freeze([e])})},cloneWithThen(t,e){return freeze({...t,whens:t.whens?freeze([...t.whens.slice(0,-1),WhenNode.cloneWithResult(t.whens[t.whens.length-1],e)]):void 0})}}),OutputNode=freeze({is(t){return t.kind==="OutputNode"},create(t){return freeze({kind:"OutputNode",selections:freeze(t)})},cloneWithSelections(t,e){return freeze({...t,selections:t.selections?freeze([...t.selections,...e]):freeze(e)})}}),QueryNode=freeze({is(t){return SelectQueryNode.is(t)||InsertQueryNode.is(t)||UpdateQueryNode.is(t)||DeleteQueryNode.is(t)||MergeQueryNode.is(t)},cloneWithEndModifier(t,e){return freeze({...t,endModifiers:t.endModifiers?freeze([...t.endModifiers,e]):freeze([e])})},cloneWithWhere(t,e){return freeze({...t,where:t.where?WhereNode.cloneWithOperation(t.where,"And",e):WhereNode.create(e)})},cloneWithJoin(t,e){return freeze({...t,joins:t.joins?freeze([...t.joins,e]):freeze([e])})},cloneWithReturning(t,e){return freeze({...t,returning:t.returning?ReturningNode.cloneWithSelections(t.returning,e):ReturningNode.create(e)})},cloneWithoutReturning(t){return freeze({...t,returning:void 0})},cloneWithoutWhere(t){return freeze({...t,where:void 0})},cloneWithExplain(t,e,i){return freeze({...t,explain:ExplainNode.create(e,i?.toOperationNode())})},cloneWithTop(t,e){return freeze({...t,top:e})},cloneWithOutput(t,e){return freeze({...t,output:t.output?OutputNode.cloneWithSelections(t.output,e):OutputNode.create(e)})}}),ColumnUpdateNode=freeze({is(t){return t.kind==="ColumnUpdateNode"},create(t,e){return freeze({kind:"ColumnUpdateNode",column:t,value:e})}});function parseUpdate(...t){return t.length===2?[ColumnUpdateNode.create(parseReferenceExpression(t[0]),parseValueExpression(t[1]))]:parseUpdateObjectExpression(t[0])}function parseUpdateObjectExpression(t){const e=isFunction(t)?t(expressionBuilder()):t;return Object.entries(e).filter(([i,r])=>r!==void 0).map(([i,r])=>ColumnUpdateNode.create(ColumnNode.create(i),parseValueExpression(r)))}const OnDuplicateKeyNode=freeze({is(t){return t.kind==="OnDuplicateKeyNode"},create(t){return freeze({kind:"OnDuplicateKeyNode",updates:t})}});class InsertResult{insertId;numInsertedOrUpdatedRows;constructor(e,i){this.insertId=e,this.numInsertedOrUpdatedRows=i}}class NoResultError extends Error{node;constructor(e){super("no result"),this.node=e}}function isNoResultErrorConstructor(t){return Object.prototype.hasOwnProperty.call(t,"prototype")}const OnConflictNode=freeze({is(t){return t.kind==="OnConflictNode"},create(){return freeze({kind:"OnConflictNode"})},cloneWith(t,e){return freeze({...t,...e})},cloneWithIndexWhere(t,e){return freeze({...t,indexWhere:t.indexWhere?WhereNode.cloneWithOperation(t.indexWhere,"And",e):WhereNode.create(e)})},cloneWithIndexOrWhere(t,e){return freeze({...t,indexWhere:t.indexWhere?WhereNode.cloneWithOperation(t.indexWhere,"Or",e):WhereNode.create(e)})},cloneWithUpdateWhere(t,e){return freeze({...t,updateWhere:t.updateWhere?WhereNode.cloneWithOperation(t.updateWhere,"And",e):WhereNode.create(e)})},cloneWithUpdateOrWhere(t,e){return freeze({...t,updateWhere:t.updateWhere?WhereNode.cloneWithOperation(t.updateWhere,"Or",e):WhereNode.create(e)})},cloneWithoutIndexWhere(t){return freeze({...t,indexWhere:void 0})},cloneWithoutUpdateWhere(t){return freeze({...t,updateWhere:void 0})}});class OnConflictBuilder{#e;constructor(e){this.#e=freeze(e)}column(e){const i=ColumnNode.create(e);return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?freeze([...this.#e.onConflictNode.columns,i]):freeze([i])})})}columns(e){const i=e.map(ColumnNode.create);return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?freeze([...this.#e.onConflictNode.columns,...i]):freeze(i)})})}constraint(e){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{constraint:IdentifierNode.create(e)})})}expression(e){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithIndexWhere(this.#e.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,i,r){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithIndexWhere(this.#e.onConflictNode,parseReferentialBinaryOperation(e,i,r))})}clearWhere(){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithoutIndexWhere(this.#e.onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{updates:parseUpdateObjectExpression(e)})})}$call(e){return e(this)}}preventAwait(OnConflictBuilder,"don't await OnConflictBuilder instances.");class OnConflictDoNothingBuilder{#e;constructor(e){this.#e=freeze(e)}toOperationNode(){return this.#e.onConflictNode}}preventAwait(OnConflictDoNothingBuilder,"don't await OnConflictDoNothingBuilder instances.");class OnConflictUpdateBuilder{#e;constructor(e){this.#e=freeze(e)}where(...e){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithUpdateWhere(this.#e.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,i,r){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithUpdateWhere(this.#e.onConflictNode,parseReferentialBinaryOperation(e,i,r))})}clearWhere(){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithoutUpdateWhere(this.#e.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#e.onConflictNode}}preventAwait(OnConflictUpdateBuilder,"don't await OnConflictUpdateBuilder instances.");const TopNode=freeze({is(t){return t.kind==="TopNode"},create(t,e){return freeze({kind:"TopNode",expression:t,modifiers:e})}});function parseTop(t,e){if(!isNumber(t)&&!isBigInt(t))throw new Error(`Invalid top expression: ${t}`);if(!isUndefined(e)&&!isTopModifiers(e))throw new Error(`Invalid top modifiers: ${e}`);return TopNode.create(t,e)}function isTopModifiers(t){return t==="percent"||t==="with ties"||t==="percent with ties"}class InsertQueryBuilder{#e;constructor(e){this.#e=freeze(e)}values(e){const[i,r]=parseInsertExpression(e);return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{columns:i,values:r})})}columns(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{columns:freeze(e.map(ColumnNode.create))})})}expression(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{values:parseExpression(e)})})}defaultValues(){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{defaultValues:!0})})}modifyEnd(e){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}ignore(){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{ignore:!0})})}top(e,i){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithTop(this.#e.queryNode,parseTop(e,i))})}onConflict(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:OnConflictNode.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{onDuplicateKey:OnDuplicateKeyNode.create(parseUpdateObjectExpression(e))})})}returning(e){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectArg(e))})}returningAll(){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectAll())})}output(e){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectArg(e))})}outputAll(e){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectAll(e))})}clearReturning(){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutReturning(this.#e.queryNode)})}$call(e){return e(this)}$if(e,i){return e?i(this):new InsertQueryBuilder({...this.#e})}$castTo(){return new InsertQueryBuilder(this.#e)}$narrowType(){return new InsertQueryBuilder(this.#e)}$assertType(){return new InsertQueryBuilder(this.#e)}withPlugin(e){return new InsertQueryBuilder({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),i=await this.#e.executor.executeQuery(e,this.#e.queryId),{adapter:r}=this.#e.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?i.rows:[new InsertResult(i.insertId,i.numAffectedRows??i.numUpdatedOrDeletedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const i=await this.executeTakeFirst();if(i===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return i}async*stream(e=100){const i=this.compile(),r=this.#e.executor.stream(i,e,this.#e.queryId);for await(const n of r)yield*n.rows}async explain(e,i){return await new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,i)}).execute()}}preventAwait(InsertQueryBuilder,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class DeleteResult{numDeletedRows;constructor(e){this.numDeletedRows=e}}const LimitNode=freeze({is(t){return t.kind==="LimitNode"},create(t){return freeze({kind:"LimitNode",limit:t})}});class DeleteQueryBuilder{#e;constructor(e){this.#e=freeze(e)}where(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,i,r){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseReferentialBinaryOperation(e,i,r))})}clearWhere(){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutWhere(this.#e.queryNode)})}top(e,i){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithTop(this.#e.queryNode,parseTop(e,i))})}using(e){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithUsing(this.#e.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("FullJoin",e))})}returning(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectArg(e))})}returningAll(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectAll(e))})}output(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectArg(e))})}outputAll(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectAll(e))})}clearReturning(){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutReturning(this.#e.queryNode)})}clearLimit(){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithoutLimit(this.#e.queryNode)})}clearOrderBy(){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithoutOrderBy(this.#e.queryNode)})}orderBy(e,i){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithOrderByItems(this.#e.queryNode,parseOrderBy([e,i]))})}limit(e){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithLimit(this.#e.queryNode,LimitNode.create(parseValueExpression(e)))})}modifyEnd(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}$call(e){return e(this)}$if(e,i){return e?i(this):new DeleteQueryBuilder({...this.#e})}$castTo(){return new DeleteQueryBuilder(this.#e)}$narrowType(){return new DeleteQueryBuilder(this.#e)}$assertType(){return new DeleteQueryBuilder(this.#e)}withPlugin(e){return new DeleteQueryBuilder({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),i=await this.#e.executor.executeQuery(e,this.#e.queryId),{adapter:r}=this.#e.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?i.rows:[new DeleteResult(i.numAffectedRows??i.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const i=await this.executeTakeFirst();if(i===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return i}async*stream(e=100){const i=this.compile(),r=this.#e.executor.stream(i,e,this.#e.queryId);for await(const n of r)yield*n.rows}async explain(e,i){return await new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,i)}).execute()}}preventAwait(DeleteQueryBuilder,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class UpdateResult{numUpdatedRows;numChangedRows;constructor(e,i){this.numUpdatedRows=e,this.numChangedRows=i}}class UpdateQueryBuilder{#e;constructor(e){this.#e=freeze(e)}where(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,i,r){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseReferentialBinaryOperation(e,i,r))})}clearWhere(){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutWhere(this.#e.queryNode)})}top(e,i){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithTop(this.#e.queryNode,parseTop(e,i))})}from(e){return new UpdateQueryBuilder({...this.#e,queryNode:UpdateQueryNode.cloneWithFromItems(this.#e.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("FullJoin",e))})}limit(e){return new UpdateQueryBuilder({...this.#e,queryNode:UpdateQueryNode.cloneWithLimit(this.#e.queryNode,LimitNode.create(parseValueExpression(e)))})}set(...e){return new UpdateQueryBuilder({...this.#e,queryNode:UpdateQueryNode.cloneWithUpdates(this.#e.queryNode,parseUpdate(...e))})}returning(e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectArg(e))})}returningAll(e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectAll(e))})}output(e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectArg(e))})}outputAll(e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectAll(e))})}modifyEnd(e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}clearReturning(){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutReturning(this.#e.queryNode)})}$call(e){return e(this)}$if(e,i){return e?i(this):new UpdateQueryBuilder({...this.#e})}$castTo(){return new UpdateQueryBuilder(this.#e)}$narrowType(){return new UpdateQueryBuilder(this.#e)}$assertType(){return new UpdateQueryBuilder(this.#e)}withPlugin(e){return new UpdateQueryBuilder({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),i=await this.#e.executor.executeQuery(e,this.#e.queryId),{adapter:r}=this.#e.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?i.rows:[new UpdateResult(i.numAffectedRows??i.numUpdatedOrDeletedRows??BigInt(0),i.numChangedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const i=await this.executeTakeFirst();if(i===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return i}async*stream(e=100){const i=this.compile(),r=this.#e.executor.stream(i,e,this.#e.queryId);for await(const n of r)yield*n.rows}async explain(e,i){return await new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,i)}).execute()}}preventAwait(UpdateQueryBuilder,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const CommonTableExpressionNameNode=freeze({is(t){return t.kind==="CommonTableExpressionNameNode"},create(t,e){return freeze({kind:"CommonTableExpressionNameNode",table:TableNode.create(t),columns:e?freeze(e.map(ColumnNode.create)):void 0})}}),CommonTableExpressionNode=freeze({is(t){return t.kind==="CommonTableExpressionNode"},create(t,e){return freeze({kind:"CommonTableExpressionNode",name:t,expression:e})},cloneWith(t,e){return freeze({...t,...e})}});class CTEBuilder{#e;constructor(e){this.#e=freeze(e)}materialized(){return new CTEBuilder({...this.#e,node:CommonTableExpressionNode.cloneWith(this.#e.node,{materialized:!0})})}notMaterialized(){return new CTEBuilder({...this.#e,node:CommonTableExpressionNode.cloneWith(this.#e.node,{materialized:!1})})}toOperationNode(){return this.#e.node}}preventAwait(CTEBuilder,"don't await CTEBuilder instances. They are never executed directly and are always just a part of a query.");function parseCommonTableExpression(t,e){const i=e(createQueryCreator()).toOperationNode();return isFunction(t)?t(cteBuilderFactory(i)).toOperationNode():CommonTableExpressionNode.create(parseCommonTableExpressionName(t),i)}function cteBuilderFactory(t){return e=>new CTEBuilder({node:CommonTableExpressionNode.create(parseCommonTableExpressionName(e),t)})}function parseCommonTableExpressionName(t){if(t.includes("(")){const e=t.split(/[\(\)]/),i=e[0],r=e[1].split(",").map(n=>n.trim());return CommonTableExpressionNameNode.create(i,r)}else return CommonTableExpressionNameNode.create(t)}const WithNode=freeze({is(t){return t.kind==="WithNode"},create(t,e){return freeze({kind:"WithNode",expressions:freeze([t]),...e})},cloneWithExpression(t,e){return freeze({...t,expressions:freeze([...t.expressions,e])})}}),CHARS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function randomString(t){let e="";for(let i=0;i<t;++i)e+=randomChar();return e}function randomChar(){return CHARS[~~(Math.random()*CHARS.length)]}function createQueryId(){return new LazyQueryId}class LazyQueryId{#e;get queryId(){return this.#e===void 0&&(this.#e=randomString(8)),this.#e}}function requireAllProps(t){return t}class OperationNodeTransformer{nodeStack=[];#e=freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this),OutputNode:this.transformOutput.bind(this)});transformNode(e){if(!e)return e;this.nodeStack.push(e);const i=this.transformNodeImpl(e);return this.nodeStack.pop(),freeze(i)}transformNodeImpl(e){return this.#e[e.kind](e)}transformNodeList(e){return e&&freeze(e.map(i=>this.transformNode(i)))}transformSelectQuery(e){return{kind:"SelectQueryNode",from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations),fetch:this.transformNode(e.fetch),top:this.transformNode(e.top)}}transformSelection(e){return{kind:"SelectionNode",selection:this.transformNode(e.selection)}}transformColumn(e){return{kind:"ColumnNode",column:this.transformNode(e.column)}}transformAlias(e){return{kind:"AliasNode",node:this.transformNode(e.node),alias:this.transformNode(e.alias)}}transformTable(e){return{kind:"TableNode",table:this.transformNode(e.table)}}transformFrom(e){return{kind:"FromNode",froms:this.transformNodeList(e.froms)}}transformReference(e){return{kind:"ReferenceNode",column:this.transformNode(e.column),table:this.transformNode(e.table)}}transformAnd(e){return{kind:"AndNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformOr(e){return{kind:"OrNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformValueList(e){return{kind:"ValueListNode",values:this.transformNodeList(e.values)}}transformParens(e){return{kind:"ParensNode",node:this.transformNode(e.node)}}transformJoin(e){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)}}transformRaw(e){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)}}transformWhere(e){return{kind:"WhereNode",where:this.transformNode(e.where)}}transformInsertQuery(e){return{kind:"InsertQueryNode",into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain),defaultValues:e.defaultValues,top:this.transformNode(e.top),output:this.transformNode(e.output)}}transformValues(e){return{kind:"ValuesNode",values:this.transformNodeList(e.values)}}transformDeleteQuery(e){return{kind:"DeleteQueryNode",from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain),top:this.transformNode(e.top),output:this.transformNode(e.output)}}transformReturning(e){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections)}}transformCreateTable(e){return{kind:"CreateTableNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),selectQuery:this.transformNode(e.selectQuery)}}transformColumnDefinition(e){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),nullsNotDistinct:e.nullsNotDistinct,identity:e.identity,ifNotExists:e.ifNotExists}}transformAddColumn(e){return{kind:"AddColumnNode",column:this.transformNode(e.column)}}transformDropTable(e){return{kind:"DropTableNode",table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e){return{kind:"OrderByNode",items:this.transformNodeList(e.items)}}transformOrderByItem(e){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)}}transformGroupBy(e){return{kind:"GroupByNode",items:this.transformNodeList(e.items)}}transformGroupByItem(e){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy)}}transformUpdateQuery(e){return{kind:"UpdateQueryNode",table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),endModifiers:this.transformNodeList(e.endModifiers),with:this.transformNode(e.with),explain:this.transformNode(e.explain),limit:this.transformNode(e.limit),top:this.transformNode(e.top),output:this.transformNode(e.output)}}transformColumnUpdate(e){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column),value:this.transformNode(e.value)}}transformLimit(e){return{kind:"LimitNode",limit:this.transformNode(e.limit)}}transformOffset(e){return{kind:"OffsetNode",offset:this.transformNode(e.offset)}}transformOnConflict(e){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing}}transformOnDuplicateKey(e){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates)}}transformCreateIndex(e){return{kind:"CreateIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where),nullsNotDistinct:e.nullsNotDistinct}}transformList(e){return{kind:"ListNode",items:this.transformNodeList(e.items)}}transformDropIndex(e){return{kind:"DropIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformUniqueConstraint(e){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name),nullsNotDistinct:e.nullsNotDistinct}}transformForeignKeyConstraint(e){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformSetOperation(e){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression),all:e.all}}transformReferences(e){return{kind:"ReferencesNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression),name:this.transformNode(e.name)}}transformWith(e){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions),recursive:e.recursive}}transformCommonTableExpression(e){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name),materialized:e.materialized,expression:this.transformNode(e.expression)}}transformCommonTableExpressionName(e){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)}}transformHaving(e){return{kind:"HavingNode",having:this.transformNode(e.having)}}transformCreateSchema(e){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists}}transformDropSchema(e){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e){return{kind:"AlterTableNode",table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint),addIndex:this.transformNode(e.addIndex),dropIndex:this.transformNode(e.dropIndex)}}transformDropColumn(e){return{kind:"DropColumnNode",column:this.transformNode(e.column)}}transformRenameColumn(e){return{kind:"RenameColumnNode",column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)}}transformAlterColumn(e){return{kind:"AlterColumnNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e){return{kind:"ModifyColumnNode",column:this.transformNode(e.column)}}transformAddConstraint(e){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint)}}transformDropConstraint(e){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier}}transformCreateView(e){return{kind:"CreateViewNode",name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)}}transformDropView(e){return{kind:"DropViewNode",name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)}}transformDefaultValue(e){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue)}}transformOn(e){return{kind:"OnNode",on:this.transformNode(e.on)}}transformSelectModifier(e){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier),of:this.transformNodeList(e.of)}}transformCreateType(e){return{kind:"CreateTypeNode",name:this.transformNode(e.name),enum:this.transformNode(e.enum)}}transformDropType(e){return{kind:"DropTypeNode",name:this.transformNode(e.name),ifExists:e.ifExists}}transformExplain(e){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options)}}transformSchemableIdentifier(e){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)}}transformAggregateFunction(e){return{kind:"AggregateFunctionNode",aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,orderBy:this.transformNode(e.orderBy),filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)}}transformOver(e){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)}}transformPartitionBy(e){return{kind:"PartitionByNode",items:this.transformNodeList(e.items)}}transformPartitionByItem(e){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy)}}transformBinaryOperation(e){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)}}transformUnaryOperation(e){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)}}transformUsing(e){return{kind:"UsingNode",tables:this.transformNodeList(e.tables)}}transformFunction(e){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments)}}transformCase(e){return{kind:"CaseNode",value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement}}transformWhen(e){return{kind:"WhenNode",condition:this.transformNode(e.condition),result:this.transformNode(e.result)}}transformJSONReference(e){return{kind:"JSONReferenceNode",reference:this.transformNode(e.reference),traversal:this.transformNode(e.traversal)}}transformJSONPath(e){return{kind:"JSONPathNode",inOperator:this.transformNode(e.inOperator),pathLegs:this.transformNodeList(e.pathLegs)}}transformJSONPathLeg(e){return{kind:"JSONPathLegNode",type:e.type,value:e.value}}transformJSONOperatorChain(e){return{kind:"JSONOperatorChainNode",operator:this.transformNode(e.operator),values:this.transformNodeList(e.values)}}transformTuple(e){return{kind:"TupleNode",values:this.transformNodeList(e.values)}}transformMergeQuery(e){return{kind:"MergeQueryNode",into:this.transformNode(e.into),using:this.transformNode(e.using),whens:this.transformNodeList(e.whens),with:this.transformNode(e.with),top:this.transformNode(e.top),endModifiers:this.transformNodeList(e.endModifiers),output:this.transformNode(e.output)}}transformMatched(e){return{kind:"MatchedNode",not:e.not,bySource:e.bySource}}transformAddIndex(e){return{kind:"AddIndexNode",name:this.transformNode(e.name),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists}}transformCast(e){return{kind:"CastNode",expression:this.transformNode(e.expression),dataType:this.transformNode(e.dataType)}}transformFetch(e){return{kind:"FetchNode",rowCount:this.transformNode(e.rowCount),modifier:e.modifier}}transformTop(e){return{kind:"TopNode",expression:e.expression,modifiers:e.modifiers}}transformOutput(e){return{kind:"OutputNode",selections:this.transformNodeList(e.selections)}}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}}const ROOT_OPERATION_NODES=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0}),SCHEMALESS_FUNCTIONS={json_agg:!0,to_json:!0};class WithSchemaTransformer extends OperationNodeTransformer{#e;#t=new Set;#i=new Set;constructor(e){super(),this.#e=e}transformNodeImpl(e){if(!this.#n(e))return super.transformNodeImpl(e);const i=this.#h(e);for(const s of i)this.#i.add(s);const r=this.#o(e);for(const s of r)this.#t.add(s);const n=super.transformNodeImpl(e);for(const s of r)this.#t.delete(s);for(const s of i)this.#i.delete(s);return n}transformSchemableIdentifier(e){const i=super.transformSchemableIdentifier(e);return i.schema||!this.#t.has(e.identifier.name)?i:{...i,schema:IdentifierNode.create(this.#e)}}transformReferences(e){const i=super.transformReferences(e);return i.table.table.schema?i:{...i,table:TableNode.createWithSchema(this.#e,i.table.table.identifier.name)}}transformAggregateFunction(e){return{...super.transformAggregateFunction({...e,aggregated:[]}),aggregated:this.#r(e,"aggregated")}}transformFunction(e){return{...super.transformFunction({...e,arguments:[]}),arguments:this.#r(e,"arguments")}}#r(e,i){return SCHEMALESS_FUNCTIONS[e.func]?e[i].map(r=>!TableNode.is(r)||r.table.schema?this.transformNode(r):{...r,table:this.transformIdentifier(r.table.identifier)}):this.transformNodeList(e[i])}#n(e){return e.kind in ROOT_OPERATION_NODES}#o(e){const i=new Set;if("name"in e&&e.name&&SchemableIdentifierNode.is(e.name)&&this.#a(e.name,i),"from"in e&&e.from)for(const r of e.from.froms)this.#s(r,i);if("into"in e&&e.into&&this.#s(e.into,i),"table"in e&&e.table&&this.#s(e.table,i),"joins"in e&&e.joins)for(const r of e.joins)this.#s(r.table,i);return"using"in e&&e.using&&this.#s(e.using,i),i}#h(e){const i=new Set;return"with"in e&&e.with&&this.#u(e.with,i),i}#s(e,i){const r=TableNode.is(e)?e:AliasNode.is(e)&&TableNode.is(e.node)?e.node:null;r&&this.#a(r.table,i)}#a(e,i){const r=e.identifier.name;!this.#t.has(r)&&!this.#i.has(r)&&i.add(r)}#u(e,i){for(const r of e.expressions){const n=r.name.table.table.identifier.name;this.#i.has(n)||i.add(n)}}}class WithSchemaPlugin{#e;constructor(e){this.#e=new WithSchemaTransformer(e)}transformQuery(e){return this.#e.transformNode(e.node)}async transformResult(e){return e.result}}const MatchedNode=freeze({is(t){return t.kind==="MatchedNode"},create(t,e=!1){return freeze({kind:"MatchedNode",not:t,bySource:e})}});function parseMergeWhen(t,e,i){return WhenNode.create(parseFilterList([MatchedNode.create(!t.isMatched,t.bySource),...e&&e.length>0?[e.length===3&&i?parseReferentialBinaryOperation(e[0],e[1],e[2]):parseValueBinaryOperationOrExpression(e)]:[]],"and",!1))}function parseMergeThen(t){return isString(t)?RawNode.create([t],[]):isOperationNodeSource(t)?t.toOperationNode():t}class Deferred{#e;#t;#i;constructor(){this.#e=new Promise((e,i)=>{this.#i=i,this.#t=e})}get promise(){return this.#e}resolve=e=>{this.#t&&this.#t(e)};reject=e=>{this.#i&&this.#i(e)}}const LOGGED_MESSAGES=new Set;function logOnce(t){LOGGED_MESSAGES.has(t)||(LOGGED_MESSAGES.add(t),console.log(t))}const NO_PLUGINS=freeze([]);class QueryExecutorBase{#e;constructor(e=NO_PLUGINS){this.#e=e}get plugins(){return this.#e}transformQuery(e,i){for(const r of this.#e){const n=r.transformQuery({node:e,queryId:i});if(n.kind===e.kind)e=n;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${n.kind}`].join(" "))}return e}async executeQuery(e,i){return await this.provideConnection(async r=>{const n=await r.executeQuery(e),s=await this.#t(n,i);return warnOfOutdatedDriverOrPlugins(n,s),s})}async*stream(e,i,r){const n=new Deferred,s=new Deferred;this.provideConnection(async a=>(n.resolve(a),await s.promise)).catch(a=>n.reject(a));const o=await n.promise;try{for await(const a of o.streamQuery(e,i))yield await this.#t(a,r)}finally{s.resolve()}}async#t(e,i){for(const r of this.#e)e=await r.transformResult({result:e,queryId:i});return e}}function warnOfOutdatedDriverOrPlugins(t,e){const{numAffectedRows:i}=t;i===void 0&&t.numUpdatedOrDeletedRows===void 0||i!==void 0&&e.numAffectedRows!==void 0||logOnce("kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.")}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const NOOP_QUERY_EXECUTOR=new NoopQueryExecutor;class MergeResult{numChangedRows;constructor(e){this.numChangedRows=e}}class MergeQueryBuilder{#e;constructor(e){this.#e=freeze(e)}modifyEnd(e){return new MergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}top(e,i){return new MergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithTop(this.#e.queryNode,parseTop(e,i))})}using(...e){return new WheneableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithUsing(this.#e.queryNode,parseJoin("Using",e))})}output(e){return new MergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectArg(e))})}outputAll(e){return new MergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectAll(e))})}}preventAwait(MergeQueryBuilder,"don't await MergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");class WheneableMergeQueryBuilder{#e;constructor(e){this.#e=freeze(e)}modifyEnd(e){return new WheneableMergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}top(e,i){return new WheneableMergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithTop(this.#e.queryNode,parseTop(e,i))})}whenMatched(){return this.#t([])}whenMatchedAnd(...e){return this.#t(e)}whenMatchedAndRef(e,i,r){return this.#t([e,i,r],!0)}#t(e,i){return new MatchedThenableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithWhen(this.#e.queryNode,parseMergeWhen({isMatched:!0},e,i))})}whenNotMatched(){return this.#i([])}whenNotMatchedAnd(...e){return this.#i(e)}whenNotMatchedAndRef(e,i,r){return this.#i([e,i,r],!0)}whenNotMatchedBySource(){return this.#i([],!1,!0)}whenNotMatchedBySourceAnd(...e){return this.#i(e,!1,!0)}whenNotMatchedBySourceAndRef(e,i,r){return this.#i([e,i,r],!0,!0)}output(e){return new WheneableMergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectArg(e))})}outputAll(e){return new WheneableMergeQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithOutput(this.#e.queryNode,parseSelectAll(e))})}#i(e,i=!1,r=!1){const n={...this.#e,queryNode:MergeQueryNode.cloneWithWhen(this.#e.queryNode,parseMergeWhen({isMatched:!1,bySource:r},e,i))},s=r?MatchedThenableMergeQueryBuilder:NotMatchedThenableMergeQueryBuilder;return new s(n)}$call(e){return e(this)}$if(e,i){return e?i(this):new WheneableMergeQueryBuilder({...this.#e})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),i=await this.#e.executor.executeQuery(e,this.#e.queryId);return e.query.output&&this.#e.executor.adapter.supportsOutput?i.rows:[new MergeResult(i.numAffectedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const i=await this.executeTakeFirst();if(i===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return i}}preventAwait(WheneableMergeQueryBuilder,"don't await WheneableMergeQueryBuilder instances directly. To execute the query you need to call `execute`.");class MatchedThenableMergeQueryBuilder{#e;constructor(e){this.#e=freeze(e)}thenDelete(){return new WheneableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithThen(this.#e.queryNode,parseMergeThen("delete"))})}thenDoNothing(){return new WheneableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithThen(this.#e.queryNode,parseMergeThen("do nothing"))})}thenUpdate(e){return new WheneableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithThen(this.#e.queryNode,parseMergeThen(e(new UpdateQueryBuilder({queryId:this.#e.queryId,executor:NOOP_QUERY_EXECUTOR,queryNode:UpdateQueryNode.createWithoutTable()}))))})}thenUpdateSet(...e){return this.thenUpdate(i=>i.set(...e))}}preventAwait(MatchedThenableMergeQueryBuilder,"don't await MatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");class NotMatchedThenableMergeQueryBuilder{#e;constructor(e){this.#e=freeze(e)}thenDoNothing(){return new WheneableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithThen(this.#e.queryNode,parseMergeThen("do nothing"))})}thenInsertValues(e){const[i,r]=parseInsertExpression(e);return new WheneableMergeQueryBuilder({...this.#e,queryNode:MergeQueryNode.cloneWithThen(this.#e.queryNode,parseMergeThen(InsertQueryNode.cloneWith(InsertQueryNode.createWithoutInto(),{columns:i,values:r})))})}}preventAwait(NotMatchedThenableMergeQueryBuilder,"don't await NotMatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");class QueryCreator{#e;constructor(e){this.#e=freeze(e)}selectFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:SelectQueryNode.createFrom(parseTableExpressionOrList(e),this.#e.withNode)})}selectNoFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:SelectQueryNode.cloneWithSelections(SelectQueryNode.create(this.#e.withNode),parseSelectArg(e))})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:InsertQueryNode.create(parseTable(e),this.#e.withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:InsertQueryNode.create(parseTable(e),this.#e.withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:DeleteQueryNode.create(parseTableExpressionOrList(e),this.#e.withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:UpdateQueryNode.create(parseTableExpression(e),this.#e.withNode)})}mergeInto(e){return new MergeQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:MergeQueryNode.create(parseAliasedTable(e),this.#e.withNode)})}with(e,i){const r=parseCommonTableExpression(e,i);return new QueryCreator({...this.#e,withNode:this.#e.withNode?WithNode.cloneWithExpression(this.#e.withNode,r):WithNode.create(r)})}withRecursive(e,i){const r=parseCommonTableExpression(e,i);return new QueryCreator({...this.#e,withNode:this.#e.withNode?WithNode.cloneWithExpression(this.#e.withNode,r):WithNode.create(r,{recursive:!0})})}withPlugin(e){return new QueryCreator({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new QueryCreator({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new QueryCreator({...this.#e,executor:this.#e.executor.withPluginAtFront(new WithSchemaPlugin(e))})}}function createQueryCreator(){return new QueryCreator({executor:NOOP_QUERY_EXECUTOR})}function createJoinBuilder(t,e){return new JoinBuilder({joinNode:JoinNode.create(t,parseTableExpression(e))})}function createOverBuilder(){return new OverBuilder({overNode:OverNode.create()})}function parseJoin(t,e){if(e.length===3)return parseSingleOnJoin(t,e[0],e[1],e[2]);if(e.length===2)return parseCallbackJoin(t,e[0],e[1]);throw new Error("not implemented")}function parseCallbackJoin(t,e,i){return i(createJoinBuilder(t,e)).toOperationNode()}function parseSingleOnJoin(t,e,i,r){return JoinNode.createWithOn(t,parseTableExpression(e),parseReferentialBinaryOperation(i,"=",r))}const OffsetNode=freeze({is(t){return t.kind==="OffsetNode"},create(t){return freeze({kind:"OffsetNode",offset:t})}}),GroupByItemNode=freeze({is(t){return t.kind==="GroupByItemNode"},create(t){return freeze({kind:"GroupByItemNode",groupBy:t})}});function parseGroupBy(t){return t=isFunction(t)?t(expressionBuilder()):t,parseReferenceExpressionOrList(t).map(GroupByItemNode.create)}const SetOperationNode=freeze({is(t){return t.kind==="SetOperationNode"},create(t,e,i){return freeze({kind:"SetOperationNode",operator:t,expression:e,all:i})}});function parseSetOperations(t,e,i){return isFunction(e)&&(e=e(createExpressionBuilder())),isReadonlyArray(e)||(e=[e]),e.map(r=>SetOperationNode.create(t,parseExpression(r),i))}class ExpressionWrapper{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(OrNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}and(...e){return new AndWrapper(AndNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new ExpressionWrapper(this.#e)}$notNull(){return new ExpressionWrapper(this.#e)}toOperationNode(){return this.#e}}class AliasedExpressionWrapper{#e;#t;constructor(e,i){this.#e=e,this.#t=i}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),isOperationNodeSource(this.#t)?this.#t.toOperationNode():IdentifierNode.create(this.#t))}}class OrWrapper{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(OrNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new OrWrapper(this.#e)}toOperationNode(){return ParensNode.create(this.#e)}}class AndWrapper{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}and(...e){return new AndWrapper(AndNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new AndWrapper(this.#e)}toOperationNode(){return ParensNode.create(this.#e)}}const FetchNode={is(t){return t.kind==="FetchNode"},create(t,e){return{kind:"FetchNode",rowCount:ValueNode.create(t),modifier:e}}};function parseFetch(t,e){if(!isNumber(t)&&!isBigInt(t))throw new Error(`Invalid fetch row count: ${t}`);if(!isFetchModifier(e))throw new Error(`Invalid fetch modifier: ${e}`);return FetchNode.create(t,e)}function isFetchModifier(t){return t==="only"||t==="with ties"}class SelectQueryBuilderImpl{#e;constructor(e){this.#e=freeze(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,i,r){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseReferentialBinaryOperation(e,i,r))})}having(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithHaving(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}havingRef(e,i,r){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithHaving(this.#e.queryNode,parseReferentialBinaryOperation(e,i,r))})}select(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSelections(this.#e.queryNode,parseSelectArg(e))})}distinctOn(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithDistinctOn(this.#e.queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithFrontModifier(this.#e.queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}distinct(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithFrontModifier(this.#e.queryNode,SelectModifierNode.create("Distinct"))})}forUpdate(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForUpdate",e?asArray(e).map(parseTable):void 0))})}forShare(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForShare",e?asArray(e).map(parseTable):void 0))})}forKeyShare(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForKeyShare",e?asArray(e).map(parseTable):void 0))})}forNoKeyUpdate(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForNoKeyUpdate",e?asArray(e).map(parseTable):void 0))})}skipLocked(){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("SkipLocked"))})}noWait(){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("NoWait"))})}selectAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSelections(this.#e.queryNode,parseSelectAll(e))})}innerJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("FullJoin",e))})}innerJoinLateral(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LateralInnerJoin",e))})}leftJoinLateral(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LateralLeftJoin",e))})}orderBy(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithOrderByItems(this.#e.queryNode,parseOrderBy(e))})}groupBy(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithGroupByItems(this.#e.queryNode,parseGroupBy(e))})}limit(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithLimit(this.#e.queryNode,LimitNode.create(parseValueExpression(e)))})}offset(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithOffset(this.#e.queryNode,OffsetNode.create(parseValueExpression(e)))})}fetch(e,i="only"){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithFetch(this.#e.queryNode,parseFetch(e,i))})}top(e,i){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithTop(this.#e.queryNode,parseTop(e,i))})}union(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("union",e,!1))})}unionAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("union",e,!0))})}intersect(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("intersect",e,!1))})}intersectAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("intersect",e,!0))})}except(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("except",e,!1))})}exceptAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("except",e,!0))})}as(e){return new AliasedSelectQueryBuilderImpl(this,e)}clearSelect(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutSelections(this.#e.queryNode)})}clearWhere(){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithoutWhere(this.#e.queryNode)})}clearLimit(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutLimit(this.#e.queryNode)})}clearOffset(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutOffset(this.#e.queryNode)})}clearOrderBy(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutOrderBy(this.#e.queryNode)})}clearGroupBy(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutGroupBy(this.#e.queryNode)})}$call(e){return e(this)}$if(e,i){return e?i(this):new SelectQueryBuilderImpl({...this.#e})}$castTo(){return new SelectQueryBuilderImpl(this.#e)}$narrowType(){return new SelectQueryBuilderImpl(this.#e)}$assertType(){return new SelectQueryBuilderImpl(this.#e)}$asTuple(){return new ExpressionWrapper(this.toOperationNode())}withPlugin(e){return new SelectQueryBuilderImpl({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile();return(await this.#e.executor.executeQuery(e,this.#e.queryId)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const i=await this.executeTakeFirst();if(i===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return i}async*stream(e=100){const i=this.compile(),r=this.#e.executor.stream(i,e,this.#e.queryId);for await(const n of r)yield*n.rows}async explain(e,i){return await new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,i)}).execute()}}preventAwait(SelectQueryBuilderImpl,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");function createSelectQueryBuilder(t){return new SelectQueryBuilderImpl(t)}class AliasedSelectQueryBuilderImpl{#e;#t;constructor(e,i){this.#e=e,this.#t=i}get expression(){return this.#e}get alias(){return this.#t}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),IdentifierNode.create(this.#t))}}preventAwait(AliasedSelectQueryBuilderImpl,"don't await AliasedSelectQueryBuilder instances directly. AliasedSelectQueryBuilder should never be executed directly since it's always a part of another query.");const AggregateFunctionNode=freeze({is(t){return t.kind==="AggregateFunctionNode"},create(t,e=[]){return freeze({kind:"AggregateFunctionNode",func:t,aggregated:e})},cloneWithDistinct(t){return freeze({...t,distinct:!0})},cloneWithOrderBy(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithFilter(t,e){return freeze({...t,filter:t.filter?WhereNode.cloneWithOperation(t.filter,"And",e):WhereNode.create(e)})},cloneWithOrFilter(t,e){return freeze({...t,filter:t.filter?WhereNode.cloneWithOperation(t.filter,"Or",e):WhereNode.create(e)})},cloneWithOver(t,e){return freeze({...t,over:e})}}),FunctionNode=freeze({is(t){return t.kind==="FunctionNode"},create(t,e){return freeze({kind:"FunctionNode",func:t,arguments:e})}});class AggregateFunctionBuilder{#e;constructor(e){this.#e=freeze(e)}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithDistinct(this.#e.aggregateFunctionNode)})}orderBy(e,i){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithOrderBy(this.#e.aggregateFunctionNode,parseOrderBy([e,i]))})}filterWhere(...e){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(this.#e.aggregateFunctionNode,parseValueBinaryOperationOrExpression(e))})}filterWhereRef(e,i,r){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(this.#e.aggregateFunctionNode,parseReferentialBinaryOperation(e,i,r))})}over(e){const i=createOverBuilder();return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithOver(this.#e.aggregateFunctionNode,(e?e(i):i).toOperationNode())})}$call(e){return e(this)}$castTo(){return new AggregateFunctionBuilder(this.#e)}$notNull(){return new AggregateFunctionBuilder(this.#e)}toOperationNode(){return this.#e.aggregateFunctionNode}}preventAwait(AggregateFunctionBuilder,"don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.");class AliasedAggregateFunctionBuilder{#e;#t;constructor(e,i){this.#e=e,this.#t=i}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),IdentifierNode.create(this.#t))}}function createFunctionModule(){const t=(i,r)=>new ExpressionWrapper(FunctionNode.create(i,parseReferenceExpressionOrList(r??[]))),e=(i,r)=>new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create(i,r?parseReferenceExpressionOrList(r):void 0)});return Object.assign(t,{agg:e,avg(i){return e("avg",[i])},coalesce(...i){return t("coalesce",i)},count(i){return e("count",[i])},countAll(i){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("count",parseSelectAll(i))})},max(i){return e("max",[i])},min(i){return e("min",[i])},sum(i){return e("sum",[i])},any(i){return t("any",[i])},jsonAgg(i){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("json_agg",[isString(i)?parseTable(i):i.toOperationNode()])})},toJson(i){return new ExpressionWrapper(FunctionNode.create("to_json",[isString(i)?parseTable(i):i.toOperationNode()]))}})}const UnaryOperationNode=freeze({is(t){return t.kind==="UnaryOperationNode"},create(t,e){return freeze({kind:"UnaryOperationNode",operator:t,operand:e})}});function parseUnaryOperation(t,e){return UnaryOperationNode.create(OperatorNode.create(t),parseReferenceExpression(e))}const CaseNode=freeze({is(t){return t.kind==="CaseNode"},create(t){return freeze({kind:"CaseNode",value:t})},cloneWithWhen(t,e){return freeze({...t,when:freeze(t.when?[...t.when,e]:[e])})},cloneWithThen(t,e){return freeze({...t,when:t.when?freeze([...t.when.slice(0,-1),WhenNode.cloneWithResult(t.when[t.when.length-1],e)]):void 0})},cloneWith(t,e){return freeze({...t,...e})}});class CaseBuilder{#e;constructor(e){this.#e=freeze(e)}when(...e){return new CaseThenBuilder({...this.#e,node:CaseNode.cloneWithWhen(this.#e.node,WhenNode.create(parseValueBinaryOperationOrExpression(e)))})}}class CaseThenBuilder{#e;constructor(e){this.#e=freeze(e)}then(e){return new CaseWhenBuilder({...this.#e,node:CaseNode.cloneWithThen(this.#e.node,isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e))})}}class CaseWhenBuilder{#e;constructor(e){this.#e=freeze(e)}when(...e){return new CaseThenBuilder({...this.#e,node:CaseNode.cloneWithWhen(this.#e.node,WhenNode.create(parseValueBinaryOperationOrExpression(e)))})}else(e){return new CaseEndBuilder({...this.#e,node:CaseNode.cloneWith(this.#e.node,{else:isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e)})})}end(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!0}))}}class CaseEndBuilder{#e;constructor(e){this.#e=freeze(e)}end(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!0}))}}const JSONPathLegNode=freeze({is(t){return t.kind==="JSONPathLegNode"},create(t,e){return freeze({kind:"JSONPathLegNode",type:t,value:e})}});class JSONPathBuilder{#e;constructor(e){this.#e=e}at(e){return this.#t("ArrayLocation",e)}key(e){return this.#t("Member",e)}#t(e,i){return JSONReferenceNode.is(this.#e)?new TraversedJSONPathBuilder(JSONReferenceNode.cloneWithTraversal(this.#e,JSONPathNode.is(this.#e.traversal)?JSONPathNode.cloneWithLeg(this.#e.traversal,JSONPathLegNode.create(e,i)):JSONOperatorChainNode.cloneWithValue(this.#e.traversal,ValueNode.createImmediate(i)))):new TraversedJSONPathBuilder(JSONPathNode.cloneWithLeg(this.#e,JSONPathLegNode.create(e,i)))}}class TraversedJSONPathBuilder extends JSONPathBuilder{#e;constructor(e){super(e),this.#e=e}get expressionType(){}as(e){return new AliasedJSONPathBuilder(this,e)}$castTo(){return new TraversedJSONPathBuilder(this.#e)}$notNull(){return new TraversedJSONPathBuilder(this.#e)}toOperationNode(){return this.#e}}class AliasedJSONPathBuilder{#e;#t;constructor(e,i){this.#e=e,this.#t=i}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),isOperationNodeSource(this.#t)?this.#t.toOperationNode():IdentifierNode.create(this.#t))}}const TupleNode=freeze({is(t){return t.kind==="TupleNode"},create(t){return freeze({kind:"TupleNode",values:freeze(t)})}}),SIMPLE_COLUMN_DATA_TYPES=["varchar","char","text","integer","int2","int4","int8","smallint","bigint","boolean","real","double precision","float4","float8","decimal","numeric","binary","bytea","date","datetime","time","timetz","timestamp","timestamptz","serial","bigserial","uuid","json","jsonb","blob","varbinary","int4range","int4multirange","int8range","int8multirange","numrange","nummultirange","tsrange","tsmultirange","tstzrange","tstzmultirange","daterange","datemultirange"],COLUMN_DATA_TYPE_REGEX=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timetz\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/,/^varbinary\(\d+\)$/],DataTypeNode=freeze({is(t){return t.kind==="DataTypeNode"},create(t){return freeze({kind:"DataTypeNode",dataType:t})}});function isColumnDataType(t){return!!(SIMPLE_COLUMN_DATA_TYPES.includes(t)||COLUMN_DATA_TYPE_REGEX.some(e=>e.test(t)))}function parseDataTypeExpression(t){if(isOperationNodeSource(t))return t.toOperationNode();if(isColumnDataType(t))return DataTypeNode.create(t);throw new Error(`invalid column data type ${JSON.stringify(t)}`)}const CastNode=freeze({is(t){return t.kind==="CastNode"},create(t,e){return freeze({kind:"CastNode",expression:t,dataType:e})}});function createExpressionBuilder(t=NOOP_QUERY_EXECUTOR){function e(n,s,o){return new ExpressionWrapper(parseValueBinaryOperation(n,s,o))}function i(n,s){return new ExpressionWrapper(parseUnaryOperation(n,s))}const r=Object.assign(e,{fn:void 0,eb:void 0,selectFrom(n){return createSelectQueryBuilder({queryId:createQueryId(),executor:t,queryNode:SelectQueryNode.createFrom(parseTableExpressionOrList(n))})},case(n){return new CaseBuilder({node:CaseNode.create(isUndefined(n)?void 0:parseReferenceExpression(n))})},ref(n,s){return isUndefined(s)?new ExpressionWrapper(parseStringReference(n)):new JSONPathBuilder(parseJSONReference(n,s))},jsonPath(){return new JSONPathBuilder(JSONPathNode.create())},table(n){return new ExpressionWrapper(parseTable(n))},val(n){return new ExpressionWrapper(parseValueExpression(n))},refTuple(...n){return new ExpressionWrapper(TupleNode.create(n.map(parseReferenceExpression)))},tuple(...n){return new ExpressionWrapper(TupleNode.create(n.map(parseValueExpression)))},lit(n){return new ExpressionWrapper(parseSafeImmediateValue(n))},unary:i,not(n){return i("not",n)},exists(n){return i("exists",n)},neg(n){return i("-",n)},between(n,s,o){return new ExpressionWrapper(BinaryOperationNode.create(parseReferenceExpression(n),OperatorNode.create("between"),AndNode.create(parseValueExpression(s),parseValueExpression(o))))},betweenSymmetric(n,s,o){return new ExpressionWrapper(BinaryOperationNode.create(parseReferenceExpression(n),OperatorNode.create("between symmetric"),AndNode.create(parseValueExpression(s),parseValueExpression(o))))},and(n){return isReadonlyArray(n)?new ExpressionWrapper(parseFilterList(n,"and")):new ExpressionWrapper(parseFilterObject(n,"and"))},or(n){return isReadonlyArray(n)?new ExpressionWrapper(parseFilterList(n,"or")):new ExpressionWrapper(parseFilterObject(n,"or"))},parens(...n){const s=parseValueBinaryOperationOrExpression(n);return ParensNode.is(s)?new ExpressionWrapper(s):new ExpressionWrapper(ParensNode.create(s))},cast(n,s){return new ExpressionWrapper(CastNode.create(parseReferenceExpression(n),parseDataTypeExpression(s)))},withSchema(n){return createExpressionBuilder(t.withPluginAtFront(new WithSchemaPlugin(n)))}});return r.fn=createFunctionModule(),r.eb=r,r}function expressionBuilder(t){return createExpressionBuilder()}function parseExpression(t){if(isOperationNodeSource(t))return t.toOperationNode();if(isFunction(t))return t(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(t)}`)}function parseAliasedExpression(t){if(isOperationNodeSource(t))return t.toOperationNode();if(isFunction(t))return t(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(t)}`)}function isExpressionOrFactory(t){return isExpression(t)||isAliasedExpression(t)||isFunction(t)}function parseTableExpressionOrList(t){return isReadonlyArray(t)?t.map(e=>parseTableExpression(e)):[parseTableExpression(t)]}function parseTableExpression(t){return isString(t)?parseAliasedTable(t):parseAliasedExpression(t)}function parseAliasedTable(t){const e=" as ";if(t.includes(e)){const[i,r]=t.split(e).map(trim$1);return AliasNode.create(parseTable(i),IdentifierNode.create(r))}else return parseTable(t)}function parseTable(t){const e=".";if(t.includes(e)){const[i,r]=t.split(e).map(trim$1);return TableNode.createWithSchema(i,r)}else return TableNode.create(t)}function trim$1(t){return t.trim()}const AddColumnNode=freeze({is(t){return t.kind==="AddColumnNode"},create(t){return freeze({kind:"AddColumnNode",column:t})}}),ColumnDefinitionNode=freeze({is(t){return t.kind==="ColumnDefinitionNode"},create(t,e){return freeze({kind:"ColumnDefinitionNode",column:ColumnNode.create(t),dataType:e})},cloneWithFrontModifier(t,e){return freeze({...t,frontModifiers:t.frontModifiers?freeze([...t.frontModifiers,e]):[e]})},cloneWithEndModifier(t,e){return freeze({...t,endModifiers:t.endModifiers?freeze([...t.endModifiers,e]):[e]})},cloneWith(t,e){return freeze({...t,...e})}}),DropColumnNode=freeze({is(t){return t.kind==="DropColumnNode"},create(t){return freeze({kind:"DropColumnNode",column:ColumnNode.create(t)})}}),RenameColumnNode=freeze({is(t){return t.kind==="RenameColumnNode"},create(t,e){return freeze({kind:"RenameColumnNode",column:ColumnNode.create(t),renameTo:ColumnNode.create(e)})}}),CheckConstraintNode=freeze({is(t){return t.kind==="CheckConstraintNode"},create(t,e){return freeze({kind:"CheckConstraintNode",expression:t,name:e?IdentifierNode.create(e):void 0})}}),ON_MODIFY_FOREIGN_ACTIONS=["no action","restrict","cascade","set null","set default"],ReferencesNode=freeze({is(t){return t.kind==="ReferencesNode"},create(t,e){return freeze({kind:"ReferencesNode",table:t,columns:freeze([...e])})},cloneWithOnDelete(t,e){return freeze({...t,onDelete:e})},cloneWithOnUpdate(t,e){return freeze({...t,onUpdate:e})}});function parseDefaultValueExpression(t){return isOperationNodeSource(t)?t.toOperationNode():ValueNode.createImmediate(t)}const GeneratedNode=freeze({is(t){return t.kind==="GeneratedNode"},create(t){return freeze({kind:"GeneratedNode",...t})},createWithExpression(t){return freeze({kind:"GeneratedNode",always:!0,expression:t})},cloneWith(t,e){return freeze({...t,...e})}}),DefaultValueNode=freeze({is(t){return t.kind==="DefaultValueNode"},create(t){return freeze({kind:"DefaultValueNode",defaultValue:t})}});function parseOnModifyForeignAction(t){if(ON_MODIFY_FOREIGN_ACTIONS.includes(t))return t;throw new Error(`invalid OnModifyForeignAction ${t}`)}class ColumnDefinitionBuilder{#e;constructor(e){this.#e=e}autoIncrement(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{autoIncrement:!0}))}identity(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{identity:!0}))}primaryKey(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{primaryKey:!0}))}references(e){const i=parseStringReference(e);if(!i.table||SelectAllNode.is(i.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{references:ReferencesNode.create(i.table,[i.column])}))}onDelete(e){if(!this.#e.references)throw new Error("on delete constraint can only be added for foreign keys");return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{references:ReferencesNode.cloneWithOnDelete(this.#e.references,parseOnModifyForeignAction(e))}))}onUpdate(e){if(!this.#e.references)throw new Error("on update constraint can only be added for foreign keys");return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{references:ReferencesNode.cloneWithOnUpdate(this.#e.references,parseOnModifyForeignAction(e))}))}unique(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{unique:!0}))}notNull(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{notNull:!0}))}unsigned(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{unsigned:!0}))}defaultTo(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{defaultTo:DefaultValueNode.create(parseDefaultValueExpression(e))}))}check(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{check:CheckConstraintNode.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#e.generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.cloneWith(this.#e.generated,{stored:!0})}))}modifyFront(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWithFrontModifier(this.#e,e.toOperationNode()))}nullsNotDistinct(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{nullsNotDistinct:!0}))}ifNotExists(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{ifNotExists:!0}))}modifyEnd(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWithEndModifier(this.#e,e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#e}}preventAwait(ColumnDefinitionBuilder,"don't await ColumnDefinitionBuilder instances directly.");const ModifyColumnNode=freeze({is(t){return t.kind==="ModifyColumnNode"},create(t){return freeze({kind:"ModifyColumnNode",column:t})}}),ForeignKeyConstraintNode=freeze({is(t){return t.kind==="ForeignKeyConstraintNode"},create(t,e,i,r){return freeze({kind:"ForeignKeyConstraintNode",columns:t,references:ReferencesNode.create(e,i),name:r?IdentifierNode.create(r):void 0})},cloneWith(t,e){return freeze({...t,...e})}});class ForeignKeyConstraintBuilder{#e;constructor(e){this.#e=e}onDelete(e){return new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.cloneWith(this.#e,{onDelete:parseOnModifyForeignAction(e)}))}onUpdate(e){return new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.cloneWith(this.#e,{onUpdate:parseOnModifyForeignAction(e)}))}$call(e){return e(this)}toOperationNode(){return this.#e}}preventAwait(ForeignKeyConstraintBuilder,"don't await ForeignKeyConstraintBuilder instances directly.");const AddConstraintNode=freeze({is(t){return t.kind==="AddConstraintNode"},create(t){return freeze({kind:"AddConstraintNode",constraint:t})}}),UniqueConstraintNode=freeze({is(t){return t.kind==="UniqueConstraintNode"},create(t,e,i){return freeze({kind:"UniqueConstraintNode",columns:freeze(t.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0,nullsNotDistinct:i})},cloneWith(t,e){return freeze({...t,...e})}}),DropConstraintNode=freeze({is(t){return t.kind==="DropConstraintNode"},create(t){return freeze({kind:"DropConstraintNode",constraintName:IdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})}}),AlterColumnNode=freeze({is(t){return t.kind==="AlterColumnNode"},create(t,e,i){return freeze({kind:"AlterColumnNode",column:ColumnNode.create(t),[e]:i})}});class AlterColumnBuilder{#e;constructor(e){this.#e=e}setDataType(e){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"dataType",parseDataTypeExpression(e)))}setDefault(e){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"setDefault",parseDefaultValueExpression(e)))}dropDefault(){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"dropDefault",!0))}setNotNull(){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"setNotNull",!0))}dropNotNull(){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"dropNotNull",!0))}$call(e){return e(this)}}preventAwait(AlterColumnBuilder,"don't await AlterColumnBuilder instances");class AlteredColumnBuilder{#e;constructor(e){this.#e=e}toOperationNode(){return this.#e}}preventAwait(AlteredColumnBuilder,"don't await AlteredColumnBuilder instances");class AlterTableExecutor{#e;constructor(e){this.#e=freeze(e)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableExecutor,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");class AlterTableAddForeignKeyConstraintBuilder{#e;constructor(e){this.#e=freeze(e)}onDelete(e){return new AlterTableAddForeignKeyConstraintBuilder({...this.#e,constraintBuilder:this.#e.constraintBuilder.onDelete(e)})}onUpdate(e){return new AlterTableAddForeignKeyConstraintBuilder({...this.#e,constraintBuilder:this.#e.constraintBuilder.onUpdate(e)})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(this.#e.constraintBuilder.toOperationNode())}),this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableAddForeignKeyConstraintBuilder,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");class AlterTableDropConstraintBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.cloneWith(this.#e.node.dropConstraint,{ifExists:!0})})})}cascade(){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.cloneWith(this.#e.node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.cloneWith(this.#e.node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableDropConstraintBuilder,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");const PrimaryConstraintNode=freeze({is(t){return t.kind==="PrimaryKeyConstraintNode"},create(t,e){return freeze({kind:"PrimaryKeyConstraintNode",columns:freeze(t.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}}),AddIndexNode=freeze({is(t){return t.kind==="AddIndexNode"},create(t){return freeze({kind:"AddIndexNode",name:IdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})},cloneWithColumns(t,e){return freeze({...t,columns:[...t.columns||[],...e]})}});class AlterTableAddIndexBuilder{#e;constructor(e){this.#e=freeze(e)}unique(){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWith(this.#e.node.addIndex,{unique:!0})})})}column(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWithColumns(this.#e.node.addIndex,[parseOrderedColumnName(e)])})})}columns(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWithColumns(this.#e.node.addIndex,e.map(parseOrderedColumnName))})})}expression(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWithColumns(this.#e.node.addIndex,[e.toOperationNode()])})})}using(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWith(this.#e.node.addIndex,{using:RawNode.createWithSql(e)})})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableAddIndexBuilder,"don't await AlterTableAddIndexBuilder instances directly. To execute the query you need to call `execute`");class UniqueConstraintNodeBuilder{#e;constructor(e){this.#e=e}toOperationNode(){return this.#e}nullsNotDistinct(){return new UniqueConstraintNodeBuilder(UniqueConstraintNode.cloneWith(this.#e,{nullsNotDistinct:!0}))}}preventAwait(UniqueConstraintNodeBuilder,"don't await UniqueConstraintNodeBuilder instances directly.");class AlterTableBuilder{#e;constructor(e){this.#e=freeze(e)}renameTo(e){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{renameTo:parseTable(e)})})}setSchema(e){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{setSchema:IdentifierNode.create(e)})})}alterColumn(e,i){const r=i(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,r.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,DropColumnNode.create(e))})}renameColumn(e,i){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,RenameColumnNode.create(e,i))})}addColumn(e,i,r=noop){const n=r(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(i))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,AddColumnNode.create(n.toOperationNode()))})}modifyColumn(e,i,r=noop){const n=r(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(i))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,ModifyColumnNode.create(n.toOperationNode()))})}addUniqueConstraint(e,i,r=noop){const n=r(new UniqueConstraintNodeBuilder(UniqueConstraintNode.create(i,e)));return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(n.toOperationNode())})})}addCheckConstraint(e,i){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(CheckConstraintNode.create(i.toOperationNode(),e))})})}addForeignKeyConstraint(e,i,r,n){return new AlterTableAddForeignKeyConstraintBuilder({...this.#e,constraintBuilder:new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(i.map(ColumnNode.create),parseTable(r),n.map(ColumnNode.create),e))})}addPrimaryKeyConstraint(e,i){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(PrimaryConstraintNode.create(i,e))})})}dropConstraint(e){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.create(e)})})}addIndex(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.create(e)})})}dropIndex(e){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropIndex:DropIndexNode.create(e)})})}$call(e){return e(this)}}preventAwait(AlterTableBuilder,"don't await AlterTableBuilder instances");class AlterTableColumnAlteringBuilder{#e;constructor(e){this.#e=freeze(e)}alterColumn(e,i){const r=i(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,r.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,DropColumnNode.create(e))})}renameColumn(e,i){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,RenameColumnNode.create(e,i))})}addColumn(e,i,r=noop){const n=r(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(i))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,AddColumnNode.create(n.toOperationNode()))})}modifyColumn(e,i,r=noop){const n=r(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(i))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,ModifyColumnNode.create(n.toOperationNode()))})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableColumnAlteringBuilder,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");class ImmediateValueTransformer extends OperationNodeTransformer{transformValue(e){return{...super.transformValue(e),immediate:!0}}}class CreateIndexBuilder{#e;constructor(e){this.#e=freeze(e)}ifNotExists(){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{ifNotExists:!0})})}unique(){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{unique:!0})})}nullsNotDistinct(){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{nullsNotDistinct:!0})})}on(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{table:parseTable(e)})})}column(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWithColumns(this.#e.node,[parseOrderedColumnName(e)])})}columns(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWithColumns(this.#e.node,e.map(parseOrderedColumnName))})}expression(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWithColumns(this.#e.node,[e.toOperationNode()])})}using(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{using:RawNode.createWithSql(e)})})}where(...e){const i=new ImmediateValueTransformer;return new CreateIndexBuilder({...this.#e,node:QueryNode.cloneWithWhere(this.#e.node,i.transformNode(parseValueBinaryOperationOrExpression(e)))})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateIndexBuilder,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");class CreateSchemaBuilder{#e;constructor(e){this.#e=freeze(e)}ifNotExists(){return new CreateSchemaBuilder({...this.#e,node:CreateSchemaNode.cloneWith(this.#e.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateSchemaBuilder,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");function parseOnCommitAction(t){if(ON_COMMIT_ACTIONS.includes(t))return t;throw new Error(`invalid OnCommitAction ${t}`)}class CreateTableBuilder{#e;constructor(e){this.#e=freeze(e)}temporary(){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{temporary:!0})})}onCommit(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{onCommit:parseOnCommitAction(e)})})}ifNotExists(){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{ifNotExists:!0})})}addColumn(e,i,r=noop){const n=r(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(i))));return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithColumn(this.#e.node,n.toOperationNode())})}addPrimaryKeyConstraint(e,i){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,PrimaryConstraintNode.create(i,e))})}addUniqueConstraint(e,i,r=noop){const n=r(new UniqueConstraintNodeBuilder(UniqueConstraintNode.create(i,e)));return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,n.toOperationNode())})}addCheckConstraint(e,i){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,CheckConstraintNode.create(i.toOperationNode(),e))})}addForeignKeyConstraint(e,i,r,n,s=noop){const o=s(new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(i.map(ColumnNode.create),parseTable(r),n.map(ColumnNode.create),e)));return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,o.toOperationNode())})}modifyFront(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithFrontModifier(this.#e.node,e.toOperationNode())})}modifyEnd(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithEndModifier(this.#e.node,e.toOperationNode())})}as(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{selectQuery:parseExpression(e)})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateTableBuilder,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");class DropIndexBuilder{#e;constructor(e){this.#e=freeze(e)}on(e){return new DropIndexBuilder({...this.#e,node:DropIndexNode.cloneWith(this.#e.node,{table:parseTable(e)})})}ifExists(){return new DropIndexBuilder({...this.#e,node:DropIndexNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropIndexBuilder({...this.#e,node:DropIndexNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropIndexBuilder,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");class DropSchemaBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new DropSchemaBuilder({...this.#e,node:DropSchemaNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropSchemaBuilder({...this.#e,node:DropSchemaNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropSchemaBuilder,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");class DropTableBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new DropTableBuilder({...this.#e,node:DropTableNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropTableBuilder({...this.#e,node:DropTableNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropTableBuilder,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const CreateViewNode=freeze({is(t){return t.kind==="CreateViewNode"},create(t){return freeze({kind:"CreateViewNode",name:SchemableIdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})}});class ImmediateValuePlugin{#e=new ImmediateValueTransformer;transformQuery(e){return this.#e.transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}}class CreateViewBuilder{#e;constructor(e){this.#e=freeze(e)}temporary(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{temporary:!0})})}materialized(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{materialized:!0})})}ifNotExists(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{ifNotExists:!0})})}orReplace(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{orReplace:!0})})}columns(e){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{columns:e.map(parseColumnName)})})}as(e){const i=e.withPlugin(new ImmediateValuePlugin).toOperationNode();return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{as:i})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateViewBuilder,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const DropViewNode=freeze({is(t){return t.kind==="DropViewNode"},create(t){return freeze({kind:"DropViewNode",name:SchemableIdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})}});class DropViewBuilder{#e;constructor(e){this.#e=freeze(e)}materialized(){return new DropViewBuilder({...this.#e,node:DropViewNode.cloneWith(this.#e.node,{materialized:!0})})}ifExists(){return new DropViewBuilder({...this.#e,node:DropViewNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropViewBuilder({...this.#e,node:DropViewNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropViewBuilder,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const CreateTypeNode=freeze({is(t){return t.kind==="CreateTypeNode"},create(t){return freeze({kind:"CreateTypeNode",name:t})},cloneWithEnum(t,e){return freeze({...t,enum:ValueListNode.create(e.map(i=>ValueNode.createImmediate(i)))})}});class CreateTypeBuilder{#e;constructor(e){this.#e=freeze(e)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}asEnum(e){return new CreateTypeBuilder({...this.#e,node:CreateTypeNode.cloneWithEnum(this.#e.node,e)})}$call(e){return e(this)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateTypeBuilder,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const DropTypeNode=freeze({is(t){return t.kind==="DropTypeNode"},create(t){return freeze({kind:"DropTypeNode",name:t})},cloneWith(t,e){return freeze({...t,...e})}});class DropTypeBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new DropTypeBuilder({...this.#e,node:DropTypeNode.cloneWith(this.#e.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropTypeBuilder,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function parseSchemableIdentifier(t){const e=".";if(t.includes(e)){const i=t.split(e).map(trim);if(i.length===2)return SchemableIdentifierNode.createWithSchema(i[0],i[1]);throw new Error(`invalid schemable identifier ${t}`)}else return SchemableIdentifierNode.create(t)}function trim(t){return t.trim()}class SchemaModule{#e;constructor(e){this.#e=e}createTable(e){return new CreateTableBuilder({queryId:createQueryId(),executor:this.#e,node:CreateTableNode.create(parseTable(e))})}dropTable(e){return new DropTableBuilder({queryId:createQueryId(),executor:this.#e,node:DropTableNode.create(parseTable(e))})}createIndex(e){return new CreateIndexBuilder({queryId:createQueryId(),executor:this.#e,node:CreateIndexNode.create(e)})}dropIndex(e){return new DropIndexBuilder({queryId:createQueryId(),executor:this.#e,node:DropIndexNode.create(e)})}createSchema(e){return new CreateSchemaBuilder({queryId:createQueryId(),executor:this.#e,node:CreateSchemaNode.create(e)})}dropSchema(e){return new DropSchemaBuilder({queryId:createQueryId(),executor:this.#e,node:DropSchemaNode.create(e)})}alterTable(e){return new AlterTableBuilder({queryId:createQueryId(),executor:this.#e,node:AlterTableNode.create(parseTable(e))})}createView(e){return new CreateViewBuilder({queryId:createQueryId(),executor:this.#e,node:CreateViewNode.create(e)})}dropView(e){return new DropViewBuilder({queryId:createQueryId(),executor:this.#e,node:DropViewNode.create(e)})}createType(e){return new CreateTypeBuilder({queryId:createQueryId(),executor:this.#e,node:CreateTypeNode.create(parseSchemableIdentifier(e))})}dropType(e){return new DropTypeBuilder({queryId:createQueryId(),executor:this.#e,node:DropTypeNode.create(parseSchemableIdentifier(e))})}withPlugin(e){return new SchemaModule(this.#e.withPlugin(e))}withoutPlugins(){return new SchemaModule(this.#e.withoutPlugins())}withSchema(e){return new SchemaModule(this.#e.withPluginAtFront(new WithSchemaPlugin(e)))}}class DynamicModule{ref(e){return new DynamicReferenceBuilder(e)}}class DefaultConnectionProvider{#e;constructor(e){this.#e=e}async provideConnection(e){const i=await this.#e.acquireConnection();try{return await e(i)}finally{await this.#e.releaseConnection(i)}}}class DefaultQueryExecutor extends QueryExecutorBase{#e;#t;#i;constructor(e,i,r,n=[]){super(n),this.#e=e,this.#t=i,this.#i=r}get adapter(){return this.#t}compileQuery(e){return this.#e.compileQuery(e)}provideConnection(e){return this.#i.provideConnection(e)}withPlugins(e){return new DefaultQueryExecutor(this.#e,this.#t,this.#i,[...this.plugins,...e])}withPlugin(e){return new DefaultQueryExecutor(this.#e,this.#t,this.#i,[...this.plugins,e])}withPluginAtFront(e){return new DefaultQueryExecutor(this.#e,this.#t,this.#i,[e,...this.plugins])}withConnectionProvider(e){return new DefaultQueryExecutor(this.#e,this.#t,e,[...this.plugins])}withoutPlugins(){return new DefaultQueryExecutor(this.#e,this.#t,this.#i,[])}}function performanceNow(){return typeof performance<"u"&&isFunction(performance.now)?performance.now():Date.now()}class RuntimeDriver{#e;#t;#i;#r;#n;#o=new WeakSet;constructor(e,i){this.#r=!1,this.#e=e,this.#t=i}async init(){if(this.#n)throw new Error("driver has already been destroyed");this.#i||(this.#i=this.#e.init().then(()=>{this.#r=!0}).catch(e=>(this.#i=void 0,Promise.reject(e)))),await this.#i}async acquireConnection(){if(this.#n)throw new Error("driver has already been destroyed");this.#r||await this.init();const e=await this.#e.acquireConnection();return this.#o.has(e)||(this.#h()&&this.#s(e),this.#o.add(e)),e}async releaseConnection(e){await this.#e.releaseConnection(e)}beginTransaction(e,i){return this.#e.beginTransaction(e,i)}commitTransaction(e){return this.#e.commitTransaction(e)}rollbackTransaction(e){return this.#e.rollbackTransaction(e)}async destroy(){this.#i&&(await this.#i,this.#n||(this.#n=this.#e.destroy().catch(e=>(this.#n=void 0,Promise.reject(e)))),await this.#n)}#h(){return this.#t.isLevelEnabled("query")||this.#t.isLevelEnabled("error")}#s(e){const i=e.executeQuery;e.executeQuery=async r=>{let n;const s=performanceNow();try{return await i.call(e,r)}catch(o){throw n=o,await this.#a(o,r,s),o}finally{n||await this.#u(r,s)}}}async#a(e,i,r){await this.#t.error(()=>({level:"error",error:e,query:i,queryDurationMillis:this.#d(r)}))}async#u(e,i){await this.#t.query(()=>({level:"query",query:e,queryDurationMillis:this.#d(i)}))}#d(e){return performanceNow()-e}}const ignoreError=()=>{};class SingleConnectionProvider{#e;#t;constructor(e){this.#e=e}async provideConnection(e){for(;this.#t;)await this.#t.catch(ignoreError);return this.#t=this.#i(e).finally(()=>{this.#t=void 0}),this.#t}async#i(e){return await e(this.#e)}}const TRANSACTION_ISOLATION_LEVELS=["read uncommitted","read committed","repeatable read","serializable","snapshot"];freeze(["query","error"]);class Log{#e;#t;constructor(e){isFunction(e)?(this.#t=e,this.#e=freeze({query:!0,error:!0})):(this.#t=defaultLogger,this.#e=freeze({query:e.includes("query"),error:e.includes("error")}))}isLevelEnabled(e){return this.#e[e]}async query(e){this.#e.query&&await this.#t(e())}async error(e){this.#e.error&&await this.#t(e())}}function defaultLogger(t){t.level==="query"?(console.log(`kysely:query: ${t.query.sql}`),console.log(`kysely:query: duration: ${t.queryDurationMillis.toFixed(1)}ms`)):t.level==="error"&&(t.error instanceof Error?console.error(`kysely:error: ${t.error.stack??t.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:t.error,query:t.query.sql,queryDurationMillis:t.queryDurationMillis})}`))}function isCompilable(t){return isObject(t)&&isFunction(t.compile)}class Kysely extends QueryCreator{#e;constructor(e){let i,r;if(isKyselyProps(e))i={executor:e.executor},r={...e};else{const n=e.dialect,s=n.createDriver(),o=n.createQueryCompiler(),a=n.createAdapter(),h=new Log(e.log??[]),u=new RuntimeDriver(s,h),c=new DefaultConnectionProvider(u),d=new DefaultQueryExecutor(o,a,c,e.plugins??[]);i={executor:d},r={config:e,executor:d,dialect:n,driver:u}}super(i),this.#e=freeze(r)}get schema(){return new SchemaModule(this.#e.executor)}get dynamic(){return new DynamicModule}get introspection(){return this.#e.dialect.createIntrospector(this.withoutPlugins())}case(e){return new CaseBuilder({node:CaseNode.create(isUndefined(e)?void 0:parseExpression(e))})}get fn(){return createFunctionModule()}transaction(){return new TransactionBuilder({...this.#e})}connection(){return new ConnectionBuilder({...this.#e})}withPlugin(e){return new Kysely({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new Kysely({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new Kysely({...this.#e,executor:this.#e.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new Kysely({...this.#e})}async destroy(){await this.#e.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#e.executor}executeQuery(e,i=createQueryId()){const r=isCompilable(e)?e.compile():e;return this.getExecutor().executeQuery(r,i)}}class Transaction extends Kysely{#e;constructor(e){super(e),this.#e=e}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(e){return new Transaction({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new Transaction({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new Transaction({...this.#e,executor:this.#e.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new Transaction({...this.#e})}}function isKyselyProps(t){return isObject(t)&&isObject(t.config)&&isObject(t.driver)&&isObject(t.executor)&&isObject(t.dialect)}class ConnectionBuilder{#e;constructor(e){this.#e=freeze(e)}async execute(e){return this.#e.executor.provideConnection(async i=>{const r=this.#e.executor.withConnectionProvider(new SingleConnectionProvider(i)),n=new Kysely({...this.#e,executor:r});return await e(n)})}}preventAwait(ConnectionBuilder,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");class TransactionBuilder{#e;constructor(e){this.#e=freeze(e)}setIsolationLevel(e){return new TransactionBuilder({...this.#e,isolationLevel:e})}async execute(e){const{isolationLevel:i,...r}=this.#e,n={isolationLevel:i};return validateTransactionSettings(n),this.#e.executor.provideConnection(async s=>{const o=this.#e.executor.withConnectionProvider(new SingleConnectionProvider(s)),a=new Transaction({...r,executor:o});try{await this.#e.driver.beginTransaction(s,n);const h=await e(a);return await this.#e.driver.commitTransaction(s),h}catch(h){throw await this.#e.driver.rollbackTransaction(s),h}})}}preventAwait(TransactionBuilder,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function validateTransactionSettings(t){if(t.isolationLevel&&!TRANSACTION_ISOLATION_LEVELS.includes(t.isolationLevel))throw new Error(`invalid transaction isolation level ${t.isolationLevel}`)}class RawBuilderImpl{#e;constructor(e){this.#e=freeze(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new AliasedRawBuilderImpl(this,e)}$castTo(){return new RawBuilderImpl({...this.#e})}$notNull(){return new RawBuilderImpl(this.#e)}withPlugin(e){return new RawBuilderImpl({...this.#e,plugins:this.#e.plugins!==void 0?freeze([...this.#e.plugins,e]):freeze([e])})}toOperationNode(){return this.#i(this.#t())}compile(e){return this.#r(this.#t(e))}async execute(e){const i=this.#t(e);return i.executeQuery(this.#r(i),this.#e.queryId)}#t(e){const i=e!==void 0?e.getExecutor():NOOP_QUERY_EXECUTOR;return this.#e.plugins!==void 0?i.withPlugins(this.#e.plugins):i}#i(e){return e.transformQuery(this.#e.rawNode,this.#e.queryId)}#r(e){return e.compileQuery(this.#i(e),this.#e.queryId)}}function createRawBuilder(t){return new RawBuilderImpl(t)}preventAwait(RawBuilderImpl,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");class AliasedRawBuilderImpl{#e;#t;constructor(e,i){this.#e=e,this.#t=i}get expression(){return this.#e}get alias(){return this.#t}get rawBuilder(){return this.#e}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),isOperationNodeSource(this.#t)?this.#t.toOperationNode():IdentifierNode.create(this.#t))}}preventAwait(AliasedRawBuilderImpl,"don't await AliasedRawBuilder instances directly. AliasedRawBuilder should never be executed directly since it's always a part of another query.");const sql=Object.assign((t,...e)=>createRawBuilder({queryId:createQueryId(),rawNode:RawNode.create(t,e?.map(parseParameter)??[])}),{ref(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseStringReference(t))})},val(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseValueExpression(t))})},value(t){return this.val(t)},table(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseTable(t))})},id(...t){const e=new Array(t.length+1).fill(".");return e[0]="",e[e.length-1]="",createRawBuilder({queryId:createQueryId(),rawNode:RawNode.create(e,t.map(IdentifierNode.create))})},lit(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(ValueNode.createImmediate(t))})},literal(t){return this.lit(t)},raw(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithSql(t)})},join(t,e=sql`, `){const i=new Array(2*t.length-1),r=e.toOperationNode();for(let n=0;n<t.length;++n)i[2*n]=parseParameter(t[n]),n!==t.length-1&&(i[2*n+1]=r);return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChildren(i)})}});function parseParameter(t){return isOperationNodeSource(t)?t.toOperationNode():parseValueExpression(t)}class OperationNodeVisitor{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#e=freeze({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#e[e.kind](e),this.nodeStack.pop()}}class DefaultQueryCompiler extends OperationNodeVisitor{#e="";#t=[];get numParameters(){return this.#t.length}compileQuery(e){return this.#e="",this.#t=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(e),freeze({query:e,sql:this.getSql(),parameters:[...this.#t]})}getSql(){return this.#e}visitSelectQuery(e){const i=this.parentNode!==void 0&&!ParensNode.is(this.parentNode)&&!InsertQueryNode.is(this.parentNode)&&!CreateTableNode.is(this.parentNode)&&!CreateViewNode.is(this.parentNode)&&!SetOperationNode.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(" ")),i&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("select"),e.distinctOn&&(this.append(" "),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.top&&(this.append(" "),this.visitNode(e.top)),e.selections&&(this.append(" "),this.compileList(e.selections)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.groupBy&&(this.append(" "),this.visitNode(e.groupBy)),e.having&&(this.append(" "),this.visitNode(e.having)),e.setOperations&&(this.append(" "),this.compileList(e.setOperations," ")),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.offset&&(this.append(" "),this.visitNode(e.offset)),e.fetch&&(this.append(" "),this.visitNode(e.fetch)),e.endModifiers?.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...e.endModifiers])," ")),i&&this.append(")")}visitFrom(e){this.append("from "),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append("distinct on ("),this.compileList(e),this.append(")")}compileList(e,i=", "){const r=e.length-1;for(let n=0;n<=r;n++)this.visitNode(e[n]),n<r&&this.append(i)}visitWhere(e){this.append("where "),this.visitNode(e.where)}visitHaving(e){this.append("having "),this.visitNode(e.having)}visitInsertQuery(e){const i=this.nodeStack.find(QueryNode.is),r=i!==e;!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&!MergeQueryNode.is(i)&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append(e.replace?"replace":"insert"),e.ignore&&this.append(" ignore"),e.top&&(this.append(" "),this.visitNode(e.top)),e.into&&(this.append(" into "),this.visitNode(e.into)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.output&&(this.append(" "),this.visitNode(e.output)),e.values&&(this.append(" "),this.visitNode(e.values)),e.defaultValues&&(this.append(" "),this.append("default values")),e.onConflict&&(this.append(" "),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(" "),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&!MergeQueryNode.is(i)&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitValues(e){this.append("values "),this.compileList(e.values)}visitDeleteQuery(e){const i=this.nodeStack.find(QueryNode.is)!==e;!i&&e.explain&&(this.visitNode(e.explain),this.append(" ")),i&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("delete "),e.top&&(this.visitNode(e.top),this.append(" ")),this.visitNode(e.from),e.output&&(this.append(" "),this.visitNode(e.output)),e.using&&(this.append(" "),this.visitNode(e.using)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),i&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitReturning(e){this.append("returning "),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(" as "),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(".")),this.visitNode(e.column)}visitSelectAll(e){this.append("*")}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!isString(e.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(" and "),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(" or "),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append("("),this.compileList(e.values),this.append(")")}visitTuple(e){this.append("("),this.compileList(e.values),this.append(")")}visitPrimitiveValueList(e){this.append("(");const{values:i}=e;for(let r=0;r<i.length;++r)this.appendValue(i[r]),r!==i.length-1&&this.append(", ");this.append(")")}visitParens(e){this.append("("),this.visitNode(e.node),this.append(")")}visitJoin(e){this.append(JOIN_TYPE_SQL[e.joinType]),this.append(" "),this.visitNode(e.table),e.on&&(this.append(" "),this.visitNode(e.on))}visitOn(e){this.append("on "),this.visitNode(e.on)}visitRaw(e){const{sqlFragments:i,parameters:r}=e;for(let n=0;n<i.length;++n)this.append(i[n]),r.length>n&&this.visitNode(r[n])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(".")),this.visitNode(e.identifier)}visitCreateTable(e){this.append("create "),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers," "),this.append(" ")),e.temporary&&this.append("temporary "),this.append("table "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.table),e.selectQuery?(this.append(" as "),this.visitNode(e.selectQuery)):(this.append(" ("),this.compileList([...e.columns,...e.constraints??[]]),this.append(")"),e.onCommit&&(this.append(" on commit "),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," ")))}visitColumnDefinition(e){e.ifNotExists&&this.append("if not exists "),this.visitNode(e.column),this.append(" "),this.visitNode(e.dataType),e.unsigned&&this.append(" unsigned"),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.generated&&(this.append(" "),this.visitNode(e.generated)),e.identity&&this.append(" identity"),e.defaultTo&&(this.append(" "),this.visitNode(e.defaultTo)),e.notNull&&this.append(" not null"),e.unique&&this.append(" unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.primaryKey&&this.append(" primary key"),e.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),e.references&&(this.append(" "),this.visitNode(e.references)),e.check&&(this.append(" "),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(e){this.append("references "),this.visitNode(e.table),this.append(" ("),this.compileList(e.columns),this.append(")"),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitDropTable(e){this.append("drop table "),e.ifExists&&this.append("if exists "),this.visitNode(e.table),e.cascade&&this.append(" cascade")}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append("order by "),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.direction&&(this.append(" "),this.visitNode(e.direction))}visitGroupBy(e){this.append("group by "),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){const i=this.nodeStack.find(QueryNode.is),r=i!==e;!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&!MergeQueryNode.is(i)&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("update "),e.top&&(this.visitNode(e.top),this.append(" ")),e.table&&(this.visitNode(e.table),this.append(" ")),this.append("set "),e.updates&&this.compileList(e.updates),e.output&&(this.append(" "),this.visitNode(e.output)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&!MergeQueryNode.is(i)&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitColumnUpdate(e){this.visitNode(e.column),this.append(" = "),this.visitNode(e.value)}visitLimit(e){this.append("limit "),this.visitNode(e.limit)}visitOffset(e){this.append("offset "),this.visitNode(e.offset)}visitOnConflict(e){this.append("on conflict"),e.columns?(this.append(" ("),this.compileList(e.columns),this.append(")")):e.constraint?(this.append(" on constraint "),this.visitNode(e.constraint)):e.indexExpression&&(this.append(" ("),this.visitNode(e.indexExpression),this.append(")")),e.indexWhere&&(this.append(" "),this.visitNode(e.indexWhere)),e.doNothing===!0?this.append(" do nothing"):e.updates&&(this.append(" do update set "),this.compileList(e.updates),e.updateWhere&&(this.append(" "),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append("on duplicate key update "),this.compileList(e.updates)}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.using&&(this.append(" using "),this.visitNode(e.using)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.where&&(this.append(" "),this.visitNode(e.where))}visitDropIndex(e){this.append("drop index "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.cascade&&this.append(" cascade")}visitCreateSchema(e){this.append("create schema "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.schema)}visitDropSchema(e){this.append("drop schema "),e.ifExists&&this.append("if exists "),this.visitNode(e.schema),e.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("primary key ("),this.compileList(e.columns),this.append(")")}visitUniqueConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(e.columns),this.append(")")}visitCheckConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("check ("),this.visitNode(e.expression),this.append(")")}visitForeignKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("foreign key ("),this.compileList(e.columns),this.append(") "),this.visitNode(e.references),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitList(e){this.compileList(e.items)}visitWith(e){this.append("with "),e.recursive&&this.append("recursive "),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(" as "),isBoolean(e.materialized)&&(e.materialized||this.append("not "),this.append("materialized ")),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append("("),this.compileList(e.columns),this.append(")"))}visitAlterTable(e){this.append("alter table "),this.visitNode(e.table),this.append(" "),e.renameTo&&(this.append("rename to "),this.visitNode(e.renameTo)),e.setSchema&&(this.append("set schema "),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append("add column "),this.visitNode(e.column)}visitRenameColumn(e){this.append("rename column "),this.visitNode(e.column),this.append(" to "),this.visitNode(e.renameTo)}visitDropColumn(e){this.append("drop column "),this.visitNode(e.column)}visitAlterColumn(e){this.append("alter column "),this.visitNode(e.column),this.append(" "),e.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append("using "),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append("set default "),this.visitNode(e.setDefault)),e.dropDefault&&this.append("drop default"),e.setNotNull&&this.append("set not null"),e.dropNotNull&&this.append("drop not null")}visitModifyColumn(e){this.append("modify column "),this.visitNode(e.column)}visitAddConstraint(e){this.append("add "),this.visitNode(e.constraint)}visitDropConstraint(e){this.append("drop constraint "),e.ifExists&&this.append("if exists "),this.visitNode(e.constraintName),e.modifier==="cascade"?this.append(" cascade"):e.modifier==="restrict"&&this.append(" restrict")}visitSetOperation(e){this.append(e.operator),this.append(" "),e.all&&this.append("all "),this.visitNode(e.expression)}visitCreateView(e){this.append("create "),e.orReplace&&this.append("or replace "),e.materialized&&this.append("materialized "),e.temporary&&this.append("temporary "),this.append("view "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),this.append(" "),e.columns&&(this.append("("),this.compileList(e.columns),this.append(") ")),e.as&&(this.append("as "),this.visitNode(e.as))}visitDropView(e){this.append("drop "),e.materialized&&this.append("materialized "),this.append("view "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.cascade&&this.append(" cascade")}visitGenerated(e){this.append("generated "),e.always&&this.append("always "),e.byDefault&&this.append("by default "),this.append("as "),e.identity&&this.append("identity"),e.expression&&(this.append("("),this.visitNode(e.expression),this.append(")")),e.stored&&this.append(" stored")}visitDefaultValue(e){this.append("default "),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(SELECT_MODIFIER_SQL[e.modifier]),e.of&&(this.append(" of "),this.compileList(e.of,", "))}visitCreateType(e){this.append("create type "),this.visitNode(e.name),e.enum&&(this.append(" as enum "),this.visitNode(e.enum))}visitDropType(e){this.append("drop type "),e.ifExists&&this.append("if exists "),this.visitNode(e.name)}visitExplain(e){this.append("explain"),(e.options||e.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append("default")}visitAggregateFunction(e){this.append(e.func),this.append("("),e.distinct&&this.append("distinct "),this.compileList(e.aggregated),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),this.append(")"),e.filter&&(this.append(" filter("),this.visitNode(e.filter),this.append(")")),e.over&&(this.append(" "),this.visitNode(e.over))}visitOver(e){this.append("over("),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(" ")),e.orderBy&&this.visitNode(e.orderBy),this.append(")")}visitPartitionBy(e){this.append("partition by "),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(" "),this.visitNode(e.operator),this.append(" "),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(" "),this.visitNode(e.operand)}isMinusOperator(e){return OperatorNode.is(e)&&e.operator==="-"}visitUsing(e){this.append("using "),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append("("),this.compileList(e.arguments),this.append(")")}visitCase(e){this.append("case"),e.value&&(this.append(" "),this.visitNode(e.value)),e.when&&(this.append(" "),this.compileList(e.when," ")),e.else&&(this.append(" else "),this.visitNode(e.else)),this.append(" end"),e.isStatement&&this.append(" case")}visitWhen(e){this.append("when "),this.visitNode(e.condition),e.result&&(this.append(" then "),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append("'$");for(const i of e.pathLegs)this.visitNode(i);this.append("'")}visitJSONPathLeg(e){const i=e.type==="ArrayLocation";this.append(i?"[":"."),this.append(String(e.value)),i&&this.append("]")}visitJSONOperatorChain(e){for(let i=0,r=e.values.length;i<r;i++)i===r-1?this.visitNode(e.operator):this.append("->"),this.visitNode(e.values[i])}visitMergeQuery(e){e.with&&(this.visitNode(e.with),this.append(" ")),this.append("merge "),e.top&&(this.visitNode(e.top),this.append(" ")),this.append("into "),this.visitNode(e.into),e.using&&(this.append(" "),this.visitNode(e.using)),e.whens&&(this.append(" "),this.compileList(e.whens," ")),e.output&&(this.append(" "),this.visitNode(e.output)),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitMatched(e){e.not&&this.append("not "),this.append("matched"),e.bySource&&this.append(" by source")}visitAddIndex(e){this.append("add "),e.unique&&this.append("unique "),this.append("index "),this.visitNode(e.name),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.using&&(this.append(" using "),this.visitNode(e.using))}visitCast(e){this.append("cast("),this.visitNode(e.expression),this.append(" as "),this.visitNode(e.dataType),this.append(")")}visitFetch(e){this.append("fetch next "),this.visitNode(e.rowCount),this.append(` rows ${e.modifier}`)}visitOutput(e){this.append("output "),this.compileList(e.selections)}visitTop(e){this.append(`top(${e.expression})`),e.modifiers&&this.append(` ${e.modifiers}`)}append(e){this.#e+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(e){const i=this.getLeftIdentifierWrapper(),r=this.getRightIdentifierWrapper();let n="";for(const s of e)n+=s,s===i?n+=i:s===r&&(n+=r);return n}addParameter(e){this.#t.push(e)}appendImmediateValue(e){if(isString(e))this.append(`'${e}'`);else if(isNumber(e)||isBoolean(e))this.append(e.toString());else if(isNull(e))this.append("null");else if(isDate(e))this.appendImmediateValue(e.toISOString());else if(isBigInt(e))this.appendImmediateValue(e.toString());else throw new Error(`invalid immediate value ${e}`)}sortSelectModifiers(e){return e.sort((i,r)=>i.modifier&&r.modifier?SELECT_MODIFIER_PRIORITY[i.modifier]-SELECT_MODIFIER_PRIORITY[r.modifier]:1),freeze(e)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}}const SELECT_MODIFIER_SQL=freeze({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),SELECT_MODIFIER_PRIORITY=freeze({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),JOIN_TYPE_SQL=freeze({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral",Using:"using"});class DummyDriver{async init(){}async acquireConnection(){return new DummyConnection}async beginTransaction(){}async commitTransaction(){}async rollbackTransaction(){}async releaseConnection(){}async destroy(){}}class DummyConnection{async executeQuery(){return{rows:[]}}async*streamQuery(){}}class DialectAdapterBase{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}}const DEFAULT_MIGRATION_TABLE="kysely_migration",DEFAULT_MIGRATION_LOCK_TABLE="kysely_migration_lock";freeze({__noMigrations__:!0});const ID_WRAP_REGEX=/"/g;class PostgresQueryCompiler extends DefaultQueryCompiler{sanitizeIdentifier(e){return e.replace(ID_WRAP_REGEX,'""')}}class PostgresIntrospector{#e;constructor(e){this.#e=e}async getSchemas(){return(await this.#e.selectFrom("pg_catalog.pg_namespace").select("nspname").$castTo().execute()).map(i=>({name:i.nspname}))}async getTables(e={withInternalKyselyTables:!1}){let i=this.#e.selectFrom("pg_catalog.pg_attribute as a").innerJoin("pg_catalog.pg_class as c","a.attrelid","c.oid").innerJoin("pg_catalog.pg_namespace as ns","c.relnamespace","ns.oid").innerJoin("pg_catalog.pg_type as typ","a.atttypid","typ.oid").innerJoin("pg_catalog.pg_namespace as dtns","typ.typnamespace","dtns.oid").select(["a.attname as column","a.attnotnull as not_null","a.atthasdef as has_default","c.relname as table","c.relkind as table_type","ns.nspname as schema","typ.typname as type","dtns.nspname as type_schema",sql`col_description(a.attrelid, a.attnum)`.as("column_description"),this.#e.selectFrom("pg_class").select(sql`true`.as("auto_incrementing")).whereRef("relnamespace","=","c.relnamespace").where("relkind","=","S").where("relname","=",sql`c.relname || '_' || a.attname || '_seq'`).as("auto_incrementing")]).where(n=>n.or([n("c.relkind","=","r"),n("c.relkind","=","v"),n("c.relkind","=","p")])).where("ns.nspname","!~","^pg_").where("ns.nspname","!=","information_schema").where("a.attnum",">=",0).where("a.attisdropped","!=",!0).orderBy("ns.nspname").orderBy("c.relname").orderBy("a.attnum").$castTo();e.withInternalKyselyTables||(i=i.where("c.relname","!=",DEFAULT_MIGRATION_TABLE).where("c.relname","!=",DEFAULT_MIGRATION_LOCK_TABLE));const r=await i.execute();return this.#t(r)}async getMetadata(e){return{tables:await this.getTables(e)}}#t(e){return e.reduce((i,r)=>{let n=i.find(s=>s.name===r.table&&s.schema===r.schema);return n||(n=freeze({name:r.table,isView:r.table_type==="v",schema:r.schema,columns:[]}),i.push(n)),n.columns.push(freeze({name:r.column,dataType:r.type,dataTypeSchema:r.type_schema,isNullable:!r.not_null,isAutoIncrementing:!!r.auto_incrementing,hasDefaultValue:r.has_default,comment:r.column_description??void 0})),i},[])}}const LOCK_ID=BigInt("3853314791062309107");class PostgresAdapter extends DialectAdapterBase{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(e,i){await sql`select pg_advisory_xact_lock(${sql.lit(LOCK_ID)})`.execute(e)}async releaseMigrationLock(e,i){}}const getDB=()=>new Kysely({dialect:{createAdapter:()=>new PostgresAdapter,createDriver:()=>new DummyDriver,createIntrospector:t=>new PostgresIntrospector(t),createQueryCompiler:()=>new PostgresQueryCompiler}});async function kyselyWrapper(t,e){const i=getDB();return await e({...t,db:i,client:{exec:async n=>await t.client.exec(n.sql)}})}const $tailor_resolver_step__kyselyStep=t=>kyselyWrapper(t,async e=>{const i=e.db.selectFrom("Supplier").select(["state"]).compile();return(await e.client.exec(i)).map(r=>r.state).join(", ")}),$connect_tailordb=async t=>{const e=new tailordb.Client({namespace:t});await e.connect();const i={async exec(r){return(await e.queryObject(r)).rows},async execOne(r){const n=await e.queryObject(r);return console.log(n),n.rows[0]}};return{...i,async transaction(r){try{await i.exec("BEGIN");const n=await r(i);return await i.exec("COMMIT"),n}catch(n){console.error("Transaction failed:",n);try{await i.exec("ROLLBACK")}catch(s){console.error("Failed to rollback transaction:",s)}}}}},$tailor_sql_step_wrapper=async(t,e)=>{const i=await $connect_tailordb(t);return async r=>await e({...r,client:i})};globalThis.main=await $tailor_sql_step_wrapper("my-db",$tailor_resolver_step__kyselyStep);
//# sourceMappingURL=stepChain__kyselyStep.js.map
