name: Type Check Performance

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  type-check-performance:
    name: Type Check Performance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install deps
        uses: ./.github/actions/install-deps

      - name: Run type check performance
        run: pnpm --filter @tailor-platform/sdk perf:typecheck

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: type-check-performance-results
          path: packages/sdk/diagnostics.json

      - name: Display results
        run: |
          {
            echo "## Type Check Performance Results"
            echo ""
            echo "### Feature-based Tests (sorted by instantiations)"
            echo ""
            echo "| Feature | Instantiations | Types |"
            echo "|---------|---------------:|------:|"
            jq -r 'sort_by(.instantiations) | reverse | .[] | "| \(.key) | \(.instantiations) | \(.types) |"' packages/sdk/diagnostics-summary.json
            echo ""
            echo "See [Operational Guidelines](packages/sdk/scripts/perf/README.md#operational-guidelines) for interpretation."
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run octocov
        uses: k1LoW/octocov-action@73d561f65d59e66899ed5c87e4621a913b5d5c20 # v1.5.0
        with:
          config: packages/sdk/.octocov.perf.yml
        env:
          OCTOCOV_CUSTOM_METRICS_TYPE_PERFORMANCE: packages/sdk/diagnostics.json
