name: Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      beta:
        description: "Release as beta version"
        required: false
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Get latest tag and calculate new version
        if: github.event_name == 'workflow_dispatch'
        id: calculate_version
        run: |
          # Get current branch name from GitHub context
          # workflow_dispatch provides github.ref_name directly
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Current branch: $BRANCH_NAME"

          # Get the latest version tag (excluding beta tags)
          # Note: Tags are already fetched by checkout action with fetch-tags: true
          LATEST_TAG="$(git tag -l "v*" | grep -v "\-beta\." | sort -V | tail -n1 || echo "v0.0.0")"
          if [[ -z "$LATEST_TAG" ]]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"

          # Remove 'v' prefix
          CURRENT_VERSION="${LATEST_TAG#v}"

          # Split version into components
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          # Calculate new version based on bump type
          case "${{ github.event.inputs.bump_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          # Get the current timestamp or build number for beta version
          BETA_ID=$(date +%s)

          # Handle version based on branch and beta flag
          if [[ "$BRANCH_NAME" != "main" ]]; then
            # For non-main branches, always use feature tag format
            # Sanitize branch name to be npm-compatible (alphanumeric, dash, underscore)
            SAFE_BRANCH="${BRANCH_NAME//([^a-zA-Z0-9._-])/-}"
            NEW_VERSION="${NEW_VERSION}-${SAFE_BRANCH}.${BETA_ID}"
            echo "publish_tag=feature" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event.inputs.beta }}" == "true" ]]; then
            # For main branch with beta flag
            NEW_VERSION="${NEW_VERSION}-beta.${BETA_ID}"
            echo "publish_tag=beta" >> "$GITHUB_OUTPUT"
          else
            # For main branch without beta flag (stable release)
            echo "publish_tag=latest" >> "$GITHUB_OUTPUT"
          fi

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -a v${{ steps.calculate_version.outputs.new_version }} -m "Release v${{ steps.calculate_version.outputs.new_version }}"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git v${{ steps.calculate_version.outputs.new_version }}

      - name: Set version from tag
        run: |
          cd packages/tailor-sdk
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            pnpm version ${{ steps.calculate_version.outputs.new_version }} --no-git-tag-version
          else
            pnpm version from-git --no-git-tag-version
          fi

      - name: Update npm
        run: npm install -g npm@latest

      - name: Publish npm package
        run: |
          # Use the publish tag determined during version calculation
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ steps.calculate_version.outputs.publish_tag }}"
          else
            # For tag pushes, determine tag based on version format
            if [[ "${{ github.ref }}" =~ -beta\. ]]; then
              TAG="beta"
            elif [[ "${{ github.ref }}" =~ -[a-zA-Z0-9._-]+\.[0-9]+$ ]]; then
              TAG="feature"
            else
              TAG="latest"
            fi
          fi

          if [[ "$TAG" == "latest" ]]; then
            pnpm --filter @tailor-platform/tailor-sdk publish --no-git-checks --access=public
          else
            pnpm --filter @tailor-platform/tailor-sdk publish --no-git-checks --access=public --tag "$TAG"
          fi
