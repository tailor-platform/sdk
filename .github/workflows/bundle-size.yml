name: Bundle Size Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  bundle-size:
    name: Measure Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
        with:
          persist-credentials: false

      - name: Install deps
        uses: ./.github/actions/install-deps

      - name: Build SDK
        run: pnpm --filter @tailor-platform/sdk build

      - name: Measure bundle size
        run: pnpm --filter @tailor-platform/sdk measure:bundle

      - name: Upload results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: bundle-size-results
          path: packages/sdk/bundle-size.json

      - name: Display results
        run: |
          {
            echo "## Bundle Size Results"
            echo ""
            echo "### Configure Index"
            echo "\`\`\`json"
            jq '.metrics[] | select(.key == "configure-index-size")' packages/sdk/bundle-size.json
            echo "\`\`\`"
            echo ""
            echo "### Auth/Config Chunk"
            echo "\`\`\`json"
            jq '.metrics[] | select(.key == "auth-config-chunk-size")' packages/sdk/bundle-size.json
            echo "\`\`\`"
            echo ""
            echo "### Total Bundle Size"
            echo "\`\`\`json"
            jq '.metrics[] | select(.key == "total-bundle-size")' packages/sdk/bundle-size.json
            echo "\`\`\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run octocov
        uses: k1LoW/octocov-action@73d561f65d59e66899ed5c87e4621a913b5d5c20
        with:
          config: packages/sdk/.octocov.bundle.yml
        env:
          OCTOCOV_CUSTOM_METRICS_BUNDLE_SIZE: packages/sdk/bundle-size.json
