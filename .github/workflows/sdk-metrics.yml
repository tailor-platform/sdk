name: SDK Metrics

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install deps
        uses: ./.github/actions/install-deps

      - name: Run SDK coverage
        run: pnpm --filter @tailor-platform/sdk test:coverage
        env:
          TAILOR_PLATFORM_TOKEN: ${{ secrets.TAILOR_PLATFORM_PAT }}

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-results
          path: packages/sdk/coverage/lcov.info

  bundle-size:
    name: Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install deps
        uses: ./.github/actions/install-deps

      - name: Build SDK
        run: pnpm --filter @tailor-platform/sdk build

      - name: Measure bundle size
        run: pnpm --filter @tailor-platform/sdk measure:bundle

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: bundle-size-results
          path: packages/sdk/bundle-size.json

  type-performance:
    name: Type Performance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install deps
        uses: ./.github/actions/install-deps

      - name: Run type check performance
        run: pnpm --filter @tailor-platform/sdk perf:typecheck

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: type-perf-results
          path: |
            packages/sdk/diagnostics.json
            packages/sdk/diagnostics-summary.json

  runtime-performance:
    name: Runtime Performance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install deps
        uses: ./.github/actions/install-deps

      - name: Run runtime performance
        run: pnpm --filter @tailor-platform/sdk perf:runtime

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: runtime-perf-results
          path: |
            packages/sdk/runtime-perf.json
            packages/sdk/runtime-perf-summary.json

  report-metrics:
    name: Report Metrics
    needs: [coverage, bundle-size, type-performance, runtime-performance]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: artifacts/

      - name: Prepare coverage
        run: |
          mkdir -p packages/sdk/coverage
          cp artifacts/coverage-results/lcov.info packages/sdk/coverage/

      - name: Display summary
        run: |
          {
            echo "# SDK Metrics Summary"
            echo ""

            echo "## Coverage"
            echo ""
            echo "See octocov report below for coverage details."
            echo ""

            echo "## Bundle Size"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|------:|"
            jq -r '.metrics[] | "| \(.name) | \(.value) \(.unit) |"' artifacts/bundle-size-results/bundle-size.json
            echo ""

            echo "## Type Check Performance"
            echo ""
            echo "| Feature | Instantiations | Types |"
            echo "|---------|---------------:|------:|"
            jq -r 'sort_by(.instantiations) | reverse | .[] | "| \(.key) | \(.instantiations) | \(.types) |"' artifacts/type-perf-results/diagnostics-summary.json
            echo ""

            echo "## Runtime Performance"
            echo ""
            echo "| Command | Min | Max | Median | Avg | StdDev |"
            echo "|---------|----:|----:|-------:|----:|-------:|"
            jq -r '"| generate | \(.generate.min)ms | \(.generate.max)ms | \(.generate.median)ms | \(.generate.avg)ms | \(.generate.stddev)ms |"' artifacts/runtime-perf-results/runtime-perf-summary.json
            jq -r '"| apply -d | \(."apply-dry".min)ms | \(."apply-dry".max)ms | \(."apply-dry".median)ms | \(."apply-dry".avg)ms | \(."apply-dry".stddev)ms |"' artifacts/runtime-perf-results/runtime-perf-summary.json
            echo ""
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run octocov
        uses: k1LoW/octocov-action@73d561f65d59e66899ed5c87e4621a913b5d5c20 # v1.5.0
        with:
          config: packages/sdk/.octocov.yml
        env:
          OCTOCOV_CUSTOM_METRICS_TYPE_PERFORMANCE: artifacts/type-perf-results/diagnostics.json
          OCTOCOV_CUSTOM_METRICS_BUNDLE_SIZE: artifacts/bundle-size-results/bundle-size.json
          OCTOCOV_CUSTOM_METRICS_RUNTIME_PERFORMANCE: artifacts/runtime-perf-results/runtime-perf.json
