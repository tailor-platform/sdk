name: Add changeset for Renovate PR

on:
  pull_request_target:
    types: [opened]

permissions:
  contents: write

jobs:
  add-changeset:
    runs-on: ubuntu-latest

    # Renovate PR only + security check
    if: |
      github.event.pull_request.user.login == 'renovate[bot]' &&
      github.event.pull_request.user.type == 'Bot'

    steps:
      # Get PR info
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            return {
              number: pr.number,
              headRef: pr.head.ref,
            };

      # Check if changeset already exists
      - name: Check existing changeset
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prData = JSON.parse('${{ steps.pr.outputs.result }}');
            const { headRef } = prData;

            // Check existence of .changeset (excluding README.md and config.json)
            try {
              const res = await github.rest.repos.getContent({
                owner,
                repo,
                path: '.changeset',
                ref: headRef,
              });

              if (Array.isArray(res.data)) {
                const changesetFiles = res.data.filter(
                  f => f.name !== 'README.md' && f.name !== 'config.json' && f.name.endsWith('.md')
                );
                if (changesetFiles.length > 0) {
                  core.info('changeset already exists. skip.');
                  core.setOutput('skip', 'true');
                  return;
                }
              }
            } catch (e) {
              if (e.status !== 404) throw e;
            }

            core.setOutput('skip', 'false');

      # Create changeset commit
      - name: Create changeset commit
        if: steps.check.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prData = JSON.parse('${{ steps.pr.outputs.result }}');
            const { number, headRef } = prData;

            // Get PR title for better description
            const pr = context.payload.pull_request;
            const description = pr.title || 'Update dependencies';

            const filename = `renovate-${number}.md`;
            const content = [
              '---',
              '"@tailor-platform/sdk": patch',
              '"@tailor-platform/create-sdk": patch',
              '---',
              '',
              description,
              '',
            ].join('\n');

            // get latest commit
            const ref = await github.rest.git.getRef({
              owner,
              repo,
              ref: `heads/${headRef}`,
            });

            const commitSha = ref.data.object.sha;

            const commit = await github.rest.git.getCommit({
              owner,
              repo,
              commit_sha: commitSha,
            });

            // create blob
              const blob = await github.rest.git.createBlob({
              owner,
              repo,
              content,
              encoding: 'utf-8',
            });

            // create tree
            const tree = await github.rest.git.createTree({
              owner,
              repo,
              base_tree: commit.data.tree.sha,
              tree: [
                {
                  path: `.changeset/${filename}`,
                  mode: '100644',
                  type: 'blob',
                  sha: blob.data.sha,
                },
              ],
            });

            // create commit
            const newCommit = await github.rest.git.createCommit({
              owner,
              repo,
              message: 'chore: add changeset for renovate',
              tree: tree.data.sha,
              parents: [commitSha],
            });

            // update ref
            await github.rest.git.updateRef({
              owner,
              repo,
              ref: `heads/${headRef}`,
              sha: newCommit.data.sha,
            });
